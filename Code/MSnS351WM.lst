
MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 1
MC68HC908GP32 User Bootloader


                        1  ;***************************************************
                                   ********************************************
                        2  ;
                        3  ;   MSnS351WM.inc
                        4  ;
                        5  ;   Based on the work of Bruce Bowling and Al 
                                   Grippo for the original B&G and Hi Res code.
                        6  ;   Also Magnus Bjelk for his megasquirtnspark and 
                                          the msnsextra team as well as all the
                        7  ;   unknown contributors to the MS project.
                        8  ;   Special thanks to Eric Fahlgren with the early 
                                            help integrating with Megatune, and
                        9  ;   Phil Tobin for assisting in integrating with 
                                                                   Tuner Studio
                       10  ;
                       11  ;   Robert Hiebert 2010
                       12  ;
                       13  ;***************************************************
                                   ********************************************
                       14  ;***************************************************
                                   ********************************************
                       15  ;   This version of the MSnS300/460 code is 
                                    designed specifically for use on a Ford 351
                       16  ;   Windsor marine engine, converted from carburatio
                                    n to EFI. The conversion was done using EFI
                       17  ;   components from the 5.8L truck engines dated 
                                  ~1992. The upper intake manifold was modified
                       18  ;   to fit in the engine space, otherwise all stock 
                                         components were used including 19lb/hr
                       19  ;   injectors and TFI igntion. The system is speed 
                                    density and fires the injectors in banks of
                       20  ;   four, alternately, every ignition event. A WB 
                                  O2 sensor is installed and is used for tuning
                       21  ;   and reference only as the engine runs open loop 
                                                             in all conditions.
                       22  ;***************************************************
                                   ********************************************
                       23  ;***************************************************
                                   ********************************************
                       24  ;
                       25  ; Rev 1: 1/1/11:  - Added Hi Res tach feature, 
                                       crankshaft trigger detection feature and
                       26  ;                   crankshaft trigger error 
                                                           compensation feature
                       27  ;
                       28  ; Rev 2: 4/12/11: - Put ADC averaging back in.
                       29  ;
                       30  ; Rev 2: 7/07/11: - Add knock detection code
                       31  ;
                       32  ; Rev 2: 8/17/11: - Change fuel delivery calculation
                                                 s to try reduce deadband error
                       33  ;
                       34  ; Rev 2: 9/25/11: - Comment out Loop Counter code. 
                                    Add code to knock sensor to fall through if
                       35  ;                   bit is already set or cleared. 
                                     Add configureable constants for all alarms
                       36  ;                   and "runon", "startedon", and 
                                    "warmoff". Modify AFR2 table. Update VE and


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 2
MC68HC908GP32 User Bootloader


                       37  ;                   ST with latest tune.
                       38  ;
                       39  ; Rev 2: 4/16/12: - ASE counter and bank flow rate 
                                                     variables and code changes
                       40  ;
                       41  ; Rev 2: 7/02/12: - Modify code to average Hi Res 
                              Tach period over 16 samples to smooth out display
                       42  ;
                       43  ; Rev 2: 8/01/12: - Revise period averaging for Hi 
                                       Res Tach calcs. Total periods for 250 ms
                       44  ;                   then divide by "tachcnt". Code 
                                                      is slower but works well.
                       45  ;                   Average "batt", "ego", "OP_ADC",
                                    "FP_ADC", and "EGT_ADC"  over 16 iterations
                       46  ;                   to smooth things out (~176 ms 
                                                                        update)
                       47  ;
                       48  ; Rev 9: 8/02/12: - Eliminate "aseHi", aseLo", 
                                     "trigErr", "dbcor" and "warmoff" from .asm
                       49  ;
                       50  ;
                       51  ; Rev 10: 8/03/12 - Modify code to allow knock 
                               detection to sound alarm only when ignition trim
                       52  ;                   or fuel trim is active.
                       53  ;
                       54  ; Rev 11: 8/08/12 - Add code for hot start ASE.
                       55  ;
                       56  ;***************************************************
                                   ********************************************
                       57  ;***************************************************
                                   ********************************************
                       58  ;
                       59  ; ---------------------------------- MSnS351WM 
                              Hardware Wiring ---------------------------------
                       60  ;
                       61  ;***************************************************
                                   ********************************************
                       62  ;
                       63  ; ----- Inputs [port name - function] -----
                       64  ;
                       65  ;  IRQ           - PIP (Profile Ignition Pickup)Inpu
                                   t (Rising edge at 10 degrees BTDC on Pin 24,
                       66  ;                 inverted to IRQ)
                       67  ;  PTB0/AD0     - Manifold Absolute Pressure
                       68  ;  PTB1/AD1     - Manifold Air Temperature
                       69  ;  PTB2/AD2     - Coolant Temperature
                       70  ;  PTB3/AD3     - Throttle Position Sensor
                       71  ;  PTB4/AD4     - Battery Voltage
                       72  ;  PTB5/AD5     - Exhaust Gas Oxygen
                       73  ;  PTB6/AD6     - Fuel Trim
                       74  ;  PTB7/AD7     - MC14051B analog multiplexer 
                                                                  common output
                       75  ;  MC14051B Ch0 - Ignition Trim
                       76  ;  MC14051B Ch1 - Engine Oil Pressure
                       77  ;  MC14051B Ch2 - Fuel Presure
                       78  ;  MC14051B Ch3 - Exhaust Gas Temperature
                       79  ;  PTA2         - Ignition Trim Enable
                       80  ;  PTA3         - Knock Sensor


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 3
MC68HC908GP32 User Bootloader


                       81  ;  PTA4         - Ignition Monitor
                       82  ;  PTA5         - Fuel Trim Enable
                       83  ;
                       84  ; ----- Outputs [port name - function] -----
                       85  ;
                       86  ;  PTD4/T1CH0   - Injector 1
                       87  ;  PTD5/T1CH1   - Injector 2
                       88  ;  PTA0         - Fuel Pump Relay driver transistor,
                                                                        sinking
                       89  ;  PTA1          - SPOUT (Spark Output) driver 
                              transistor, sinking, with pullup, for TFI module,
                       90  ;                 50% duty cycle, fires on rising 
                                                                           edge
                       91  ;  PTA6         - MC14051B input "B"
                       92  ;  PTA7         - MC14051B input "A"
                       93  ;  PTC0          - Accumulated Injector On Time(open
                                                                     collector)
                       94  ;  PTC1          - Engine Alarm
                       95  ;  PTC2          - Program loop counter LED (Spare 
                                                                        Output)
                       96  ;
                       97  ;***************************************************
                                   ********************************************
                       98  ;***************************************************
                                   ********************************************
                       99  ; ram_start         = memory location $0040(64T)(GP3
                                                                          2equ)
                      100  ; ram_last          = memory location $023F(575T)(GP
                                                                         32equ)
                      101  ; rom_start         = memory location $8000(32768)(G
                                                                        P32equ)
                      102  ; rom_last          = memory location $FDFF(65023)(G
                                                                        P32equ)
                      103  ; init_stack        = ram_exec = memory location 
                                                            $01ED(493)(bootr12)
                      104  ; ms_ram_start      = memory location $0040(64)(MS_E
                                                                       CU_HP.h)
                      105  ; ms_ram_end        = memory location $00D0(208)(MS_
                                                                      ECU_HP.h)
                      106  ; ms_rf_start       = memory location $00D0(208)(MS_
                                                                      ECU_HP.h)
                      107  ; ms_rf_end         = memory location $01B0(432)(MS_
                                                                      ECU_HP.h)
                      108  ; ms_ram_size       = {ms_ram_end-ms_ram_start}($00D
                                        0-$0040=$0090)(208-64=144)(MS_ECU_HP.h)
                      109  ; ms_rf_size        = {ms_rf_end-ms_rf_start}}($01B0
                                        -$00D0=$00E0)(432-208=224)(MS_ECU_HP.h)
                      110  ; ms_total_ram_size = {ms_rf_end-ms_ram_start}}($01B
                                        0-$0040=$0170)(432-64=368)(MS_ECU_HP.h)
                      111  ;***************************************************
                                   ********************************************
                      112  
                      113  
 0040                 114       org        ram_start                  ; Origin  Memory location $0040(64)
 0040                 115       include "MSnS351WM.inc"              ; Include definitions for
                      116  ;***********************************************************************************************
                      117  ;
                      118  ;   MSnS351WM.inc (include file for MSnS351WM.asm)
                      119  ;
                      120  ;   Based on the work of Bruce Bowling and Al Grippo for the original B&G and Hi Res code.
                      121  ;   Also Magnus Bjelk for his megasquirtnspark and the msnsextra team as well as all the
                      122  ;   unknown contributors to the MS project.
                      123  ;   Special thanks to Eric Fahlgren with the early help integrating with Megatune, and
                      124  ;   Phil Tobin for assisting in integrating with Tuner Studio
                      125  ;
                      126  ;   Robert Hiebert 2010
                      127  ;
                      128  ;***********************************************************************************************
                      129  ;***********************************************************************************************
                      130  ;   This version of the MSnS300/460 code is designed specifically for use on a Ford 351
                      131  ;   Windsor marine engine, converted from carburation to EFI. The conversion was done using EFI
                      132  ;   components from the 5.8L truck engines dated ~1992. The upper intake manifold was modified
                      133  ;   to fit in the engine space, otherwise all stock components were used including 19lb/hr
                      134  ;   injectors and TFI igntion. The system is speed density and fires the injectors in banks of
                      135  ;   four, alternately, every ignition event. A WB O2 sensor is installed and is used for tuning
                      136  ;   and reference only as the engine runs open loop in all conditions.
                      137  ;***********************************************************************************************
                      138  ;***********************************************************************************************
                      139  ;
                      140  ; Rev 1: 1/1/11:  - Added Hi Res tach feature, crankshaft trigger detection feature and 
                      141  ;                   crankshaft trigger error compensation feature
                      142  ;
                      143  ; Rev 2: 4/12/11: - Put ADC averaging back in.
                      144  ;
                      145  ; Rev 3: 7/07/11: - Add knock detection code
                      146  ;
                      147  ; Rev 4: 8/17/11: - Change fuel delivery calculations to try reduce deadband error
                      148  ;
                      149  ; Rev 5: 9/25/11: - Comment out Loop Counter code. Add code to knock sensor to fall through if 
                      150  ;                   bit is already set or cleared. Add configureable constants for all alarms 
                      151  ;                   and "runon", "startedon", and "warmoff". Modify AFR2 table. Update VE and 
                      152  ;                   ST with latest tune.
                      153  ;
                      154  ; Rev 6: 4/16/12: - ASE counter and bank flow rate variables and code changes
                      155  ;
                      156  ; Rev 7: 7/02/12: - Modify code to average Hi Res Tach period over 16 samples to smooth out display
                      157  ;
                      158  ; Rev 8: 8/01/12: - Revise period averaging for Hi Res Tach calcs. Total periods for 250 ms
                      159  ;                   then divide by "tachcnt". Code is slower but works well.
                      160  ;                   Average "batt", "ego", "OP_ADC", "FP_ADC", and "EGT_ADC"  over 16 iterations
                      161  ;                   to smooth things out (~176 ms update)
                      162  ;
                      163  ; Rev 9: 8/02/12: - Eliminate "aseHi", aseLo", "trigErr", "dbcor" and "warmoff" from .asm
                      164  ;
                      165  ; Rev 10: 8/03/12 - Modify code to allow knock detection to sound alarm only when ignition trim
                      166  ;                   or fuel trim is active.
                      167  ;
                      168  ; Rev 11: 8/08/12 - Add code for hot start ASE.
                      169  ;
                      170  ;***********************************************************************************************
                      171  ;***********************************************************************************************
                      172  ;
                      173  ; ---------------------------------- MSnS351WM Hardware Wiring ---------------------------------
                      174  ;
                      175  ;***********************************************************************************************
                      176  ;
                      177  ; ----- Inputs [port name - function] -----
                      178  ;
                      179  ;  IRQ           - PIP (Profile Ignition Pickup)Input (Rising edge at 10 degrees BTDC on Pin 24,
                      180  ;                 inverted to IRQ)
                      181  ;  PTB0/AD0     - Manifold Absolute Pressure
                      182  ;  PTB1/AD1     - Manifold Air Temperature
                      183  ;  PTB2/AD2     - Coolant Temperature
                      184  ;  PTB3/AD3     - Throttle Position Sensor
                      185  ;  PTB4/AD4     - Battery Voltage
                      186  ;  PTB5/AD5     - Exhaust Gas Oxygen
                      187  ;  PTB6/AD6     - Fuel Trim
                      188  ;  PTB7/AD7     - MC14051B analog multiplexer common output
                      189  ;  MC14051B Ch0 - Ignition Trim
                      190  ;  MC14051B Ch1 - Engine Oil Pressure
                      191  ;  MC14051B Ch2 - Fuel Presure
                      192  ;  MC14051B Ch3 - Exhaust Gas Temperature
                      193  ;  PTA2         - Ignition Trim Enable
                      194  ;  PTA3         - Knock Sensor
                      195  ;  PTA4         - Ignition Monitor
                      196  ;  PTA5         - Fuel Trim Enable


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 4
MC68HC908GP32 User Bootloader


                      197  ;
                      198  ; ----- Outputs [port name - function] -----
                      199  ;
                      200  ;  PTD4/T1CH0   - Injector 1
                      201  ;  PTD5/T1CH1   - Injector 2
                      202  ;  PTA0         - Fuel Pump Relay driver transistor, sinking
                      203  ;  PTA1          - SPOUT (Spark Output) driver transistor, sinking, with pullup, for TFI module,
                      204  ;                 50% duty cycle, fires on rising edge
                      205  ;  PTA6         - MC14051B input "B"
                      206  ;  PTA7         - MC14051B input "A"
                      207  ;  PTC0          - Accumulated Injector On Time(open collector)
                      208  ;  PTC1          - Engine Alarm
                      209  ;  PTC2          - Program loop counter LED (Spare Output)
                      210  ;
                      211  ;***********************************************************************************************
                      212  ;***********************************************************************************************
                      213  ;
                      214  ; -----Assembler Directives -----
                      215  ;
                      216  ; EQU    - Equate -Define label equal to operand
                      217  ; RMB    - Reserve Memory Byte -  Reserve number of bytes in memory
                      218  ;          as specified by operand
                      219  ; DS#n   - Define Storage - Reserve n number of bytes in memory
                      220  ;          as specified by operand
                      221  ;
                      222  ;***********************************************************************************************
                      223  
                      224  ;****************************************************************************
                      225  ; ------------------------ Input Port Equates -------------------------------
                      226  ;****************************************************************************
                      227  
 0040                 228  Ign_Trm_En:  equ 2     ; Ignition Trim Enable on Port A2
 0040                 229  Knk_Det:     equ 3     ; Knock detected on Port A3
 0040                 230  Ign_Mon:     equ 4     ; Ignition Monitor on Port A4
 0040                 231  Fuel_Trm_En: equ 5     ; Fuel Trim Enable on Port A5
                      232  
                      233  ;***********************************************************************************************
                      234  ; ----------------------------------- Output Port Equates --------------------------------------
                      235  ;***********************************************************************************************
                      236  
 0040                 237  inject1:    equ 4     ; Injector 1 on Port D4
 0040                 238  inject2:    equ 5     ; Injector 2 on Port D5
                      239  
 0040                 240  fuelp:      equ 0     ; Fuel Pump Relay on Port A0
 0040                 241  spark:      equ 1     ; Spark Output on Port A1
 0040                 242  MplexB:     equ 6     ; MC14051B control input "B" Port A6
 0040                 243  MplexA:     equ 7     ; MC14051B control input "A" Port A7
                      244  
 0040                 245  aiot:       equ 0     ; 25.5ms injector on time pulse on Port C0
 0040                 246  Eng_Alrm:   equ 1     ; Engine Alarm on Port C1
 0040                 247  Loopchk:    equ 2     ; Program loop frequency LED on Port C2
                      248  
                      249  ;***********************************************************************************************
                      250  ; ---------------------- "Squirt" Event Scheduling  bit field equates  -------------------------
                      251  ;***********************************************************************************************
                      252  
 0040                 253  inj1:       equ 0     ; 1 = INJ1 fire          0 = INJ1 no fire
 0040                 254  inj2:       equ 1     ; 1 = INJ2 fire          0 = INJ2 no fire
 0040                 255  sched1:     equ 2     ; 1 = INJ1 scheduled     0 = INJ1 not scheduled
 0040                 256  firing1:    equ 3     ; 1 = INJ1 firing        0 = INJ1 not firing
 0040                 257  sched2:     equ 4     ; 1 = INJ2 scheduled     0 = INJ2 not scheduled
 0040                 258  firing2:    equ 5     ; 1 = INJ2 firing        0 = INJ2 not firing
                      259  
                      260  ;***********************************************************************************************
                      261  ; ----------------------- "Engine" Operating Status bit field equates --------------------------
                      262  ;***********************************************************************************************
                      263  
 0040                 264  running:    equ 0    ; 1 = Engine running      0 = Engine not running
 0040                 265  crank:      equ 1    ; 1 = Engine cranking     0 = Engine not cranking
 0040                 266  startw:     equ 2    ; 1 = Warmup enrich       0 = Not in startup warmup
 0040                 267  warmup:     equ 3    ; 1 = In warmup           0 = Not in warmup
 0040                 268  tpsaen:     equ 4    ; 1 = TPS accel mode      0 = Not in TPS accel mode
 0040                 269  tpsden:     equ 5    ; 1 = Decel mode          0 = Not in decel mode
 0040                 270  mapaen:     equ 6    ; 1 = In MAP accel mode   0 = Not in MAP aceel mode
 0040                 271  trigHi      equ 7    ; 1 = IRQ Lo(PIP Hi)      0 = IRQ Hi(PIP Lo)
                      272  
                      273  
                      274  ;***********************************************************************************************
                      275  ; ------------------------ "Engine2" Operating Status bit field equates ------------------------
                      276  ;***********************************************************************************************
                      277  
 0040                 278  run         equ 0     ; 1 = in Run mode              0 = not in Run mode
 0040                 279  schedspk    equ 1     ; 1 = Spark scheduled flag     0 = "schedspk" cleared
 0040                 280  sparking    equ 2     ; 1 = Spark in progress flag   0 = "sparking" cleared
 0040                 281  started     equ 3     ; 1 = Engine has started       0 = Engine not started
 0040                 282  cant_crank  equ 4     ; 1 = Crank mode inhibit       0 = Crank mode OK
 0040                 283  cant_delay  equ 5     ; 1 = Crank mode delay         0 = Crank mode not delay
                      284  
                      285  
                      286  ;***********************************************************************************************
                      287  ; -------------------------- "inputs" Operating Status bit field equates -----------------------
                      288  ;***********************************************************************************************
                      289  
 0040                 290  piprise     equ 0     ; 1 = PIP rising edge flag       0 = "piprise" cleared
 0040                 291  adcc        equ 1     ; 1 = ADC complete flag          0 = "adcc" cleared
 0040                 292  MONrise     equ 2     ; 1 = Ign Mon rising edge flag   0 = "MONrise" cleared
 0040                 293  MONen       equ 3     ; 1 = Ign Mon KBI enabled        0 = MON KBI disabled
 0040                 294  clock100    equ 4     ; 1 = 100mS clock tick           0 = "clock100" cleared
 0040                 295  clock250    equ 5     ; 1 = 250mS clock tick           0 = "clock250" cleared
 0040                 296  clock500    equ 6     ; 1 = 500mS clock tick           0 = "clock500" cleared
                      297  
                      298  ;***********************************************************************************************
                      299  ; ----------------------- "alarmbits" Operating Status bit field equates -----------------------
                      300  ;
                      301  ; LOP      = 00000001 = 1T   = #$01 
                      302  ; HET      = 00000010 = 2T   = #$02
                      303  ; LFP      = 00000100 = 4T   = #$04
                      304  ; HFP      = 00001000 = 8T   = #$08
                      305  ; HEGT     = 00010000 = 16T  = #$10
                      306  ; REVL     = 00100000 = 32T  = #$20
                      307  ; fldclr   = 01000000 = 64T  = #$40
                      308  ; knocking = 10000000 = 128T = #$80
                      309  ;
                      310  ;***********************************************************************************************
                      311  
 0040                 312  LOP:       equ 0     ; 1 = Low oil pressure         0 = No low oil pressure
 0040                 313  HET:       equ 1     ; 1 = High Engine Temperature  0 = No High Engine Temperature
 0040                 314  LFP:       equ 2     ; 1 = Low Fuel Pressure        0 = No Low Fuel Pressure
 0040                 315  HFP:       equ 3     ; 1 = High Fuel Pressure       0 = No High Fuel Pressure
 0040                 316  HEGT:      equ 4     ; 1 = High Exhaust Gas Temp    0 = No High Exhaust Gas Temp
 0040                 317  REVL:      equ 5     ; 1 = Engine Rev Limit         0 = No Engine Rev Limit
 0040                 318  fldClr:    equ 6     ; 1 = Engine Flood Clear       0 = No Engine Flood Clear
 0040                 319  knocking:  equ 7     ; 1 = Engine Knock             0 = No Engine Engine Knock
                      320  
                      321  ;***********************************************************************************************
                      322  ; ----------------------- "portAbits" Operating Status bit field equates -----------------------
                      323  ;***********************************************************************************************
                      324  
 0040                 325  FPon:     equ 0    ; 1 = Fuel Pump On            0 = Fuel Pump Not On
 0040                 326  ITen:     equ 2    ; 1 = Ignition Trim Enabled   0 = Ignition Trim Not Enabled
 0040                 327  FTen:     equ 5    ; 1 = Fuel Trim Enabled       0 = Fuel Trim Not Enabled
                      328  
                      329  ;***********************************************************************************************
                      330  ; ----------------------- "portCbits" Operating Status bit field equates -----------------------
                      331  ;***********************************************************************************************
                      332  


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 5
MC68HC908GP32 User Bootloader


 0040                 333  EAon:     equ 0    ; 1 = Engine Alarm On         0 = Engine Alarm Not On
                      334  
                      335  ;***********************************************************************************************
                      336  ; ---------------------------------------- Misc. equates ---------------------------------------
                      337  ;***********************************************************************************************
                      338  
 0040                 339  Stat_Tim_Ang   equ $0A     ; Static Timing Angle 10 degrees BTDC
 0040                 340  PAGESIZE       equ $A8     ;(168)Size of the data page, used by the P and C commands
                      341  
                      342  ms_ram_start:
                      343  
                      344  ;***********************************************************************************************
                      345  ; --------------------------- RAM Variables (512 bytes available) ------------------------------
                      346  ; I/O registers from $0000 to $0039 (decimal 0 to 63)
                      347  ; Direct page addressing from $0000 to $00FF (decimal 0 to 255)
                      348  ; Ram end at $023F (decimal 575)
                      349  ;***********************************************************************************************
                      350  ;***********************************************************************************************
                      351  ; ---------------------- RS232 Real Time Download and Datalog Variables ------------------------
                      352  ;***********************************************************************************************
                      353  
                      354  ; - Memory Location $0040 (decimal 64)
                      355  
 0040                 356  secl:           ds 1 ; low seconds - from 0 to 255, then rollover
 0041                 357  map:           ds 1 ; Manifold Absolute Pressure ADC Raw Reading - KPa (0 - 255)(AD0)
 0042                 358  mat:           ds 1 ; Manifold Air Temp ADC Raw Reading - counts (0 - 255)(AD1)
 0043                 359  clt:           ds 1 ; Coolant Temperature ADC Raw Reading - counts (0 - 255)(AD2)
 0044                 360  tps:           ds 1 ; Throttle Position Sensor ADC Raw Reading - counts (0 - 255)(AD3)
 0045                 361  batt:                  ds 1 ; Battery Voltage ADC Av Reading - counts (0 - 255)(AD4)
 0046                 362  ego:            ds 1 ; Exhaust Gas Oxygen ADC Av Reading - counts (0 - 255)(AD5)
 0047                 363  Ftrm_ADC:       ds 1 ; Fuel Trim ADC Raw Reading - counts (0 - 255)(AD6)
 0048                 364  Itrm_ADC:       ds 1 ; Ignition Trim ADC Raw Reading - counts (0 - 255)(AD7, Mplx ch0)
 0049                 365  OP_ADC:         ds 1 ; Engine Oil Pressure ADC Av Reading - counts (0 - 255)(AD7, Mplx ch1)
 004A                 366  FP_ADC:         ds 1 ; Fuel Pressure ADC Av Reading - counts (0 - 255)(AD7, Mplx ch2)
 004B                 367  EGT_ADC:        ds 1 ; Exhaust Gas Temperature ADC Av Reading - counts (0 - 255)(AD7, Mplx ch3)
 004C                 368  barometer:      ds 1 ; Current barometer reading in KPA (for MV)
 004D                 369  barocor:        ds 1 ; Barometer Lookup Correction - percent
 004E                 370  warmcor:        ds 1 ; Total Warmup Correction - percent
 004F                 371  aircor:         ds 1 ; Air Density Correction lookup - percent
                      372  
                      373  ; - Memory Location $0050 (decimal 80)
                      374  
 0050                 375  Ftrimcor:       ds 1 ; Fuel Trim Correction Factor (85% - 115%)
 0051                 376  gammae:         ds 1 ; Total Gamma Enrichments - percent
 0052                 377  tpsaccel:       ds 1 ; Acceleration enrichment - percent
 0053                 378  rpm20:          ds 1 ; Computed engine RPM - rpm/20
 0054                 379  vecurr:         ds 1 ; Current VE value from lookup table - percent
 0055                 380  pwcalcH:        ds 1 ; high order of calculated pulsewith (16 bits)
 0056                 381  pwcalcL:        ds 1 ; low order of calculated pulsewidth (16 bits)
 0057                 382  pw:             ds 1 ; injector squirt time in 1/10 millesec (0 to 25.5 millisec) - applied
 0058                 383  fd:             ds 1 ; Fuel Delivery PW Lo Res
 0059                 384  fdSecH:         ds 1 ; Fuel Delivery PW Lo Res over 16 periods Hi byte
 005A                 385  fdSecL:         ds 1 ; Fuel Delivery PW Lo Res over 16 periods Lo byte
 005B                 386  tachH:          ds 1 ; Tachometer period averaged over 500 mS Hi byte
 005C                 387  tachL:          ds 1 ; Tachometer period averaged over 500 mS Lo byte
 005D                 388  Spk_Ang_Fac:    ds 1 ; Spark Angle Factor (from ST table)
 005E                 389  Trm_Ang_Fac:    ds 1 ; Trim Angle Factor (from IgnTrimcor table)
 005F                 390  Dly_Ang_Fac:    ds 1 ; Delay Angle Factor (Spk_Ang_Fac + Trm_Ang_Fac)
                      391  
                      392  ; - Memory Location $0060 (decimal 96)
                      393  
 0060                 394  MON_pH:         ds 1 ; MON period Hi byte (MON_tsH - PIP_tsH)
 0061                 395  MON_pL:         ds 1 ; MON period Lo byte (MON_tsL - PIP_tsL)
 0062                 396  tpsp:           ds 1 ; Throttle position percent
 0063                 397  engine:         ds 1 ; Variable bit-field to hold engine current status
 0064                 398  alarmbits:      ds 1 ; Engine Alarm Status Bit Field
 0065                 399  portAbits:      ds 1 ; Port A status Bit field
 0066                 400  portCbits:      ds 1 ; Port C Status Bit Field
 0067                 401  BnkflowHmv:     ds 1 ; Injector bank flow rate L/hr x 10 Hi byte for MV
 0068                 402  BnkflowLmv:     ds 1 ; Injector bank flow rate L/hr x 10 Lo byte for MV
                      403  
                      404  ;***********************************************************************************************
                      405  ; This marks the end of the real time download variables, 41 in total
                      406  ;***********************************************************************************************
                      407  
                      408  ;***********************************************************************************************
                      409  ; Bit Field Variables
                      410  ;***********************************************************************************************
                      411  
 0069                 412  engine2:        ds 1 ; Variable bit-field to hold engine current status #2
 006A                 413  squirt:         ds 1 ; Event variable bit field for Injector Firing
 006B                 414  inputs:         ds 1 ; Bit field variable for input status flags
                      415  
                      416  ;***********************************************************************************************
                      417  ; ADC Conversion Variables
                      418  ;***********************************************************************************************
                      419  
 006C                 420  kpa:            ds 1 ; MAP value in units of KPa
 006D                 421  coolant:        ds 1 ; Coolant temperature in Degrees F plus 40 (allows -40 degress to fit in int)
                      422  
                      423  ;***********************************************************************************************
                      424  ; ADC Calculation Variables
                      425  ;***********************************************************************************************
                      426  
 006E                 427  adsel:      ds 1 ; ADC Selector Variable
 006F                 428  adsel2:      ds 1 ; ADC Selector Variable 2
                      429  
                      430  ; - Memory Location $0070 (decimal 112)
                      431  
                      432  ;***********************************************************************************************
                      433  ; Fuel Calculation Variables
                      434  ;***********************************************************************************************
                      435  
 0070                 436  pwnadH:        ds 1     ; Calculated PW without Accel and deadband Hi byte
 0071                 437  pwnadL:        ds 1     ; Calculated PW without Accel and deadband Lo byte
 0072                 438  fdhrH:         ds 1     ; Calc PW without deadband Hi byte (fuel delivery)
 0073                 439  fdhrL:         ds 1     ; Calc PW without deadband Lo byte (fuel delivery)
 0074                 440  deadband:      ds 1     ; Injector deadband in 100uS resolution
                      441  
                      442  ;***********************************************************************************************
                      443  ; Engine RPM -> RPM = 12000/(ncyl * (rpmph - rpmpl))
                      444  ;***********************************************************************************************
                      445  
 0075                 446  rpmph:      ds 1 ; High part of RPM Period
 0076                 447  rpmpl:      ds 1 ; Low part of RPM Period
 0077                 448  rpmch:      ds 1 ; Counter for high part of RPM
 0078                 449  rpmcl:      ds 1 ; Counter for low part of RPM
                      450  
                      451  
                      452  ;***********************************************************************************************
                      453  ; Timer Variables
                      454  ;***********************************************************************************************
                      455  
 0079                 456  mSx250:     ds 1 ; 250 Milliseconds counter
 007A                 457  mSx100:     ds 1 ; 100 Milliseconds counter
 007B                 458  mS:         ds 1 ; Milliseconds counter
 007C                 459  uSx100:     ds 1 ; 100 Microseconds counter
 007D                 460  sech:       ds 1 ; high seconds - rollover at 65536 secs (1110.933 minutes, 18.51 hours)
 007E                 461  tpsaclk:    ds 1 ; TPS enrichment timer clock in 0.1 second resolution
 007F                 462  asecount:   ds 1 ; Counter value for after-start enrichment counter - every ignition pulse
                      463  
                      464  ; - Memory Location $0080 (decimal 128))
                      465  
 0080                 466  last_tps:   ds 1 ; TPS reading updated every 0.1 seconds
 0081                 467  igncount:   ds 1 ; Ignition pulse counter
 0082                 468  altcount:   ds 1 ; Alternate count selector


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 6
MC68HC908GP32 User Bootloader


 0083                 469  tpsaclkcmp: ds 1 ; Comparison value for TPS acceleration time - from lookup table
 0084                 470  tpsfuelcut: ds 1 ; TPS Fuel Cut (percent)
                      471  
                      472  ;***********************************************************************************************
                      473  ; SCI parameters/variables
                      474  ;***********************************************************************************************
                      475  
 0085                 476  txcnt:      ds 1 ; SCI transmitter count (incremented)
 0086                 477  txgoal:     ds 1 ; SCI number of bytes to transmit
 0087                 478  txmode:     ds 1 ; Transmit mode flag
 0088                 479  rxoffset:   ds 1 ; offset placeholder when receiving VE/constants vis. SCI
                      480  
                      481  ;***********************************************************************************************
                      482  ; Routines for integer math - storage variables
                      483  ;***********************************************************************************************
                      484  
 0089                 485  INTACC1       rmb 4
 008D                 486  INTACC2       rmb 4
                      487  
                      488  
                      489  ; - Memory Location $0090 (decimal 144)(at INTACC2+3)
                      490  
                      491  ;***********************************************************************************************
                      492  ; Temporary variables
                      493  ;***********************************************************************************************
                      494  
 0091                 495  tmp1    ds 1
 0092                 496  tmp2    ds 1
 0093                 497  tmp3    ds 1
 0094                 498  tmp4    ds 1
 0095                 499  tmp5    ds 1
 0096                 500  tmp6    ds 1
 0097                 501  tmp7    ds 1
 0098                 502  tmp8    ds 1
 0099                 503  tmp9    ds 1
 009A                 504  tmp10   ds 1
 009B                 505  tmp11   ds 1
 009C                 506  tmp12   ds 1
 009D                 507  tmp13   ds 1
 009E                 508  tmp14   ds 1
 009F                 509  tmp15   ds 1
                      510  
                      511  ; - Memory location $00A0 (decimal 160)
                      512  
 00A0                 513  tmp16   ds 1
 00A1                 514  tmp17   ds 1
 00A2                 515  tmp18   ds 1
 00A3                 516  tmp19   ds 1
 00A4                 517  tmp20   ds 1
 00A5                 518  tmp21   ds 1
 00A6                 519  tmp22   ds 1
                      520  
                      521  
                      522  ;****************************************************************************
                      523  ; ------------------- Spark Timing  Control Variables -----------------------
                      524  ;****************************************************************************
                      525  
 00A7                 526  PIP_tsH:        ds 1     ; PIP timestamp current reading Hi byte
 00A8                 527  PIP_tsL:        ds 1     ; PIP timestamp current reading Lo byte
 00A9                 528  PIP_tsH_prv:    ds 1     ; PIP timestamp previous reading Hi byte
 00AA                 529  PIP_tsL_prv:    ds 1     ; PIP timestamp previous reading Lo byte
 00AB                 530  PIP_pH_prv:     ds 1     ; PIP period Hi byte previous
 00AC                 531  PIP_pL_prv:     ds 1     ; PIP period Lo byte previous
 00AD                 532  PIP_pH_dif:     ds 1     ; PIP period difference Hi byte (PIP_pH - PIP_pH_prv)
 00AE                 533  PIP_pL_dif:     ds 1     ; PIP period difference Lo byte (PIP_pL - PIP_pL_prv)
 00AF                 534  PIP_pH:         ds 1     ; PIP period Hi byte (PIP_tsH - PIP_tsH_prv)
                      535  
                      536  ; - Memory location $00B0 (decimal 176)
                      537  
 00B0                 538  PIP_pL:         ds 1     ; PIP period Lo byte (PIP_tsL - PIP_tsL_prv)
 00B1                 539  PIP_pH_pred:    ds 1     ; Predicted PIP period Hi byte (PIP_pH + PIP_pH_dif)
 00B2                 540  PIP_pL_pred:    ds 1     ; Predicted PIP period Lo byte (PIP_pL + PIP_pL_dif)
 00B3                 541  Delay_pH:       ds 1     ; Delay period from PIP to SPOUT, Hi byte
 00B4                 542  Delay_pL:       ds 1     ; Delay period from PIP to SPOUT, Lo byte
                      543                           ;(16 bit result of Mul_Hi:Mul_Mid:Mul_Lo / $FF)
 00B5                 544  CH1_onH:        ds 1     ; T2CH1 output compare for SPOUT rising, Hi byte
 00B6                 545  CH1_onL:        ds 1     ; T2CH1 output compare for SPOUT rising, Lo byte
                      546                           ;(PIP_tsH:PIP_tsL + Delay_pH:Delay_pL)
 00B7                 547  SPOUT_tsH:      ds 1     ; SPOUT timestamp current reading Hi byte
 00B8                 548  SPOUT_tsL:      ds 1     ; SPOUT timestamp current reading Lo byte
 00B9                 549  PIP_periodH:    ds 1     ; PIP period Hi byte (for SPOUT off calcs)
 00BA                 550  PIP_periodL:    ds 1     ; PIP period Lo byte (for SPOUT off calcs)
 00BB                 551  SPOUTon_pH:     ds 1     ; SPOUT on period Hi byte
 00BC                 552  SPOUTon_pL:     ds 1     ; SPOUT on period Lo byte
                      553                           ;(50% duty cycle, half of PIP period)
 00BD                 554  CH1_offH:       ds 1     ; T2CH1 output compare for SPOUT falling, Hi byte
 00BE                 555  CH1_offL:       ds 1     ; T2CH1 output compare for SPOUT falling, Lo byte
                      556                           ;(SPOUT_tsH:SPOUT_tsL + SPOUTon_pH:SPOUTon_pL)
                      557  
                      558  
                      559  ;****************************************************************************
                      560  ; --------------- Ignition Monitor Calculation Variables --------------------
                      561  ;****************************************************************************
                      562  
 00BF                 563  MON_tsH:          ds 1     ; MON timestamp Hi byte current reading
                      564  
                      565  ; - Memory location $00C0  (decimal 192)
                      566  
 00C0                 567  MON_tsL:          ds 1     ; MON timestamp Lo byte current reading
                      568  
                      569  ;***************************************************************************
                      570  ; ---------------------------- Misc. Variables --------------------------
                      571  ;***************************************************************************
                      572  
 00C1                 573  LoopCounter:    ds 1     ; Loop counter for main loop frequency check
 00C2                 574  MinPIP:         ds 1     ; Minimum PIP signals required for period calcs
 00C3                 575  page:           ds 1     ; Page selection variable
 00C4                 576  flocker:        ds 1     ; Burner locking semaphor
                      577  
                      578  ;***********************************************************************************************
                      579  ; Burner variables
                      580  ;***********************************************************************************************
                      581  
 00C5                 582  burnSrc:        ds 2    ; Burn routine variable
 00C7                 583  burnDst:        ds 2    ; Burn routine variable
 00C9                 584  burnCount:      ds 1    ; Burn routine variable
                      585  
                      586  ;***********************************************************************************************
                      587  ; Fuel burn calculation variables
                      588  ;***********************************************************************************************
                      589  
 00CA                 590  fdcntr:         ds 1    ; Counter for AIOT trigger on
 00CB                 591  aiotcntr:       ds 1    ; Counter for AIOT trigger off
 00CC                 592  fdtH:           ds 1    ; Fuel deleivery Lo Res total Hi byte
 00CD                 593  fdtL:           ds 1    ; Fuel deleivery Lo Res total Lo byte
                      594  
                      595  ;***********************************************************************************************
                      596  ; Tachometer calculation variables
                      597  ;***********************************************************************************************
                      598  
 00CE                 599  tachcurH:       ds 1    ; Tachometer period current Hi byte
 00CF                 600  tachcurL:       ds 1    ; Tachometer period current Lo byte
                      601  
                      602  ; - Memory location $00D0 (decimal 208)
                      603  
 00D0                 604  tachTH:         ds 1    ; Tachometer period total Hi byte


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 7
MC68HC908GP32 User Bootloader


 00D1                 605  tachTM:         ds 1    ; Tachometer period total Mid byte
 00D2                 606  tachTL:         ds 1    ; Tachometer period total Lo byte
 00D3                 607  tachcnt:        ds 1    ; Tachometer counter for tachometer period averaging time
                      608  
                      609  ;***********************************************************************************************
                      610  ; "batt" average calculation variables
                      611  ;***********************************************************************************************
                      612       
 00D4                 613  battTH:         ds 1    ; Battery ADC total Hi Byte     
 00D5                 614  battTL:         ds 1    ; Battery ADC total Lo Byte     
 00D6                 615  battcnt:        ds 1    ; Counter for battery ADC averaging
                      616  
                      617  ;***********************************************************************************************
                      618  ; "ego" average calculation variables
                      619  ;***********************************************************************************************
                      620       
 00D7                 621  egoTH:          ds 1    ; EGO ADC total Hi Byte     
 00D8                 622  egoTL:          ds 1    ; EGO ADC total Lo Byte     
 00D9                 623  egocnt:         ds 1    ; Counter for EGO ADC averaging
                      624  
                      625  
                      626  ;***********************************************************************************************
                      627  ; "OP_ADC" average calculation variables
                      628  ;***********************************************************************************************
                      629  
 00DA                 630  OP_ADCTH:       ds 1 ; Engine Oil Pressure ADC total Hi Byte
 00DB                 631  OP_ADCTL:       ds 1 ; Engine Oil Pressure ADC total Lo Byte
 00DC                 632  OP_ADCcnt:      ds 1 ; Counter for Engine Oil Pressure ADC averaging
                      633  
                      634  ;***********************************************************************************************
                      635  ; "FP_ADC" average calculation variables
                      636  ;***********************************************************************************************
                      637  
 00DD                 638  FP_ADCTH:       ds 1 ; Fuel Pressure ADC total Hi Byte
 00DE                 639  FP_ADCTL:       ds 1 ; Fuel Pressure ADC total Lo Byte
 00DF                 640  FP_ADCcnt:      ds 1 ; Counter for Fuel Pressure ADC averaging
                      641  
                      642  ;***********************************************************************************************
                      643  ; "EGT_ADC" average calculation variables
                      644  ;***********************************************************************************************
                      645  
                      646  ; - Memory location $00E0 (decimal 224)
                      647  
                      648  
 00E0                 649  EGT_ADCTH:       ds 1 ; Exhaust Gas Temperature ADC total Hi Byte
 00E1                 650  EGT_ADCTL:       ds 1 ; Exhaust Gas Temperature ADC total Lo Byte
 00E2                 651  EGT_ADCcnt:      ds 1 ; Counter for Exhaust Gas Temperature ADC averaging
                      652  
                      653  ;***********************************************************************************************
                      654  ; More ADC averaging calculation variables
                      655  ;***********************************************************************************************
                      656  
 00E3                 657  mapcur:           ds 1 ; Manifold Absolute Pressure ADC Raw Reading - KPa (0 - 255)(AD0)
 00E4                 658  matcur:           ds 1 ; Manifold Air Temp ADC Raw Reading - counts (0 - 255)(AD1)
 00E5                 659  cltcur:           ds 1 ; Coolant Temperature ADC Raw Reading - counts (0 - 255)(AD2)
 00E6                 660  tpscur:           ds 1 ; Throttle Position Sensor ADC Raw Reading - counts (0 - 255)(AD3)
 00E7                 661  battcur:          ds 1 ; Battery Voltage ADC Raw Reading - counts (0 - 255)(AD4)
 00E8                 662  egocur:          ds 1 ; Exhaust Gas Oxygen ADC Raw Reading - counts (0 - 255)(AD5)
 00E9                 663  Ftrm_ADCcur:     ds 1 ; Fuel Trim ADC Raw Reading - counts (0 - 255)(AD6)
 00EA                 664  Itrm_ADCcur:     ds 1 ; Ignition Trim ADC Raw Reading - counts (0 - 255)(AD7, Mplx ch0)
 00EB                 665  OP_ADCcur:       ds 1 ; Engine Oil Pressure ADC Raw Reading - counts (0 - 255)(AD7, Mplx ch1)
 00EC                 666  FP_ADCcur:       ds 1 ; Fuel Pressure ADC Raw Reading - counts (0 - 255)(AD7, Mplx ch2)
 00ED                 667  EGT_ADCcur:      ds 1 ; Exhaust Gas Temperature ADC Raw Reading - counts (0 - 255)(AD7, Mplx ch3)
 00EE                 668  ADCcnt:          ds 1 ; ADC channel counter
                      669  
                      670  ;***********************************************************************************************
                      671  ; One more ADC Conversion Variable
                      672  ;***********************************************************************************************
                      673  
 00EF                 674  airtemp:         ds 1 ; Manifold Air Temperature in degrees F + 40
                      675  
                      676  ; - Memory location $00F0 (decimal 240)
                      677  
                      678  ms_ram_end:
                      679  
                      680  
                      681  ;***********************************************************************************************
                      682  ; - Page 1(TS page 1) VE table (table copied into RAM on demand)
                      683  ;***********************************************************************************************
                      684  
                      685  ms_rf_start:
                      686  
 00F0                 687  VE_r               rmb $90     ; 144 bytes for VE Table
                      688  
                      689  ; - Memory location $0170 (decimal 368)
                      690  
 0180                 691  RPMRANGEVE_r       rmb $0C     ; 12 VE Table RPM Bins for 2-D interpolation
 018C                 692  KPARANGEVE_r       rmb $0C     ; 12 VE Table MAP Pressure Bins for 2_D interpolation
                      693  
                      694  ; - Memory location $0188 (decimal 392)
                      695  
                      696  ms_rf_end:
                      697  
                      698  ;***********************************************************************************************
                      699  ; - Page 2(TS page 2) ST table (table copied into RAM on demand)
                      700  ;***********************************************************************************************
                      701  
 0198                 702  ST_r             equ  ms_rf_start         ; Spark timing table
 0198                 703  RPMRANGEST_r     equ {ms_rf_start + $90}  ; Spark timing RPM bins for 2-D interpolation
 0198                 704  KPARANGEST_r     equ {ms_rf_start + $9C}  ; Spark timing MAP pressure bins for 2-D interpolation
                      705  
                      706  ;***********************************************************************************************
                      707  ; - Page 3(TS page 3) AFR1 table (table copied into RAM on demand)(Used by MLV only)
                      708  ;***********************************************************************************************
                      709  
 0198                 710  AFR1_r             equ  ms_rf_start         ; AFR1 table
 0198                 711  RPMRANGEAFR1_r     equ {ms_rf_start + $90}  ; AFR1 RPM bins for 2-D interpolation
 0198                 712  KPARANGEAFR1_r     equ {ms_rf_start + $9C}  ; AFR1 MAP pressure bins for 2-D interpolation
                      713  
                      714  ;***********************************************************************************************
                      715  ; - Page 4(TS page 4) AFR2 table (table copied into RAM on demand)(Used by MLV only)
                      716  ;***********************************************************************************************
                      717  
 0198                 718  AFR2_r             equ  ms_rf_start         ; AFR2 table
 0198                 719  RPMRANGEAFR2_r     equ {ms_rf_start + $90}  ; AFR2 RPM bins for 2-D interpolation
 0198                 720  KPARANGEAFR2_r     equ {ms_rf_start + $9C}  ; AFR2 MAP pressure bins for 2-D interpolation
                      721  
                      722  ;***********************************************************************************************
                      723  ; - Page 5(TS page 5) Constants always run from Flash so no need to copy to RAM
                      724  ;***********************************************************************************************
                      725  
                      726  ;*WWURANGE         rmb $0A     ; WWU Table temperature Bins for 2_D interp.
                      727  ;*WWU              rmb $0A     ; Warmup bins(fn temp)
                      728  ;*TPSDOTRATE       rmb $04     ; TPSAQ table TPS count DOT for 2_D interp.
                      729  ;*TPSAQ            rmb $04     ; TPS accel amount (fn TPSDOT)(0.1mS res)
                      730  ;*cwu              rmb $01     ; Crank Pulse Width at -40 F)(0.1mS res)
                      731  ;*cwh              rmb $01     ; Crank Pulse Width at 170 F)(0.1mS res)
                      732  ;*awev             rmb $01     ; After-start Warmup % enrichment add-on
                      733  ;*awc              rmb $01     ; After-start number of cycles or time
                      734  ;*tpsacold         rmb $01     ; Cold accel amount (at -40F)(0.1ms res)
                      735  ;*tpsthresh        rmb $01     ; Accel TPS DOT threshold
                      736  ;*tpsasync         rmb $01     ; TPS Acceleration clock value
                      737  ;*req_fuel         rmb $01     ; Fuel Constant
                      738  ;*divider          rmb $01     ; IRQ divide factor for pulse
                      739  ;*Alternate        rmb $01     ; Alternate injector drivers
                      740  ;*InjOpen          rmb $01     ; Injector Open Time


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 8
MC68HC908GP32 User Bootloader


                      741  ;*battfac          rmb $01     ; Battery Gamma Factor
                      742  ;*floodClear       rmb $01     ; tpsADC value for flood clear
                      743  ;*acmult           rmb $01     ; Accel cold mult factor (%)
                      744  ;*pru              rmb $01     ; Primer Pulse Width at -40 F)(0.1mS res)
                      745  ;*prh              rmb $01     ; Primer Pulse Width at 170 F)(0.1mS res)
                      746  ;*PIP_Angle        rmb $01     ; PIP Angle in crank degrees(4cyl=180. 6cyl=120, 8cyl=90
                      747  ;*CT_cnt           rmb $01     ; Closed throttle position ADC count
                      748  ;*WOT_cnt          rmb $01     ; Wide Open throttle position ADC count
                      749  ;*awevh            rmb $01     ; After-start hot start % enrichment add-on
                      750  ;*awch             rmb $01     ; After-start hot number of cycles or time
                      751  ;*tpsdq            rmb $01     ; Deacceleration fuel cut
                      752  ;*ASEHtype         rmb $01     ; ASEHtype   Configuration variable for ASE Hot counter type
                      753                                 ;            0 = ignition cycles, 1 = 100 ms counter,
                      754                                 ;            2 = 250 ms counter, 3 = 500 ms counter
                      755                                 ;            4 = 1 second counter
                      756  ;*coolanton        rmb $01     ; Set point for coolant temp ASE Hot degrees F+40
                      757  ;*heton            rmb $01     ; High engine temperature alarm on set point (degF+40)
                      758  ;*hetoff           rmb $01     ; High engine temperature alarm off set point (degF+40)
                      759  ;*lopon            rmb $01     ; Low oil pressure alarm on set point (OP_adc 0-255=0-100 PSI)
                      760  ;*lopoff           rmb $01     ; Low oil pressure alarm off set point (OP_adc 0-255=0-100 PSI)
                      761  ;*hegton           rmb $01     ; High exhaust temp alarm on set point (EGT_adc 0-255=32-1328F)
                      762  ;*hegtoff          rmb $01     ; High exhaust temp alarm off set point (EGT_adc 0-255=32-1328F)
                      763  ;*lfpon            rmb $01     ; Low fuel pressure alarm on set point (FP_adc 0-255=0-100 PSI)
                      764  ;*lfpoff           rmb $01     ; Low fuel pressure alarm off set point (FP_adc 0-255=0-100 PSI)
                      765  ;*hfpon            rmb $01     ; High fuel pressure alarm on set point (FP_adc 0-255=0-100 PSI)
                      766  ;*hfpoff           rmb $01     ; High fuel pressure alarm off set point (FP_adc 0-255=0-100 PSI)
                      767  ;*revlon           rmb $01     ; Rev limiter alarm on set point (RPM20)
                      768  ;*revloff          rmb $01     ; Rev limiter alarm off set point (RPM20)
                      769  ;*runon            rmb $01     ; Run on set point for ignition (RPM20)
                      770  ;*startedon        rmb $01     ; Started on set point for fuel (RPM20)
                      771  ;*airtempon        rmb $01     ; Set point for Manifold Air Temp ASE Hot degrees F+40
                      772  ;*BnkflowH         rmb $01     ; BnkflowH        Injector bank flow rate L/hr x 10 Hi byte
                      773                                 ;                 configuration variable
                      774  ;*BnkflowL         rmb $01     ; BnkflowL        Injector bank flow rate L/hr x 10 Lo byte
                      775                                 ;                 configuration variable
                      776  ;*ASEtype          rmb $01     ; ASEtype         Configuration variable for ASE counter type
                      777                                 ;                 0 = ignition cycles, 1 = 100 ms counter,
                      778                                 ;                 2 = 250 ms counter, 3 = 500 ms counter
                      779                                 ;                 4 = 1 second counter
                      780  
                      781  ;***********************************************************************************************
                      782  ; - RAM copy equates
                      783  ;***********************************************************************************************
                      784  
 0198                 785  ms_ram_size        equ {ms_ram_end-ms_ram_start}
 0198                 786  ms_rf_size         equ {ms_rf_end-ms_rf_start}
 0198                 787  ms_total_ram_size  equ {ms_rf_end-ms_ram_start}
                      788  
                      789                                            ; MSnS351WM.asm
                      790  
                      791  
                      792  ;***********************************************************************************************
                      793  ;
                      794  ; Main Routine Here - Initialization and main loop
                      795  ;
                      796  ; Note: Org down 128 bytes below the "rom_start" point because of erase bug in bootloader
                      797  ;       routine. Only B&G HiRes and Megasquirtnspark use the 256 offset, all others use 128???
                      798  ;
                      799  ;***********************************************************************************************
                      800  
 8128                 801       org     {rom_start + 128}     ; Origin at memory location $8000 + $80 = $8080
                      802                                    ; (32768 + 128 = 32896)
                      803  Start:
 8128 [03] 4501ED     804       ldhx    #init_stack+1    ; Load index register with value in init_stack+1
                      805                               ;(Set the stack Pointer)($01ED + 1 = $01EE = 494
 812B [02] 94         806       txs                    ; Transfer value in index register Lo byte to stack
                      807                               ;(Move before burner to avoid conflict)
                      808  
                      809  
                      810  ;***********************************************************************************************
                      811  ; - Set the phase lock loop for a bus frequency of 8.003584mhz
                      812  ;  (Boot loader initially sets it at 7.3728mhz)
                      813  ;***********************************************************************************************
                      814  
                      815  ;PllSet:
 812C [04] 1936       816       bclr    BCS,pctl                ; Select external Clock Reference
 812E [04] 1B36       817       bclr    PLLON,pctl              ; Turn Of PLL
 8130 [04] 6E0236     818       mov     #$02,pctl               ; Set P and E Bits
 8133 [04] 6ED03A     819       mov     #$D0,pmrs               ; Set L ($C0 for 7.37 MHz)
 8136 [04] 6E0338     820       mov     #$03,pmsh               ; Set N (MSB)
 8139 [04] 6ED139     821       mov     #$D1,pmsl               ; Set N (LSB) ($84 for 7.37 MHz)
 813C [04] 1E37       822       bset    AUTO,pbwc         ; Enable automatic bandwidth control
 813E [04] 1A36       823       bset    PLLON,pctl              ; Turn back on PLL
                      824  
                      825  PLL_wait:
 8140 [05] 0D37FD     826       brclr   LOCK,pbwc,PLL_wait  ; Wait for PLL to lock
 8143 [04] 1836       827       bset    BCS,pctl            ; Select VCO as base clock
                      828  
                      829  ;***********************************************************************************************
                      830  ; - Set up the port data-direction registers, Set directions
                      831  ;   Preset state of pins to become outputs
                      832  ;***********************************************************************************************
                      833  
                      834  ; Port A
 8145 [04] 6EFF0D     835       mov     #$FF,PTAPUE     ; Move %11111111 to Port A pullup enable reg Set all pullups to
                      836                               ; (connect unused pins to VDD, output direction clears pullup)
 8148 [04] 6E0200     837       mov     #$02,PORTA      ; Move %00000010 to Port A Data Regisister (preinit) Loopchk Lo,
                      838                               ; Spark Hi, fuelp Lo,(SPOUT Lo, fuel pump off)
 814B [04] 6EC304     839       mov     #$C3,DDRA       ; Move %11000011 to Port A Data Direction Register
                      840                               ; Inputs on PTA5,4,3,2, = NA,NA,Ftrm en,Ign_Mon,Knk_Det,Itrm en
                      841                               ; Outputs on PTA7,6,1,0 = MVa,MVb,Spout,Fuel Pump
                      842  
                      843  ; Port B
 814E [03] 3F05       844       clr     DDRB            ; Clear Port B Data Direction Register (Set as inputs,
                      845                               ; "ADSEL" will select channel)
                      846  
                      847  ; Port C
 8150 [04] 6EFF0E     848       mov     #$FF,PTCPUE     ; Move %11111111 to Port C pullup enable reg (Set all pullups to
                      849                               ; connect unused pins to VDD, output direction clears pullup)
 8153 [03] 3F02       850       clr          PORTC      ; Move %00000000 to Port C Data Register(Preinit all low)
 8155 [04] 6E0706     851       mov     #$07,DDRC       ; Move %00000111 to Port C Data Direction Register,
                      852                               ; Inputs on PTC7,6,5,4,3 = NA,NA,NA,NA,NA
                      853                               ; Outputs on PTC2,1,0 = spare(loop chk),Eng Alarm,AIOT
                      854  
                      855  ; Port D
 8158 [04] 6EFF0F     856       mov     #$FF,PTDPUE     ; Move %11111111 to Port C pullup enable reg (Set all pullups to
                      857                               ; connect unused pins to VDD, output direction clears pullup)
 815B [04] 6E3003     858       mov     #$30,PORTD      ; Move %00110000 to Port D Data Direction Register (preinit output
                      859                               ; pins 5,4 Hi)(Turn off injectors (inverted output)
 815E [04] 6EF007     860       mov     #$F0,DDRD       ; Move %11110000 to Port D Data Direction Register (Injectors on
                      861                               ; PTD4,5)(PTD6,7 not available, set as outputs)
                      862  
                      863  ; Port E
 8161 [03] 3F08       864       clr     PORTE         ; Clear Port E Data Register (to avoid glitches)
 8163 [04] 6E010C     865       mov     #$01,DDRE     ; Move %00000001 to Port E Data Direction Register(Serial Comm Port)
                      866  
                      867  
                      868  ;***********************************************************************************************
                      869  ; - Set up TIM2 as a free running ~1us counter. Set Channel 0 output compare
                      870  ;   to generate the ~100us(.1ms) clock tick. Interupt vector "TIM2CH0_ISR:"
                      871  ;   Set Channel 1 output compare for SPOUT control.
                      872  ;   Interupt vector "TIM2CH1_ISR:"
                      873  ; - NOTE! The channels on this timer are not connected to any pins so pin
                      874  ;   state is irrelevant.
                      875  ;***********************************************************************************************
                      876  


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 9
MC68HC908GP32 User Bootloader


 8166 [04] 6E332B     877       mov     #$33,T2SC       ; Move %00110011 into Timer2 Status and Control Register
                      878                               ;(Disable interupts, stop timer)(Prescale and counter cleared))
                      879                               ;(Prescale for bus frequency / 8)
 8169 [04] 6EFF2E     880       mov     #$FF,T2MODH     ; Move dec 255 into T2 modulo register Hi
 816C [04] 6EFF2F     881       mov     #$FF,T2MODL     ; Move dec 255 into T2 modulo register Lo(free running timer)
 816F [03] 3F31       882       clr     T2CH0H          ; Clear T2CH0 O/C register Hi byte
 8171 [04] 6E6432     883       mov     #$64,T2CH0L     ; Move decimal 100 into T2CH0 O/C register Lo byte(~100uS)
 8174 [04] 6E5430     884       mov     #$54,T2SC0      ; Move %01010100 into T2CH0 Status and Control Register.
                      885                               ;(Output compare, interrupt enabled)
 8177 [03] 3F34       886       clr     T2CH1H          ; Clear T2CH1 O/C register Hi byte
 8179 [03] 3F35       887       clr     T2CH1L          ; Clear T2CH1 O/C register Lo byte
 817B [04] 6E1433     888       mov     #$14,T2SC1      ; Move %00010100 into T2CH1 Status and Control Register.
                      889                               ; (Output compare, interrupt disabled)
 817E [04] 6E132B     890       mov     #$13,T2SC       ; Move %00010011 into Timer2 Status and Control Register.
                      891                               ; (Disable interupts, reset counter, counter Active,
                      892                               ; Prescale for bus frequency /8. 8,003,584hz/8=1,000,448hz
                      893                               ; = .0000009995sec
                      894  
                      895  
                      896  ;***********************************************************************************************
                      897  ; Set up TIM1 as a free running ~1us counter. Set channels 0 and 1 for output
                      898  ; compare, pulsewidth control of injectors. INJ1 on T1SC0 and INJ2 on T1SC1
                      899  ; Initialize output pins logic state 1 (injectors off)
                      900  ;***********************************************************************************************
                      901  
 8181 [04] 6E3320     902       mov     #$33,T1SC       ; Move %00110011 into Timer1 Status and Control Register
                      903                               ;(Disable interupts, stop timer)(Prescale and counter cleared))
                      904                               ;(Prescale for bus frequency / 8)
 8184 [04] 6EFF23     905       mov     #$FF,T1MODH     ; Move decimal 255 into T1 modulo reg Hi
 8187 [04] 6EFF24     906       mov     #$FF,T1MODL     ; Move decimal 255 into T1 modulo reg Lo
 818A [04] 6E0025     907       mov     #$00,T1SC0      ; Move %00000000 into Timer1 Channel 0 Status and Control Register
                      908                               ;(Normal port output initialized logic 1)(injector off)
 818D [04] 6E0028     909       mov     #$00,T1SC1      ; Move %00000000 into Timer1 Channel 1 Status and Control Register
                      910                               ;(Normal port output initialized logic 1)(injector off)
 8190 [04] 6E0026     911       mov     #$00,T1CH0H     ; Move decimal 0 to T1CH0 register Hi
 8193 [04] 6E0127     912       mov     #$01,T1CH0L     ; Move decimal 1 to T1CH0 register Lo
 8196 [04] 6E0029     913       mov     #$00,T1CH1H     ; Move decimal 0 to T1CH0 register Hi
 8199 [04] 6E012A     914       mov     #$01,T1CH1L     ; Move decimal 1 to T1CH0 register Lo
                      915  
                      916  
                      917  ;***********************************************************************************************
                      918  ; - Set up Serial Communications Interface Module
                      919  ;***********************************************************************************************
                      920  
 819C [04] 6E3019     921       mov     #$30,SCBR       ; Move %0110000 into SCI Baud Rate Register
                      922                               ; (8003584/(64*13*1)=9619.7 baud)
 819F [04] 1C13       923       bset     ENSCI,SCC1     ; Set enable SCI bit of SCI Control Register 1(Enable SCI)
 81A1 [04] 1414       924       bset     RE,SCC2        ; Set receiver enable bit of SCI Control Reg 2(Enable receiver)
 81A3 [04] 1A14       925       bset     SCRIE,SCC2     ; Set SCI receive interrupt enable bit of SCI Control Reg 2
                      926                               ;(Enable Rcv. Interrupt)
 81A5 [03] B616       927       lda      SCS1           ; Load accumulator with SCI Status Register 1
                      928                               ;(Clear SCI transmitter Empty Bit)
 81A7 [03] 3F85       929       clr      TXCNT          ; Clear SCI transmitter count(incremented)(characters transmitted)
 81A9 [03] 3F86       930       clr      TXGOAL         ; Clear SCI number of bytes to transmit
                      931                               ;(characters to be transmitted)
                      932  
                      933  
                      934  ;***********************************************************************************************
                      935  ; - Set up IRQ Interrupt (Rising edge of PIP on Pin 24, hardware inverted)
                      936  ;***********************************************************************************************
                      937  
 81AB [04] 6E041D     938       mov     #$04,INTSCR     ; Move %00000100 into IRQ Status and Control Register
                      939                               ; (Enable IRQ (turn on interrupts))(falling edge only)
                      940  
                      941  
                      942  ;***********************************************************************************************
                      943  ; - Set up Keyboard Interrupt, Ign Mon on PTA4
                      944  ;***********************************************************************************************
                      945  
 81AE [04] 6E021A     946       mov     #$02,INTKBSCR       ; Move %00000010 into Keyboard Status and Control Register
                      947                                   ;(Keyboard interrupts masked)(interrupts on falling edges only)
 81B1 [04] 6E101B     948       mov     #$10,INTKBIER       ; Move %0010000 into Keyboard Interrupt Enable Register
                      949                                   ;(Keyboard interrupts on PTA4)
 81B4 [04] 141A       950       bset    ackk,INTKBSCR       ; Set the Keyboard Acknowledge bit of Keyboard Status and
                      951                                   ; Control Register(clear any false interrupts)
 81B6 [04] 166B       952       bset    MONen,inputs        ; Set "MONen" bit of "inputs" variable
 81B8 [04] 131A       953       bclr    imaskk,INTKBSCR     ; Clear the Interrupt Mask bit of Keyboard Status and Control
                      954                                   ; Register(enable interrupts)
                      955  
                      956  ;***********************************************************************************************
                      957  ;   Set all RAM to known value - for code runaway protection.
                      958  ;   If there is ever a code runaway, and processor tries executing this as an opcode ($32)
                      959  ;   then a reset will occur.
                      960  ;***********************************************************************************************
                      961  
 81BA [03] 450040     962       ldhx   #ram_start      ;Point to start of RAM $0040(64)
                      963  
                      964  ClearRAM:
 81BD [02] A632       965       lda     #$32             ; This is an illegal op-code - cause reset if executed
 81BF [02] F7         966       sta    ,x              ;Set RAM location
 81C0 [02] AF01       967       aix    #1              ;advance pointer
 81C2 [03] 650240     968       cphx   #ram_last+1     ;$23F + 1 = $240(576)  done ?
 81C5 [03] 26F6       969       bne    ClearRAM        ;loop back if not
                      970  
                      971  ;***********************************************************************************************
                      972  ; - Clear all variables
                      973  ;***********************************************************************************************
                      974  
 81C7 [03] 3F40       975       clr     secl         ; low seconds - from 0 to 255, then rollover
 81C9 [03] 3F41       976       clr     map          ; Manifold Absolute Pressure ADC Raw Reading - KPa (0 - 255)(AD0)
 81CB [03] 3F42       977       clr     mat          ; Manifold Air Temp ADC Raw Reading - counts (0 - 255)(AD1)
 81CD [03] 3F43       978       clr     clt          ; Coolant Temperature ADC Raw Reading - counts (0 - 255)(AD2)
 81CF [03] 3F44       979       clr     tps          ; Throttle Position Sensor ADC Raw Reading - counts (0 - 255)(AD3)
 81D1 [03] 3F45       980       clr     batt         ; Battery Voltage ADC Av Reading - counts (0 - 255)(AD4)
 81D3 [03] 3F46       981       clr     ego          ; Exhaust Gas Oxygen ADC Av Reading - counts (0 - 255)(AD5)
 81D5 [03] 3F47       982       clr     Ftrm_ADC     ; Fuel Trim ADC Raw Reading - counts (0 - 255)(AD6)
 81D7 [03] 3F48       983       clr     Itrm_ADC     ; Ignition Trim ADC Raw Reading - counts (0 - 255)(AD7, Mplx ch0)
 81D9 [03] 3F49       984       clr     OP_ADC       ; Engine Oil Pressure ADC Av Reading - counts (0 - 255)(AD7, Mplx ch1)
 81DB [03] 3F4A       985       clr     FP_ADC       ; Fuel Pressure ADC Av Reading - counts (0 - 255)(AD7, Mplx ch2)
 81DD [03] 3F4B       986       clr     EGT_ADC      ; Exhaust Gas Temperature ADC Av Reading - counts (0 - 255)(AD7, Mplx ch3)
 81DF [03] 3F4C       987       clr     barometer    ; Current barometer reading in KPA (for MV)
 81E1 [03] 3F4D       988       clr     barocor      ; Barometer Lookup Correction - percent
 81E3 [03] 3F4E       989       clr     warmcor      ; Total Warmup Correction - percent
 81E5 [03] 3F4F       990       clr     aircor       ; Air Density Correction lookup - percent
 81E7 [03] 3F50       991       clr     Ftrimcor     ; Fuel Trim Correction Factor (85% - 115%)
 81E9 [03] 3F51       992       clr     gammae       ; Total Gamma Enrichments - percent
 81EB [03] 3F52       993       clr     tpsaccel     ; Acceleration enrichment - percent
 81ED [03] 3F53       994       clr     rpm20        ; Computed engine RPM - rpm/20
 81EF [03] 3F54       995       clr     vecurr       ; Current VE value from lookup table - percent
 81F1 [03] 3F55       996       clr     pwcalcH      ; high order of calculated pulsewith (16 bits)
 81F3 [03] 3F56       997       clr     pwcalcL      ; low order of calculated pulsewidth (16 bits)
 81F5 [03] 3F57       998       clr     pw           ; injector squirt time in 1/10 millesec (0 to 25.5 millisec) - applied
 81F7 [03] 3F58       999       clr     fd           ; Fuel Delivery PW Lo Res
 81F9 [03] 3F59      1000       clr     fdSecH       ; Fuel Delivery PW Lo Res over 1 second Hi byte
 81FB [03] 3F5A      1001       clr     fdSecL       ; Fuel Delivery PW Lo Res over 1 second Lo byte
 81FD [03] 3F5B      1002       clr     tachH        ; Tachometer period averaged over 16 periods Hi byte
 81FF [03] 3F5C      1003       clr     tachL        ; Tachometer period averaged over 16 periods Lo byte
 8201 [03] 3F5D      1004       clr     Spk_Ang_Fac  ; Spark Angle Factor (from ST table)
 8203 [03] 3F5E      1005       clr     Trm_Ang_Fac  ; Trim Angle Factor (from IgnTrimcor table)
 8205 [03] 3F5F      1006       clr     Dly_Ang_Fac  ; Delay Angle Factor (Spk_Ang_Fac + Trm_Ang_Fac)
 8207 [03] 3F60      1007       clr     MON_pH       ; MON period Hi byte (MON_tsH - PIP_tsH)
 8209 [03] 3F61      1008       clr     MON_pL       ; MON period Lo byte (MON_tsL - PIP_tsL)
 820B [03] 3F62      1009       clr     tpsp         ; Throttle position percent
 820D [03] 3F63      1010       clr     engine       ; Variable bit-field to hold engine current status
 820F [03] 3F64      1011       clr     alarmbits    ; Engine Alarm Status Bit Field
 8211 [03] 3F65      1012       clr     portAbits    ; Port A status Bit field


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 10
MC68HC908GP32 User Bootloader


 8213 [03] 3F66      1013       clr     portCbits    ; Port C Status Bit Field
 8215 [03] 3F69      1014       clr     engine2      ; Variable bit-field to hold engine current status #2
 8217 [03] 3F6A      1015       clr     squirt       ; Event variable bit field for Injector Firing
 8219 [03] 3F6B      1016       clr     inputs       ; Bit field variable for input status flags
 821B [03] 3F6C      1017       clr     kpa          ; MAP value in units of KPa
 821D [03] 3F6D      1018       clr     coolant      ; Coolant temperature in Degrees F plus 40 (allows -40 degress to fit in int)
 821F [03] 3F6E      1019       clr     adsel        ; ADC Selector Variable
 8221 [03] 3F6F      1020       clr     adsel2       ; ADC Selector Variable 2
 8223 [03] 3F70      1021       clr     pwnadH       ; Calculated PW without Accel and deadband Hi byte
 8225 [03] 3F71      1022       clr     pwnadL       ; Calculated PW without Accel and deadband Lo byte
 8227 [03] 3F72      1023       clr     fdhrH        ; Calc PW without deadband Hi byte (fuel delivery)
 8229 [03] 3F73      1024       clr     fdhrL        ; Calc PW without deadband Lo byte (fuel delivery)
 822B [03] 3F74      1025       clr     deadband     ; Injector deadband in 100uS resolution
 822D [03] 3F75      1026       clr     rpmph        ; High part of RPM Period
 822F [03] 3F76      1027       clr     rpmpl        ; Low part of RPM Period
 8231 [03] 3F77      1028       clr     rpmch        ; Counter for high part of RPM
 8233 [03] 3F78      1029       clr     rpmcl        ; Counter for low part of RPM
 8235 [03] 3F79      1030       clr     mSx250       ; 250 Milliseconds counter
 8237 [03] 3F7A      1031       clr     mSx100       ; 100 Milliseconds counter
 8239 [03] 3F7B      1032       clr     mS           ; Milliseconds counter
 823B [03] 3F7C      1033       clr     uSx100       ; 100 Microseconds counter
 823D [03] 3F7D      1034       clr     sech         ; high seconds - rollover at 65536 secs (1110.933 minutes, 18.51 hours)
 823F [03] 3F7E      1035       clr     tpsaclk      ; TPS enrichment timer clock in 0.1 second resolution
 8241 [03] 3F7F      1036       clr     asecount     ; Counter value for after-start enrichment counter - every ignition pulse
 8243 [03] 3F80      1037       clr     last_tps     ; TPS reading updated every 0.1 seconds
 8245 [03] 3F81      1038       clr     igncount     ; Ignition pulse counter
 8247 [03] 3F82      1039       clr     altcount     ; Alternate count selector
 8249 [03] 3F83      1040       clr     tpsaclkcmp   ; Comparison value for TPS acceleration time - from lookup table
 824B [03] 3F84      1041       clr     tpsfuelcut   ; TPS Fuel Cut (percent)
 824D [03] 3F85      1042       clr     txcnt        ; SCI transmitter count (incremented)
 824F [03] 3F86      1043       clr     txgoal       ; SCI number of bytes to transmit
 8251 [03] 3F87      1044       clr     txmode       ; Transmit mode flag
 8253 [03] 3F88      1045       clr     rxoffset     ; offset placeholder when receiving VE/constants vis. SCI
 8255 [03] 3F89      1046       clr     INTACC1
 8257 [03] 3F8D      1047       clr     INTACC2
 8259 [03] 3F91      1048       clr     tmp1
 825B [03] 3F92      1049       clr     tmp2
 825D [03] 3F93      1050       clr     tmp3
 825F [03] 3F94      1051       clr     tmp4
 8261 [03] 3F95      1052       clr     tmp5
 8263 [03] 3F96      1053       clr     tmp6
 8265 [03] 3F97      1054       clr     tmp7
 8267 [03] 3F98      1055       clr     tmp8
 8269 [03] 3F99      1056       clr     tmp9
 826B [03] 3F9A      1057       clr     tmp10
 826D [03] 3F9B      1058       clr     tmp11
 826F [03] 3F9C      1059       clr     tmp12
 8271 [03] 3F9D      1060       clr     tmp13
 8273 [03] 3F9E      1061       clr     tmp14
 8275 [03] 3F9F      1062       clr     tmp15
 8277 [03] 3FA0      1063       clr     tmp16
 8279 [03] 3FA1      1064       clr     tmp17
 827B [03] 3FA2      1065       clr     tmp18
 827D [03] 3FA3      1066       clr     tmp19
 827F [03] 3FA4      1067       clr     tmp20
 8281 [03] 3FA5      1068       clr     tmp21
 8283 [03] 3FA6      1069       clr     tmp22
 8285 [03] 3FA7      1070       clr     PIP_tsH         ; PIP timestamp current reading Hi byte
 8287 [03] 3FA8      1071       clr     PIP_tsL         ; PIP timestamp current reading Lo byte
 8289 [03] 3FA9      1072       clr     PIP_tsH_prv     ; PIP timestamp previous reading Hi byte
 828B [03] 3FAA      1073       clr     PIP_tsL_prv     ; PIP timestamp previous reading Lo byte
 828D [03] 3FAB      1074       clr     PIP_pH_prv      ; PIP period Hi byte previous
 828F [03] 3FAC      1075       clr     PIP_pL_prv      ; PIP period Lo byte previous
 8291 [03] 3FAD      1076       clr     PIP_pH_dif      ; PIP period difference Hi byte
                     1077                               ;(PIP_pH - PIP_pH_prv)
 8293 [03] 3FAE      1078       clr     PIP_pL_dif      ; PIP period difference Lo byte
                     1079                               ;(PIP_pL - PIP_pL_prv)
 8295 [03] 3FAF      1080       clr     PIP_pH          ; PIP period Hi byte (PIP_tsH - PIP_tsH_prv)
 8297 [03] 3FB0      1081       clr     PIP_pL          ; PIP period Lo byte (PIP_tsL - PIP_tsL_prv)
 8299 [03] 3FB1      1082       clr     PIP_pH_pred     ; Predicted PIP period Hi byte(PIP_pH + PIP_pH_dif)
 829B [03] 3FB2      1083       clr     PIP_pL_pred     ; Predicted PIP period Lo byte(PIP_pL + PIP_pL_dif)
 829D [03] 3FB3      1084       clr     Delay_pH        ; Delay period from PIP to SPOUT, Hi byte
 829F [03] 3FB4      1085       clr     Delay_pL        ; Delay period from PIP to SPOUT, Lo byte
                     1086                               ;(16 bit result of Mul_Hi:Mul_Mid:Mul_Lo / $FF)
 82A1 [03] 3FB5      1087       clr     CH1_onH         ; T2CH1 output compare for SPOUT rising, Hi byte
 82A3 [03] 3FB6      1088       clr     CH1_onL         ; T2CH1 output compare for SPOUT rising, Lo byte
                     1089                               ;(PIP_tsH:PIP_tsL + Delay_pH:Delay_pL)
 82A5 [03] 3FB7      1090       clr     SPOUT_tsH       ; SPOUT timestamp current reading Hi byte
 82A7 [03] 3FB8      1091       clr     SPOUT_tsL       ; SPOUT timestamp current reading Lo byte
 82A9 [03] 3FB9      1092       clr     PIP_periodH     ; PIP period Hi byte (for SPOUT off calcs)
 82AB [03] 3FBA      1093       clr     PIP_periodL     ; PIP period Lo byte (for SPOUT off calcs)
 82AD [03] 3FBB      1094       clr     SPOUTon_pH      ; SPOUT on period Hi byte
 82AF [03] 3FBC      1095       clr     SPOUTon_pL      ; SPOUT on period Lo byte
                     1096                               ;(50% duty cycle, half of PIP period)
 82B1 [03] 3FBD      1097       clr     CH1_offH        ; T2CH1 output compare for SPOUT falling, Hi byte
 82B3 [03] 3FBE      1098       clr     CH1_offL        ; T2CH1 output compare for SPOUT falling, Lo byte
                     1099                               ;(SPOUT_tsH:SPOUT_tsL + SPOUTon_pH:SPOUTon_pL)
 82B5 [03] 3FBF      1100       clr     MON_tsH         ; MON timestamp Hi byte current reading
 82B7 [03] 3FC0      1101       clr     MON_tsL         ; MON timestamp Lo byte current reading
 82B9 [03] 3FC1      1102       clr     LoopCounter     ; Loop counter for main loop frequency check
 82BB [03] 3FC2      1103       clr     MinPIP          ; Minimum PIP signals required for period calcs
 82BD [03] 3FC3      1104       clr     page            ; Page selection variable
 82BF [03] 3FC4      1105       clr     flocker         ; Burner locking semaphor
 82C1 [03] 3FC5      1106       clr     burnSrc         ; Burn routine variable
 82C3 [03] 3FC7      1107       clr     burnDst         ; Burn routine variable
 82C5 [03] 3FC9      1108       clr     burnCount       ; Burn routine variable
 82C7 [03] 3FCA      1109       clr     fdcntr          ; Counter for AIOT trigger on
 82C9 [03] 3FCB      1110       clr     aiotcntr        ; Counter for AIOT trigger off
 82CB [03] 3FCC      1111       clr     fdtH            ; Fuel deleivery Lo Res total Hi byte
 82CD [03] 3FCD      1112       clr     fdtL            ; Fuel deleivery Lo Res total Lo byte
 82CF [03] 3FCE      1113       clr     tachcurH        ; Tachometer period current Hi byte
 82D1 [03] 3FCF      1114       clr     tachcurL        ; Tachometer period current Lo byte
 82D3 [03] 3FD0      1115       clr     tachTH          ; Tachometer period total Hi byte
 82D5 [03] 3FD1      1116       clr     tachTM          ; Tachometer period total Mid byte
 82D7 [03] 3FD2      1117       clr     tachTL          ; Tachometer period total Lo byte
 82D9 [03] 3F67      1118       clr     BnkflowHmv      ; Injector bank flow rate L/hr x 10 Hi byte for MV
 82DB [03] 3F68      1119       clr     BnkflowLmv      ; Injector bank flow rate L/hr x 10 Lo byte for MV
 82DD [03] 3FD3      1120       clr     tachcnt         ; Tachometer counter for tachometer period averaging time
 82DF [03] 3FD4      1121       clr     battTH          ; Battery ADC total Hi Byte
 82E1 [03] 3FD5      1122       clr     battTL          ; Battery ADC total Lo Byte
 82E3 [03] 3FD6      1123       clr     battcnt         ; Counter for battery ADC averaging
 82E5 [03] 3FD7      1124       clr     egoTH           ; EGO ADC total Hi Byte
 82E7 [03] 3FD8      1125       clr     egoTL           ; EGO ADC total Lo Byte
 82E9 [03] 3FD9      1126       clr     egocnt          ; Counter for EGO ADC averaging
 82EB [03] 3FDA      1127       clr     OP_ADCTH        ; Engine Oil Pressure ADC total Hi Byte
 82ED [03] 3FDB      1128       clr     OP_ADCTL        ; Engine Oil Pressure ADC total Lo Byte
 82EF [03] 3FDC      1129       clr     OP_ADCcnt       ; Counter for Engine Oil Pressure ADC averaging
 82F1 [03] 3FDD      1130       clr     FP_ADCTH        ; Fuel Pressure ADC total Hi Byte
 82F3 [03] 3FDE      1131       clr     FP_ADCTL        ; Fuel Pressure ADC total Lo Byte
 82F5 [03] 3FDF      1132       clr     FP_ADCcnt       ; Counter for Fuel Pressure ADC averaging
 82F7 [03] 3FE0      1133       clr     EGT_ADCTH       ; Exhaust Gas Temperature ADC total Hi Byte
 82F9 [03] 3FE1      1134       clr     EGT_ADCTL       ; Exhaust Gas Temperature ADC total Lo Byte
 82FB [03] 3FE2      1135       clr     EGT_ADCcnt      ; Counter for Exhaust Gas Temperature ADC averaging
 82FD [03] 3FE3      1136       clr     mapcur          ; Manifold Absolute Pressure ADC Raw Reading - KPa (0 - 255)(AD0)
 82FF [03] 3FE4      1137       clr     matcur          ; Manifold Air Temp ADC Raw Reading - counts (0 - 255)(AD1)
 8301 [03] 3FE5      1138       clr     cltcur          ; Coolant Temperature ADC Raw Reading - counts (0 - 255)(AD2)
 8303 [03] 3FE6      1139       clr     tpscur          ; Throttle Position Sensor ADC Raw Reading - counts (0 - 255)(AD3)
 8305 [03] 3FE7      1140       clr     battcur         ; Battery Voltage ADC Raw Reading - counts (0 - 255)(AD4)
 8307 [03] 3FE8      1141       clr     egocur          ; Exhaust Gas Oxygen ADC Raw Reading - counts (0 - 255)(AD5)
 8309 [03] 3FE9      1142       clr     Ftrm_ADCcur     ; Fuel Trim ADC Raw Reading - counts (0 - 255)(AD6)
 830B [03] 3FEA      1143       clr     Itrm_ADCcur     ; Ignition Trim ADC Raw Reading - counts (0 - 255)(AD7, Mplx ch0)
 830D [03] 3FEB      1144       clr     OP_ADCcur       ; Engine Oil Pressure ADC Raw Reading - counts (0 - 255)(AD7, Mplx ch1)
 830F [03] 3FEC      1145       clr     FP_ADCcur       ; Fuel Pressure ADC Raw Reading - counts (0 - 255)(AD7, Mplx ch2)
 8311 [03] 3FED      1146       clr     EGT_ADCcur      ; Exhaust Gas Temperature ADC Raw Reading - counts (0 - 255)(AD7, Mplx ch3)
 8313 [03] 3FEE      1147       clr     ADCcnt          ; ADC channel counter
 8315 [03] 3FEF      1148       clr     airtemp         ; Manifold Air Temperature in degrees F + 40


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 11
MC68HC908GP32 User Bootloader


                     1149  
                     1150  ;***********************************************************************************************
                     1151  ; - Initialize critical variables to some other acceptable starting value
                     1152  ;***********************************************************************************************
                     1153  
 8317 [02] A603      1154       lda     #$03        ; Decimal 3
 8319 [03] B7C2      1155       sta     MinPip
                     1156  
 831B [02] A632      1157       lda     #$32        ; Decimal 50
 831D [03] B7E6      1158       sta     tpscur
                     1159  
 831F [02] A664      1160       lda     #$64        ; Decimal 100
 8321 [03] B7E3      1161       sta     mapcur
 8323 [03] B74F      1162       sta     aircor
 8325 [03] B754      1163       sta     vecurr
 8327 [03] B74D      1164       sta     barocor
 8329 [03] B74E      1165       sta     warmcor
 832B [03] B750      1166       sta     Ftrimcor
                     1167  
 832D [02] A670      1168       lda     #$70        ; Decimal 112
 832F [03] B7E7      1169       sta     battcur
                     1170  
 8331 [02] A673      1171       lda     #$73        ; Decimal 115
 8333 [03] B7E4      1172       sta     matcur
 8335 [03] B7E5      1173       sta     cltcur
                     1174  
 8337 [02] A680      1175       lda     #$80        ; Decimal 128
 8339 [03] B7E9      1176       sta     Ftrm_ADCcur
 833B [03] B7EA      1177       sta     Itrm_ADCcur
                     1178  
 833D [02] A682      1179       lda     #$82        ; Decimal 130
 833F [03] B7EB      1180       sta     OP_ADCcur
 8341 [03] B7EC      1181       sta     FP_ADCcur
                     1182  
 8343 [02] A6FF      1183       lda     #$FF
 8345 [03] B780      1184       sta     last_tps
 8347 [03] B7AB      1185       sta     PIP_pH_prv     ; 305 RPM 6 cyl, 229 RPM 8 cyl
 8349 [03] B7AC      1186       sta     PIP_pL_prv     ; 305 RPM 6 cyl, 229 RPM 8 cyl
 834B [03] B75B      1187       sta     tachH          ; 305 RPM 6 cyl, 229 RPM 8 cyl
 834D [03] B75C      1188       sta     tachL          ; 305 RPM 6 cyl, 229 RPM 8 cyl
                     1189  
                     1190  ;*********************************************************************************************
                     1191  ; Copy injector bank flow rate configurable constants from Flash memory to RAM for use by
                     1192  ; Megaview in fuel burn calculations.
                     1193  ;*********************************************************************************************
                     1194  
 834F [04] C6E443    1195       lda     BnkflowH     ; Load accumulator with value in "BnkflowH"
 8352 [03] B767      1196       sta     BnkflowHmv   ; Copy to "BnkflowHmv"
 8354 [04] C6E444    1197       lda     BnkflowL     ; Load accumulator with value in "BnkflowL"
 8357 [03] B768      1198       sta     BnkflowLmv   ; Copy to "BnkflowLmv"
                     1199  
                     1200  ;***********************************************************************************************
                     1201  ; - Fire up the ADC, and perform one conversion, Set up clock source for ADC
                     1202  ;   Do an initial conversion for barometric pressure and barometric pressure correction
                     1203  ;***********************************************************************************************
                     1204  
                     1205  ;GetBaro:
 8359 [02] A670      1206       lda     #%01110000     ; Load accumulator with %01110000
 835B [03] B73E      1207       sta     ADCLK          ; Copy to ADC Clock Register( bus clock/8 = ~1mhz )
 835D [02] A600      1208       lda     #%00000000          ; Load accumulator with %0000000(one conversion, no interrupt on
                     1209                              ; channel AD0)
 835F [03] B73C      1210       sta     ADSCR          ; Copy to ADC Status and Control Register
                     1211  
                     1212  ADCWait:
 8361 [05] 0F3CFD    1213       brclr   coco,ADSCR,ADCWait     ; If "conversions complete flag" bit of ADC Status and
                     1214                                      ; Control Register is clear, branch to ADCWait:
                     1215                                      ;(keep looping while COnversion COmplete flag = 0)
 8364 [01] 8C        1216       clrh                           ; Clear index register Hi Byte
 8365 [03] B63D      1217       lda     ADR                    ; Load accumulator with value in ADC Result Variable
 8367 [01] 97        1218       tax                            ; Copy to index register Lo byte
 8368 [04] D6F100    1219       lda     KPAFACTOR4250rjh,x     ; Load accumulator with value in KPAFACTOR4250rjh table
                     1220                                      ; offset in index register Lo byte
 836B [03] B74C      1221       sta     barometer              ; Copy to Barometric Pressure  in Kilopascals
 836D [04] D6F000    1222       lda     BAROFAC4250rjh,x       ; Load accumulator with value in BAROFAC4250rjh  table
                     1223                                      ; offset in index register Lo byte
 8370 [03] B74D      1224       sta     barocor                ; Copy to Barometric Pressure correction factor
                     1225  
                     1226  
                     1227  
                     1228  ;***********************************************************************************************
                     1229  ;  Do the ADC conversion again for Coolant Temperature ADC, then determine the
                     1230  ;  actual temperature from the Thermfac table
                     1231  ;***********************************************************************************************
                     1232  
 8372 [02] A602      1233       lda     #%00000010          ; Load accumulator with %00000010
                     1234                              ;(one conversion, no interrupt on channel AD2)
 8374 [03] B73C      1235       sta     ADSCR          ; Copy to ADC Status and Control Register
                     1236  
                     1237  ADCWait2:
 8376 [05] 0F3CFD    1238       brclr   coco,ADSCR,ADCWait2 ; If "conversions complete flag" bit of ADC Status and Control
                     1239                                   ; Register is clear, branch to ADCWait2:
                     1240                                   ;(keep looping while COnversion COmplete flag = 0)
 8379 [03] B63D      1241       lda     ADR                 ; Load accumulator with value in ADC Result Variable
 837B [03] B743      1242       sta     clt                 ; Copy to Coolant Temperature 8 bit ADC
 837D [03] 3F6E      1243       clr     adsel               ; Clear the ADC channel selector variable
 837F [01] 8C        1244       clrh                        ; Clear index register Hi byte
 8380 [03] B643      1245       lda     clt                 ; Load accumulator with value in Coolant Temperature ADC
 8382 [01] 97        1246       tax                         ; Copy to index register Lo byte
 8383 [04] D6F200    1247       lda     thermfactor,x       ; Load accumulator with value in thermfactor table, offset in
                     1248                                   ; index register Lo byte
 8386 [03] B76D      1249       sta     coolant             ; Copy to Coolant Temp in degreesF+40
                     1250  
                     1251  
                     1252  ;***********************************************************************************************
                     1253  ; - Primer Pulse Width is directly set by the coolant temperature value of
                     1254  ;   "pru" (at -40 degrees) and "prh" (at 165 degrees) - value is interpolated
                     1255  ;   Load the Final Pulse Width variable with the Prime Pulse value * 100 and
                     1256  ;   schedule the injectors to be fired on the first 100uS clock tick.
                     1257  ;
                     1258  ;   Note! In order for the Prime Pulse to be effective, the fuel system must
                     1259  ;   be at normal operating pressure. If there is insufficient residual
                     1260  ;   pressure, it may be necessary to turn the ignition switch off after the
                     1261  ;   fuel pump stops(1 second with no IRQ signal), then switch on and start.
                     1262  ;***********************************************************************************************
                     1263  
                     1264  INTERP_PRIME_PW:
 8388 [02] A600      1265       lda     #$00             ; Load accumulator with decimal 0
 838A [03] B791      1266       sta     tmp1             ; Copy to tmp1 variable
 838C [02] A6CD      1267       lda     #$CD             ; Load accumulator with decimal 205
                     1268                                ; 165 + 40 degrees (offset in lookup table)
 838E [03] B792      1269       sta     tmp2             ; Copy to tmp2 variable
 8390 [04] C6E42A    1270       lda     pru              ; Load accumulator with value in Primer Pulse
                     1271                                ; Width at -40 F)
 8393 [03] B793      1272       sta     tmp3             ; Copy to "tmp3"
 8395 [04] C6E42B    1273       lda     prh              ; Load accumulator with value in Primer Pulse
                     1274                                ; Width at 165 F)
 8398 [03] B794      1275       sta     tmp4             ; Copy to "tmp4"
 839A [05] 4E6D95    1276       mov     coolant,tmp5     ; Move value at current coolant temp to tmp5
 839D [05] CD900A    1277       jsr     lininterp        ; Jump to Lininterp: (interpolation subroutine)
 83A0 [03] B696      1278       lda     tmp6             ; Load accumulator with value in tmp6 variable
                     1279                                ; (result of calculation)
 83A2 [03] B757      1280       sta     pw               ; Copy to "pw"
 83A4 [03] B758      1281       sta     fd               ; Copy to "fd"
 83A6 [01] 97        1282       tax                      ; Tansfer value in accumulator to index register Lo byte
 83A7 [02] A664      1283       lda     #$64             ; Load accumulator with decimal 100
 83A9 [05] 42        1284       mul                      ; Multiply X:A<-(X)x(A)


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 12
MC68HC908GP32 User Bootloader


 83AA [03] BF55      1285       stx     pwcalch          ; Copy result Hi byte to "pwcalch"
 83AC [03] B756      1286       sta     pwcalcl          ; Copy result Lo byte to "pwcalcl"
 83AE [04] 1000      1287       bset    fuelp,porta      ; Set "fuelp" bit of Port A (energise fuel pump relay)
 83B0 [04] 1065      1288       bset    FPon,portAbits   ; Set "FPon" bit of "portAbits"
 83B2 [04] 146A      1289       bset    sched1,squirt    ; Set "sched1" bit of "squirt"
 83B4 [04] 106A      1290       bset    inj1,squirt      ; Set "inj1" bit of "squirt"
 83B6 [04] 186A      1291       bset    sched2,squirt    ; Set "sched2" bit of "squirt"
 83B8 [04] 126A      1292       bset    inj2,squirt      ; Set "inj2" bit of "squirt"
 83BA [04] 1063      1293       bset    running,engine   ; Set "running" bit of "engine"
                     1294  
                     1295  
                     1296  ;***********************************************************************************************
                     1297  ; - Enable interrupts
                     1298  ;***********************************************************************************************
                     1299  
 83BC [02] 9A        1300       cli                      ; Clear interrupt mask
                     1301  
                     1302  ;***********************************************************************************************
                     1303  ;***********************************************************************************************
                     1304  ;***************************    M A I N  E V E N T  L O O P     ********************************
                     1305  ;***********************************************************************************************
                     1306  ;***********************************************************************************************
                     1307  
                     1308  LOOPER:
                     1309  
                     1310  
                     1311  ;*;***********************************************************************************************
                     1312  ;*; - Toggle "Loopchk" bit on Port C each program loop so frequency can
                     1313  ;*;   be checked with a scope or frequency meter.(for program developement)
                     1314  ;*;***********************************************************************************************
                     1315  ;*
                     1316  ;*     com     LoopCounter      ; Ones compliment "LoopCounter"(flip state of "LoopCounter")
                     1317  ;*     bne     SET_LOOPCHK      ; If the Z bit of CCR is clear, branch to SET_LOOPCHK:
                     1318  ;*     bclr    Loopchk,PORTC    ; Clear "Loopchk" bit of Port C (LED off)
                     1319  ;*     bra     LOOPCHK_DONE     ; Branch to LOOPCHK_DONE:
                     1320  ;*
                     1321  ;*SET_LOOPCHK:
                     1322  ;*     bset    Loopchk,PORTC    ; Set "Loopchk" bit of Port C (LED on)
                     1323  ;*
                     1324  ;*LOOPCHK_DONE:
                     1325  
                     1326  ;***********************************************************************************************
                     1327  ; - Check the state of the Fuel Trim and Ignition Trim enable switches and act accordingly
                     1328  ;***********************************************************************************************
                     1329  
                     1330  ;CHK_TRM:
 83BD [05] 050007    1331       brclr   Ign_Trm_En,porta,ITRM_ON    ; If "Ign_Trm_En" (PTA2) is low, branch to ITRM_ON:
 83C0 [04] 6E1C5E    1332       mov     #$1C,Trm_Ang_Fac            ; Move decimal 28 into Trim Angle Factor
                     1333                                           ; 90/256=.352 counts per degree, 28 counts is mid
                     1334                                           ; point(10 degrees, no correction 8 cyl)
 83C3 [04] 1565      1335       bclr    ITen,portAbits              ; Clear "ITen" bit of "portAbits"
 83C5 [03] 2016      1336       bra     CHK_FTRM                    ; Branch to CHK_FTRM:
                     1337  
                     1338  ITRM_ON:
 83C7 [04] 1465      1339       bset    ITen,portAbits              ; Set "ITen" bit of "portAbits"
                     1340  
                     1341  ;***********************************************************************************************
                     1342  ; - Linear Interpolation of ADC value:
                     1343  ;   tmp1 = 0
                     1344  ;   tmp2 = 255
                     1345  ;   tmp3 = High end of scale
                     1346  ;   tmp4 = Lo end of scale
                     1347  ;   tmp5 = ADC value
                     1348  ;   tmp6 = Result
                     1349  ;***********************************************************************************************
                     1350  
 83C9 [03] 3F91      1351       clr     tmp1              ; Clear "tmp1"(0 volts)
 83CB [04] 6EFF92    1352       mov     #$FF,tmp2         ; Move decimal 255 to "tmp2"(5 volts)
 83CE [04] 6E3993    1353       mov     #$39,tmp3         ; Move decimal 57 to "tmp3" (20 degrees 8 cyl)
 83D1 [03] 3F94      1354       clr     tmp4              ; Clear "tmp4"(0 degrees)
 83D3 [05] 4E4895    1355       mov     Itrm_ADC,tmp5     ; Move value in "Itrm_ADC" to "tmp5"(ADC value)
 83D6 [05] CD900A    1356       jsr     lininterp         ; Jump to subroutine at linenterp:
 83D9 [03] B696      1357       lda     tmp6              ; Load accumulator with value in "tmp6"(Result)
 83DB [03] B75E      1358       sta     Trm_Ang_Fac       ; Copy to Trim Angle Factor variable
                     1359  
                     1360  CHK_FTRM:
 83DD [05] 0B0007    1361       brclr   Fuel_Trm_En,porta,FTRM_ON   ; If "Fuel_Trm_En" (PTA5) is low, branch to FTRM_ON:
 83E0 [04] 6E6450    1362       mov     #$64,Ftrimcor               ; Move decimal 100 into "Ftrimcor" (no fuel trim)
 83E3 [04] 1B65      1363       bclr    FTen,portAbits              ; Clear "FTen" bit of "portAbits"
 83E5 [03] 2017      1364       bra     CHK_TRM_DONE
                     1365  
                     1366  FTRM_ON:
 83E7 [04] 1A65      1367       bset    FTen,portAbits       ; Set "FTen" bit of "portAbits"
                     1368  
                     1369  ;***********************************************************************************************
                     1370  ; - Linear Interpolation of ADC value:
                     1371  ;   tmp1 = 0
                     1372  ;   tmp2 = 255
                     1373  ;   tmp3 = High end of scale
                     1374  ;   tmp4 = Lo end of scale
                     1375  ;   tmp5 = ADC value
                     1376  ;   tmp6 = Result
                     1377  ;***********************************************************************************************
                     1378  
 83E9 [03] 3F91      1379       clr     tmp1              ; Clear "tmp1"(0 volts)
 83EB [04] 6EFF92    1380       mov     #$FF,tmp2         ; Move decimal 255 to "tmp2"(5 volts)
 83EE [04] 6E7393    1381       mov     #$73,tmp3         ; Move decimal 115 to "tmp3" (115%)
 83F1 [04] 6E5594    1382       mov     #$55,tmp4         ; Move decimal 85 to "tmp4"(85%)
 83F4 [05] 4E4795    1383       mov     Ftrm_ADC,tmp5     ; Move value in "Ftrm_ADC" to "tmp5"(ADC value)
 83F7 [05] CD900A    1384       jsr     lininterp         ; Jump to subroutine at linenterp:
 83FA [03] B696      1385       lda     tmp6              ; Load accumulator with value in "tmp6"(Result)
 83FC [03] B750      1386       sta     Ftrimcor          ; Copy to Fuel Trim Correction Factor
                     1387  
                     1388  CHK_TRM_DONE:
                     1389  
                     1390  ;***********************************************************************************************
                     1391  ;
                     1392  ; - KnockSenseMS output "TIM is normally high (+5 volts), and goes low (0 volts) when it
                     1393  ;   detects a knock. TIM is connected to MS DB37 pin 4 which is traced on the MS board to
                     1394  ;   JP1-2 (X9). X9 is a header socket to the daughter board header pin X9 which connects to R4
                     1395  ;   and C5 to header pin X4 to header socket X4 on the MS board. X4 is traced to HC908 pin 36
                     1396  ;   (PTA3) which was a spare input. PTA3 is polled every time through the main loop. If it is
                     1397  ;   high knock (bit 7) of alarmbits is cleared. If it is low, the bit is set. The code
                     1398  ;   poles alarmbits to see if any of the bits are set. If all are clear, no alarm is sounded.
                     1399  ;   If any are set, the alarm is sounded and TS or MV displays which bit, or bits are causing
                     1400  ;   the alarm.
                     1401  ;
                     1402  ;***********************************************************************************************
                     1403  
                     1404  ;**********************************************************************************************
                     1405  ; - Check the state of the Knock Sensor Input and act accordingly
                     1406  ;**********************************************************************************************
                     1407  
                     1408  ;CHK_KNOCK:
 83FE [05] 070007    1409       brclr   Knk_Det,porta,KNOCK_ON        ; If "Knk" (PTA3) is low, branch to KNOCK_ON:
 8401 [05] 0F6409    1410       brclr   knocking,alarmbits,KNOCK_DONE ; If "knocking" bit of "alarmbits" is already clear,
                     1411                                             ; branch to KNOCK_DONE:
 8404 [04] 1F64      1412       bclr    knocking,alarmbits            ; Clear "knocking" bit of "alarmbits"
 8406 [03] 2005      1413       bra     KNOCK_DONE                    ; Branch to KNOCK_DONE:
                     1414  
                     1415  KNOCK_ON:
 8408 [05] 0E6402    1416       brset   knocking,alarmbits,KNOCK_DONE ; If "knocking" bit of "alarmbits" is already set,
                     1417                                             ; branch to KNOCK_DONE:
 840B [04] 1E64      1418       bset    knocking,alarmbits            ; Set "knocking" bit of "alarmbits"
                     1419  
                     1420  KNOCK_DONE:


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 13
MC68HC908GP32 User Bootloader


                     1421  
                     1422  ;*;***********************************************************************************************
                     1423  ;*; - Set the "trigHi" bit of "engine" variable when the IRQ signal goes low (PIP Hi) and clear
                     1424  ;*;   it when the IRQ signal goes Hi (PIP Lo). This is used to test the crank trigger signal for
                     1425  ;*;   initial engine set up only.
                     1426  ;*;***********************************************************************************************
                     1427  
                     1428  ;*     bil     SET_TRIG       ; If IRQ pin is low (PIP Hi), branch to SET_TRIG:
                     1429  ;*     bclr    trigHi,engine  ; Clear "trigHi" bit of "engine" variable
                     1430  ;*     bra     TRIG_DONE      ; Branch to TRIG_DONE:
                     1431  
                     1432  ;*SET_TRIG:
                     1433  ;*     bset    trigHi,engine  ; Set "trigHi" bit of "engine" variable
                     1434  
                     1435  ;*TRIG_DONE:
                     1436  
                     1437  ;***********************************************************************************************
                     1438  ; - On start up, until we have received a minimum of 3 PIP signals so
                     1439  ;   that 0.1uS period calculations will be valid, prohibit "Run" mode.
                     1440  ;***********************************************************************************************
                     1441  
 840D [03] B6C2      1442       lda     MinPIP       ; Load accumulator with value in "MinPIP" variable
 840F [03] 2702      1443       beq     MINPIP_DONE  ; If Z bit of CCR is set, branch to MINPIP_DONE:
 8411 [04] 1169      1444       bclr    run,engine2  ; Clear "run" bit of "engine2" variable
                     1445  
                     1446  MINPIP_DONE:
                     1447  
                     1448  ;***********************************************************************************************
                     1449  ; - Check to see if Ignition Monitor on PTA4 is high so it can be re-enabled for
                     1450  ;   keyboard interrupts
                     1451  ;***********************************************************************************************
                     1452  
 8413 [05] 076B02    1453       brclr   MONen,inputs,CHK_MON_HI    ; If "MONen" bit of "inputs" var is clear,
                     1454                                          ; branch to CHK_MON_HI:
 8416 [03] 200F      1455       bra     EN_KYBD_DONE               ; Branch to EN_KYBD_DONE:
                     1456  
                     1457  CHK_MON_HI:
 8418 [04] 1904      1458       bclr     Ign_Mon,DDRA               ; Clear "Ign_Mon" bit of Port Data Direction Register
                     1459                                           ;(Make sure PTA4 is configured as an input
                     1460                                           ; so it can be read)
 841A [05] 09000A    1461       brclr   Ign_Mon,porta,EN_KYBD_DONE  ; If "Ign_Mon" bit of Port A is clear, branch to
                     1462                                           ;EN_KYBD_DONE:(pin is Lo, continue loop)
                     1463  
                     1464  ;***********************************************************************************************
                     1465  ; ------------------- Re enable Ignition Monitor KBI ------------------------
                     1466  ; To avoid false interrupts, configure pin as output, set, logic Hi, enable
                     1467  ; KBI, and restore pin to input.
                     1468  ;***********************************************************************************************
                     1469  
 841D [04] 1804      1470       bset     Ign_Mon,DDRA       ; Set "Ign_Mon" bit of Port A Data Direction Register
                     1471                                   ; (pin is output)
 841F [04] 1800      1472       bset     Ign_Mon,porta      ; Set "Ign_Mon" pin of Port A (pin is Hi)
 8421 [04] 181B      1473       bset     Ign_Mon,INTKBIER   ; Set "Ign_Mon" bit of Keyboard Interrupt
                     1474                                   ; Enable Register (enable pin for interrupt)
 8423 [04] 1904      1475       bclr     Ign_Mon,DDRA       ; Clear "Ign_Mon" bit of Port A Data Direction Register
                     1476                                   ; (pin is input)
 8425 [04] 166B      1477       bset     MONen,inputs       ; Set "MONen" bit of "inputs" variable
                     1478  
                     1479  EN_KYBD_DONE:
                     1480  
                     1481  ;***********************************************************************************************
                     1482  ; - At cranking and low engine speeds, PIP "mirrors" SPOUT. If we are not in "Run" mode,
                     1483  ;   control SPOUT here.
                     1484  ;***********************************************************************************************
                     1485  
                     1486  ;SLOW_SPOUT:
 8427 [05] 006908    1487       brset   run,engine2,SLOW_SPOUT_DONE  ; If "run" bit of "engine2 variable is set,
                     1488                                            ; branch to SLOW_SPOUT_DONE:
 842A [03] 2E04      1489       bil     SET_SPOUT_HI                 ; If IRQ pin is low (PIP Hi), branch to SET_SPOUT_HI
 842C [04] 1200      1490       bset    spark,PORTA                  ; Set "spark" bit of Port A(SPOUT falling edge)
 842E [03] 2002      1491       bra     SLOW_SPOUT_DONE              ; Branch to SLOW_SPOUT_DONE:
                     1492  
                     1493  SET_SPOUT_HI:
 8430 [04] 1300      1494       bclr    spark,PORTA                  ; Clear "spark" bit of Port A (SPOUT rising edge)
                     1495  
                     1496  SLOW_SPOUT_DONE:
                     1497  
                     1498  ;***********************************************************************************************
                     1499  ; - If we are in "Run" mode, and if a spark is not in progress, and if a
                     1500  ;   spark has been scheduled, set and arm TIM1 CH0 with new output compare
                     1501  ;   value to drive SPOUT Hi and fire coil.
                     1502  ;***********************************************************************************************
                     1503  
 8432 [05] 01690F    1504       brclr   run,engine2,DELAY_DONE       ; If "run" bit of "engine2 variable is clear,
                     1505                                            ; branch to DELAY_DONE:
 8435 [05] 04690C    1506       brset   sparking,engine2,DELAY_DONE  ; If "sparking" bit of "engine2" variable is set,
                     1507                                            ; branch to DELAY_DONE:
 8438 [05] 036909    1508       brclr   schedspk,engine2,DELAY_DONE  ; If "schedspk" bit of "engine2" variable is clear,
                     1509                                            ; branch to DELAY_DONE:
                     1510  
                     1511  
                     1512  ;***********************************************************************************************
                     1513  ; - Set and arm TIM2 Chan 1 output compare value to fire coil
                     1514  ;   CH1_ocH:CH1_ocL = T2CH1H:T2CH1L
                     1515  ;***********************************************************************************************
                     1516  
                     1517  ;SPARK_DELAY:
 843B [01] 8C        1518       clrh                      ; Clear index register Hi byte
 843C [04] 55B5      1519       ldhx    CH1_onH           ; Load index register with value in CH1 on O/C value H:L
 843E [04] 3534      1520       sthx    T2CH1H            ; Copy to TIM2 CH1 register H:L
                     1521                                 ;(output compare value for SPOUT rising edge)
 8440 [04] 1C33      1522       bset    CHxIE,T2SC1       ; Enable interrupt requests TIM2 channel 1
                     1523                                 ; Status and Control Register
 8442 [04] 1369      1524       bclr    schedspk,engine2  ; Clear "schedspk" bit of "engine2" variable
                     1525  
                     1526  DELAY_DONE:
                     1527  
                     1528  
                     1529  ;***********************************************************************************************
                     1530  ; ----------------------------------------- ADC Section ----------------------------------------
                     1531  ;
                     1532  ; - All tables are pre-computed for all 256 different values
                     1533  ;   and stored in FLASH.
                     1534  ; - Manifold Air and Coolant temperatures are in degrees F plus 40 ("airtemp"
                     1535  ;   and "coolant"). This allows unsigned numbers for full temperature range
                     1536  ; - Manifold Air pressures is in Kilopascals ("kpa")
                     1537  ;   Air density correction factors is in percent,
                     1538  ;   with 100 being no correction ("barocor" and "aircor")
                     1539  ;   "Ftrimcor" is the fuel correction factor from -15% to +15% (85 to 115)
                     1540  ;   Centre position of the pot is 0 correction (100%).
                     1541  ;   "Itrimcor" is the ignition trim correction factor, 10 degrees advance
                     1542  ;   or retard. 0=10 degrees retard, 10=no trim, 20=10 degrees advance.
                     1543  ;***********************************************************************************************
                     1544  
                     1545  ;***********************************************************************************************
                     1546  ; - Update the ADC readings and conversions. This is done only once per ADC
                     1547  ;   conversion complete interrupt, in the first pass through the main loop
                     1548  ;   after the interrupt routine has been completed.
                     1549  ;***********************************************************************************************
                     1550  
 8444 [05] 026B03    1551       brset   adcc,inputs,ADC_LOOKUPS  ; If "adcc" bit of "inputs" variable is set, branch to
                     1552                                        ; ADC_LOOKUPS:
 8447 [03] CC85C9    1553       jmp     NO_ADC_PASS              ; Jump to NO_ADC_PASS:
                     1554  
                     1555  ADC_LOOKUPS:
                     1556  


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 14
MC68HC908GP32 User Bootloader


                     1557  ;***********************************************************************************************
                     1558  ; - First determine which is the current ADC reading and branch accordingly
                     1559  ;***********************************************************************************************
                     1560  
 844A [03] B6EE      1561       lda     ADCcnt        ; Load accumulator with value in "ADCcnt"
 844C [04] 41001E    1562       cbeqa   #$00,ADC_0    ; Compare with decimal 0 and if equal, branch to ADC_0:(map)
 844F [04] 41012B    1563       cbeqa   #$01,ADC_1    ; Compare with decimal 1 and if equal, branch to ADC_1:(mat)
 8452 [04] 410240    1564       cbeqa   #$02,ADC_2    ; Compare with decimal 2 and if equal, branch to ADC_2:(clt)
 8455 [04] 41034D    1565       cbeqa   #$03,ADC_3    ; Compare with decimal 3 and if equal, branch to ADC_3:(tps)
 8458 [04] 410477    1566       cbeqa   #$04,ADC_4    ; Compare with decimal 4 and if equal, branch to ADC_4:(batt)
 845B [04] 410568    1567       cbeqa   #$05,ADC_5_J  ; Compare with decimal 5 and if equal, branch to ADC_5_J:(ego)
 845E [04] 410667    1568       cbeqa   #$06,ADC_6_J  ; Compare with decimal 6 and if equal, branch to ADC_6_J:(Ftrm_ADC)
 8461 [04] 410766    1569       cbeqa   #$07,ADC_7_J  ; Compare with decimal 7 and if equal, branch to ADC_7_J:(ITrm_ADC)
 8464 [04] 410865    1570       cbeqa   #$08,ADC_8_J  ; Compare with decimal 8 and if equal, branch to ADC_8_J:(OP_ADC)
 8467 [04] 410964    1571       cbeqa   #$09,ADC_9_J  ; Compare with decimal 9 and if equal, branch to ADC_9_J:(FP_ADC)
 846A [04] 410A63    1572       cbeqa   #$A,ADC_10_J  ; Compare with decimal 10 and if equal, branch to ADC_10_J:(EGT_ADC)
                     1573  
                     1574  ;***********************************************************************************************
                     1575  ; - "map" section
                     1576  ;***********************************************************************************************
                     1577  
                     1578  ADC_0:
 846D [03] B6E3      1579       lda     mapcur               ; Load accumulator with value in "mapcur"
 846F [03] B741      1580       sta     map                  ; Copy to "map"
 8471 [01] 8C        1581       clrh                         ; Clear index register Hi byte
 8472 [03] B641      1582       lda     map                  ; Load accumulator with value in MAP ADC
 8474 [01] 97        1583       tax                          ; Copy to index register Lo byte
 8475 [04] D6F100    1584       lda     KPAFACTOR4250rjh,x   ; Load accumulator with value in KPAFACTOR4250rjh table
                     1585                                    ; offset in index register Lo byte
 8478 [03] B76C      1586       sta     kpa                  ; Copy to Manifold Air Pressure in Kilopascals
 847A [03] CC85C7    1587       jmp     ADC_DONE             ; Jump to ADC_DONE:
                     1588  
                     1589  ;***********************************************************************************************
                     1590  ; - "mat" section
                     1591  ;***********************************************************************************************
                     1592  
                     1593  ADC_1:
 847D [03] B6E4      1594       lda     matcur          ; Load accumulator with value in "matcur"
 847F [03] B742      1595       sta     mat             ; Copy to "mat"
 8481 [01] 8C        1596       clrh                    ; Clear index register Hi byte
 8482 [03] B642      1597       lda     mat             ; Load accumulator with value in Manifold Air Temperatue ADC
 8484 [01] 97        1598       tax                     ; Copy to index register Lo byte
 8485 [04] D6F300    1599       lda     airdenfactor,x  ; Load accumulator with value in airdenfactor
                     1600                               ; table, offset in index register Lo byte
 8488 [03] B74F      1601       sta     aircor          ; Copy to Air Density Correction
 848A [03] B642      1602       lda     mat             ; Load accumulator with value in Manifold Air Temperatue ADC
 848C [01] 97        1603       tax                     ; Copy to index register Lo byte
 848D [04] D6F200    1604       lda     thermfactor,x   ; Load accumulator with value in thermfactor table,
                     1605                               ; offset in index register Lo byte
 8490 [03] B7EF      1606       sta     airtemp         ; Copy to Manifold Air Temperature in degrees F + 40
 8492 [03] CC85C7    1607       jmp     ADC_DONE        ; Jump to ADC_DONE:
                     1608  
                     1609  ;***********************************************************************************************
                     1610  ; - "clt" section
                     1611  ;***********************************************************************************************
                     1612  
                     1613  ADC_2:
 8495 [03] B6E5      1614       lda     cltcur          ; Load accumulator with value in "cltcur"
 8497 [03] B743      1615       sta     clt             ; Copy to "clt"
 8499 [01] 8C        1616       clrh                    ; Clear index register Hi byte
 849A [03] B643      1617       lda     clt             ; Load accumulator with value in Coolant Temperature ADC
 849C [01] 97        1618       tax                     ; Copy to index register Lo byte
 849D [04] D6F200    1619       lda     thermfactor,x   ; Load accumulator with value in thermfactor table,
                     1620                               ; offset in index register Lo byte
 84A0 [03] B76D      1621       sta     coolant         ; Copy to Coolant Temp in degreesF+40
 84A2 [03] CC85C7    1622       jmp     ADC_DONE        ; Jump to ADC_DONE:
                     1623  
                     1624  ;***********************************************************************************************
                     1625  ; - "tps" section
                     1626  ;***********************************************************************************************
                     1627  
                     1628  ADC_3:
 84A5 [03] B6E6      1629       lda     tpscur          ; Load accumulator with value in "tpscur"
 84A7 [03] B744      1630       sta     tps             ; Copy to "tps"
                     1631  
                     1632  ;***********************************************************************************************
                     1633  ; - Linear Interpolation of ADC value:
                     1634  ;   tmp1 = Lo ADC(CT_cnt)
                     1635  ;   tmp2 = Hi ADC(WOT_cnt)
                     1636  ;   tmp3 = Lo end of scale(0%)
                     1637  ;   tmp4 = Hi end of scale(100%)
                     1638  ;   tmp5 = ADC value
                     1639  ;   tmp6 = Result
                     1640  ;***********************************************************************************************
                     1641  
 84A9 [04] C6E42D    1642       lda     CT_cnt            ; Load accumulator with value in "CT_cnt"
 84AC [03] B791      1643       sta     tmp1              ; Copy to "tmp1"
 84AE [04] C6E42E    1644       lda     WOT_cnt           ; Load accumulator with value in "WOT_cnt"
 84B1 [03] B792      1645       sta     tmp2              ; Copy to "tmp2"
 84B3 [04] 6E0093    1646       mov     #$00,tmp3         ; Move zero to "tmp3"(0%)
 84B6 [04] 6E6494    1647       mov     #$64,tmp4         ; Move decimal 100 to "tmp4"(100%)
 84B9 [05] 4E4495    1648       mov     tps,tmp5          ; Move value in "tps" to "tmp5"(ADC value)
 84BC [05] CD900A    1649       jsr     lininterp         ; Jump to subroutine at linenterp:
 84BF [03] B696      1650       lda     tmp6              ; Load accumulator with value in "tmp6"(Result)
 84C1 [03] B762      1651       sta     tpsp              ; Copy to "tpsp"(Throttle percent opening)
 84C3 [03] CC85C7    1652       jmp     ADC_DONE          ; Jump to ADC_DONE:
                     1653  
                     1654  ;***********************************************************************************************
                     1655  ; - Long branches
                     1656  ;***********************************************************************************************
                     1657  
                     1658  ADC_5_J:
 84C6 [03] 2038      1659       bra     ADC_5
                     1660  
                     1661  ADC_6_J:
 84C8 [03] 2064      1662       bra     ADC_6
                     1663  
                     1664  ADC_7_J:
 84CA [03] 2069      1665       bra     ADC_7
                     1666  
                     1667  ADC_8_J:
 84CC [03] 2072      1668       bra     ADC_8
                     1669  
                     1670  ADC_9_J:
 84CE [03] 206C      1671       bra     ADC_9_J1
                     1672  
                     1673  ADC_10_J:
 84D0 [03] 206C      1674       bra     ADC_10_J1
                     1675  
                     1676  ;***********************************************************************************************
                     1677  ; - "batt" Section
                     1678  ;***********************************************************************************************
                     1679  
                     1680  ADC_4:
 84D2 [03] B6E7      1681       lda     battcur      ; Load accumulator with value in "battcur"
 84D4 [03] BBD5      1682       add     battTL       ; Add without Carry A<-(A)+(M) "ADR" + "battTL" (total Lo Byte)
 84D6 [03] B7D5      1683       sta     battTL       ; Copy to "battTL" (update total Lo Byte))
 84D8 [03] B6D4      1684       lda     battTH       ; Load accumulator with value in "battTH" (total Hi Byte)
 84DA [02] A900      1685       adc     #$0          ; Add with carry decimal zero A<-(A)+(M)(just the carry)
 84DC [03] B7D4      1686       sta     battTH       ; Copy to "battT" (update total Hi Byte))
 84DE [04] 3CD6      1687       inc     battcnt      ; Increment "battcnt" variable
                     1688  
                     1689  ;***********************************************************************************************
                     1690  ; - Check the value of "battcnt" to see if it's time to average the values
                     1691  ;***********************************************************************************************
                     1692  


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 15
MC68HC908GP32 User Bootloader


 84E0 [03] B6D6      1693       lda     battcnt      ; Load accumulator with value in "battcnt"
 84E2 [02] A110      1694       cmp     #$10         ; Compare value in "battcnt" to decimal 16
 84E4 [03] 2702      1695       beq     BATT_AV      ; If Z bit of CCR is set (operands equal) branch to BATT_AV:
 84E6 [03] 2015      1696       bra     NO_BATT_AV   ; Branch to NO_BATT_AV:
                     1697  
                     1698  BATT_AV:
 84E8 [03] B6D5      1699       lda     battTL       ; Lod accumulator with value in "battTL"
 84EA [03] B791      1700       sta     tmp1         ; Copy to "tmp1"
 84EC [03] B6D4      1701       lda     battTH       ; Load accumulator with value in "battTH"
 84EE [03] B792      1702       sta     tmp2         ; Copy to "tmp2"
 84F0 [05] CD9170    1703       jsr     DIV_BY_16    ; Jump to subroutine at DIV_BY_16:
 84F3 [03] B691      1704       lda     tmp1         ; Load accumulator with value in "tmp1"
 84F5 [03] B745      1705       sta     batt         ; Copy to "batt"
 84F7 [03] 3FD4      1706       clr     battTH       ; Clear "battTH"
 84F9 [03] 3FD5      1707       clr     battTL       ; Clear "battTL"
 84FB [03] 3FD6      1708       clr     battcnt      ; Clear "battcnt"
                     1709  
                     1710  NO_BATT_AV:
 84FD [03] CC85C7    1711       jmp     ADC_DONE     ; Jump to ADC_DONE:
                     1712  
                     1713  ;***********************************************************************************************
                     1714  ; - "ego" Section
                     1715  ;***********************************************************************************************
                     1716  
                     1717  ADC_5:
 8500 [03] B6E8      1718       lda     egocur       ; Load accumulator with value in "egocur"
 8502 [03] BBD8      1719       add     egoTL        ; Add without Carry A<-(A)+(M) "ADR" + "egoTL" (total Lo Byte)
 8504 [03] B7D8      1720       sta     egoTL        ; Copy to "egoTL" (update total Lo Byte))
 8506 [03] B6D7      1721       lda     egoTH        ; Load accumulator with value in "egoTH" (total Hi Byte)
 8508 [02] A900      1722       adc     #$0          ; Add with carry decimal zero A<-(A)+(M)(just the carry)
 850A [03] B7D7      1723       sta     egoTH        ; Copy to "egoTH" (update total Hi Byte))
 850C [04] 3CD9      1724       inc     egocnt       ; Increment "battcnt" variable
                     1725  
                     1726  ;***********************************************************************************************
                     1727  ; - Check the value of "egocnt" to see if it's time to average the values
                     1728  ;***********************************************************************************************
                     1729  
 850E [03] B6D9      1730       lda     egocnt       ; Load accumulator with value in "egocnt"
 8510 [02] A110      1731       cmp     #$10         ; Compare value in "battcnt" to decimal 16
 8512 [03] 2702      1732       beq     EGO_AV      ; If Z bit of CCR is set (operands equal) branch to EGO_AV:
 8514 [03] 2015      1733       bra     NO_EGO_AV   ; Branch to NO_EGO_AV:
                     1734  
                     1735  EGO_AV:
 8516 [03] B6D8      1736       lda     egoTL        ; Lod accumulator with value in "egoTL"
 8518 [03] B791      1737       sta     tmp1         ; Copy to "tmp1"
 851A [03] B6D7      1738       lda     egoTH        ; Load accumulator with value in "egoTH"
 851C [03] B792      1739       sta     tmp2         ; Copy to "tmp2"
 851E [05] CD9170    1740       jsr     DIV_BY_16    ; Jump to subroutine at DIV_BY_16:
 8521 [03] B691      1741       lda     tmp1         ; Load accumulator with value in "tmp1"
 8523 [03] B746      1742       sta     ego          ; Copy to "ego"
 8525 [03] 3FD7      1743       clr     egoTH        ; Clear "egoTH"
 8527 [03] 3FD8      1744       clr     egoTL        ; Clear "egoTL"
 8529 [03] 3FD9      1745       clr     egocnt       ; Clear "egocnt"
                     1746  
                     1747  NO_EGO_AV:
 852B [03] CC85C7    1748       jmp     ADC_DONE     ; Jump to ADC_DONE:
                     1749  
                     1750  ;***********************************************************************************************
                     1751  ; - "Ftrm_ADC" section
                     1752  ;***********************************************************************************************
                     1753  
                     1754  ADC_6:
 852E [03] B6E9      1755       lda     Ftrm_ADCcur     ; Load accumulator with value in "Ftrm_ADCcur"
 8530 [03] B747      1756       sta     Ftrm_ADC        ; Copy to "Ftrm_ADC"
 8532 [03] CC85C7    1757       jmp     ADC_DONE        ; Jump to ADC_DONE:
                     1758  
                     1759  ;***********************************************************************************************
                     1760  ; - "Itrm_ADC" section
                     1761  ;***********************************************************************************************
                     1762  
                     1763  ADC_7:
 8535 [03] B6EA      1764       lda     Itrm_ADCcur     ; Load accumulator with value in "Itrm_ADCcur"
 8537 [03] B748      1765       sta     Itrm_ADC        ; Copy to "Itrm_ADC"
 8539 [03] CC85C7    1766       jmp     ADC_DONE        ; Jump to ADC_DONE:
                     1767  
                     1768  ;***********************************************************************************************
                     1769  ; - Long branches
                     1770  ;***********************************************************************************************
                     1771  
                     1772  ADC_9_J1:
 853C [03] 2030      1773       bra     ADC_9
                     1774  
                     1775  ADC_10_J1:
 853E [03] 205C      1776       bra     ADC_10
                     1777  
                     1778  ;***********************************************************************************************
                     1779  ; - "OP_ADC" Section
                     1780  ;***********************************************************************************************
                     1781  
                     1782  ADC_8:
 8540 [03] B6EB      1783       lda     OP_ADCcur      ; Load accumulator with value in "OP_ADCcur"
 8542 [03] BBDB      1784       add     OP_ADCTL       ; Add without Carry A<-(A)+(M) "ADR" + "OP_ADCTL" (total Lo Byte)
 8544 [03] B7DB      1785       sta     OP_ADCTL       ; Copy to "OP_ADCTL" (update total Lo Byte))
 8546 [03] B6DA      1786       lda     OP_ADCTH       ; Load accumulator with value in "OP_ADCTH" (total Hi Byte)
 8548 [02] A900      1787       adc     #$0            ; Add with carry decimal zero A<-(A)+(M)(just the carry)
 854A [03] B7DA      1788       sta     OP_ADCTH       ; Copy to "OP_ADCT" (update total Hi Byte))
 854C [04] 3CDC      1789       inc     OP_ADCcnt      ; Increment "OP_ADCcnt" variable
                     1790  
                     1791  ;***********************************************************************************************
                     1792  ; - Check the value of "OP_ADCcnt" to see if it's time to average the values
                     1793  ;***********************************************************************************************
                     1794  
 854E [03] B6DC      1795       lda     OP_ADCcnt      ; Load accumulator with value in "OP_ADCcnt"
 8550 [02] A110      1796       cmp     #$10           ; Compare value in "battcnt" to decimal 16
 8552 [03] 2702      1797       beq     OP_ADC_AV;     ; If Z bit of CCR is set (operands equal) branch to OP_ADC_AV:
 8554 [03] 2015      1798       bra     NO_OP_ADC_AV   ; Branch to NO_OP_ADC_AV:
                     1799  
                     1800  OP_ADC_AV:
 8556 [03] B6DB      1801       lda     OP_ADCTL       ; Lod accumulator with value in "OP_ADCTL"
 8558 [03] B791      1802       sta     tmp1           ; Copy to "tmp1"
 855A [03] B6DA      1803       lda     OP_ADCTH       ; Load accumulator with value in "OP_ADCTH"
 855C [03] B792      1804       sta     tmp2           ; Copy to "tmp2"
 855E [05] CD9170    1805       jsr     DIV_BY_16      ; Jump to subroutine at DIV_BY_16:
 8561 [03] B691      1806       lda     tmp1           ; Load accumulator with value in "tmp1"
 8563 [03] B749      1807       sta     OP_ADC         ; Copy to "OP_ADC"
 8565 [03] 3FDA      1808       clr     OP_ADCTH       ; Clear "OP_ADCTH"
 8567 [03] 3FDB      1809       clr     OP_ADCTL       ; Clear "OP_ADCTL"
 8569 [03] 3FDC      1810       clr     OP_ADCcnt      ; Clear "OP_ADCcnt"
                     1811  
                     1812  NO_OP_ADC_AV:
 856B [03] CC85C7    1813       jmp     ADC_DONE       ; Jump to ADC_DONE:
                     1814  
                     1815  ;***********************************************************************************************
                     1816  ; - "FP_ADC" Section
                     1817  ;***********************************************************************************************
                     1818  
                     1819  ADC_9:
 856E [03] B6EC      1820       lda     FP_ADCcur      ; Load accumulator with value in "FP_ADCcur"
 8570 [03] BBDE      1821       add     FP_ADCTL       ; Add without Carry A<-(A)+(M) "ADR" + "FP_ADCTL" (total Lo Byte)
 8572 [03] B7DE      1822       sta     FP_ADCTL       ; Copy to "FP_ADCTL" (update total Lo Byte))
 8574 [03] B6DD      1823       lda     FP_ADCTH       ; Load accumulator with value in "FP_ADCTH" (total Hi Byte)
 8576 [02] A900      1824       adc     #$0            ; Add with carry decimal zero A<-(A)+(M)(just the carry)
 8578 [03] B7DD      1825       sta     FP_ADCTH       ; Copy to "FP_ADCT" (update total Hi Byte))
 857A [04] 3CDF      1826       inc     FP_ADCcnt      ; Increment "FP_ADCcnt" variable
                     1827  
                     1828  ;***********************************************************************************************


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 16
MC68HC908GP32 User Bootloader


                     1829  ; - Check the value of "FP_ADCcnt" to see if it's time to average the values
                     1830  ;***********************************************************************************************
                     1831  
 857C [03] B6DF      1832       lda     FP_ADCcnt      ; Load accumulator with value in "FP_ADCcnt"
 857E [02] A110      1833       cmp     #$10           ; Compare value in "battcnt" to decimal 16
 8580 [03] 2702      1834       beq     FP_ADC_AV;     ; If Z bit of CCR is set (operands equal) branch to FP_ADC_AV:
 8582 [03] 2015      1835       bra     NO_FP_ADC_AV   ; Branch to NO_FP_ADC_AV:
                     1836  
                     1837  FP_ADC_AV:
 8584 [03] B6DE      1838       lda     FP_ADCTL       ; Lod accumulator with value in "FP_ADCTL"
 8586 [03] B791      1839       sta     tmp1           ; Copy to "tmp1"
 8588 [03] B6DD      1840       lda     FP_ADCTH       ; Load accumulator with value in "FP_ADCTH"
 858A [03] B792      1841       sta     tmp2           ; Copy to "tmp2"
 858C [05] CD9170    1842       jsr     DIV_BY_16      ; Jump to subroutine at DIV_BY_16:
 858F [03] B691      1843       lda     tmp1           ; Load accumulator with value in "tmp1"
 8591 [03] B74A      1844       sta     FP_ADC         ; Copy to "FP_ADC"
 8593 [03] 3FDD      1845       clr     FP_ADCTH       ; Clear "FP_ADCTH"
 8595 [03] 3FDE      1846       clr     FP_ADCTL       ; Clear "FP_ADCTL"
 8597 [03] 3FDF      1847       clr     FP_ADCcnt      ; Clear "FP_ADCcnt"
                     1848  
                     1849  NO_FP_ADC_AV:
 8599 [03] CC85C7    1850       jmp     ADC_DONE       ; Jump to ADC_DONE:
                     1851  
                     1852  ;***********************************************************************************************
                     1853  ; - "EGT_ADC" Section
                     1854  ;***********************************************************************************************
                     1855  
                     1856  ADC_10:
 859C [03] B6ED      1857       lda     EGT_ADCcur      ; Load accumulator with value in "EGT_ADCcur"
 859E [03] BBE1      1858       add     EGT_ADCTL       ; Add without Carry A<-(A)+(M) "ADR" + "EGT_ADCTL" (total Lo Byte)
 85A0 [03] B7E1      1859       sta     EGT_ADCTL       ; Copy to "EGT_ADCTL" (update total Lo Byte))
 85A2 [03] B6E0      1860       lda     EGT_ADCTH       ; Load accumulator with value in "EGT_ADCTH" (total Hi Byte)
 85A4 [02] A900      1861       adc     #$0            ; Add with carry decimal zero A<-(A)+(M)(just the carry)
 85A6 [03] B7E0      1862       sta     EGT_ADCTH       ; Copy to "EGT_ADCT" (update total Hi Byte))
 85A8 [04] 3CE2      1863       inc     EGT_ADCcnt      ; Increment "EGT_ADCcnt" variable
                     1864  
                     1865  ;***********************************************************************************************
                     1866  ; - Check the value of "EGT_ADCcnt" to see if it's time to average the values
                     1867  ;***********************************************************************************************
                     1868  
 85AA [03] B6E2      1869       lda     EGT_ADCcnt     ; Load accumulator with value in "EGT_ADCcnt"
 85AC [02] A110      1870       cmp     #$10           ; Compare value in "battcnt" to decimal 16
 85AE [03] 2702      1871       beq     EGT_ADC_AV;    ; If Z bit of CCR is set (operands equal) branch to EGT_ADC_AV:
 85B0 [03] 2015      1872       bra     NO_EGT_ADC_AV  ; Branch to NO_EGT_ADC_AV:
                     1873  
                     1874  EGT_ADC_AV:
 85B2 [03] B6E1      1875       lda     EGT_ADCTL      ; Lod accumulator with value in "EGT_ADCTL"
 85B4 [03] B791      1876       sta     tmp1           ; Copy to "tmp1"
 85B6 [03] B6E0      1877       lda     EGT_ADCTH      ; Load accumulator with value in "EGT_ADCTH"
 85B8 [03] B792      1878       sta     tmp2           ; Copy to "tmp2"
 85BA [05] CD9170    1879       jsr     DIV_BY_16      ; Jump to subroutine at DIV_BY_16:
 85BD [03] B691      1880       lda     tmp1           ; Load accumulator with value in "tmp1"
 85BF [03] B74B      1881       sta     EGT_ADC        ; Copy to "EGT_ADC"
 85C1 [03] 3FE0      1882       clr     EGT_ADCTH      ; Clear "EGT_ADCTH"
 85C3 [03] 3FE1      1883       clr     EGT_ADCTL      ; Clear "EGT_ADCTL"
 85C5 [03] 3FE2      1884       clr     EGT_ADCcnt     ; Clear "EGT_ADCcnt"
                     1885  
                     1886  NO_EGT_ADC_AV:
                     1887  
                     1888  ADC_DONE:
 85C7 [04] 136B      1889       bclr    adcc,inputs                    ; Clear "adcc" bit of "inputs" variable
                     1890  
                     1891  NO_ADC_PASS:
                     1892  
                     1893  ;***********************************************************************************************
                     1894  ; - Alarm section
                     1895  ;***********************************************************************************************
                     1896  
                     1897  ;HET_ALARM:
 85C9 [03] B66D      1898       lda     coolant                      ; Load accumulator with value in "coolant"
 85CB [04] C1E435    1899       cmp     hetoff                       ; Compare with "hetoff" (235=195 degrees F)
 85CE [03] 2302      1900       bls     CLEAR_HET                    ; If A lower or same as M, branch to CLEAR_HET:
 85D0 [03] 2007      1901       bra     CHK_HET_HI                   ; Branch to CHK_HET_HI:
                     1902  
                     1903  CLEAR_HET:
 85D2 [05] 036410    1904       brclr   HET,alarmbits,HET_ALARM_DONE ; If "HET" bit of "alarmbits" is clear,
                     1905                                            ; branch to HET_ALARM_DONE:
 85D5 [04] 1364      1906       bclr    HET,alarmbits                ; Clear "HET" bit of "alarmbits"
 85D7 [03] 200C      1907       bra     HET_ALARM_DONE               ; Branch to HET_ALARM_DONE:
                     1908  
                     1909  CHK_HET_HI:
 85D9 [04] C1E434    1910       cmp     heton                        ; Compare with "heton" (240=200 degrees F)
 85DC [03] 2402      1911       bhs     SET_HET                      ; If A greater or same as M, branch to SET_HET:
 85DE [03] 2005      1912       bra     HET_ALARM_DONE               ; Branch to HET_ALARM_DONE:
                     1913  
                     1914  SET_HET:
 85E0 [05] 026402    1915       brset   HET,alarmbits,HET_ALARM_DONE ; If "HET" bit of "alarmbits" is set, branch to
                     1916                                            ; HET_ALARM_DONE:
 85E3 [04] 1264      1917       bset    HET,alarmbits                ; Set "HET" bit of "alarmbits"
                     1918  
                     1919  HET_ALARM_DONE:
                     1920  
                     1921  ;LOP_ALARM:
 85E5 [03] B649      1922       lda     OP_ADC                       ; Load accumulator with value in "OP_ADC"
 85E7 [04] C1E436    1923       cmp     lopon                        ; Compare with "lopon" (92=20 PSI)
 85EA [03] 2302      1924       bls     SET_LOP                      ; If A lower or same as M, branch to SET_LOP:
 85EC [03] 2007      1925       bra     CHK_LOP_HI                   ; Branch to CHK_LOP_HI:
                     1926  
                     1927  SET_LOP:
 85EE [05] 006410    1928       brset   LOP,alarmbits,LOP_ALARM_DONE ; If "LOP" bit of "alarmbits" is set, branch to
                     1929                                            ; LOP_ALARM_DONE:
 85F1 [04] 1064      1930       bset    LOP,alarmbits                ; Set "LOP" bit of "alarmbits"
 85F3 [03] 200C      1931       bra     LOP_ALARM_DONE               ; Branch to LOP_ALARM_DONE:
                     1932  
                     1933  CHK_LOP_HI:
 85F5 [04] C1E437    1934       cmp     lopoff                       ; Compare with "lopoff" (102=25 PSI)
 85F8 [03] 2402      1935       bhs     CLEAR_LOP                    ; If A greater or same as M, branch to CLEAR_LOP:
 85FA [03] 2005      1936       bra     LOP_ALARM_DONE               ; Branch to LOP_ALARM_DONE:
                     1937  
                     1938  CLEAR_LOP:
 85FC [05] 016402    1939       brclr   LOP,alarmbits,LOP_ALARM_DONE ; If "LOP" bit of "alarmbits" is clear, branch to
                     1940                                            ; LOP_ALARM_DONE:
 85FF [04] 1164      1941       bclr    LOP,alarmbits                ; Clear "LOP" bit of "alarmbits"
                     1942  
                     1943  LOP_ALARM_DONE:
                     1944  
                     1945  ;HEGT_ALARM:
 8601 [03] B64B      1946       lda     EGT_ADC                        ; Load accumulator with value in "EGT_ADC"
 8603 [04] C1E439    1947       cmp     hegtoff                        ; Compare with "hegtoff" (181=950 degrees F)
 8606 [03] 2302      1948       bls     CLEAR_HEGT                     ; If A lower or same as M, branch to CLEAR_HEGT:
 8608 [03] 2007      1949       bra     CHK_HEGT_HI                    ; Branch to CHK_HEGT_HI:
                     1950  
                     1951  CLEAR_HEGT:
 860A [05] 096410    1952       brclr   HEGT,alarmbits,HEGT_ALARM_DONE ; If "HEGT" bit of "alarmbits" is clear,
                     1953                                              ; branch to HEGT_ALARM_DONE:
 860D [04] 1964      1954       bclr    HEGT,alarmbits                 ; Clear "HEGT" bit of "alarmbits"
 860F [03] 200C      1955       bra     HEGT_ALARM_DONE                ; Branch to HEGT_ALARM_DONE:
                     1956  
                     1957  CHK_HEGT_HI:
 8611 [04] C1E438    1958       cmp     hegton                         ; Compare with "hegton" (191=1000 degrees F)
 8614 [03] 2402      1959       bhs     SET_HEGT                       ; If A greater or same as M, branch to SET_HEGT:
 8616 [03] 2005      1960       bra     HEGT_ALARM_DONE                ; Branch to HEGT_ALARM_DONE:
                     1961  
                     1962  SET_HEGT:
 8618 [05] 086402    1963       brset   HEGT,alarmbits,HEGT_ALARM_DONE ; If "HET" bit of "alarmbits" is set, branch to
                     1964                                              ; HEGT_ALARM_DONE:


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 17
MC68HC908GP32 User Bootloader


 861B [04] 1864      1965       bset    HEGT,alarmbits                 ; Set "HEGT" bit of "alarmbits"
                     1966  
                     1967  HEGT_ALARM_DONE:
                     1968  
                     1969  ;FP_ALARM
 861D [03] B64A      1970       lda     FP_ADC                       ; Load accumulator with value in "EGT_ADC"
 861F [04] C1E43A    1971       cmp     lfpon                        ; Compare with "lfpon" (102=25 PSI)
 8622 [03] 2302      1972       bls     SET_LFP                      ; If A lower or same as M, branch to SET_LFP:
 8624 [03] 2007      1973       bra     CHK_LFP_HI                   ; Branch to CHK_LFP_HI:
                     1974  
                     1975  SET_LFP
 8626 [05] 046410    1976       brset   LFP,alarmbits,LFP_ALARM_DONE ; If "LFP: bit of "alarmbits" is set, branch to
                     1977                                            ; LFP_ALARM_DONE:
 8629 [04] 1464      1978       bset    LFP,alarmbits                ; Set "LFP" bit of "alarmbits"
 862B [03] 200C      1979       bra     LFP_ALARM_DONE               ; Branch to LFP_ALARM_DONE:
                     1980  
                     1981  CHK_LFP_HI:
 862D [04] C1E43B    1982       cmp     lfpoff                       ; Compare with "lfpoff" (112=30 PSI)
 8630 [03] 2402      1983       bhs     CLEAR_LFP                    ; If A higher or same as M, branch to CLEAR_LFP:
 8632 [03] 2005      1984       bra     LFP_ALARM_DONE               ; Branch to LFP_ALARM_DONE:
                     1985  
                     1986  CLEAR_LFP:
 8634 [05] 056402    1987       brclr   LFP,alarmbits,LFP_ALARM_DONE ; If "LFP" bit of "alarmbits" is clear, branch to
                     1988                                            ; LFP_ALARM_DONE:
 8637 [04] 1564      1989       bclr    LFP,alarmbits                ; Clear "LFP" bit of "alarmbits"
                     1990  
                     1991  LFP_ALARM_DONE:
                     1992  
 8639 [04] C1E43D    1993       cmp     hfpoff                       ; Compare with "hfpoff" (143=45 PSI)
 863C [03] 2302      1994       bls     CLEAR_HFP                    ; If A lower or same as M, branch to CLEAR_HFP:
 863E [03] 2007      1995       bra     CHK_HFP_HI                   ; Branch to CHK_HFP_HI:
                     1996  
                     1997  CLEAR_HFP
 8640 [05] 076410    1998       brclr   HFP,alarmbits,HFP_ALARM_DONE ; If "HFP: bit of "alarmbits" is clear, branch to
                     1999                                            ; HFP_ALARM_DONE:
 8643 [04] 1764      2000       bclr    HFP,alarmbits                ; Clear "HFP" bit of "alarmbits"
 8645 [03] 200C      2001       bra     HFP_ALARM_DONE               ; Branch to HFP_ALARM_DONE:
                     2002  
                     2003  CHK_HFP_HI:
 8647 [04] C1E43C    2004       cmp     hfpon                        ; Compare with "hfpon" (153=50 PSI)
 864A [03] 2402      2005       bhs     SET_HFP                      ; If A higher or same as M, branch to SET_HFP:
 864C [03] 2005      2006       bra     HFP_ALARM_DONE               ; Branch to HFP_ALARM_DONE:
                     2007  
                     2008  SET_HFP:
 864E [05] 066402    2009       brset   HFP,alarmbits,HFP_ALARM_DONE ; If "HFP" bit of "alarmbits" is set, branch to
                     2010                                            ; HFP_ALARM_DONE:
 8651 [04] 1664      2011       bset    HFP,alarmbits                ; Set "HFP" bit of "alarmbits"
                     2012  
                     2013  HFP_ALARM_DONE:
                     2014  
                     2015  ;***********************************************************************************************
                     2016  ; Check to see if any of the engine alarm flags are set and energise or de-energise the
                     2017  ; alarm relay as required. If the cause of the alarm is a knock detection only, do not energise
                     2018  ; the alarm relay unless ignition trim or fuel trim has been activated. This is a band aid
                     2019  ; measure to get around knock detector nuisance trips.
                     2020  ;
                     2021  ; LOP      = 00000001 = 1T   = #$01
                     2022  ; HET      = 00000010 = 2T   = #$02
                     2023  ; LFP      = 00000100 = 4T   = #$04
                     2024  ; HFP      = 00001000 = 8T   = #$08
                     2025  ; HEGT     = 00010000 = 16T  = #$10
                     2026  ; REVL     = 00100000 = 32T  = #$20
                     2027  ; fldclr   = 01000000 = 64T  = #$40
                     2028  ; knocking = 10000000 = 128T = #$80
                     2029  ;
                     2030  ;***********************************************************************************************
                     2031  
                     2032  ;ALARM_CHK:
 8653 [03] B664      2033       lda     alarmbits                      ; Load accumulaotr with value in "alarmbits"
 8655 [04] 410016    2034       cbeqa   #$00,ALARM_OFF                 ; If equal to "0" branch to ALARM_OFF:
 8658 [05] 00661A    2035       brset   EAon,portCbits,ALARM_CHK_DONE  ; If "EAon" bit of "portCbits" is already set,
                     2036                                              ; branch to ALARM_CHK_DONE:
 865B [04] 418006    2037       cbeqa   #$80,KNOCK_ALARM               ; If equal to decimal 128 branch to KNOCK_ALARM:
                     2038  
                     2039  ALARM_ON:
 865E [04] 1202      2040       bset    Eng_Alrm,PORTC                 ; Energise alarm relay
 8660 [04] 1066      2041       bset    EAon,portCbits                 ; Set "EAon" bit of "portCbits"
 8662 [03] 2011      2042       bra     ALARM_CHK_DONE                 ; Branch to ALARM_CHK_DONE:
                     2043  
                     2044  KNOCK_ALARM:
 8664 [05] 0465F7    2045       brset   ITen,portAbits,ALARM_ON        ; If "ITen" bit of "portAbits" is set, branch
                     2046                                              ; to ALARM_ON:
 8667 [05] 0A65F4    2047       brset   FTen,portAbits,ALARM_ON        ; If "FTen" bit of "portAbits" is set, branch
                     2048                                              ; to ALARM_ON:
 866A [04] 1066      2049       bset    EAon,portCbits                 ; Set "EAon" bit of "portCbits"
 866C [03] 2007      2050       bra     ALARM_CHK_DONE                 ; Branch to ALARM_CHK_DONE:
                     2051  
                     2052  ALARM_OFF:
 866E [05] 016604    2053       brclr   EAon,portCbits,ALARM_CHK_DONE  ; If "EAon" bit of "portCbits" is already clear,
                     2054                                              ; branch to ALARM_CHK_DONE:
 8671 [04] 1302      2055       bclr    Eng_Alrm,PORTC                 ; De-Energise alarm relay
 8673 [04] 1166      2056       bclr    EAon,portCbits                 ; Clear "EAon" bit of "portCbits"
                     2057  
                     2058  ALARM_CHK_DONE:
                     2059  
                     2060  ;***********************************************************************************************
                     2061  ; - Spark scheduling, as well as RPM calculations are done only once in the
                     2062  ;   main loop after the PIP rising edge signal has been received, the
                     2063  ;   interrupt routine has been completed, and relevent variables updated.
                     2064  ;***********************************************************************************************
                     2065  
 8675 [05] 006B03    2066       brset   piprise,inputs,PIP_PASS          ; If "piprise" bit of "inputs" variable is set,
                     2067                                                ; branch to PIP_PASS:
 8678 [03] CC8789    2068       jmp     NO_PIP_PASS                      ; Jump to NO_PIP_PASS:
                     2069  
                     2070  PIP_PASS:
                     2071  
                     2072  ;***********************************************************************************************
                     2073  ;
                     2074  ; ------------- IGNITION CALCULATION and SCHEDULING SECTION -----------------
                     2075  ;
                     2076  ; To simplify the igntion calculations, the angles are scaled by a factor of
                     2077  ; 256. The PIP Angle Factor is 256, and all other angles are scaled to this.
                     2078  ;
                     2079  ;***********************************************************************************************
                     2080  
                     2081  ;***********************************************************************************************
                     2082  ; - Calculate Period
                     2083  ;   PIP_tsH:PIP_tsL - PIP_tsH_prv:PIP_tsL_prv = PIP_pH:PIP_pL
                     2084  ;***********************************************************************************************
                     2085  
                     2086  IGNITION_CALCS:
 867B [03] B6A8      2087       lda     PIP_tsL        ; Load accumulator with value in PIP timestamp Lo byte
 867D [03] B0AA      2088       sub     PIP_tsL_prv    ; Subtract A<-(A)-(M) PIP Timestamp previous Lo byte
 867F [03] B7B0      2089       sta     PIP_pL         ; Copy result to PIP period Lo byte variable
 8681 [03] B7CF      2090       sta     tachcurL       ; Copy to "tachcurL"
 8683 [03] B6A7      2091       lda     PIP_tsH        ; Load accumulator with value in PIP timestamp Hi byte
 8685 [03] B2A9      2092       sbc     PIP_tsH_prv    ; Subtract with carry A<-(A)-(M)-(C)
                     2093                              ;(PIP Timestamp previous Hi byte)
 8687 [03] B7AF      2094       sta     PIP_pH         ; Copy result to PIP period Hi byte variable
 8689 [03] B7CE      2095       sta     tachcurH       ; Copy to "tachcurH"
                     2096  
                     2097  ;***********************************************************************************************
                     2098  ; - 1/02/11 Skip the "predicted period" thing to see if it makes any real world difference
                     2099  ;***********************************************************************************************
                     2100  


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 18
MC68HC908GP32 User Bootloader


 868B [03] B6B0      2101       lda     PIP_pL          ; Load accumulator with value in "PIP_pL"
 868D [03] B7B2      2102       sta     PIP_pL_pred     ; Copy to "PIP_pL_pred"(for SPOUT on calcs)
 868F [03] B7BA      2103       sta     PIP_PeriodL     ; Copy to "PIP_PeriodL"(for SPOUT off calcs)
 8691 [03] B6AF      2104       lda     PIP_pH          ; Load accumulator with value in "PIP_pH"
 8693 [03] B7B1      2105       sta     PIP_pH_pred     ; Copy to "PIP_pH_pred"(for SPOUT on calcs)
 8695 [03] B7B9      2106       sta     PIP_PeriodH     ; Copy to "PIP_PeriodH"(for SPOUT off calcs)
                     2107  
                     2108  
                     2109  ;*;***********************************************************************************************
                     2110  ;*; - Calculate "predicted" period to compensate for acceleration/deceleration
                     2111  ;*;***********************************************************************************************
                     2112  
                     2113  ;*     lda     PIP_pL          ; Load accumulator with value in "PIP_pL"
                     2114  ;*     sub     PIP_pL_prv      ; Subtract A<-(A)-(M)(PIP_pL - PIP_pL_prv = PIP_pL_dif)
                     2115  ;*     sta     PIP_pL_dif      ; Copy result to "PIP_pL_dif" variable
                     2116  ;*     lda     PIP_pH          ; Load accumulator with value in "PIP_pH"
                     2117  ;*     sbc     PIP_pH_prv      ; Subtract with carry A<-(A)-(M)-(C)
                     2118                               ;(PIP_pH - PIP_pH_prv = PIP_pH_dif)
                     2119  ;*     sta     PIP_pH_dif      ; Copy result to "PIP_pH_dif" variable
                     2120  ;*     lda     PIP_pL          ; Load accumulator with value in "PIP_pL"
                     2121  ;*     add     PIP_pL_dif      ; Add without Carry A<-(A)+(M)(PIP_pL + PIP_pL_dif = PIP_pL_pred)
                     2122  ;*     sta     PIP_pL_pred     ; Copy to "PIP_pL_pred" variable(for SPOUT on calcs)
                     2123  ;*     sta     PIP_PeriodL     ; Copy to PIP Period Lo byte(for SPOUT off calcs)
                     2124  ;*     lda     PIP_pH          ; Load accumulator with value in "PIP_pH"
                     2125  ;*     adc     PIP_pH_dif      ; Add with Carry A<-(A)+(M)
                     2126                               ; (PIP_pH + PIP_pH_dif = PIP_pH_pred)
                     2127  ;*     sta     PIP_pH_pred     ; Copy to "PIP_pH_pred" variable(for SPOUT on calcs)
                     2128  ;*     sta     PIP_PeriodH     ; Copy to PIP Period Hi byte(for SPOUT off calcs)
                     2129  
                     2130  ;***********************************************************************************************
                     2131  ; - Calculate delay time from PIP rising edge to drive SPOUT Hi (on).
                     2132  ;   This is a magical bit of code that Magnus uses and took me the longest
                     2133  ;   time to understand. I originally developed the long math routine version
                     2134  ;   with UMUL32 and UDVD32,,which worked, but got my program loop frequency
                     2135  ;   down to about 768HZ @ ~6450RPM 8cyl, where the ignition starts to falter.
                     2136  ;   This code runs at ~973HZ @ ~6450, and 963HZ @ ~8205RPM 8cyl until falter.
                     2137  ;   (The falter may be due to the duty cycle of my "superstim" IRQ input.)
                     2138  ;   It is simply an 8 bit by 16 bit multiply, which yields a 24 bit result.
                     2139  ;   By ignoring the least significant byte, you effectively divide the 24
                     2140  ;   bit result by 256, rounded down.
                     2141  ;   So, the PIP Period Predicted * Delay Angle Factor / PIP Angle Factor
                     2142  ;   = Delay Period
                     2143  ;
                     2144  ;   PIP_pH_pred:PIP_pL_pred * Dly_Ang_Fac / $01:00 = Delay_pH:Delay_pL.
                     2145  ;
                     2146  ;***********************************************************************************************
                     2147  
                     2148  ;DELAY_CALC:
 8697 [03] B65F      2149       lda     Dly_Ang_Fac     ; Load accumulator with value in Delay Angle Factor
 8699 [03] BEB1      2150       ldx     PIP_pH_pred     ; Load index register Lo byte with value in PIP period predicted Hi
 869B [05] 42        2151       mul                     ; Multiply (X:A)<-(X)*(A)
 869C [03] BF91      2152       stx     tmp1            ; Copy value in index register Lo byte to tmp1 variable
                     2153                               ; (result Hi byte)
 869E [03] B792      2154       sta     tmp2            ; Copy value in accumulator to tmp2 variable
                     2155                               ;(result Lo byte)
 86A0 [03] B65F      2156       lda     Dly_Ang_Fac     ; Load accumulator with value in Delay
 86A2 [03] BEB2      2157       ldx     PIP_pL_pred     ; Load index register Lo byte with value in PIP period predicted Lo
 86A4 [05] 42        2158       mul                     ; Multiply (X:A)<-(X)*(A)
 86A5 [01] 9F        2159       txa                     ; Transfer value in index register Lo byte to accumulator
                     2160                               ;(result Hi byte to accumulator)
 86A6 [03] BB92      2161       add     tmp2            ; Add (A)<-(A)+(M)(Lo byte result of Hi byte
                     2162                               ; mul + Hi byte result of Lo byte mul)
 86A8 [03] B7B4      2163       sta     Delay_pL        ; Copy result to Delay Period Lo byte variable
 86AA [03] B691      2164       lda     tmp1            ; Load accumulator with value in tmp1 variable
                     2165                               ;(Hi byte result of Hi byte mul)
 86AC [02] A900      2166       adc     #$0             ; Add with carry decimal 0 (A)<-(A)+(M)+(C)(just add the carry)
 86AE [03] B7B3      2167       sta     Delay_pH        ; Copy result to Delay Period Hi byte variable
                     2168  
                     2169  
                     2170  ;***********************************************************************************************
                     2171  ; - Calculate the output compare value for delay from PIP to SPOUT
                     2172  ;   PIP_tsH:PIP_tsL + Delay_pH:Delay_pL = CH1_onH:CH1_onL
                     2173  ;***********************************************************************************************
                     2174  
                     2175  ;CALC_OC:
 86B0 [03] B6A8      2176       lda     PIP_tsL            ; Load accumulator with value in "PIP_tsL"
 86B2 [03] BBB4      2177       add     Delay_pL           ; Add without Carry A<-(A)+(M)(PIP_tsL + Delay_pL)
 86B4 [01] 97        2178       tax                        ; Transfer result in accumulator to index register Lo byte
 86B5 [03] B6A7      2179       lda     PIP_tsH            ; Load accumulator with value in "PIP_tsH"
 86B7 [03] B9B3      2180       adc     Delay_pH           ; Add with Carry A<-(A)+(M)
 86B9 [03] B7B5      2181       sta     CH1_onH            ; Copy to CH1 on O/C value Hi byte
 86BB [03] BFB6      2182       stx     CH1_onL            ; Copy to CH1 on O/C value Lo byte
 86BD [04] 1269      2183       bset    schedspk,engine2   ; Set "schedspk" bit of "engine2" variable
                     2184  
                     2185  
                     2186  ;***********************************************************************************************
                     2187  ; - Calculate SPOUT on time (50% duty cycle, half PIP predicted period)
                     2188  ;***********************************************************************************************
                     2189  
 86BF [03] BEBA      2190       ldx     PIP_periodL      ; Load index register Lo byte with value in PIP Period Lo byte
 86C1 [03] B6B9      2191       lda     PIP_periodH      ; Load accumulator with value in PIP Period Hi byte
 86C3 [01] 44        2192       lsra                     ; Logical shift right accumulator
 86C4 [01] 56        2193       rorx                     ; Rotate right through carry index register Lo byte
                     2194                                ; (these 2 steps = A:X / 2)
 86C5 [03] B7BB      2195       sta     SPOUTon_pH       ; Copy to Spout on period Hi byte
 86C7 [03] BFBC      2196       stx     SPOUTon_pL       ; Copy to Spout on period Lo byte
                     2197  
                     2198  
                     2199  ;***********************************************************************************************
                     2200  ; - Save the current timestamp as timestamp previous for next calculations
                     2201  ;***********************************************************************************************
                     2202  
 86C9 [05] 4EA7A9    2203       mov     PIP_tsH,PIP_tsH_prv  ; Copy value in PIP_tsH to PIP_tsH_prv
 86CC [05] 4EA8AA    2204       mov     PIP_tsL,PIP_tsL_prv  ; Copy value in PIP_tsL to PIP_tsL_prv
                     2205  
                     2206  
                     2207  ;***********************************************************************************************
                     2208  ; - Save the current period as period previous for next calculations
                     2209  ;***********************************************************************************************
                     2210  
 86CF [05] 4EAFAB    2211       mov     PIP_pH,PIP_pH_prv  ; Copy value in PIP_pH to PIP_pH_prv
 86D2 [05] 4EB0AC    2212       mov     PIP_pL,PIP_pL_prv  ; Copy value in PIP_pL to PIP_pL_prv
                     2213  
                     2214  ;IGN_CALCS_DONE:
                     2215  
                     2216  ;***********************************************************************************************
                     2217  ;
                     2218  ; ---------------------------------- RPM CALCULATION SECTION -----------------------------------
                     2219  ;
                     2220  ; RPM = CONSTANT/PERIOD
                     2221  ; Where:
                     2222  ; RPM         = Engine RPM
                     2223  ; RPM_K = 16 bit constant using .1ms clock tick (10khz)
                     2224  ;               ((10,000tickpsec*60secpmin)/(number of cyl/(stroke/2)))
                     2225  ; RPM_P = 16 bit period count between IRQ pulsed lines in 0.1ms
                     2226  ;               resolution
                     2227  ;   RPM_K
                     2228  ;   ----- = RPM
                     2229  ;   RPM_P
                     2230  ;
                     2231  ; 6cyl 4stroke RPMK = ((10,000*60)/3) = 200,000
                     2232  ; 8cyl 4stroke RPMK = ((10,000*60)/4) = 150,000
                     2233  ;
                     2234  ; We use the 100uS clock tick to calculate RPM/20. This allows us to use an
                     2235  ; 8 bit variable with a range of 0 to 5,100 RPM
                     2236  ; Our formula is now:


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 19
MC68HC908GP32 User Bootloader


                     2237  ;
                     2238  ; rpm = constant/period
                     2239  ; Where:
                     2240  ; rpm         = Engine RPM/20 (0 to 5,100 RPM to fit in 8 bit variable)
                     2241  ; RPMk:RPMk+1 = 16 bit constant using 100uS clock tick (10khz)
                     2242  ;               ((10,000tickpsec*60secpmin)/(number of cyl/(stroke/2)))/20
                     2243  ; RPMpH:RPMpL = 16 bit period count between IRQ pulsed lines in 100uS
                     2244  ;               resolution
                     2245  ;   rpmk:rpmk+1
                     2246  ;   ----------- = rpm
                     2247  ;   RPMpH:RPMpL
                     2248  ;
                     2249  ; 6cyl 4stroke rpmK = ((10,000*60)/3)/20 = 10,000 = $2710
                     2250  ; 8cyl 4stroke rpmK = ((10,000*60)/4)/20 = 7,500  = $1D4C
                     2251  ; 6cyl RPM resolution is ~05@~1000, ~20@~2000, ~76@~3000, and ~128@~5000
                     2252  ; 8cyl RPM resolution is ~06@~1000, ~27@~2000, ~61@~3000, and ~172@~5000
                     2253  ;***********************************************************************************************
                     2254  
                     2255  ;***********************************************************************************************
                     2256  ; - Calculate Engine RPM/20.
                     2257  ;***********************************************************************************************
                     2258  
                     2259  ;RPM_COMP:
 86D5 [04] 5575      2260       ldhx    RPMph               ; Load index register with value in RPM Period Hy byte
 86D7 [03] 2728      2261       beq     RPM_CALC_DONE       ; If Z bit of CCR is set, branch to RPM_CALC_DONE:
 86D9 [02] 8B        2262       pshh                        ; Push value in index register Hi byte to stack
 86DA [02] 86        2263       pula                        ; Pull value in stack to accumulator
 86DB [01] 4D        2264       tsta                        ; Test accumulator for Z or N
 86DC [03] 2717      2265       beq     FAST_RPM_CALC       ; If the Z bit of CCR is set, branch to FAST_RPM_CALC:
                     2266  
                     2267  ;SLOW_RPM_CALC:
 86DE [03] 3F89      2268       clr     intacc1             ; Clear intacc1 variable
 86E0 [03] 3F8A      2269       clr     intacc1+1           ; Clear intacc1+1 variable
 86E2 [04] 358D      2270       sthx    intacc2             ; Copy value in index register to intacc2 variable
 86E4 [02] A61D      2271       lda     #$1D                ; Load accumulator with $1D ("RPMk")
 86E6 [03] B78B      2272       sta     intacc1+2           ; Copy to "intacc1+2
 86E8 [02] A64C      2273       lda     #$4C                ; Load accumulator with $4C ("RPMk+1")
 86EA [03] B78C      2274       sta     intacc1+3           ; Copy to "intacc1+3"
 86EC [05] CD905F    2275       jsr     udvd32              ; Jump to subroutine udvd32 (32x16 divide)
 86EF [03] B68C      2276       lda     intacc1+3           ; Load accumulator with value in intacc1+3(8-bit RPM result)
 86F1 [03] B753      2277       sta     rpm20               ; Copy to "rpm20"
 86F3 [03] 200C      2278       bra     RPM_CALC_DONE       ; Branch to RPM_CALC_DONE:
                     2279  
                     2280  FAST_RPM_CALC:
 86F5 [02] A61D      2281       lda     #$1D          ; Load accumulator with $1D (RPMk)
 86F7 [02] 87        2282       psha                  ; Push value in accumulator to stack
 86F8 [02] 8A        2283       pulh                  ; Pull value from stack to index register Hi byte
 86F9 [02] A64C      2284       lda     #$4C          ; Load accumulator with $4C (rpmk+1)
 86FB [07] 52        2285       div                   ; Divide (A = (H:A) / X)
 86FC [05] CD90EB    2286       jsr     DIVROUND      ; Jump to "DIVROUND" subroutine,(round result)
 86FF [03] B753      2287       sta     rpm20         ; Copy to "rpm20"
                     2288  
                     2289  RPM_CALC_DONE:
                     2290  
                     2291  ;**********************************************************************************************
                     2292  ; - Check for over speed. If overspeed, set the alarm bit which will skip over the Injector
                     2293  ;   Firing Control in the 100uS section which should slow things down in a hurry
                     2294  ;;**********************************************************************************************
                     2295  
 8701 [03] B653      2296       lda     rpm20                       ; Load accumulator with value in "rpm20"
 8703 [04] C1E43F    2297       cmp     revloff                     ; Compare with "revloff" (175=3500RPM)
 8706 [03] 2302      2298       bls     NO_REV_LIMIT                ; If (A=<(M), branch to NO_REV_LIMIT:
 8708 [03] 2007      2299       bra     CHK_REV_LIMIT               ; Branch to CHK_REV_LIMIT:
                     2300  
                     2301  NO_REV_LIMIT:
 870A [05] 0B6410    2302       brclr   REVL,alarmbits,REV_LIM_DONE ; If "REVL" bit of "alarmbits" is clear, branch to
                     2303                                           ; REV_LIM_DONE:(bit already clear, skip over)
 870D [04] 1B64      2304       bclr    REVL,alarmbits              ; Clear "REVL" bit of "alarmbits"
 870F [03] 200C      2305       bra     REV_LIM_DONE                ; Branch to REV_LIM_DONE
                     2306  
                     2307  CHK_REV_LIMIT:
 8711 [04] C1E43E    2308       cmp     revlon                      ; Compare with "revlon" (225=4500RPM)
 8714 [03] 2402      2309       bhs     REV_LIMIT                   ; If (A=>(M), branch to REV_LIMIT:
 8716 [03] 2005      2310       bra     REV_LIM_DONE                ; Branch to REV_LIM_DONE
                     2311  
                     2312  REV_LIMIT:
 8718 [05] 0A6402    2313       brset   REVL,alarmbits,REV_LIM_DONE ; If "REVL" bit of "alarmbits" is set, branch to
                     2314                                           ; REV_LIM_DONE:(bit already set, skip over)
 871B [04] 1A64      2315       bset    REVL,alarmbits              ; Set "REVL" bit of "alarmbits"
                     2316  
                     2317  REV_LIM_DONE:
                     2318  
                     2319  ;***********************************************************************************************
                     2320  ; - Determine if engine RPMs are high enough that the ~1uS TIM2 counter
                     2321  ;   won't overflow between PIP signals, and that the engine has actually
                     2322  ;   started.(for ignition calcs)
                     2323  ;   At ~1uS, 65535 rollover occurs at 305.18 RPM 6cyl, and 228.88 RPM 8cyl
                     2324  ;   Start/Run break point for fuel is at 320 RPM, so this Lo limit is
                     2325  ;   set to 340 RPM
                     2326  ;***********************************************************************************************
                     2327  
 871D [03] B653      2328       lda     rpm20             ; Load accumulator with value in RPM/20
 871F [04] C1E440    2329       cmp     runon             ; Compare it with "runon" (17=340 RPM)
 8722 [03] 2204      2330       bhi     SET_RUN_E2        ; If (A)>(M), branch to SET_RUN_E2:
 8724 [04] 1169      2331       bclr    run,engine2       ; Clear "run" bit of "engine2" variable
 8726 [03] 2002      2332       bra     CHK_LO_SPD_DONE   ; Branch to CHK_LO_SPD_DONE:
                     2333  
                     2334  SET_RUN_E2:
 8728 [04] 1069      2335       bset    run,engine2       ; Set "run" bit of "engine2" variable
                     2336  
                     2337  CHK_LO_SPD_DONE:
                     2338  
                     2339  ;***********************************************************************************************
                     2340  ; - The high resolution tach uses a time stamp from the ~1uS counters T2CNTH:T2CNTL which
                     2341  ;   overflows at 306.044 RPM for 6 cyl, and 227.84 RPM for 8 cyl engines.
                     2342  ;   It is saved as tachcurH:tachcurL
                     2343  ;
                     2344  ;   Resolution @ 5000 RPM is 1.25 RPM 6 cyl, 1.67 RPM 8 cyl
                     2345  ;   Resolution @ 2500 RPM is 0.31 RPM 6 cyl, 0.42 RPM 8 cyl
                     2346  ;   Resolution @ 1000 RPM is 0.05 RPM 6 cyl, 0.07 RPM 8 cyl
                     2347  ;
                     2348  ;   tachcurH:tachcurL is added to tachTH:tachTM:TachTL for 250 ms, then divided by the value of
                     2349  ;   "tachcnt" which was incemented at every trigger signal, to smooth the read out.
                     2350  ;
                     2351  ;***********************************************************************************************
                     2352  
                     2353  ;***********************************************************************************************
                     2354  ; - First make sure that our engine speed is above roll over point for the 16 bit period value.
                     2355  ;   If it is, do the Hi Res tach period averaging calculations, if not rail tachH:tachL, clear
                     2356  ;   "tachcnt" so it will be at zero when the revs are within range and skip over.
                     2357  ;***********************************************************************************************
                     2358  
 872A [05] 00690B    2359       brset   run,engine2,HI_RES_TACH     ; If "run" bit of "engine2" variable is set,
                     2360                                           ; branch to HI_RES_TACH:
 872D [02] A6FF      2361       lda     #$FF                        ; Load accumulator with decimal 255
 872F [03] B75B      2362       sta     tachH                       ; Copy to "tachH"
 8731 [03] B75C      2363       sta     tachL                       ; Copy to "tachL"
 8733 [03] 3FD3      2364       clr     tachcnt                     ; Clear "tachcnt"
 8735 [03] CC877A    2365       jmp     HI_RES_TACH_DONE            ; Branch to HI_RES_TACH_DONE:
                     2366  
                     2367  HI_RES_TACH:
 8738 [03] B6D2      2368       lda     tachTL       ; Load accumulator with value in "tachTL" (total Lo byte)
 873A [03] BBCF      2369       add     tachcurL     ; Add "tachcurL" A<-(A)+(M)(current period Lo Byte)
 873C [03] B7D2      2370       sta     tachTL       ; Copy to "tachTL"(result Lo byte)(updated total Lo byte
 873E [03] B6D1      2371       lda     tachTM       ; Load accumulator with value in "tachTM" (total Mid byte)
 8740 [03] B9CE      2372       adc     tachcurH     ; Add with carry "tachcurH" A<-(A)+(M)(current period Hi Byte)


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 20
MC68HC908GP32 User Bootloader


 8742 [03] B7D1      2373       sta     tachTM       ; Copy to "tachTM"(result Mid byte)(updated total Mid byte
 8744 [03] B6D0      2374       lda     tachTH       ; Load accumulator with value in "tachTH" (total Hi Byte)
 8746 [02] A900      2375       adc     #$0          ; Add with carry decimal zero A<-(A)+(M)(just the carry)
 8748 [03] B7D0      2376       sta     tachTH       ; Copy to "tachTH"(result Hi byte)(updated total Hi byte
                     2377  
                     2378  ;***********************************************************************************************
                     2379  ; - Check "clock250,inputs" to see if it's time to average the period values
                     2380  ;***********************************************************************************************
                     2381  
 874A [05] 0A6B02    2382       brset   clock250,inputs,AV_HI_RES_PERIOD     ; If "clock250" bit of "inputs variable is
                     2383                                                    ; set, branch to AV_HO_RES_PERIOD:
 874D [03] 202B      2384       bra     HI_RES_TACH_DONE                     ; Branch to HI_RES_TACH_DONE:
                     2385  
                     2386  AV_HI_RES_PERIOD:
 874F [03] 3F89      2387       clr     intacc1             ; Clear intacc1 (divident Hi Byte)
 8751 [03] 3F8A      2388       clr     intacc1+1           ; Clear intacc1+1 (dividend Mid Hi Byte)
 8753 [03] 3F8D      2389       clr     intacc2             ; Clear intacc2 (divisor Hi Byte)
 8755 [03] B6D0      2390       lda     tachTH              ; Load accumulator with value in "tachTH"
 8757 [03] B78A      2391       sta     intacc1+1           ; Copy to intacc1+1 (dividend Mid Hi Byte)
 8759 [03] B6D1      2392       lda     tachTM              ; Load accumulator with value in "tachTM"
 875B [03] B78B      2393       sta     intacc1+2           ; Copy to intacc1+2 (dividend Mid Lo Byte)
 875D [03] B6D2      2394       lda     tachTL              ; Load accumulator with value in "tachTL"
 875F [03] B78C      2395       sta     intacc1+3           ; Copy to intacc1+3 (dividend Lo Byte)
 8761 [03] B6D3      2396       lda     tachcnt             ; Load accumulator with value in "tachcnt"
 8763 [03] B78E      2397       sta     intacc2+1           ; Copy to intacc2+1 (divisor Lo Byte)
 8765 [05] CD905F    2398       jsr     udvd32              ; Jump to "udcd32" subroutine (32x16 divide)
 8768 [03] B68C      2399       lda     intacc1+3           ; Load accumulator with value in intacc1+3 (result Lo Byte)
 876A [03] B75C      2400       sta     tachL               ; Copy to "tachL"
 876C [03] B68B      2401       lda     intacc1+2           ; Load accumulator with value in intacc1+2 (result Hi Byte)
 876E [03] B75B      2402       sta     tachH               ; Copy to "tachH"
 8770 [03] 3FD0      2403       clr     tachTH              ; Clear "tachTH" (total Hi Byte)
 8772 [03] 3FD1      2404       clr     tachTM              ; Clear "tachTM" (total Mid Byte)
 8774 [03] 3FD2      2405       clr     tachTL              ; Clear "tachTL" (total Lo Byte)
 8776 [03] 3FD3      2406       clr     tachcnt             ; Clear "tachcnt" (tachometer period averaging counter)
 8778 [04] 1B6B      2407       bclr    clock250,inputs     ; Clear "clock250" bit of "inputs" variable
                     2408  
                     2409  HI_RES_TACH_DONE:
                     2410  
                     2411  ;***********************************************************************************************
                     2412  ; - Determine if engine RPMs are high enough that we have finished cranking,
                     2413  ;   and that the engine has actually started. (for fuel calcs)
                     2414  ;***********************************************************************************************
                     2415  
                     2416  ;CHK_CRANK:
 877A [03] B653      2417       lda     rpm20             ; Load accumulator with value in RPM/20
 877C [04] C1E441    2418       cmp     startedon         ; Compare it with "startedon" (17=340 RPM)
 877F [03] 2204      2419       bhi     ENG_START         ; If (A)>(M), branch to ENG_START:
 8781 [04] 1769      2420       bclr    started,engine2   ; Clear "started" bit of "engine2" variable
 8783 [03] 2002      2421       bra     PIP_PASS_DONE     ; Branch to PIP_PASS_DONE:
                     2422  
                     2423  ENG_START:
 8785 [04] 1669      2424       bset    started,engine2   ; Set "started" bit of "engine2" variable
                     2425  
                     2426  PIP_PASS_DONE:
 8787 [04] 116B      2427       bclr    piprise,inputs    ; Clear "piprise" bit of "inputs" variable
                     2428  
                     2429  NO_PIP_PASS:
 8789 [05] 08694A    2430       brset   cant_crank,engine2,WARM_UP_ENRICH ; If "cant_crank" bit of "engine2" variable is
                     2431                                                 ; set, branch to WARM_UP_ENRICH:
 878C [05] 066947    2432       brset   started,engine2,WARM_UP_ENRICH    ; If "started" bit of "engine2" variable is
                     2433                                                 ; set, branch to WARM_UP_ENRICH:
                     2434  
                     2435  
                     2436  ;***********************************************************************************************
                     2437  ;
                     2438  ; ------------------------------------- Cranking Mode ------------------------------------------
                     2439  ;
                     2440  ; Pulsewidth is directly set by the coolant temperature value of
                     2441  ;  CWU (at -40 degrees) and CWH (at 165 degrees) - value is interpolated
                     2442  ;
                     2443  ;***********************************************************************************************
                     2444  
                     2445  ;CRANKING_SET:
 878F [04] 1263      2446       bset    crank,engine    ; Set crank bit of engine variable
 8791 [04] 1563      2447       bclr    startw,engine   ; Clear startw bit of engine variable
 8793 [04] 1763      2448       bclr    warmup,engine   ; Clear warmup bit of engine variable
 8795 [04] C6E428    2449       lda     floodClear       ; Load accumulator with value in "floodClear"(flood clear trigger)
 8798 [03] B144      2450       cmp     tps              ; Compare with current throttle position ADC reading
 879A [03] 220F      2451       bhi     INTERP_CRANK_PW ; If (A)>(M), branch to INTERP_CRANK_PW:
                     2452  
                     2453  FLOOD_CLEAR:
 879C [02] A601      2454          lda     #$01             ; Load accumulator with decimal 1(0.001 ms pulsewidth)
 879E [03] B756      2455          sta     pwcalcl          ; Copy to "pwcalcl"
 87A0 [03] 3F55      2456          clr     pwcalch          ; Clear "pwcalch"
 87A2 [03] 3F57      2457          clr     pw               ; Clear "pw"
 87A4 [03] 3F58      2458          clr     fd               ; Clear "fd"
 87A6 [04] 1C64      2459          bset    fldClr,alarmbits ; Set "fldClr" bit of "alarmbits"
 87A8 [03] CC83BD    2460          jmp     LOOPER           ; Jump to LOOPER: (Keep looping until "floodClear">"tps"
                     2461  
                     2462  INTERP_CRANK_PW:
 87AB [04] 1D64      2463       bclr    fldClr,alarmbits ; Clear "fldClr" bit of "alarmbits"
 87AD [02] A600      2464       lda     #$00             ; Load accumulator with decimal 0
 87AF [03] B791      2465       sta     tmp1             ; Copy to tmp1 variable
 87B1 [02] A6CD      2466       lda     #$CD             ; Load accumulator with decimal 205 165 + 40 degrees
                     2467                                ; (offset in lookup table)
 87B3 [03] B792      2468       sta     tmp2             ; Copy to tmp2 variable
 87B5 [04] C6E41C    2469       lda     cwu              ; Load accumulator with value in "cwu"
 87B8 [03] B793      2470       sta     tmp3             ; Copy to "tmp3"
 87BA [04] C6E41D    2471       lda     cwh              ; Load accumulator with value in "cwh"
 87BD [03] B794      2472       sta     tmp4             ; Copy to "tmp4"
 87BF [05] 4E6D95    2473       mov     coolant,tmp5     ; Move value at current coolant temp to tmp5
 87C2 [05] CD900A    2474       jsr     lininterp        ; Jump to Lininterp: (interpolation subroutine)
 87C5 [03] B696      2475       lda     tmp6             ; Load accumulator with value in tmp6 variable
                     2476                                ; (result of calculation)
 87C7 [03] B757      2477       sta     pw               ; Copy to "pw"
 87C9 [03] B758      2478       sta     fd               ; Copy to "fd"
 87CB [01] 97        2479       tax                      ; Transfer value in accumulator to index reg Lo
 87CC [02] A664      2480       lda     #$64             ; Load accumulator with decimal 100
 87CE [05] 42        2481       mul                      ; Multiply X:A <-(X)*(A)
 87CF [03] BF55      2482       stx     pwcalch          ; Copy value in index register to
                     2483                                ; Calculated pulsewidth Hi byte
 87D1 [03] B756      2484       sta     pwcalcl          ; Copy value in acumulator to
                     2485                                ; Calculated pulsewidth Lo byte
 87D3 [03] CC83BD    2486       jmp     LOOPER           ; Jump to LOOPER: (loop until engine starts)
                     2487  
                     2488  
                     2489  ;***********************************************************************************************
                     2490  ;
                     2491  ; ----------------------- Warm Up and After Start Enrichment section ---------------------------
                     2492  ;
                     2493  ; The Warm-up enrichment is a linear interpolated value from WWU (10 points)
                     2494  ; which are placed at configurabletemperatures in the WWURANGE table originally set at
                     2495  ; -40, -20, 0, +20, +40, +60, +80, +100, +130, and +160 degrees F
                     2496  ;
                     2497  ; The After Start enrichment is active below 160 degrees F and is added to the warm up
                     2498  ; enrichment percent value.
                     2499  ;
                     2500  ; Method:
                     2501  ;
                     2502  ; 1) If (warmup, engine is set) then:
                     2503  ; 2) Perform ordered table search of WWU (using coolant variable) to
                     2504  ;    determine which bin.
                     2505  ; 3) Perform linear interpolation to get interpolated warmup enrichment
                     2506  ;    percent
                     2507  ; 4)  else clear warmup bit in engine
                     2508  ;


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 21
MC68HC908GP32 User Bootloader


                     2509  ; Also, the after-start enrichment value is calculated and applied here - it
                     2510  ;  is an added percent value on top of the warmup enrichment, and is applied
                     2511  ;  for the number of INJ1 firings or time specified in AWC. This enrichment starts
                     2512  ;  at a value of AWEV at first, then it linearly interpolates down to zero
                     2513  ;  after AWC cycles.
                     2514  ;
                     2515  ; where:
                     2516  ; warmup, engine = "warm up" bit of "engine" variable
                     2517  ; startw, engine = "after start enrichment" bit of "engine" variable
                     2518  ; awc            = After-start number of cycles
                     2519  ; asecount       = Counter value for after-start enrichment counter,
                     2520  ; AWEV           = After-start Warmup Percent enrichment add-on value
                     2521  ; warmcor        = After Start and Warmup Enrichment percent value
                     2522  ;
                     2523  ; 1) If (startw, engine is set) then:
                     2524  ; 2)  compare if (awc < asecount) then:
                     2525  ; 3)  x1=0, x2=AWC, y1=AWEV, y2=0, x=asecount, y=tmp6(ASE%)
                     2526  ; 4)  warmcor + tmp6 = warmcor
                     2527  ; 5)  else clear startw bit in engine
                     2528  ;
                     2529  ; - Rev 11 added ASE enrichment above "coolanton" set point to try eliminate hot start lean
                     2530  ;   conditions which may be brought on by heat soak of the manifold air temperature sensor,
                     2531  ;   heating of fuel in the rails, or a combination of both. The method is somewhat similar
                     2532  ;   to cold ASE but simpler in that under starting conditions of coolant temps of "coolanton"
                     2533  ;   set point  or greater, and air temps of "airtempon" set point or greater, the "awevh"
                     2534  ;   value is decayed by the "awch" value until it times out.
                     2535  ;
                     2536  ;***********************************************************************************************
                     2537  
                     2538  WARM_UP_ENRICH:
 87D6 [05] 03630A    2539       brclr   crank,engine,WUE1     ; If the "crank" bit of "engine" variable is clear,
                     2540                                     ; Branch to WUE1:
 87D9 [04] 1363      2541       bclr    crank,engine          ; Clear "crank" bit of "engine" variable
 87DB [04] 1D64      2542       bclr    fldClr,alarmbits      ; Clear "fldClr" bit of "alarmbits"
 87DD [04] 1663      2543       bset    warmup,engine         ; Set "warmup" bit of "engine" variable
 87DF [04] 1463      2544       bset    startw,engine         ; Set "startw" bit of "engine" variable
 87E1 [03] 3F7F      2545       clr     asecount              ; Clear the after-start enrichment counter variable
                     2546  
                     2547  ;***********************************************************************************************
                     2548  ; - Determine if we are starting cold or at operating temperature
                     2549  ;***********************************************************************************************
                     2550  
                     2551  WUE1:
 87E3 [05] 076302    2552       brclr   warmup,engine,WUE2    ; If "warmup" bit of "engine" variable is clear
                     2553                                     ; Branch to WUE2:
 87E6 [03] 2005      2554       bra     CHK_WUE_RNG           ; Branch to CHK_WUE_RNG:
                     2555  
                     2556  WUE2:
 87E8 [05] 056349    2557       brclr   startw,engine,WUE_DONE_J     ; If "startw" bit of "engine" variable is
                     2558                                            ; clear, branch to WUE_DONE_J:(long branch)
 87EB [03] 2012      2559       bra     CHK_ASEH_RNG                 ; Branch to CHK_ASEH_RNG:
                     2560  
                     2561  CHK_WUE_RNG:
 87ED [03] B66D      2562       lda     coolant               ; Load accumulator with value in "coolant"
 87EF [04] C1E433    2563       cmp     coolanton             ; Compare value in accumulator with "coolanton"
 87F2 [03] 2402      2564       bhs     NOT_WUE_RNG           ; If "coolant" >= "coolanton", branch to NOT_WUE_RNG:
 87F4 [03] 2040      2565       bra     WUE_RNG               ; Branch to WUE_RNG:
                     2566  
                     2567  NOT_WUE_RNG:
 87F6 [05] 076306    2568       brclr   warmup,engine,CHK_ASEH_RNG     ; If "warmup" bit of "engine" variable is
                     2569                                              ; already clear branch to CHK_ASEH_RNG:
 87F9 [04] 1763      2570       bclr    warmup,engine                  ; Clear "warmup" bit of "engine" variable
 87FB [02] A664      2571       lda     #$64                           ; Load accumulator with decimal 100
 87FD [03] B74E      2572       sta     warmcor                        ; Copy value to Warmup Correction variable
                     2573  
                     2574  ;***********************************************************************************************
                     2575  ; - Determine if we are starting at operating temperature and a potential heat soak condition
                     2576  ;  (high Manifold Air Temperature)
                     2577  ;***********************************************************************************************
                     2578  
                     2579  CHK_ASEH_RNG:
 87FF [05] 056332    2580       brclr   startw,engine,WUE_DONE_J     ; If "startw" bit of "engine" variable is already
                     2581                                            ; clear, branch to WUE_DONE:(long branch)
 8802 [03] B6EF      2582       lda     airtemp            ; Load accumulator with value in Manifold Air Temperature F+40
 8804 [04] C1E442    2583       cmp     airtempon          ; Compare value in accumulator with "airtempon"
 8807 [03] 2404      2584       bhs     ASEH_RNG           ; If "mat" >= "airtempon", branch to ASEH_RNG:
 8809 [04] 1563      2585       bclr    startw,engine      ; Clear "startw" bit of "engine" variable
 880B [03] 2027      2586       bra     WUE_DONE_J         ; Branch to WUE_DONE_J:(long branch)
                     2587  
                     2588  
                     2589  ;***********************************************************************************************
                     2590  ; - Hot start ASE section
                     2591  ;***********************************************************************************************
                     2592  
                     2593  ASEH_RNG:
 880D [03] B67F      2594       lda     asecount           ; Load accumulator with Counter value for
                     2595                                  ; after-start enrichment counter
 880F [04] C1E430    2596       cmp     awch               ; Compare to After-start Hot number of cycles
 8812 [03] 2275      2597       bhi     ASE_ASEH_END       ; If higher, branch to ASE_ASEH_END:(hot start ASE finished)
 8814 [03] 3F91      2598       clr     tmp1               ; Clear tmp1 variable
 8816 [04] C6E430    2599       lda     awch               ; Load accumulator with value in After-start hot number of cycles
 8819 [03] B792      2600       sta     tmp2               ; Copy to tmp2 variable
 881B [04] C6E42F    2601       lda     awevh              ; Load accumulator with value in After-start Hot Warmup Percent
                     2602                                  ; enrichment add-on value
 881E [03] B793      2603       sta     tmp3               ; Copy to tmp3 variable
 8820 [03] 3F94      2604       clr     tmp4               ; Clear tmp4 variable
 8822 [05] 4E7F95    2605       mov     asecount,tmp5      ; Move Counter value for after-start enrichment counter to
                     2606                                  ; tmp5 variable
 8825 [05] CD900A    2607       jsr     lininterp          ; Jump to Liniterp subroutine, (result in tmp6)
 8828 [02] A664      2608       lda     #$64               ; Load accumulator with decimal 100
 882A [03] B74E      2609       sta     warmcor            ; Copy value to Warmup Correction variable
 882C [03] B696      2610       lda     tmp6               ; Load accumulator with value in tmp6
 882E [03] BB4E      2611       add     warmcor            ; Add it to Warmup Correction variable (result in accumulator)
 8830 [03] B74E      2612       sta     warmcor            ; Copy new value to Warmup Correction variable
 8832 [03] 205D      2613       bra     WUE_ASE_ASEH_DONE  ; Branch to WUE_ASE_ASEH_DONE:
                     2614  
                     2615  ;***********************************************************************************************
                     2616  ; - Long Branch
                     2617  ;***********************************************************************************************
                     2618  
                     2619  WUE_DONE_J:
 8834 [03] 205B      2620       bra     WUE_ASE_ASEH_DONE     ; Branch to WUE_ASE_ASEH_DONE:
                     2621  
                     2622  ;***********************************************************************************************
                     2623  ; - Cold start warm up and ASE Section
                     2624  ;***********************************************************************************************
                     2625  
                     2626  WUE_RNG:
 8836 [03] 45E400    2627       ldhx    #WWURANGE                 ; Load Index register with address of first byte of WWURANGE
 8839 [04] 3591      2628       sthx    tmp1               ; Copy value into tmp1 variable
 883B [02] A609      2629       lda     #$09               ; Load accumulator with decimal 9
 883D [03] B793      2630       sta     tmp3               ; Copy value into tmp3 variable
 883F [03] B66D      2631       lda     coolant           ; Load accumulator with current coolant temp
 8841 [03] B794      2632       sta     tmp4               ; Copy value into tmp4 variable
 8843 [05] CD8FEF    2633       jsr     ORD_TABLE_FIND     ; jump to subroutine ORD_TABLE_FIND (result in tmp5)
 8846 [01] 8C        2634       clrh                       ; Clear index register hi byte
 8847 [03] B695      2635       lda     tmp5               ; Load accumulator with result from ORD_TABLE_FIND
 8849 [01] 97        2636       tax                        ; Copy it to index register Lo byte
 884A [04] D6E40A    2637       lda     WWU,x              ; Load the accumulator with the warmup bin from index
                     2638                                  ; register Lo byte
 884D [03] B794      2639       sta     tmp4               ; Copy it to the tmp4 variable
 884F [01] 5A        2640       decx                       ; Decrement index reg Lo byt(move down 1 bin)
 8850 [04] D6E40A    2641       lda     WWU,x              ; Load accumulator with new bin value
 8853 [03] B793      2642       sta     tmp3               ; Copy it to the tmp3 variable
 8855 [05] 4E6D95    2643       mov     coolant,tmp5       ; Move current coolant temp to tmp5 variable
 8858 [05] CD900A    2644       jsr     lininterp          ; Jump to Lininterp subroutine(result in temp6)


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 22
MC68HC908GP32 User Bootloader


 885B [05] 4E964E    2645       mov     tmp6,warmcor       ; Copy to Total Warmup Correction variable
 885E [03] B64E      2646       lda     warmcor            ; Load accumulator with Warmup Correction variable
 8860 [02] A164      2647       cmp     #$64               ; Compare it to decimal 100
 8862 [03] 2602      2648       bne     ASE_RNG            ; If not equal, branch to ASE_RNG:
 8864 [03] 2027      2649       bra     WUE_END            ; Branch to WUE_END:
                     2650  
                     2651  ASE_RNG:
 8866 [03] B67F      2652       lda     asecount           ; Load accumulator with Counter value for
                     2653                                  ; after-start enrichment counter
 8868 [04] C1E41F    2654       cmp     awc                ; Compare to After-start number of cycles
 886B [03] 221C      2655       bhi     ASE_ASEH_END       ; If higher, branch to ASE_ASEH_END:
 886D [03] 3F91      2656       clr     tmp1               ; Clear tmp1 variable
 886F [04] C6E41F    2657       lda     awc                ; Load accumulator with value in After-start number of cycles
 8872 [03] B792      2658       sta     tmp2               ; Copy to tmp2 variable
 8874 [04] C6E41E    2659       lda     awev               ; Load accumulator with value in After-start Warmup Percent
                     2660                                  ; enrichment add-on value
 8877 [03] B793      2661       sta     tmp3               ; Copy to tmp3 variable
 8879 [03] 3F94      2662       clr     tmp4               ; Clear tmp4 variable
 887B [05] 4E7F95    2663       mov     asecount,tmp5      ; Move Counter value for after-start enrichment counter to
                     2664                                  ; tmp5 variable
 887E [05] CD900A    2665       jsr     lininterp          ; Jump to Liniterp subroutine, (result in tmp6)
 8881 [03] B696      2666       lda     tmp6               ; Load accumulator with value in tmp6
 8883 [03] BB4E      2667       add     warmcor            ; Add it to Warmup Correction variable (result in accumulator)
 8885 [03] B74E      2668       sta     warmcor            ; Copy new value to Warmup Correction variable
 8887 [03] 2008      2669       bra     WUE_ASE_ASEH_DONE  ; Branch to WUE_ASE_ASEH_DONE:
                     2670  
                     2671  ;***********************************************************************************************
                     2672  ; Outside of ASE or ASEH range, clear ASE or ASEH  mode
                     2673  ;***********************************************************************************************
                     2674  
                     2675  ASE_ASEH_END:
 8889 [04] 1563      2676       bclr    startw,engine         ; Clear "startw" bit of "engine" variable
 888B [03] 2004      2677       bra     WUE_ASE_ASEH_DONE     ; Branch to WUE_ASE_ASEH_DONE:
                     2678  
                     2679  ;***********************************************************************************************
                     2680  ; Outside of WUE range - clear WUE and ASE modes
                     2681  ;***********************************************************************************************
                     2682  
                     2683  WUE_END:
 888D [04] 1763      2684       bclr    warmup,engine      ; Clear "warmup" bit of "engine" variable
 888F [04] 1563      2685       bclr    startw,engine      ; Clear "startw" bit of "engine" variable
                     2686  
                     2687  WUE_ASE_ASEH_DONE:
                     2688  
                     2689  ;***********************************************************************************************
                     2690  ;
                     2691  ; ------------------------- Throttle Acceleration Enrichment section ---------------------------
                     2692  ;
                     2693  ; Method is the following, where:
                     2694  ;
                     2695  ; tps         = Throttle Position Sensor ADC Raw Reading, counts, 0-5 volts
                     2696  ; last_tps    = TPS reading updated every 0.1 seconds
                     2697  ; tpsthresh   = Accel TPS difference over time threshold
                     2698  ; TPSAEN      = "engine" bit4, 0 = not in TPS accel mode 1 = TPS accel mode
                     2699  ; TPSDEN      = "engine" bit5, 0 = not in deaccel mode   1 = in deaccel mode
                     2700  ; TPSAQ       = TPS acceleration amount (function of TPSDOT) in 0.1 ms units
                     2701  ; TPSDQ       = Deceleration fuel cut  100 = no fuel cut, 1 = 99% fuel cut
                     2702  ; TPSACLK     = TPS enrichment timer clock in 0.1 second resolution
                     2703  ; TPSACLKCMP  = Comparison value for TPS acceleration time - from lookup table
                     2704  ; TPSACCEL    = Acceleration enrichment % (0 = 0% enrich, 255 = 255% enrich)
                     2705  ; TPSFUELCUT  = TPS fuel cut % variable ( 1 = 99% cut, 100 = 0% cut)
                     2706  ; rpm         = Computed engine RPM - rpm/20 (20 RPM resolution)
                     2707  ; DFC_en      = Decel Fuel Cut Enable on PTA2
                     2708  ;
                     2709  ;
                     2710  ;   ACCELERATION ENRICHMENT:
                     2711  ;   If (tps < lasr_tps) go to DEACCELERATION ENRICHMENT
                     2712  ;   If (tps - last_tps) > tpsthresh and TPSAEN = 0 then (accel enrichemnt):
                     2713  ;   {
                     2714  ;    1) Set acceleration mode
                     2715  ;    2) Continuously determine rate-of-change of throttle, and perform
                     2716  ;        interpolation of TPSAQ values to determine acceleration
                     2717  ;        enrichment amount to apply.
                     2718  ;   }
                     2719  ;   If (TPSACLK > TPSACLKCMP) and TPSAEN = 1, then:
                     2720  ;   {
                     2721  ;    1) Clear TPSAEN bit in engine
                     2722  ;    2) Set TPSACCEL to 100% (no enrichment)
                     2723  ;    3) Go to end of section
                     2724  ;   }
                     2725  ;
                     2726  ;
                     2727  ;   DEACCELERATION ENRICHMENT:
                     2728  ;    If (lasr_tps - tps > tpsthresh then (deaccelleration fuel cut)
                     2729  ;    {
                     2730  ;     If (TPSAEN = 1) then:
                     2731  ;     {
                     2732  ;      1) TPSACCEL = 100 percent (no acceleration)
                     2733  ;      2) Clear TPSAEN bit in ENGINE
                     2734  ;      3) Go to end of section
                     2735  ;    }
                     2736  ;    If (RPM > 60 (1200 RPM) then (fuel cut mode):
                     2737  ;    {
                     2738  ;      1) Set TPSACCEL value to TPSDQ
                     2739  ;      2) Set TPSDEN bit in ENGINE
                     2740  ;      3) Go to end of section
                     2741  ;    }
                     2742  ;   }
                     2743  ;   else
                     2744  ;   {
                     2745  ;    If (TPSDEN = 1) then
                     2746  ;    {
                     2747  ;      1) Clear TPSACCEL value in ENGINE
                     2748  ;      2) TPSACCEL = 100%
                     2749  ;      3) Go to end of section
                     2750  ;    }
                     2751  ;   }
                     2752  ;
                     2753  ;***********************************************************************************************
                     2754  
                     2755  ;***********************************************************************************************
                     2756  ; - Acceleration enrichment calculations are done only once in the first
                     2757  ;   pass through the main loop after the 100mS clock tick signal has been
                     2758  ;   received, the interrupt routine has been completed, and relevent
                     2759  ;   variables updated.
                     2760  ;   NOTE! This doesn't appear to work so it's commented out
                     2761  ;***********************************************************************************************
                     2762  
                     2763  ;     brset   clock100,inputs,TAE    ; If "clock100" bit of "inputs" variable is
                     2764                                       ; clear, branch to TAE:
                     2765  ;     jmp     NO_CLOCK_PASS          ; Jump to NO_CLOCK_PASS:
                     2766  
                     2767  
                     2768  TAE:
 8891 [02] 9B        2769       sei                       ; Set interrupt mask bit
 8892 [05] 4E4491    2770       mov     tps,tmp1          ; Move Throttle Position reading to tmp1 var
 8895 [05] 4E8092    2771       mov     last_tps,tmp2     ; Move Last Throttle Position reading to tmp2
 8898 [02] 9A        2772       cli                       ; Clear interupt mask bit
 8899 [03] B691      2773       lda     tmp1              ; Load accumulator with value in tmp1
 889B [03] B192      2774       cmp     tmp2              ; Compare accumulator with tmp2
 889D [03] 2555      2775       blo     TDE2              ; If (A)<(M) branch to TDE2: (deacelleration section)
                     2776  
                     2777  ;AE_CHK:
 889F [03] B691      2778       lda     tmp1                             ; Load accumulator with value in tmp1 (TPS)
 88A1 [03] B092      2779       sub     tmp2                             ; Subtract, A<-(A)-(M) (TPS - Last_TPS)
 88A3 [04] C1E421    2780       cmp     tpsthresh                        ; Compare result to Accel TPS DOT threshold value


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 23
MC68HC908GP32 User Bootloader


 88A6 [03] 254A      2781       blo     B_LO_CONT                        ; If (A)<(M), branch to B_LO_CONT:
 88A8 [05] 086313    2782       brset   tpsaen,engine,AE_COMP_SHOOT_AMT  ; If "TPSAEN" bit of "engine" is set branch to
                     2783                                                ; AE_COMP_SHOOT_AMT:
                     2784  
                     2785  ;***********************************************************************************************
                     2786  ; Add in accelleration  enrichement
                     2787  ;***********************************************************************************************
                     2788  
 88AB [04] C6E418    2789       lda     tpsaq           ; Load accumulator with value in first element
                     2790                               ;(start out using first element)
                     2791                               ;(will determine actual next time around)
 88AE [03] B752      2792       sta     tpsaccel        ; Copy to Acceleration percent amount
                     2793                               ; (used in later calculations)
 88B0 [03] 3F7E      2794       clr     tpsaclk         ; Clear Comparison value for TPS accel time var
 88B2 [04] C6E422    2795       lda     tpsasync             ; Load accumulator with TPS Accel clock value
 88B5 [03] B783      2796       sta     tpsaclkcmp      ; Copy to Comparison value for TPS accel time
                     2797                               ;(Shoot time comparison value)
 88B7 [04] 1863      2798       bset    tpsaen,engine   ; Set "tpsaen" bit of "engine" variable
 88B9 [04] 1B63      2799       bclr    tpsden,engine   ; Clear "tpsden" bit of "engine" variable
 88BB [03] CC8992    2800       jmp     TDE_DONE        ; Jump to TDE_DONE:
                     2801  
                     2802  
                     2803  ;***********************************************************************************************
                     2804  ; First, calculate Cold temperature add-on enrichment value from coolant
                     2805  ;  value TPSACOLD, from -40 degrees to 165 degrees.
                     2806  ;
                     2807  ; Then determine cold temperature multiplier value ACCELMULT (in percent),
                     2808  ;  from -40 degrees to 165 degrees.
                     2809  ;
                     2810  ; Next, Calculate Shoot amount (quantity) for accel enrichment from table.
                     2811  ;  Find bins (between) for corresponding TPSDOT, and linear interpolate
                     2812  ;  to find enrichment amount (from TPSAQ). This is continuously
                     2813  ;  checked every time thru main loop while in acceleration mode,
                     2814  ;  and the highest value is latched and used.
                     2815  ;
                     2816  ; The final acceleration applied is
                     2817  ;  AE = Alookup(TPSDOT) * (ACCELMULT/100) + TPSACOLD
                     2818  ;
                     2819  ;***********************************************************************************************
                     2820  
                     2821  AE_COMP_SHOOT_AMT:
                     2822  
                     2823  ;***********************************************************************************************
                     2824  ; First, the "added" amount based on cold temperatures
                     2825  ;***********************************************************************************************
                     2826  
 88BE [02] A600      2827       lda     #$00              ; Load accumulator with 0 (0 -> - 40 degrees)
 88C0 [03] B791      2828       sta     tmp1              ; Copy to tmp1 variable
 88C2 [02] A6CD      2829       lda     #$CD              ; Load accumulator with decimal 205
                     2830                                 ; 165 + 40 degrees (offset in lookup table)
 88C4 [03] B792      2831       sta     tmp2              ; Copy to to tmp2 variable (this is the amount at coldest)
 88C6 [04] C6E420    2832       lda     tpsacold          ; Load accumulator with value in "tpsacold"
 88C9 [03] B793      2833       sta     tmp3              ; Copy to tmp3 variable
 88CB [04] 6E0094    2834       mov     #$00,tmp4         ; Move decimal 0 to tmp4 variable (no enrichemnt add on at warm
                     2835                                 ; temperature)
 88CE [05] 4E6D95    2836       mov     coolant,tmp5      ; Move current coolant temp value to tmp5 var
 88D1 [05] CD900A    2837       jsr     lininterp         ; Jump to liniterp subroutine (result in tmp6)
 88D4 [05] 4E969D    2838       mov     tmp6,tmp13        ; Move result to tmp13 (save here temporarily)
                     2839  
                     2840  ;***********************************************************************************************
                     2841  ; Second, find the multiplier (ACCELMULT) amount based on cold temperatures
                     2842  ;***********************************************************************************************
                     2843  
 88D7 [02] A600      2844       lda     #$00             ; Load accumulator with 0 (0 -> - 40 degrees)
 88D9 [03] B791      2845       sta     tmp1             ; Copy to tmp1 variable
 88DB [02] A6CD      2846       lda     #$CD             ; Load accumulator with decimal 205 (165 + 40 degrees)
                     2847                                ; (offset in lookup table)
 88DD [03] B792      2848       sta     tmp2             ; Copy to to tmp2 variable
 88DF [04] C6E429    2849       lda     ACMULT           ; load accumulator with Acceleration cold multiplication factor
                     2850                                ; (percent/100)
 88E2 [03] B793      2851       sta     tmp3             ; Copy to tmp3 variable (This is the amount at coldest)
 88E4 [04] 6E6494    2852       mov     #$64,tmp4        ; Move decimal 100 to tmp4 variable
                     2853                                ;(1.00 multiplier at 165 degrees)
 88E7 [05] 4E6D95    2854       mov     coolant,tmp5     ; Move coolant temperature to tmp5 variable
 88EA [05] CD900A    2855       jsr     lininterp        ; Jump to liniterp subroutine (result in tmp6)
 88ED [05] 4E969E    2856       mov     tmp6,tmp14       ; Move result to tmp14 (save here temporarily)
                     2857  
                     2858  ;***********************************************************************************************
                     2859  ; This is here to extend the branch range for the instructions earlier
                     2860  ; (long-jumps)
                     2861  ;***********************************************************************************************
                     2862  
 88F0 [03] 2004      2863       bra     END_AE_LONGBRANCH    ; Branch to END_AE_LONGBRANCH:
                     2864  
                     2865  B_LO_CONT:
 88F2 [03] 2057      2866       bra     TAE_CHK_TIME         ; Branch to TAE_CHK_TIME:
                     2867  
                     2868  TDE2:
 88F4 [03] 2068      2869       bra     TDE                  ; Branch to TDE:
                     2870  
                     2871  END_AE_LONGBRANCH:
                     2872  
                     2873  
                     2874  ;***********************************************************************************************
                     2875  ; Now the lookup table amount based on TPSDOT (TPS difference over time)
                     2876  ;***********************************************************************************************
                     2877  
 88F6 [03] 45E414    2878       ldhx    #tpsdotrate     ; Load Index register with value in "tpsdotrate"
 88F9 [04] 3591      2879       sthx    tmp1            ; Copy to tmp1 variable
 88FB [02] A60F      2880       lda     #$0F            ; Load accumulator with decimal 15 (300RPM)
 88FD [03] B793      2881       sta     tmp3            ; Copy to TMP3 variable
 88FF [03] B644      2882       lda     tps             ; Load accumulator with value in Throttle Position Sensor ADC
 8901 [03] B080      2883       sub     last_tps        ; Subract it from the last TPS value
 8903 [03] B794      2884       sta     tmp4            ; Copy result to tmp4 variable ( TPSDOT )
 8905 [03] B79A      2885       sta     tmp10           ; Copy result in tmp10 variable as well (Save away for later
                     2886                               ; use below)
 8907 [05] CD8FEF    2887       jsr     ord_table_find  ; Jump to subroutine ord_table_find( result in tmp5 )
 890A [01] 8C        2888       clrh                    ; Clear the Index Register
 890B [03] B695      2889       lda     tmp5            ; Load accumulator with value in tmp5
 890D [01] 97        2890       tax                     ; Transfer Index Register Lo byte
 890E [04] D6E418    2891       lda     TPSAQ,x         ; Load accumulator with TPS acceleration amount
                     2892                               ; (TPSAQ is entry, offset in index register Lo
 8911 [03] B794      2893       sta     tmp4            ; Copy to tmp4 variable
 8913 [01] 5A        2894       decx                    ; Decrement index register Lo byte
 8914 [04] D6E418    2895       lda     TPSAQ,x         ; Load accumulator with this new value
 8917 [03] B793      2896       sta     tmp3            ; Copy it to tmp3 variable
 8919 [03] B69A      2897       lda     tmp10           ; Load accumulator with value in tmp10
 891B [03] B795      2898       sta     tmp5            ; Copy it to tmp5 variable
 891D [05] CD900A    2899       jsr     lininterp       ; Jump to subroutine lininterp (result in tmp6)
                     2900  
                     2901  ;***********************************************************************************************
                     2902  ; Now, the final applied acceleration enrichment amount is
                     2903  ; ((TMP6 * tmp14)/100) + tmp13
                     2904  ;  AE = Alookup(TPSDOT) * (ACCELMULT/100) + TPSACOLD
                     2905  ;***********************************************************************************************
                     2906  
                     2907  ;FIND_TOTAL_A:
 8920 [03] B696      2908       lda     tmp6            ; Load accumulator with value in tmp6( result of lininterp)
 8922 [01] 97        2909       tax                     ; Transfer to index register Lo byte
 8923 [03] B69E      2910       lda     tmp14           ; Load accumulator with value in tmp14
 8925 [05] 42        2911       mul                     ; Multiply tmp6 by tmp14
 8926 [02] 89        2912       pshx                    ; Push index register Lo onto stack
 8927 [02] 8A        2913       pulh                    ; Pull index register L to index register Hi
 8928 [02] AE64      2914       ldx     #$64            ; Load index register low with decimal 100
 892A [07] 52        2915       div                     ; Divide A<-(H:A)/(X);H<-Remainder
 892B [03] 250E      2916       bcs     UPPER_RAIL_AE   ; If the C bit of CCR is set, branch to UPPER_RAIL_AE:


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 24
MC68HC908GP32 User Bootloader


 892D [02] 87        2917       psha                    ; Push accumulator onto stack
 892E [02] 8B        2918       pshh                    ; Push index register high onto stack
 892F [02] 86        2919       pula                    ; Pull index register high into accumulator
 8930 [02] A132      2920       cmp     #$32            ; Compare accumulator with decimal 50
 8932 [03] 9304      2921       ble     NDA1            ; If less than or equal to, branch to NDA1:
 8934 [02] 86        2922       pula                    ; Pull value from stack to accumulator
 8935 [01] 4C        2923       inca                    ; Increment accumulator
 8936 [03] 2007      2924       bra     ADD_TO_AE       ; Branch to ADD_TO_AE:
                     2925  
                     2926  NDA1:
 8938 [02] 86        2927       pula                    ; Pull value from stack to accumulator
 8939 [03] 2004      2928       bra     ADD_TO_AE       ; Branch to ADD_TO_AE:
                     2929  
                     2930  UPPER_RAIL_AE:
 893B [02] A6C8      2931       lda     #$C8            ; Load accumulator with decimal 200(Set to 20 milliseconds railed)
 893D [03] 2000      2932       bra     ADD_TO_AE       ; Branch to ADD_TO_AE:
                     2933  
                     2934  ADD_TO_AE:
 893F [03] BB9D      2935       add     tmp13            ; Add value in accumulator with value in tmp13(Add on the amount
                     2936                                ;(computed in col temperature enrich above)
 8941 [03] B796      2937       sta     tmp6             ; Copy result to tmp6 variable
 8943 [03] B152      2938       cmp     TPSACCEL         ; Compare with Acceleration percent amount
 8945 [03] 2504      2939       blo     TAE_CHK_TIME     ; If lower, branch to TAE_CHK_TIME:
 8947 [03] B696      2940       lda     tmp6             ; Load accumulator with value in tmp6
                     2941                                ; (Replace with this higher value)
 8949 [03] B752      2942       sta     TPSACCEL         ; Copy value to Acceleration percent amount
                     2943  
                     2944  
                     2945  ;***********************************************************************************************
                     2946  ; Check if acceleration is done
                     2947  ;***********************************************************************************************
                     2948  
                     2949  TAE_CHK_TIME:
 894B [05] 0A6306    2950       brset   tpsden,engine,RST_ACCEL ; If deceleration bit of "Engine" variable is set,
                     2951                                       ; branch to RST_ACCEL:
 894E [03] B67E      2952       lda     tpsaclk                 ; Load accumulator with value in TPS enrichment timer clock
 8950 [03] B183      2953       cmp     tpsaclkcmp              ; Compare it to Comparison value for TPS acceleration time
 8952 [03] 253E      2954       blo     TDE_DONE                ; If lower, branch to TDE_DONE:
                     2955  
                     2956  RST_ACCEL:
 8954 [04] 1963      2957       bclr    tpsaen,engine     ; Clear "tpsaen" bit of "engine" variable
 8956 [02] A664      2958       lda     #$64              ; Load accumulator with decimal 100
 8958 [03] B784      2959       sta     tpsfuelcut        ; Copy to TPS Fuel Cut % variable (0% cut)
 895A [03] 3F52      2960       clr     tpsaccel          ; Clear Acceleration enrich % var (0% enrich)
 895C [04] 1B63      2961       bclr    tpsden,engine     ; Clear "tpsden" bit of "engine" variable
                     2962  
                     2963  ;***********************************************************************************************
                     2964  ; - Deceleration fuel cut mode
                     2965  ;***********************************************************************************************
                     2966  
                     2967  TDE:
 895E [03] B692      2968       lda     tmp2                            ; Load accumulator with value in tmp2(last_tps)
 8960 [03] B091      2969       sub     tmp1                            ; A<-(A)-(M)(last_tps - tps)
 8962 [04] C1E421    2970       cmp     tpsthresh                       ; Compare result with value in "tpsthresh"
 8965 [03] 2520      2971       blo     TDE_CHK_DONE                    ; If A<M, branch to TDE_CHK_DONE:
 8967 [05] 09630C    2972       brclr   tpsaen,engine,TDE_CHK_FUEL_CUT  ; If "tpsaen" bit of "engine" variable is set,
                     2973                                               ; branch to TDE_CHK_DONE:
 896A [02] A664      2974       lda     #$64                            ; Load accumulator with decimal 100
 896C [03] B784      2975       sta     tpsfuelcut                      ; Copy to "tpsfuelcut" variable
 896E [03] 3F52      2976       clr     tpsaccel                        ; Clear "tpsaccel" variable
 8970 [04] 1963      2977       bclr    tpsaen,engine                   ; Clear "tpsaen" bit of "engine" variable
 8972 [04] 1B63      2978       bclr    tpsden,engine                   ; Clear "tpsden" bit of "engine" variable
 8974 [03] 201C      2979       bra     TDE_DONE                        ; Branch to TDE_DONE:
                     2980  
                     2981  TDE_CHK_FUEL_CUT:
 8976 [03] B653      2982       lda     rpm20             ; Load accumulator with value in "rpm20"
 8978 [02] A14B      2983       cmp     #$4B              ; Compare with decimal 75(1500 RPM)
 897A [03] 2516      2984       blo     TDE_DONE          ; If (A)<(M) branch to TDE_DONE(Revs too low, no fuel cut)
 897C [04] C6E431    2985       lda     tpsdq             ; Load accumulator with value in "tpsdq"(fuel cut %)
 897F [03] B784      2986       sta     tpsfuelcut        ; Copy to "tpsfuelcut"
 8981 [04] 1A63      2987       bset    tpsden,engine     ; Set "tpsden" bit of "engine"
 8983 [04] 1963      2988       bclr    tpsaen,engine     ; Clear "tpsaen" bit of "engine"
 8985 [03] 200B      2989       bra     TDE_DONE          ; Branch to TDE_DONE:
                     2990  
                     2991  TDE_CHK_DONE:
 8987 [05] 0B6308    2992       brclr   tpsden,engine,TDE_DONE  ; If "tpsden" bit of "engine" is clear, branch to
                     2993                                       ; TDE_DONE:
 898A [04] 1B63      2994       bclr    tpsden,engine           ; Clear "tpsden" bit of "engine" variable
 898C [02] A664      2995       lda     #$64                    ; Load accumulator with decimal 100
 898E [03] B784      2996       sta     tpsfuelcut              ; Copy to "tpsfuelcut" variable
 8990 [03] 3F52      2997       clr     tpsaccel                ; Clear "tpsaccel" variable
                     2998  
                     2999  TDE_DONE:
 8992 [04] 196B      3000       bclr    clock100,inputs         ; Clear "clock100" bit of "inputs" variable
                     3001  
                     3002  NO_CLOCK_PASS:
                     3003  
                     3004  ;***********************************************************************************************
                     3005  ;
                     3006  ; VE 3-D Table Lookup
                     3007  ;
                     3008  ;  This is used to determine value of VE based on RPM and MAP
                     3009  ;  The table looks like:
                     3010  ;
                     3011  ;     105 +....+....+....+....+....+....+....+
                     3012  ;         ....................................
                     3013  ;      00 +....+....+....+....+....+....+....+
                     3014  ;                    ...
                     3015  ;  KPA                ...
                     3016  ;                        ...
                     3017  ;      35 +....+....+....+....+....+....+....+
                     3018  ;         5    15   25   35   45   55   65   75 RPM/20
                     3019  ;
                     3020  ;
                     3021  ; Steps:
                     3022  ;  1) Find the bracketing KPA positions via ORD_TABLE_FIND, put index in
                     3023  ;      tmp8 and bounding values in tmp9(kpa1) and tmp10(kpa2)
                     3024  ;  2) Find the bracketing RPM positions via ORD_TABLE_FIND, store index in
                     3025  ;      tmp11 and bounding values in tmp13(rpm1) and tmp14(rpm2)
                     3026  ;  3) Using the VE table, find the table VE values for tmp15=VE(kpa1,rpm1),
                     3027  ;      tmp16=VE(kpa1,rpm2), tmp17 = VE(kpa2,rpm1), and tmp18 = VE(kpa2,rpm2)
                     3028  ;  4) Find the interpolated VE value at the lower KPA range :
                     3029  ;      x1=rpm1, x2=rpm2, y1=VE(kpa1,rpm1), y2=VE(kpa1,rpm2) - put in tmp19
                     3030  ;  5) Find the interpolated VE value at the upper KPA range :
                     3031  ;      x1=f1, x2=rpm2, y1=VE(kpa2,rpm1), y2=VE(kpa2,rpm2) - put in tmp11
                     3032  ;  6) Find the final VE value using the two interpolated VE values:
                     3033  ;      x1=kpa1, x2=kpa2, y1=VE_FROM_STEP_4, y2=VE_FROM_STEP_5
                     3034  ;
                     3035  ;***********************************************************************************************
                     3036  
                     3037  ;VETABLELOOKUP:
                     3038  
                     3039  ;VE_STEP_1:
 8994 [03] 45E09C    3040       ldhx    #KPARANGEVE_f       ; Load index register with value in KPARANGEVE table
 8997 [04] 3591      3041       sthx    tmp1                ; Copy value to tmp1 variable
 8999 [04] 6E0B93    3042       mov     #$0B,tmp3           ; Move decimal 12 into "tmp3"
 899C [05] 4E6C94    3043       mov     kpa,tmp4            ; Move value in "kpa" to "tmp4"
 899F [05] CD8FEF    3044       jsr     ORD_TABLE_FIND     ; Jump to subroutine ORD_TABLE_FIND,(result in tmp5)
 89A2 [03] B691      3045       lda     tmp1                ; Load accumulator with value in tmp1
 89A4 [03] B692      3046       lda     tmp2                ; Load accumulator with value in tmp2
 89A6 [05] 4E9598    3047       mov     tmp5,tmp8                  ; move value from tmp5 to tmp8 (Index)
 89A9 [05] 4E9199    3048       mov     tmp1,tmp9                  ; move value from tmp1 to tmp9 (X1)
 89AC [05] 4E929A    3049       mov     tmp2,tmp10                 ; move value from tmp2 to tmp10 (X2)
                     3050  
                     3051  ;VE_STEP_2:
 89AF [03] 45E090    3052       ldhx    #RPMRANGEVE_f       ; Load index register with value from RPMRANGEVE table


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 25
MC68HC908GP32 User Bootloader


 89B2 [04] 3591      3053       sthx    tmp1                ; Copy value to tmp1 variable
 89B4 [04] 6E0B93    3054       mov     #$0B,tmp3           ; Move decimal 12 into "tmp3"
 89B7 [05] 4E5394    3055       mov     rpm20,tmp4          ; Move value in "rpm20" to "tmp4"
 89BA [05] CD8FEF    3056       jsr     ORD_TABLE_FIND     ; Jump to subroutine ORD_TABLE_FIND,(result in tmp5)
 89BD [05] 4E959B    3057       mov     tmp5,tmp11                 ; Move value from tmp5 to tmp11 (Index)
 89C0 [05] 4E919D    3058       mov     tmp1,tmp13                 ; Move value from tmp1 to tmp13 (X1)
 89C3 [05] 4E929E    3059       mov     tmp2,tmp14                 ; Move value from tmp2 to tmp14 (X2)
                     3060  
                     3061  ;VE_STEP_3:
 89C6 [01] 8C        3062          clrh              ; Clear index register Hi byte
 89C7 [02] AE0C      3063          ldx     #$0C      ; Load index register Lo byte with decimal 13
 89C9 [03] B698      3064          lda     tmp8      ; Load accumulator with value in "tmp8"
 89CB [01] 4A        3065          deca              ; Decrement value in accumulator
 89CC [05] 42        3066          mul               ; Multiply X:A<-(X)x(A)
 89CD [03] BB9B      3067          add     tmp11     ; Add "tmp11" to result A<-(A)+(M)
 89CF [01] 4A        3068          deca              ; Decrement value in accumulator
 89D0 [01] 97        3069          tax               ; Transfer value in accumulator to index register Lo byte
 89D1 [05] CD9154    3070          jsr     VE1X      ; Jump to subroutine at VE1X:
 89D4 [03] B79F      3071          sta     tmp15     ; Copy result to "tmp15"
 89D6 [01] 5C        3072          incx              ; Increment value in index rgister Lo byte
 89D7 [05] CD9154    3073          jsr     VE1X      ; Jump to subroutine at VE1X:
 89DA [03] B7A0      3074          sta     tmp16     ; Copy result to "tmp16"
 89DC [02] AE0C      3075          ldx     #$0C      ; Load index register Lo byte with decimal 13
 89DE [03] B698      3076          lda     tmp8      ; Load accumulator with value in "tmp8"
 89E0 [05] 42        3077          mul               ; Multiply X:A<-(X)x(A)
 89E1 [03] BB9B      3078          add     tmp11     ; Add "tmp11" to result A<-(A)+(M)
 89E3 [01] 4A        3079          deca              ; Decrement value in accumulator
 89E4 [01] 97        3080          tax               ; Transfer value in accumulator to index register Lo byte
 89E5 [05] CD9154    3081          jsr     VE1X      ; Jump to subroutine at VE1X:
 89E8 [03] B7A1      3082          sta     tmp17     ; Copy result to "tmp17"
 89EA [01] 5C        3083          incx              ; Increment value in index rgister Lo byte
 89EB [05] CD9154    3084          jsr     VE1X      ; Jump to subroutine at VE1X:
 89EE [03] B7A2      3085          sta     tmp18     ; Copy result to "tmp18"
                     3086  
                     3087  ;VE_STEP_4:
 89F0 [05] 4E9D91    3088       mov     tmp13,tmp1      ; Move value from tmp13 variable to tmp1 variable
 89F3 [05] 4E9E92    3089       mov     tmp14,tmp2      ; Move value from tmp14 variable to tmp2 variable
 89F6 [05] 4E9F93    3090       mov     tmp15,tmp3      ; Move value from tmp15 variable to tmp3 variable
 89F9 [05] 4EA094    3091       mov     tmp16,tmp4      ; Move value from tmp16 variable to tmp4 variable
 89FC [05] 4E5395    3092       mov     rpm20,tmp5      ; Move RPM/20 to tmp5 variable
 89FF [05] CD900A    3093       jsr     lininterp       ; Jump to subroutine lininterp (result in tmp6)
 8A02 [05] 4E96A3    3094       mov     tmp6,tmp19      ; Move value from tmp6 variable to tmp19 variable
                     3095  
                     3096  ;VE_STEP_5:
 8A05 [05] 4E9D91    3097       mov     tmp13,tmp1      ; Move value from tmp13 variable to tmp1 variable
 8A08 [05] 4E9E92    3098       mov     tmp14,tmp2      ; Move value from tmp14 variable to tmp2 variable
 8A0B [05] 4EA193    3099       mov     tmp17,tmp3      ; Move value from tmp17 variable to tmp3 variable
 8A0E [05] 4EA294    3100       mov     tmp18,tmp4      ; Move value from tmp18 variable to tmp4 variable
 8A11 [05] 4E5395    3101       mov     rpm20,tmp5      ; Move RPM/20 to tmp5 variable
 8A14 [05] CD900A    3102       jsr     lininterp       ; Jump to subroutine lininterp (result in tmp6)
 8A17 [05] 4E969B    3103       mov     tmp6,tmp11      ; Move value from tmp6 variable to tmp11 variable
                     3104  
                     3105  ;VE_STEP_6:
 8A1A [05] 4E9991    3106       mov     tmp9,tmp1        ; Move value from tmp9 variable to tmp1 variable
 8A1D [05] 4E9A92    3107       mov     tmp10,tmp2       ; Move value from tmp10 variable to tmp2 variable
 8A20 [05] 4EA393    3108       mov     tmp19,tmp3       ; Move value from tmp19 variable to tmp3 variable
 8A23 [05] 4E9B94    3109       mov     tmp11,tmp4       ; Move value from tmp11 variable to tmp4 variable
 8A26 [05] 4E6C95    3110       mov     kpa,tmp5         ; Move value in MAP value in units of KPa to tmp5
 8A29 [03] B66C      3111       lda     kpa         ; Load accumulator with value in MAP value in KPa
 8A2B [05] CD900A    3112       jsr     lininterp        ; Jump to subroutine lininterp (result in tmp6)
 8A2E [05] 4E9654    3113       mov     tmp6,vecurr ; Move value from tmp6 variable to Current VE
                     3114                           ; value from lookup table - percent
                     3115  
                     3116  
                     3117  ;***********************************************************************************************
                     3118  ;
                     3119  ; ---------------------------- Computation of Fuel Parameters ----------------------------------
                     3120  ;
                     3121  ; Remainders are maintained for hi-resolution mode
                     3122  ;
                     3123  ; Where:
                     3124  ;  Ftrimcor   = Fuel trim correction factor (85 to 115)(-15% to +15%)
                     3125  ;  warmcor    = Total warmup enrichment,(Warmup and After Start)
                     3126  ;               (0 to 255)(0% to 255%)(prctical values 100 to 175)
                     3127  ;  Tpsfuelcut = TPS fuel cut amount (1 = 99% cut, 100 = 0% cut)
                     3128  ;  barocorr   = Barometric pressure correction (27 to 141)(27% to 141%)
                     3129  ;               (practical value 100 to 110)
                     3130  ;  aircorr    = Air Density correction ( 90 to 105) (90% to 105%)
                     3131  ;  kpa        = Manifold Absolute Pressure (12 to 255kpa)
                     3132  ;               (practical value naturally aspirated 15 to 98)
                     3133  ;  vecurr     = Volumetric Efficiency (0 to 255)
                     3134  ;               (practical value naturally aspirated 25 to 150)
                     3135  ;               (Actually, the VE table is a combination of
                     3136  ;                volumetric efficiency and Lambda. Both can change with
                     3137  ;                RPM and load, so they are combined in a common 3D Table)
                     3138  ;  REQ_FUEL   = Required fuel pulse width (0 - 25.5mS) at 100%VE, 68
                     3139  ;               degrees F Manifold Air Temp and atmospheric pressure to
                     3140  ;               achieve stoichiometric air fuel ratio for 1 cylinder per
                     3141  ;               combustion cycle (720 crank degrees)
                     3142  ;
                     3143  ; Step 1 (warmcor * Tpsfuelcut)/100 = R1 + rem1/100
                     3144  ; Step 2 (barocor * Aircor)/100 = R2 + rem2/100
                     3145  ; Step 3 ((R1 + rem1/100) * (R2 + rem2/100)) / 100 = R3 + rem3/100
                     3146  ; Step 4 (Ftrimcor * vecurr)/100 = R4 + rem4/100
                     3147  ; Step 5 ((R3 + rem3/100) * (R4 + rem4/100)) /100 = R5 + rem5/100
                     3148  ; Step 6 (kpa * REQ_FUEL)/100 = R6 + rem6/100
                     3149  ; Step 7 ((R5 + rem5/100) * (R6 + rem6/100))  = R7 + rem7/100
                     3150  ;
                     3151  ;  The result in R7 is the 1 microsecond result
                     3152  ;
                     3153  ; NOTE!! It is important to note that the results of all steps except
                     3154  ; step 7 cannot exceed 25500, or the calculations will not be accurate
                     3155  ;
                     3156  ;***********************************************************************************************
                     3157  
                     3158  ;***********************************************************************************************
                     3159  ;
                     3160  ; -------------------------- Computation of Normalized Variables -------------------------------
                     3161  ;
                     3162  ;  The following is the form of the evaluation for the normalized variables:
                     3163  ;
                     3164  ;  (A rem A * B)
                     3165  ;  -------------  = C rem C
                     3166  ;      100
                     3167  ;
                     3168  ;  Where A = Whole part of the percentage,
                     3169  ;        rem A = Remainder of A from previous calculation (range 0 to 99)
                     3170  ;        B = Percentage multiplied (this always has a zero remainder)
                     3171  ;        C = Whole part of result
                     3172  ;        rem C = remainder of result
                     3173  ;
                     3174  ;
                     3175  ;  Calculation is performed by the following method:
                     3176  ;
                     3177  ;     |(A * B) + (rem A * B)|
                     3178  ;     |          -----------|
                     3179  ;     |              100    |
                     3180  ;     ----------------------- = C rem C
                     3181  ;             100
                     3182  ;
                     3183  ;
                     3184  ;   Inputs:  tmp10 = A
                     3185  ;            tmp11 = rem A
                     3186  ;            tmp12 = B
                     3187  ;            tmp13 = rem B
                     3188  ;


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 26
MC68HC908GP32 User Bootloader


                     3189  ;   Outputs: tmp10 = C
                     3190  ;            tmp11 = rem C
                     3191  ;            tmp13 = high order part of (A rem A) * B
                     3192  ;            tmp14 = low order part of (A rem A) * B
                     3193  ;
                     3194  ;***********************************************************************************************
                     3195  
                     3196  ;WARMACCEL_COMP:
                     3197  
 8A31 [05] 4E4E9A    3198       mov     warmcor,tmp10      ; Warmup Correction in tmp10
 8A34 [03] 3F9B      3199       clr     tmp11              ; tmp11 is zero
 8A36 [05] 4E849C    3200       mov     tpsfuelcut,tmp12   ; tpsfuelcut in tmp12
 8A39 [03] 3F9D      3201       clr     tmp13              ; tmp13 is zero
 8A3B [05] CD90FE    3202       jsr     Supernorm          ; Multiply and divide by 100(warmcor and tpsfuelcut)
                     3203                                  ;(result in tmp10:tmp11)=R1+rem1/100
 8A3E [05] 4E9A91    3204       mov     tmp10,tmp1              ; save whole result in tmp1
 8A41 [05] 4E9B92    3205       mov     tmp11,tmp2              ; save remainder in tmp2(tmp1:tmp2 is R1+rem1/100)
 8A44 [05] 4E4D9A    3206       mov     barocor,tmp10      ; tmp10 is barometer percent
 8A47 [03] 3F9B      3207       clr     tmp11              ; zero to tmp11
 8A49 [05] 4E4F9C    3208       mov     aircor,tmp12       ; air temp correction % in tmp12
 8A4C [03] 3F9D      3209       clr     tmp13              ; tmp13 is zero
 8A4E [05] CD90FE    3210       jsr     Supernorm          ; Multiply and divide by 100(barocor and aircor)
                     3211                                  ;(result in tmp10:tmp11)=R2+rem2/100
 8A51 [05] 4E919C    3212       mov     tmp1,tmp12              ; move saved tmp1 into tmp12
 8A54 [05] 4E929D    3213       mov     tmp2,tmp13              ; move saved tmp2 into tmp13
 8A57 [05] CD90FE    3214       jsr     Supernorm          ; Multiply and divide by 100(R1+rem1/100 and R2+rem2/100)
                     3215                                  ;(result in tmp10:tmp11)=R3+rem3/100
 8A5A [05] 4E9A95    3216       mov     tmp10,tmp5              ; save whole result into tmp5
 8A5D [05] 4E9B96    3217       mov     tmp11,tmp6              ; save remainder into tmp6(R3+rem3/100)
 8A60 [03] B69A      3218       lda     tmp10              ;(R3)
 8A62 [03] B751      3219       sta     gammae             ; Copy to "Gammae" variable
 8A64 [05] 4E509A    3220       mov     Ftrimcor,tmp10     ; Fuel Trim correction percent into tmp10
 8A67 [03] 3F9B      3221       clr     tmp11              ; Remainder is zero
 8A69 [05] 4E549C    3222       mov     vecurr,tmp12       ; VE into tmp12
 8A6C [03] 3F9D      3223       clr     tmp13              ; Remainder is zero
 8A6E [05] CD90FE    3224       jsr     Supernorm          ; Multiply and divide by 100(Ftrimcor and vecurr)
                     3225                                  ;(result in tmp10:tmp11)=R4+rem4/100
 8A71 [05] 4E959C    3226       mov     tmp5,tmp12              ; move saved tmp5 into tmp12
 8A74 [05] 4E969D    3227       mov     tmp6,tmp13              ; move saved tmp6 into tmp13
 8A77 [05] CD90FE    3228       jsr     Supernorm          ; Multiply and divide by 100(R3+rem3/100 and R4+rem4/100)
                     3229                                  ;(result in tmp10:tmp11)=R5+rem5/100
 8A7A [05] 4E9A93    3230       mov     tmp10,tmp3              ; save whole result into tmp3
 8A7D [05] 4E9B94    3231       mov     tmp11,tmp4              ; save remainder into tmp4(R5+rem5/100)
 8A80 [05] 4E6C9A    3232       mov     kpa,tmp10          ; MAP into tmp10
 8A83 [03] 3F9B      3233       clr     tmp11              ; tmp11 is zero
 8A85 [04] C6E423    3234       lda     REQ_FUEL           ; Load accumulator with value in "REQ_FUEL"
 8A88 [03] B79C      3235       sta     tmp12              ; Copy to tmp12 variable
 8A8A [03] 3F9D      3236       clr     tmp13              ; tmp13 is zero
 8A8C [05] CD90FE    3237       jsr     Supernorm          ; Multiply and divide by 100(kpa and REQ_FUEL)
                     3238                                  ;(result in tmp10:tmp11)=R6+rem6/100
 8A8F [05] 4E939C    3239       mov     tmp3,tmp12              ; move saved tmp3 into tmp12
 8A92 [05] 4E949D    3240       mov     tmp4,tmp13              ; move saved tmp4 into tmp13
 8A95 [05] CD90FE    3241       jsr     Supernorm               ; Multiply and divide by 100(R5+rem5/100 and R6+rem6/100)
                     3242                                  ;(result in tmp13:tmp14)=R7+rem7/100
 8A98 [05] 4E9D70    3243       mov     tmp13,pwnadH       ; Move value in tmp13 to "pwnadH"
 8A9B [05] 4E9E71    3244       mov     tmp14,pwnadL       ; Move value in tmp14 to "pwnadL"
                     3245  
                     3246  
                     3247  ************************************************************************************************
                     3248  **
                     3249  ** Calculation of Battery Voltage Correction for Injector Opening Time
                     3250  **
                     3251  ** Injector open time is implemented as a linear function of
                     3252  **  battery voltage, from 7.2 volts (61 ADC counts) to 19.2 volts (164 counts),
                     3253  **  with 13.2 volts (113 counts) being the nominal operating voltage
                     3254  **
                     3255  ** INJOPEN = injector open time at 13.2 volts in mms
                     3256  ** BATTFAC = injector open adjustment factor 6 volts from 13.2V in mms
                     3257  **
                     3258  **
                     3259  ** + (INJOPEN + BATTFAC)
                     3260  ** +   *
                     3261  ** +                     (INJOPEN)
                     3262  ** +                         *
                     3263  ** +                                       (INJOPEN - BATTFAC)
                     3264  ** +                                               *
                     3265  ** +
                     3266  ** ++++++++++++++++++++++++++++++++++++++++++++++++++++++
                     3267  **    6.0V                 13.2V                16.2
                     3268  **
                     3269  ***********************************************************************************************
                     3270  
                     3271  BATT_CORR_COMP:
 8A9E [02] A63D      3272       lda     #61T        ; Load accumulator with decimal 61
 8AA0 [03] B791      3273       sta     tmp1        ; Copy to "tmp1"
 8AA2 [02] A6A4      3274       lda     #164T       ; Load accumulator with decimal 164
 8AA4 [03] B792      3275       sta     tmp2        ; Copy to "tmp2"
 8AA6 [04] C6E426    3276       lda     injopen     ; Load accumulator with value in "injopen"
 8AA9 [04] CBE427    3277       add     battfac     ; Add A<-(A)+(M)
 8AAC [03] B793      3278       sta     tmp3        ; Copy result to "tmp3"
 8AAE [04] C6E426    3279       lda     injopen     ; Load accumulator with value in "injopen"
 8AB1 [04] C0E427    3280       sub     battfac     ; Subtract A<-(A)-(M)
 8AB4 [03] B794      3281       sta     tmp4        ; Copy result to "tmp4"
 8AB6 [03] 2A02      3282       bpl     MBFF        ; Branch to MBFF: if plus(Check if minus condition)
 8AB8 [03] 3F94      3283       clr     tmp4        ; Clear "tmp4"
                     3284  MBFF:
 8ABA [05] 4E4595    3285       mov     batt,tmp5   ; Move value in "batt" to "tmp5"
 8ABD [05] CD900A    3286       jsr     lininterp   ; Jump to subroutine at lininterp:(injector open time in tmp6)
 8AC0 [03] B696      3287       lda     tmp6        ; Load accumulator with value in tmp6
 8AC2 [03] B774      3288       sta     deadband    ; Copy to Injector Deadband variable.
                     3289  
                     3290  
                     3291  ;***********************************************************************************************
                     3292  ;
                     3293  ; --------------------------- Calculation of Final Pulse Width ---------------------------------
                     3294  ;-----------
                     3295  ; The following equation is evaluated here:
                     3296  ;
                     3297  ; Where:
                     3298  ;  pwnadH:pwnadL   = Calculated Pulse Width without accelleration enrichment
                     3299  ;                    and injector deadband, in 1uS resolution
                     3300  ;  tpsaccel        = Accelleration Enrichment in 100uS resolution
                     3301  ;  fdhrH:fdhrL     = Calculated Pulse Width without injector deadband,
                     3302  ;                    in 1uS resolution (Fuel delivery)
                     3303  ;  deadband        = Injector deadband in 100uS resolution
                     3304  ;  pwcalch:pwcalcl = Final pulse width in 1uS resolution
                     3305  ;
                     3306  ;  pwnadH:pwnadL + (tpsaccel*100) = fdH:fdL
                     3307  ;
                     3308  ;  fdhrH:fdhrL + (deadband*100) = pwcalcH:pwcalcL
                     3309  ;
                     3310  ;***********************************************************************************************
                     3311  
                     3312  FINAL_PW_CALC:
 8AC4 [03] B652      3313       lda     tpsaccel     ; Load accumulator with value in "tpsaccel"
 8AC6 [02] AE64      3314       ldx     #$64         ; Load index register Lo byte with decimal 100
 8AC8 [05] 42        3315       mul                  ; Multiply (X:A <-(X)*(A)
 8AC9 [03] BB71      3316       add     pwnadL       ; Add (A)<-(A)+(X) Calculated PW Lo byte
 8ACB [03] B773      3317       sta     fdhrL        ; Copy result to Fuel delivery PW Hi Res Lo byte
 8ACD [01] 9F        3318       txa                  ; Transfer value in index register Lo byte to accumulator
 8ACE [03] B970      3319       adc     pwnadH       ; Add with carry (A)<-(A)+(X)+(C) Calculated PW Hi byte
 8AD0 [03] B772      3320       sta     fdhrH        ; Copy result to Fuel Delivery PW Hi Res Hi byte
 8AD2 [03] B674      3321       lda     deadband     ; Load accumulator with value in "Deadband"
 8AD4 [02] AE64      3322       ldx     #$64         ; Load index register Lo byte with decimal 100
 8AD6 [05] 42        3323       mul                  ; Multiply (X:A <-(X)*(A)
 8AD7 [03] BB73      3324       add     fdhrL        ; Add (A)<-(A)+(X) Fuel Delivery PW Hi Res Lo byte


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 27
MC68HC908GP32 User Bootloader


 8AD9 [03] B756      3325       sta     pwcalcL      ; Copy result to Final Pulse Width Lo byte
 8ADB [01] 9F        3326       txa                  ; Transfer value in index register Lo byte to accumulator
 8ADC [03] B972      3327       adc     fdhrH        ; Add with carry (A)<-(A)+(X)+(C) Fuel Delivery Pulse Width Hi Res
                     3328                            ; Hi byte
 8ADE [03] B755      3329       sta     pwcalcH      ; Copy result to Final Pulse Width Hi byte
                     3330  
                     3331  ;***********************************************************************************************
                     3332  ; - Divide pwcalcH:pwcalcL by 100 to produce Lo Res version ("pw") for TS and MT display,
                     3333  ;   and Fuel Burn Calcs
                     3334  ;***********************************************************************************************
                     3335  
 8AE0 [04] 5555      3336       ldhx     pwcalcH          ; Load index register with value in pwcalcH:pwcalcL
 8AE2 [01] 9F        3337       txa                       ; Transfer value in index register Lo byte to accumulator
 8AE3 [02] AE64      3338       ldx      #$64             ; Load index register Lo byte with decimal 100
 8AE5 [07] 52        3339       div                       ; Divide (A)<-(H:A)/(X);(H)rem
 8AE6 [05] CD90EB    3340       jsr      DIVROUND         ; Jump to "DIVROUND" subroutine(round result)
 8AE9 [03] B757      3341       sta      pw               ; Copy result to Final Pulse Width for display variable
                     3342                                 ;(0.1mS resolution)
                     3343  
                     3344  ;***********************************************************************************************
                     3345  ; - Divide fdhrH:fdhrL by 100, then add to ("dbCor") variable to produce Lo Res version ("fd")
                     3346  ;   for MV and MT display, and Fuel Burn Calcs
                     3347  ;   It is assumed that even with a 0.9 ms dead band the actual deadband may be less which can be
                     3348  ;   tuned around, but skews the fuel burn calcultaions especially at smaller pulse widths.
                     3349  ;   Adding the "dbCor" value will attempt to solve this problem by making the fuel delivery
                     3350  ;   variable larger
                     3351  ;
                     3352  ;   8/02/12 - Eliminate "dbcor"
                     3353  ;
                     3354  ;***********************************************************************************************
                     3355  
 8AEB [04] 5572      3356       ldhx     fdhrH          ; Load index register with value in fdhrH:fdhrL
 8AED [01] 9F        3357       txa                     ; Transfer value in index register Lo byte to accumulator
 8AEE [02] AE64      3358       ldx      #$64           ; Load index register Lo byte with decimal 100
 8AF0 [07] 52        3359       div                     ; Divide (A)<-(H:A)/(X);(H)rem
 8AF1 [05] CD90EB    3360       jsr      DIVROUND       ; Jump to "DIVROUND" subroutine(round result)
                     3361  ;*     add      dbCor          ; Add A<-(A)+(M) Deadband correction
 8AF4 [03] B758      3362       sta      fd             ; Copy result to Fuel Delivery Lo Res variable
                     3363  
                     3364  ;***********************************************************************************************
                     3365  ;
                     3366  ; ST 3-D Table Lookup
                     3367  ;
                     3368  ;  This is used to determine value of Spark Angle minus 10 degrees ST,
                     3369  ;   based on RPM and MAP
                     3370  ;  The table looks like:
                     3371  ;
                     3372  ;     105 +....+....+....+....+....+....+....+
                     3373  ;         ....................................
                     3374  ;      00 +....+....+....+....+....+....+....+
                     3375  ;                    ...
                     3376  ;  KPA                ...
                     3377  ;                        ...
                     3378  ;      35 +....+....+....+....+....+....+....+
                     3379  ;         5    15   25   35   45   55   65   75 RPM/20
                     3380  ;
                     3381  ;
                     3382  ; Steps:
                     3383  ;  1) Find the bracketing KPA positions via ORD_TABLE_FIND, put index in
                     3384  ;      tmp8 and bounding values in tmp9(kpa1) and tmp10(kpa2)
                     3385  ;  2) Find the bracketing RPM positions via ORD_TABLE_FIND, store index in
                     3386  ;      tmp11 and bounding values in tmp13(rpm1) and tmp14(rpm2)
                     3387  ;  3) Using the ST table, find the table ST values for tmp15=ST(kpa1,rpm1),
                     3388  ;      tmp16=ST(kpa1,rpm2), tmp17 = ST(kpa2,rpm1), and tmp18 = ST(kpa2,rpm2)
                     3389  ;  4) Find the interpolated ST value at the lower KPA range :
                     3390  ;      x1=rpm1, x2=rpm2, y1=ST(kpa1,rpm1), y2=ST(kpa1,rpm2) - put in tmp19
                     3391  ;  5) Find the interpolated ST value at the upper KPA range :
                     3392  ;      x1=rpm1, x2=rpm2, y1=ST(kpa2,rpm1), y2=ST(kpa2,rpm2) - put in tmp11
                     3393  ;  6) Find the final ST value using the two interpolated ST values:
                     3394  ;      x1=kpa1, x2=kpa2, y1=ST_FROM_STEP_4, y2=ST_FROM_STEP_5
                     3395  ;
                     3396  ;***********************************************************************************************
                     3397  
                     3398  ;STTABLELOOKUP:
                     3399  
                     3400  ;ST_STEP_1:
 8AF6 [03] 45E19C    3401       ldhx    #KPARANGEST_f       ; Load index register with value in KPARANGEST table
 8AF9 [04] 3591      3402       sthx    tmp1                ; Copy value to tmp1 variable
 8AFB [04] 6E0B93    3403       mov     #$0B,tmp3           ; Move decimal 12 into "tmp3"
 8AFE [05] 4E6C94    3404       mov     kpa,tmp4            ; Move value in "kpa" to "tmp4"
 8B01 [05] CD8FEF    3405       jsr     ORD_TABLE_FIND     ; Jump to subroutine ORD_TABLE_FIND,(result in tmp5)
 8B04 [03] B691      3406       lda     tmp1                ; Load accumulator with value in tmp1
 8B06 [03] B692      3407       lda     tmp2                ; Load accumulator with value in tmp2
 8B08 [05] 4E9598    3408       mov     tmp5,tmp8                  ; move value from tmp5 to tmp8 (Index)
 8B0B [05] 4E9199    3409       mov     tmp1,tmp9                  ; move value from tmp1 to tmp9 (X1)
 8B0E [05] 4E929A    3410       mov     tmp2,tmp10                 ; move value from tmp2 to tmp10 (X2)
                     3411  
                     3412  ;ST_STEP_2:
 8B11 [03] 45E190    3413       ldhx    #RPMRANGEST_f       ; Load index register with value from RPMRANGEST table
 8B14 [04] 3591      3414       sthx    tmp1                ; Copy value to tmp1 variable
 8B16 [04] 6E0B93    3415       mov     #$0B,tmp3           ; Move decimal 12 into "tmp3"
 8B19 [05] 4E5394    3416       mov     rpm20,tmp4          ; Move value in "rpm20" to "tmp4"
 8B1C [05] CD8FEF    3417       jsr     ORD_TABLE_FIND     ; Jump to subroutine ORD_TABLE_FIND,(result in tmp5)
 8B1F [05] 4E959B    3418       mov     tmp5,tmp11                 ; Move value from tmp5 to tmp11 (Index)
 8B22 [05] 4E919D    3419       mov     tmp1,tmp13                 ; Move value from tmp1 to tmp13 (X1)
 8B25 [05] 4E929E    3420       mov     tmp2,tmp14                 ; Move value from tmp2 to tmp14 (X2)
                     3421  
                     3422  ;ST_STEP_3:
 8B28 [01] 8C        3423          clrh              ; Clear index register Hi byte
 8B29 [02] AE0C      3424          ldx     #$0C      ; Load index register Lo byte with decimal 13
 8B2B [03] B698      3425          lda     tmp8      ; Load accumulator with value in "tmp8"
 8B2D [01] 4A        3426          deca              ; Decrement value in accumulator
 8B2E [05] 42        3427          mul               ; Multiply X:A<-(X)x(A)
 8B2F [03] BB9B      3428          add     tmp11     ; Add "tmp11" to result A<-(A)+(M)
 8B31 [01] 4A        3429          deca              ; Decrement value in accumulator
 8B32 [01] 97        3430          tax               ; Transfer value in accumulator to index register Lo byte
 8B33 [05] CD9162    3431          jsr     VE2X      ; Jump to subroutine at VE2X:
 8B36 [03] B79F      3432          sta     tmp15     ; Copy result to "tmp15"
 8B38 [01] 5C        3433          incx              ; Increment value in index rgister Lo byte
 8B39 [05] CD9162    3434          jsr     VE2X      ; Jump to subroutine at VE2X:
 8B3C [03] B7A0      3435          sta     tmp16     ; Copy result to "tmp16"
 8B3E [02] AE0C      3436          ldx     #$0C      ; Load index register Lo byte with decimal 13
 8B40 [03] B698      3437          lda     tmp8      ; Load accumulator with value in "tmp8"
 8B42 [05] 42        3438          mul               ; Multiply X:A<-(X)x(A)
 8B43 [03] BB9B      3439          add     tmp11     ; Add "tmp11" to result A<-(A)+(M)
 8B45 [01] 4A        3440          deca              ; Decrement value in accumulator
 8B46 [01] 97        3441          tax               ; Transfer value in accumulator to index register Lo byte
 8B47 [05] CD9162    3442          jsr     VE2X      ; Jump to subroutine at VE2X:
 8B4A [03] B7A1      3443          sta     tmp17     ; Copy result to "tmp17"
 8B4C [01] 5C        3444          incx              ; Increment value in index rgister Lo byte
 8B4D [05] CD9162    3445          jsr     VE2X      ; Jump to subroutine at VE2X:
 8B50 [03] B7A2      3446          sta     tmp18     ; Copy result to "tmp18"
                     3447  
                     3448  ;ST_STEP_4:
 8B52 [05] 4E9D91    3449       mov     tmp13,tmp1      ; Move value from tmp13 variable to tmp1 variable
 8B55 [05] 4E9E92    3450       mov     tmp14,tmp2      ; Move value from tmp14 variable to tmp2 variable
 8B58 [05] 4E9F93    3451       mov     tmp15,tmp3      ; Move value from tmp15 variable to tmp3 variable
 8B5B [05] 4EA094    3452       mov     tmp16,tmp4      ; Move value from tmp16 variable to tmp4 variable
 8B5E [05] 4E5395    3453       mov     rpm20,tmp5      ; Move Throttle Position Sensor ADC to tmp5 variable
 8B61 [05] CD900A    3454       jsr     lininterp       ; Jump to subroutine lininterp (result in tmp6)
 8B64 [05] 4E96A3    3455       mov     tmp6,tmp19      ; Move value from tmp6 variable to tmp19 variable
                     3456  
                     3457  ;ST_STEP_5:
 8B67 [05] 4E9D91    3458       mov     tmp13,tmp1      ; Move value from tmp13 variable to tmp1 variable
 8B6A [05] 4E9E92    3459       mov     tmp14,tmp2      ; Move value from tmp14 variable to tmp2 variable
 8B6D [05] 4EA193    3460       mov     tmp17,tmp3      ; Move value from tmp17 variable to tmp3 variable


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 28
MC68HC908GP32 User Bootloader


 8B70 [05] 4EA294    3461       mov     tmp18,tmp4      ; Move value from tmp18 variable to tmp4 variable
 8B73 [05] 4E5395    3462       mov     rpm20,tmp5      ; Move RPM/20 to tmp5 variable
 8B76 [05] CD900A    3463       jsr     lininterp       ; Jump to subroutine lininterp (result in tmp6)
 8B79 [05] 4E969B    3464       mov     tmp6,tmp11      ; Move value from tmp6 variable to tmp11 variable
                     3465  
                     3466  ;ST_STEP_6:
 8B7C [05] 4E9991    3467       mov     tmp9,tmp1        ; Move value from tmp9 variable to tmp1 variable
 8B7F [05] 4E9A92    3468       mov     tmp10,tmp2       ; Move value from tmp10 variable to tmp2 variable
 8B82 [05] 4EA393    3469       mov     tmp19,tmp3       ; Move value from tmp19 variable to tmp3 variable
 8B85 [05] 4E9B94    3470       mov     tmp11,tmp4       ; Move value from tmp11 variable to tmp4 variable
 8B88 [05] 4E6C95    3471       mov     kpa,tmp5         ; Move value in MAP value in units of KPa to tmp5
 8B8B [05] CD900A    3472       jsr     lininterp        ; Jump to subroutine lininterp (result in tmp6)
 8B8E [05] 4E965D    3473       mov     tmp6,Spk_Ang_Fac   ; Move result to "Spk_Ang_Fac"
                     3474  
                     3475  ;*;***********************************************************************************************
                     3476  ;*; - MSnS351WM uses a crank triggered hall effect sensor to trigger the IRQ, as opposed to the
                     3477  ;*;   distributor hall effect PIP signal used in MSnS300 and MSnS460. This is done to retain
                     3478  ;*;   the ignition protected marine certified distributor. Static timing is still set to 10
                     3479  ;*;   degrees BTDC to retain the remote TFI module. The crank triggered PIP signal is 12 volt
                     3480  ;*;   square wave 50% duty cycle, the same as the signals used in MSnS300 and MSnS460. In case
                     3481  ;*;   there was an error in positioning the crank sensor, the following code is used to correct
                     3482  ;*;   for that error by using the variable "trigErr". A "trigErr" value of 128 commands no
                     3483  ;*;   correction. Values <128 will advance the timing, values >128 will retard the timing.
                     3484  ;*;   1 count = .353 degrees, or 1 degree = 2.83 counts.
                     3485  ;*;
                     3486  ;*;   8/02/12 - Eliminate "trigErr"
                     3487  ;*;
                     3488  ;*;***********************************************************************************************
                     3489  
                     3490  ;*     lda     trigErr        ; Load accumulator with value in "trigErr"
                     3491  ;*     cmp     #$80           ; Compare with decimal 128
                     3492  ;*     bhi     RETARD         ; If (A)>(M) branch to RETARD:
                     3493  ;*     blo     ADVANCE        ; If (A)<(M) branch to ADVANCE:
                     3494  ;*     bra     NO_TRIGERR     ; Branch to NO_TRIGERR:
                     3495  
                     3496  ;*RETARD:
                     3497  ;*     lda     trigErr        ; Load accumulator with value in "trigErr"
                     3498  ;*     sub     #$80           ; Subtract (A<-(A)-(M))(trigErr - decimal 128)
                     3499  ;*     add     tmp6           ; Add (A<-(A)+(M))(result + trigErr)
                     3500  ;*     sta     Spk_Ang_Fac    ; Copy to Spk_Ang_Fac
                     3501  ;*     bra     TRIGERR_DONE   ; Branch to TRIGERR_DONE:
                     3502  
                     3503  ;*ADVANCE:
                     3504  ;*     lda     #$80           ; Load accumulator with decimal 128
                     3505  ;*     sub     trigErr        ; Subtract (A<-(A)-(M))(decimal 128 - trigErr)
                     3506  ;*     sta     tmp1           ; Copy result to "tmp1"
                     3507  ;*     lda     tmp6           ; Load accumulator with value in "tmp6"(St table lookup value)
                     3508  ;*     sub     tmp1           ; Subtract (A<-(A)-(M))
                     3509                              ; (St table lookup value - (decimal 128 - trigErr))
                     3510  ;*     sta     Spk_Ang_Fac    ; Copy to Spk_Ang_Fac
                     3511  ;*     bra     TRIGERR_DONE   ; Branch to TRIGERR_DONE:
                     3512  
                     3513  ;*NO_TRIGERR:
                     3514  ;*     mov     tmp6,Spk_Ang_Fac   ; Move ST table lookup value to "Spk_Ang_Fac"
                     3515  
                     3516  ;*TRIGERR_DONE:
                     3517  
                     3518  ;***********************************************************************************************
                     3519  ; - Calculate the Delay Angle Factor from PIP to SPOUT
                     3520  ;***********************************************************************************************
                     3521  
 8B91 [03] B65D      3522       lda     Spk_Ang_Fac         ; Load acumulator with value in Spark Angle Factor variable
 8B93 [03] BB5E      3523       add     Trm_Ang_Fac         ; Add with value in Trim Angle Factor(A<-(A)+(M))
 8B95 [03] 2504      3524       bcs     RAIL_DL_ANG_FAC     ; If C bit of CCR is set, branch to RAIL_DL_ANG_FAC
 8B97 [03] B75F      3525       sta     Dly_Ang_Fac         ; Copy Result to Delay Angle Factor var
 8B99 [03] 2004      3526       bra     DLY_ANG_CALC_DONE   ; Branch to DLY_ANG_CALC_DONE
                     3527  
                     3528  RAIL_DL_ANG_FAC:
 8B9B [02] A6FF      3529       lda     #$FF            ; Load accumultor with decimal 255 (maximum delay = 255/256*period)
 8B9D [03] B75F      3530       sta     Dly_Ang_Fac     ; Copy Result to Delay Angle variable
                     3531  
                     3532  DLY_ANG_CALC_DONE:
                     3533  
                     3534  ;***********************************************************************************************
                     3535  ;***********************************************************************************************
                     3536  
                     3537  LOOP_DONE:
 8B9F [03] CC83BD    3538       jmp     LOOPER     ; Jump to LOOPER: (End of Main Loop!!!)
                     3539  
                     3540  ;***********************************************************************************************
                     3541  ;***********************************************************************************************
                     3542  
                     3543  
                     3544  ;***********************************************************************************************
                     3545  ;
                     3546  ;* * * * * * * * * * * * * * * * * *   Interrupt Section * * * * * * * * * * * * * * * * * * * *
                     3547  ;
                     3548  ; NOTE!!! If the interrupt service routine modifies the H register, or uses the indexed
                     3549  ; addressing mode, save the H register (pshh) and then restore it (pulh) prior to exiting
                     3550  ; the routine
                     3551  ;
                     3552  ;***********************************************************************************************
                     3553  
                     3554  ;***********************************************************************************************
                     3555  ;
                     3556  ; -------------------- Following interrupt service routines in priority order ------------------
                     3557  ;
                     3558  ; IRQ_ISR:     - PIP input (PIP input Hi, IRQ Lo, hardware inverted)
                     3559  ;
                     3560  ; TIM2CH0_ISR: - TIM2 CH0 output compare ($0064 * 1uS) (100us Timer Tick)
                     3561  ;
                     3562  ; TIM2CH1_ISR: - TIM2 CH1 output compare (SPOUT control)
                     3563  ;
                     3564  ; SCIRCV_ISR:  - SCI receive
                     3565  ;
                     3566  ; SCITX_ISR:   - SCI transmit
                     3567  ;
                     3568  ; KYBD_ISR:    - Keyboard interrupt (Ignition Monitor)
                     3569  ;                from High to Low (hardware inverted)
                     3570  ;
                     3571  ; ADC_ISR:     - ADC Conversion Complete
                     3572  ;
                     3573  ;***********************************************************************************************
                     3574  
                     3575  ;***********************************************************************************************
                     3576  ;===============================================================================================
                     3577  ; - IRQ - Input trigger (PIP rising edge,IRQ falling edge, hardware inverted)
                     3578  ;   SPOUT signal scheduling time stamps,
                     3579  ;   Decrement minPIP counter.
                     3580  ;   Increment afterstart enrichment counter.
                     3581  ;   Determine RPM period.
                     3582  ;   Injector scheduling.
                     3583  ;===============================================================================================
                     3584  ;***********************************************************************************************
                     3585  
                     3586  IRQ_ISR:
 8BA2 [02] 8B        3587       pshh             ; Push value in index register Hi byte to stack
                     3588  
                     3589  
                     3590  ;***********************************************************************************************
                     3591  ; - Get 1uS Timestamp for SPOUT "on" calculations
                     3592  ;   T2CNTH:T2CNTL = PIP_tsH:PIP_tsL
                     3593  ;***********************************************************************************************
                     3594  
                     3595  GET_TIMESTAMP:
 8BA3 [03] B62D      3596       lda     T2CNTL      ; Load accumulator with value in TIM2 Counter Register Lo byte


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 29
MC68HC908GP32 User Bootloader


                     3597                           ;(Unlatch any previous reads)
 8BA5 [03] BE2C      3598       ldx     T2CNTH      ; Load index register Lo byte with value in TIM2 Counter Register Hi
 8BA7 [03] BFA7      3599       stx     PIP_tsH     ; Copy to PIP Timestamp Hi byte variable
 8BA9 [03] B62D      3600       lda     T2CNTL      ; Load accumulator with value in TIM2 Counter Register Lo byte
 8BAB [03] B7A8      3601       sta     PIP_tsL     ; Copy to PIP Timestamp Lo byte variable
                     3602  
                     3603  ;***********************************************************************************************
                     3604  ; - Check to see if we have received a minimum of 3 PIP signals so that
                     3605  ;   period calculations will be valid
                     3606  ;***********************************************************************************************
                     3607  
                     3608  CHECK_PIPn:
 8BAD [03] B6C2      3609       lda   MinPIP         ; Load accumulator with value in Minimum PIP signals required for
                     3610                            ; period calculations
 8BAF [03] 2704      3611       beq   PIP_OK         ; If Z bit of CCR is set, branch to PIP_OK:
 8BB1 [04] 3AC2      3612       dec   MinPIP         ; Decrement "MinPIP" variable
 8BB3 [03] 2000      3613       bra   RPM_PERIOD     ; Branch to RPM_PERIOD:
                     3614  
                     3615  PIP_OK:
                     3616  
                     3617  ;***********************************************************************************************
                     3618  ; - Determine the RPM period in 100uS resolution from the RPM counter values
                     3619  ;***********************************************************************************************
                     3620  
                     3621  RPM_PERIOD:
 8BB5 [03] B677      3622       lda     RPMcH          ; Load accumulator with value in RPM counter Hi byte
 8BB7 [03] B775      3623       sta     RPMpH          ; Copy to RPM Period Hi byte
 8BB9 [03] B678      3624       lda     RPMcL          ; Load accumulator with value in RPM counter Lo byte
 8BBB [03] B776      3625       sta     RPMpL          ; Copy to RPM Period Low byte
 8BBD [03] 3F77      3626       clr     RPMcH          ; Clear RPM counter Hi byte
 8BBF [03] 3F78      3627       clr     RPMcL          ; Clear RPM counter Lo byte
                     3628  
                     3629  ;***********************************************************************************************
                     3630  ; - Increment the counter for the Hi Res tachometer period averageing.
                     3631  ;***********************************************************************************************
                     3632  
 8BC1 [04] 3CD3      3633       inc     tachcnt        ; Increment the tachometer averaging counter
                     3634  
                     3635  ;***********************************************************************************************
                     3636  ; If we are in ASE mode, and ignition cycle counter has been selected, Increment after-start
                     3637  ; enrichment counter
                     3638  ;***********************************************************************************************
                     3639  
 8BC3 [05] 056317    3640       brclr   startw,engine,NO_IGN_COUNT     ; If "startw" bit of "engine" variable is clear,
                     3641                                              ; branch to NO_IGN_COUNT:
 8BC6 [05] 076309    3642       brclr   warmup,engine,HOT_IGN          ; If "startw" bit of "engine" variable is clear,
                     3643                                              ; branch to HOT_IGN:
 8BC9 [04] C6E445    3644       lda     ASEtype           ; Load accumulator with value in ASE type configuration variable
 8BCC [02] A100      3645       cmp     #$0               ; Compare it with decimal 0
 8BCE [03] 270B      3646       beq     DO_IGN_COUNT      ; IF Z bit of CCR is set, branch to DO_IGN_COUNT: (ASEtype = 0)
 8BD0 [03] 200B      3647       bra     NO_IGN_COUNT      ; Branch to NO_IGN_COUNT: (ASEtype not = 0)
                     3648  
                     3649  HOT_IGN:
 8BD2 [04] C6E432    3650       lda     ASEHtype          ; Load accumulator with value in ASE Hot type config variable
 8BD5 [02] A100      3651       cmp     #$0               ; Compare it with decimal 0
 8BD7 [03] 2702      3652       beq     DO_IGN_COUNT      ; IF Z bit of CCR is set, branch to DO_IGN_COUNT: (ASEHtype = 0)
 8BD9 [03] 2002      3653       bra     NO_IGN_COUNT      ; Branch to NO_IGN_COUNT: (ASEHtype not = 0)
                     3654  
                     3655  DO_IGN_COUNT:
 8BDB [04] 3C7F      3656       inc    asecount
                     3657  
                     3658  NO_IGN_COUNT:
                     3659  
                     3660  ;***********************************************************************************************
                     3661  ; ------------------------------------- Fuel Section -------------------------------------------
                     3662  ; - "divider" is the "ignition counts per injection" constant set in Tuner Studio
                     3663  ; - "alternate" is the "Injection Mode" constant set in Tuner Studio(0 = sim,1 = alternate)
                     3664  ;***********************************************************************************************
                     3665  
                     3666  DO_FUEL:
 8BDD [05] 006306    3667       brset    running,engine,RUN_SET    ; If "running" bit of"engine" variable is set,
                     3668                                          ; branch to RUN_SET:
 8BE0 [04] 1000      3669       bset     fuelp,PORTA               ; Set Fuel Pump Relay on Port A0(Turn on fuel Pump)
 8BE2 [04] 1065      3670       bset     FPon,portAbits            ; Set "FPon" bit of "PortAbits"
 8BE4 [04] 1063      3671       bset     running,engine            ; Set "running" bit of "engine" variable
                     3672  
                     3673  RUN_SET:
 8BE6 [05] 026313    3674       brset    crank,engine,SCHED_SQUIRT ; If "crank" bit of "engine" variable is set,
                     3675                                          ; branch to SCHED_SQUIRT:
                     3676                                          ; (Inject on every pulse if cranking)
 8BE9 [04] 3C81      3677       inc      igncount                  ; Increment Ignition pulse counter
 8BEB [03] B681      3678       lda      igncount                  ; Load accumulator with value in Ign pulse counter
 8BED [04] C1E424    3679       cmp      divider                   ; Compare with Ignition counts per injection
 8BF0 [03] 270A      3680       beq      SCHED_SQUIRT              ; If Z bit in CCR is set((A)=(M))
                     3681                                          ; branch to SCHED_SQUIRT:
 8BF2 [03] B681      3682       lda      igncount                       ; Load accumulator with Ignition pulse counter
 8BF4 [02] A108      3683       cmp      #$08                      ; Compare with decimal 8
                     3684                                          ;(The maximum allowed - reset if match)
 8BF6 [03] 2623      3685       bne      IRQ_DONE                       ; If not equal, branch to IRQ_DONE:
 8BF8 [03] 3F81      3686       clr      igncount                  ; Clear Ignition pulse counter variable
 8BFA [03] 201F      3687       bra      IRQ_DONE                  ; Branch to IRQ_DONE:
                     3688  
                     3689  SCHED_SQUIRT:
 8BFC [03] 3F81      3690       clr      igncount                  ; Clear Ignition pulse counter variable
                     3691  
                     3692  CRANK_CHK:
 8BFE [05] 026316    3693       brset     crank,engine,SCHED_BOTH   ; If crank bit of engine variable is set, branch
                     3694                                           ; to SCHED_BOTH:
 8C01 [04] C6E425    3695       lda       alternate                 ; Load accumulator with value in "alternate"(0 or 1)
 8C04 [03] 2711      3696       beq       SCHED_BOTH                ; If Z bit of CCR is set(A)=(M), branch to
                     3697                                           ; SCHED_BOTH:
 8C06 [04] 3C82      3698       inc       altcount                  ; Increment Alternate count selector variable
 8C08 [05] 008206    3699       brset     0,altcount,SCHED_INJ2     ; If 0 bit of "altcount" variable is set, branch to
                     3700                                           ; SCHED_INJ2:
                     3701  
                     3702  SCHED_INJ1:
 8C0B [04] 146A      3703       bset    sched1,squirt     ; Set "sched1" bit of "squirt" variable
 8C0D [04] 196A      3704       bclr    sched2,squirt     ; Clear "sched2" bit of "squirt" variable
 8C0F [03] 200A      3705       bra     IRQ_DONE          ; Branch to IRQ_DONE:
                     3706  
                     3707  SCHED_INJ2:
 8C11 [04] 186A      3708       bset    sched2,squirt    ; Set "sched2" bit of "squirt" variable
 8C13 [04] 156A      3709       bclr    sched1,squirt     ; Clear "sched1" bit of "squirt" variable
 8C15 [03] 2004      3710       bra     IRQ_DONE          ; Branch to IRQ_DONE:
                     3711  
                     3712  SCHED_BOTH:
 8C17 [04] 146A      3713       bset    sched1,squirt     ; Set "sched1" bit of "squirt" variable
 8C19 [04] 186A      3714       bset    sched2,squirt     ; Set "sched2" bit of "squirt" variable
                     3715  
                     3716  IRQ_DONE:
 8C1B [04] 106B      3717       bset    piprise,inputs    ; Set "piprise" bit of "inputs" variable
 8C1D [02] 8A        3718       pulh                      ; Pull value from stack to index register Hi
 8C1E [07] 80        3719       rti                       ; Return from interrupt
                     3720  
                     3721  
                     3722  ;***********************************************************************************************
                     3723  ;===============================================================================================
                     3724  ; - TIM2 CH0 Interrupt (100 uS clock tick)
                     3725  ; - Generate time rates:
                     3726  ;   100 Microseconds,(for AIOT,RPM counters, Overspeed check,Stall check, Injector firing
                     3727  ;                     control, Update fuel burn variables)
                     3728  ;   Milliseconds,(for ADC conversions)
                     3729  ;   100 Milliseconds,(for TPS DOT calculations and ASE counter)
                     3730  ;   250 Milliseconds,(for ASE counter)
                     3731  ;   500 Milliseconds,(for ASE counter)
                     3732  ;   Seconds,(for fuel burn calc variables for TS and MV and ASE counter)


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 30
MC68HC908GP32 User Bootloader


                     3733  ;===============================================================================================
                     3734  ;***********************************************************************************************
                     3735  
                     3736  ;***********************************************************************************************
                     3737  ; - Read the current TIM2 CH0 counter value and add decimal 100 for the new
                     3738  ;   100uS clock tick O/C value
                     3739  ;***********************************************************************************************
                     3740  
                     3741  TIM2CH0_ISR:
 8C1F [02] 8B        3742       pshh                  ; Push value in index register Hi byte to stack
 8C20 [03] B630      3743       lda     T2SC0         ; Load accumulator with value in TIM2 CH0 Status and Control Register
                     3744                             ; (Arm CHxF flag clear)
 8C22 [04] 1F30      3745       bclr    CHxF,T2SC0    ; Clear CHxF bit of TIM2 CH0 Status and Control Register
 8C24 [04] 5531      3746       ldhx    T2CH0H        ; Load index register with value in TIM2 CH0 register H:L
                     3747                             ; (output compare value)
 8C26 [02] AF64      3748       aix     #$64          ; Add decimal 100 (100 uS)
 8C28 [04] 3531      3749       sthx    T2CH0H        ; Copy result to TIM2 CH0 register(new output compare value)
                     3750  
                     3751  ;==============================================================================================
                     3752  ;******************************** 100 Microsecond section *************************************
                     3753  ;==============================================================================================
                     3754  
                     3755  ;**********************************************************************************************
                     3756  ; - Check the value of the AIOT trigger off counter variable, if other than zero, decrement it.
                     3757  ;   When it reaches zero, shut the AIOT trigger off(open collector output)
                     3758  ;**********************************************************************************************
                     3759  
 8C2A [03] B6CB      3760       lda     aiotcntr          ; Load accumulator with value in "aiotcntr"
 8C2C [03] 270A      3761       beq     AIOT_CHK_DONE     ; If "Z" bit of "CCR is set, branch to AIOT_CHK_DONE:
 8C2E [04] 3ACB      3762       dec     aiotcntr          ; Decrement "aiotcntr"
 8C30 [03] B6CB      3763       lda     aiotcntr          ; load accumulator with value in "aiotcntr"
 8C32 [03] 2702      3764       beq     AIOT_OFF          ; If "Z" bit of "CCR is set, branch to AIOT_OFF:
 8C34 [03] 2002      3765       bra     AIOT_CHK_DONE     ; Branch to AIOT_CHK_DONE:
                     3766  
                     3767  AIOT_OFF:
 8C36 [04] 1102      3768       bclr    aiot,portC        ; Clear "aiot" bit of Port C (AIOT trigger off)
                     3769  
                     3770  AIOT_CHK_DONE:
                     3771  
                     3772  ;**********************************************************************************************
                     3773  ; - Increment the RPM counter
                     3774  ;**********************************************************************************************
                     3775  
                     3776  INC_RPM_CNTR:
 8C38 [04] 3C78      3777       inc      rpmcl           ; Increment counter for RPM Lo byte
 8C3A [03] 2602      3778       bne      RPM_CNTR_DONE  ; If the Z bit of the CCR is clear, branch to RPM_CNTR_DONE:
                     3779                                ;(Increment "rpmch" when "rpmcl" rolls over)
 8C3C [04] 3C77      3780       inc      rpmch           ; Increment counter for RPM Hi byte
                     3781  
                     3782  RPM_CNTR_DONE:
 8C3E [05] 0A6478    3783       brset   REVL,alarmbits,INC_CUS_JMP ; If "REVL" bit of "alarmbits" is set, branch to
                     3784                                          ; INC_CUS_JMP:(Over speed situation. Skip over firing
                     3785                                          ; control to slow engine down in a hurry)
                     3786  
                     3787  ;**********************************************************************************************
                     3788  ; - Check for stall and take appropriate action
                     3789  ;**********************************************************************************************
                     3790  
                     3791  CHECK_STALL:
 8C41 [03] B677      3792       lda      rpmch              ; Load accumulator with Counter for RPM Hi byte
 8C43 [02] A164      3793       cmp      #$64               ; Compare with decimal 100 (If rpmch is 100
                     3794                                   ; (RPM Period = 2.56 sec) then engine not turning over)
 8C45 [03] 2612      3795       bne      INJ_FIRE_CNTL      ; If (A)not=(M), branch to INJ_FIRE_CNTL:
 8C47 [03] 3F63      3796       clr      engine             ; Clear "engine" variable
                     3797                                   ;(Engine is stalled, clear all in engine)
 8C49 [04] 1100      3798       bclr     fuelp,PORTA        ; Clear "Fuel Pump" output Port A(Turn off fuel pump)
 8C4B [04] 1165      3799       bclr     FPon,portAbits     ; Clear "FPon" bit of "portAbits"
 8C4D [04] 1200      3800       bset     spark,PORTA        ; Set "spark" bit of Port A (SPOUT falling edge)
 8C4F [03] 3F77      3801       clr      rpmch              ; Clear Counter for high part of RPM
 8C51 [03] 3F78      3802       clr      rpmcl              ; Clear Low part of RPM Period
 8C53 [03] 3F53      3803       clr      rpm20              ; Clear Computed engine RPM - rpm/20 variable
 8C55 [04] 1969      3804       bclr     cant_crank,engine2 ; Clear "cant_crank" bit in "engine"(OK to crank again)
 8C57 [03] 2060      3805       bra      INC_CUS_JMP        ; Branch to INC_CUS_JMP:
                     3806                                   ;(engine not turning over, skip Injector Firing Control)
                     3807  
                     3808  
                     3809  ;**********************************************************************************************
                     3810  ;
                     3811  ;=================== Injector Firing Control = Main Injector Control Logic ====================
                     3812  ;
                     3813  ; An injector is scheduled to be fired - because the other bank *may* be
                     3814  ; firing, we have to do a little monkey business with the timer. Here we stop
                     3815  ; the timer counting, but we do not reset the count to zero - this lets us
                     3816  ; subtract both channel's OC compare value from the current timer value and
                     3817  ; re-write back in. Later on, we stop the timer again (already stopped) but
                     3818  ; this time the count is reset to zero. Because we do the following below,
                     3819  ; the other channel's count is still valid for a future OC. If there is not
                     3820  ; a OC compare pending in the other channel, we still do this because it does
                     3821  ; not hurt anything and it takes less time to do the subtraction than it does
                     3822  ; to determine if there is a OC compare pending.....
                     3823  ; This code allows pulsewidths to overlap - up to 65.535ms PW
                     3824  ;
                     3825  ;**********************************************************************************************
                     3826  
                     3827  INJ_FIRE_CNTL:
 8C59 [05] 046A06    3828       brset   sched1,squirt,INJSTRT   ; If "sched1" bit of "squirt" variable is set,
                     3829                                       ; branch to INJSTRT:
 8C5C [05] 086A03    3830       brset   sched2,squirt,INJSTRT   ; If "sched2" bit of "squirt" variable is set,
                     3831                                       ; branch to INJSTRT:
 8C5F [03] CC8CEF    3832       jmp     INJ_FIRE_CNTL_DONE      ; Jump to INJ_FIRE_CNTL_DONE:
                     3833  
                     3834  ;**********************************************************************************************
                     3835  ; - Stop Timer so it can be set up - no timer clock reset
                     3836  ;   Subtract OC values from current timer count, and re-write back in.
                     3837  ;**********************************************************************************************
                     3838  
                     3839  INJSTRT:
 8C62 [04] 6E2320    3840       mov      #$23,T1SC     ; Move %00100011 into Timer1 Status and Control Register
                     3841                              ; (Stop timer, reset timer counter, prescale for 1uS)
 8C65 [03] B626      3842       lda      T1CH0H        ; Load accumulator with value in Timer1 Channel 0 Register Hi byte
 8C67 [03] B021      3843       sub      T1CNTH        ;Subtract value in Timer1 Counter Register Hi (A<-(A)-(M))
 8C69 [03] B726      3844       sta      T1CH0H        ; Copy to Timer1 Channel 0 Register Hi byte
 8C6B [03] B627      3845       lda      T1CH0L        ; Load accumulator with value in Timer1 Channel 0 Register Lo byte
 8C6D [03] B022      3846       sub      T1CNTL        ; Subtract value in Timer1 Counter Register Lo byte(A<-(A)-(M))
 8C6F [03] B727      3847       sta      T1CH0L        ; Copy to Timer1 Channel 0 Register Lo bytr
 8C71 [03] B629      3848       lda      T1CH1H        ; Load accumulator with value in Timer1 Channel 1 Register Hi byte
 8C73 [03] B021      3849       sub      T1CNTH        ; Subtract value in Timer1 Counter Register Hi byte(A<-(A)-(M))
 8C75 [03] B729      3850       sta      T1CH1H        ; Copy to Timer1 Channel 1 Register Hi byte
 8C77 [03] B62A      3851       lda      T1CH1L        ; Load accumulator with value in Timer1 Channel 1 Register Lo byte
 8C79 [03] B022      3852       sub      T1CNTL        ; Subtract value in Timer1 Counter Register Lo byte(A<-(A)-(M))
 8C7B [03] B72A      3853       sta      T1CH1L        ; Copy to Timer1 Channel 1 Register Lo byte
                     3854  
 8C7D [05] 046A05    3855       brset   sched1,squirt,NEW_SQUIRT1  ; If "sched1" bit of "squirt" is set, branch to
                     3856                                          ; NEW_SQUIRT1:
                     3857  
                     3858  INJF1:
 8C80 [05] 086A38    3859       brset   sched2,squirt,NEW_SQUIRT2  ; If "sched2" bit of "squirt" is set, branch to
                     3860                                          ; NEW_SQUIRT2:
                     3861  
                     3862  INJF2:
 8C83 [03] 206A      3863       bra     INJ_FIRE_CNTL_DONE         ; Branch to INJ_FIRE_CNTL_DONE:
                     3864  
                     3865  
                     3866  ;**********************************************************************************************
                     3867  ;=========================== Injector #1 - Start New Injection ================================
                     3868  ;**********************************************************************************************


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 31
MC68HC908GP32 User Bootloader


                     3869  
                     3870  NEW_SQUIRT1:
 8C85 [04] 156A      3871       bclr    sched1,squirt     ; Clear "sched1" bit of "squirt"(is now current operation)
 8C87 [04] 6E3320    3872       mov     #$33,T1SC         ; Move %00110011 into TIM1 Status and Control Register
                     3873                                 ; (Disable interrupts, stop timer, reset counter,
                     3874                                 ; prescale for 1uS)
 8C8A [05] 4E5526    3875       mov     pwcalcH,T1CH0H    ; Move value in Final Pulse Width Hi byte
                     3876                                 ; to TIM1 CHO O/C Register Hi byte
 8C8D [05] 4E5627    3877       mov     pwcalcL,T1CH0L    ; Move value in Final Pulse Width Lo byte
                     3878                                 ; to TIM1 CHO O/C Register Lo byte
                     3879                                 ; pulsewidth to TIM1 CH0 register Lo byte
 8C90 [04] 6E1025    3880       mov     #$10,T1SC0        ; Move %00010000 into TIM1 CH0 Status and Control Register
                     3881                                 ; (Make this normal port output init logic 1)
 8C93 [04] 6E1C25    3882       mov     #$1C,T1SC0        ; Move %00011100 into TIM1 CH0 Status and Control register
                     3883                                 ; (Disable interupts,set output on compare)
 8C96 [04] 6E0320    3884       mov     #$03,T1SC         ; Move %00000011 into TIM1 Status and Control Register
                     3885                                 ; (Disable interrupts, start timer, prescale for 1uS)
                     3886  
                     3887  ;***********************************************************************************************
                     3888  ; - Update Fuel Delivery Pulse Width Lo Res Total so the results can be used by TS and MV to
                     3889  ;   calculate current fuel burn.
                     3890  ;***********************************************************************************************
                     3891  
 8C99 [03] B658      3892       lda     fd        ; Load accumulator with value in Fuel Delivery PW Lo Res
 8C9B [03] BBCD      3893       add     fdtL      ; Add (A)<-(A)+(M) (Fuel Delivery PW Lo Res + Fuel
                     3894                         ; Delivery Pulse width Lo Res total Lo byte)
 8C9D [03] B7CD      3895       sta     fdtL      ; Copy result to "fdtL" (update fdtL)
 8C9F [03] B6CC      3896       lda     fdtH      ; Load accumulator with value in Fuel Delivery Pulse
                     3897                         ; width Lo Res Total Hi byte
 8CA1 [02] A900      3898       adc     #$00      ; Add with carry (A)<-(A)+(M)+(C) (just the carry)
 8CA3 [03] B7CC      3899       sta     fdtH      ; Copy result to "fdtH" (update fdtH)
                     3900  
                     3901  ;***********************************************************************************************
                     3902  ; - Update the Fuel Delivery Lo Res counter so that on roll over a pulsed signal can be sent
                     3903  ;   to the totalizer(open collector output)
                     3904  ;***********************************************************************************************
                     3905  
 8CA5 [03] B658      3906       lda     fd               ; Load accumulator with value in "fd"
 8CA7 [03] BBCA      3907       add     fdcntr           ; Add (A)<-(A)+(M)
 8CA9 [03] 2504      3908       bcs     TOTALIZER1       ; If the carry bit of CCR is set, branch to TOTALIZER1:
 8CAB [03] B7CA      3909       sta     fdcntr           ; Copy to "fdcntr"
 8CAD [03] 2008      3910       bra     TOTALIZER_DONE1  ; Branch to TOTALIZER_DONE1:
                     3911  
                     3912  TOTALIZER1:
 8CAF [03] B7CA      3913       sta     fdcntr           ; Copy to "fdcntr"
 8CB1 [04] 1002      3914       bset    aiot,portC       ; Set "aiot" bit of port C(Totalizer trigger on)
 8CB3 [02] A61E      3915       lda     #$1E             ; Load accumulator with decimal 30(3mS)
 8CB5 [03] B7CB      3916       sta     aiotcntr         ; Copy to "aiotcntr"(3mS on time)
                     3917  
                     3918  TOTALIZER_DONE1:
 8CB7 [03] 20C7      3919       bra     INJF1            ; Branch to INJFI:
                     3920  
                     3921  ;***********************************************************************************************
                     3922  ; - Long branch for INC_CUS:
                     3923  ;***********************************************************************************************
                     3924  
                     3925  INC_CUS_JMP:
 8CB9 [03] 2034      3926       bra     INC_CUS     ; Branch to INC_CUS_:
                     3927  
                     3928  ;***********************************************************************************************
                     3929  ;============================= Injector #2 - Start New Injection ===============================
                     3930  ;***********************************************************************************************
                     3931  
                     3932  NEW_SQUIRT2:
 8CBB [04] 196A      3933       bclr    sched2,squirt     ; Clear "sched2" bit of "squirt"(is now current operation)
 8CBD [04] 6E3320    3934       mov     #$33,T1SC         ; Move %00110011 into TIM1 Status and Control Register
                     3935                                 ;(Disable interrupts, stop timer, reset counter,
                     3936                                 ; prescale for 1uS)
 8CC0 [05] 4E5529    3937       mov     pwcalcH,T1CH1H    ; Move value in Final Pulse Width Hi byte
                     3938                                 ; to TIM1 CH1 O/C Register Hi byte
 8CC3 [05] 4E562A    3939       mov     pwcalcL,T1CH1L    ; Move value in Final Pulse Width Lo byte
                     3940                                 ; to TIM1 CH1 O/C Register Lo byte
                     3941                                 ; pulsewidth to TIM1 CH0 register Lo byte
 8CC6 [04] 6E1028    3942       mov     #$10,T1SC1        ; Move %00010000 into TIM1 CH1 Status and Control Register
                     3943                                 ;(Make this normal port output init logic 1
 8CC9 [04] 6E1C28    3944       mov     #$1C,T1SC1        ; Move %00011100 into TIM1 CH1 Status and Control register
                     3945                                 ;(Disable interupts,set output on compare)
 8CCC [04] 6E0320    3946       mov     #$03,T1SC         ; Move %00000011 into TIM1 Status and Control Register
                     3947                                 ; (Disable interrupts, start timer, prescale for 1uS)
                     3948  
                     3949  
                     3950  ;***********************************************************************************************
                     3951  ; - Update Fuel Delivery Pulse Width Lo Res Total so the results can be used by TS and MV to
                     3952  ;   calculate current fuel burn.
                     3953  ;***********************************************************************************************
                     3954  
 8CCF [03] B658      3955       lda     fd        ; Load accumulator with value in Fuel Delivery PW Lo Res
 8CD1 [03] BBCD      3956       add     fdtL      ; Add (A)<-(A)+(M) (Fuel Delivery PW Lo Res + Fuel
                     3957                         ; Delivery Pulse width Lo Res total Lo byte)
 8CD3 [03] B7CD      3958       sta     fdtL      ; Copy result to "fdtL" (update fdtL)
 8CD5 [03] B6CC      3959       lda     fdtH      ; Load accumulator with value in Fuel Delivery Pulse
                     3960                         ; width Lo Res Total Hi byte
 8CD7 [02] A900      3961       adc     #$00      ; Add with carry (A)<-(A)+(M)+(C) (just the carry)
 8CD9 [03] B7CC      3962       sta     fdtH      ; Copy result to "fdtH" (update fdtH)
                     3963  
                     3964  ;***********************************************************************************************
                     3965  ; - Update the Fuel Delivery Lo Res counter so that on roll over a pulsed signal can be sent
                     3966  ;   to the totalizer(open collector output)
                     3967  ;***********************************************************************************************
                     3968  
 8CDB [03] B658      3969       lda     fd               ; Load accumulator with value in "fd"
 8CDD [03] BBCA      3970       add     fdcntr           ; Add (A)<-(A)+(M)
 8CDF [03] 2504      3971       bcs     TOTALIZER2       ; If the carry bit of CCR is set, branch to TOTALIZER2:
 8CE1 [03] B7CA      3972       sta     fdcntr           ; Copy to "fdcntr"
 8CE3 [03] 2008      3973       bra     TOTALIZER_DONE2  ; Branch to TOTALIZER_DONE2:
                     3974  
                     3975  TOTALIZER2:
 8CE5 [03] B7CA      3976       sta     fdcntr           ; Copy to "fdcntr"
 8CE7 [04] 1002      3977       bset    aiot,portC       ; Set "aiot" bit of port C(Totalizer trigger on)
 8CE9 [02] A61E      3978       lda     #$1E             ; Load accumulator with decimal 30(3mS)
 8CEB [03] B7CB      3979       sta     aiotcntr         ; Copy to "aiotcntr"(3mS on time)
                     3980  
                     3981  TOTALIZER_DONE2:
 8CED [03] 2094      3982       bra     INJF2            ; Branch to INJF2:
                     3983  
                     3984  INJ_FIRE_CNTL_DONE:
                     3985  
                     3986  ;***********************************************************************************************
                     3987  ; - Increment 100 Microsecond counter
                     3988  ;***********************************************************************************************
                     3989  
                     3990  INC_CUS:
 8CEF [04] 3C7C      3991       inc     uSx100            ; Increment 100 Microsecond counter
 8CF1 [03] B67C      3992       lda     uSx100            ; Load accumulator with 100 Microsecond counter
 8CF3 [02] A10A      3993       cmp     #$0A              ; Compare it with decimal 10
 8CF5 [03] 266A      3994       bne     TIM2CH0_ISR_JMP   ; If not equal, branch to TIM2CH0_ISR_JMP:
                     3995  
                     3996  ;===============================================================================================
                     3997  ;********************************* millisecond section *****************************************
                     3998  ;===============================================================================================
                     3999  
                     4000  
                     4001  ;***********************************************************************************************
                     4002  ; - Fire off another ADC conversion, channel is pointed to by "adsel"
                     4003  ;***********************************************************************************************
                     4004  


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 32
MC68HC908GP32 User Bootloader


                     4005  FIRE_ADC:
 8CF7 [03] B66E      4006       lda     adsel          ; Load accumulator with ADC Selector Variable
 8CF9 [02] AA40      4007       ora     #%01000000     ; Inclusive "or" with %01000000 and ADC Selector
                     4008                              ; Variable ( result in accumulator )
                     4009                              ;(Enables interupt with channel selected)
 8CFB [03] B73C      4010       sta     adscr          ; Copy result to ADC Status and Control Register
                     4011  
                     4012  ;***********************************************************************************************
                     4013  ; - Increment millisecond counter
                     4014  ;***********************************************************************************************
                     4015  
                     4016  INC_mS:
 8CFD [03] 3F7C      4017       clr     uSx100              ; Clear 100 Microsecond counter
 8CFF [04] 3C7B      4018       inc     mS                  ; Increment Millisecond counter
 8D01 [03] B67B      4019       lda     mS                  ; Load accumulator with value in Millisecond counter
 8D03 [02] A164      4020       cmp     #$64                ; Compare it with decimal 100
 8D05 [03] 270A      4021       beq     DO_100MS            ; IF Z bit of CCR is set, branch to DO_100MS: (mS=100)
 8D07 [02] A1C8      4022       cmp     #$C8                ; Compare it with decimal 200
 8D09 [03] 2706      4023       beq     DO_100MS            ; IF Z bit of CCR is set, branch to DO_100MS: (mS=200)
 8D0B [02] A1FA      4024       cmp     #$FA                ; Compare it with decimal 250
 8D0D [03] 2726      4025       beq     DO_250MS            ; IF Z bit of CCR is set, branch to DO_250MS: (mS=250)
 8D0F [03] 2050      4026       bra     TIM2CH0_ISR_JMP     ; Branch to TIM2CH0_ISR_JMP:
                     4027  
                     4028  ;===============================================================================================
                     4029  ;*********************************** 100 Millisecond section ***********************************
                     4030  ;===============================================================================================
                     4031  
                     4032  DO_100MS:
                     4033  
                     4034  ;**********************************************************************************************
                     4035  ; If we are in ASE mode, and 100 ms counter has been selected, Increment after-start
                     4036  ; enrichment counter
                     4037  ;**********************************************************************************************
                     4038  
 8D11 [05] 056317    4039       brclr   startw,engine,NO_100MS_COUNT   ; If "startw" bit of "engine" variable is clear,
                     4040                                              ; branch to NO_100MS_COUNT:
 8D14 [05] 076309    4041       brclr   warmup,engine,HOT_100MS        ; If "startw" bit of "engine" variable is clear,
                     4042                                              ; branch to HOT_100MS:
 8D17 [04] C6E445    4043       lda     ASEtype           ; Load accumulator with value in ASE type configuration variable
 8D1A [02] A101      4044       cmp     #$1               ; Compare it with decimal 1
 8D1C [03] 270B      4045       beq     DO_100MS_COUNT    ; IF Z bit of CCR is set, branch to DO_100MS_COUNT: (ASEtype = 1)
 8D1E [03] 200B      4046       bra     NO_100MS_COUNT    ; Branch to NO_100MS_COUNT: (ASEtype not = 1)
                     4047  
                     4048  HOT_100MS:
 8D20 [04] C6E432    4049       lda     ASEHtype          ; Load accumulator with value in ASE Hot type config variable
 8D23 [02] A101      4050       cmp     #$1               ; Compare it with decimal 1
 8D25 [03] 2702      4051       beq     DO_100MS_COUNT    ; IF Z bit of CCR is set, branch to DO_100MS_COUNT: (ASEHtype = 1)
 8D27 [03] 2002      4052       bra     NO_100MS_COUNT    ; Branch to NO_100MS_COUNT: (ASEHtype not = 1)
                     4053  
                     4054  DO_100MS_COUNT:
 8D29 [04] 3C7F      4055       inc    asecount
                     4056  
                     4057  NO_100MS_COUNT:
                     4058  
                     4059  ;***********************************************************************************************
                     4060  ; - Increment "tpsaclk" counter for TPS DOT calculations
                     4061  ;***********************************************************************************************
                     4062  
 8D2B [04] 3C7E      4063       inc     tpsaclk     ; Increment "tpsaclk" counter
                     4064  
                     4065  ;***********************************************************************************************
                     4066  ; - Save current TPS reading in last_tps variable to compute TPSDOT in
                     4067  ;   acceleration enrichment section
                     4068  ;***********************************************************************************************
                     4069  
 8D2D [03] B644      4070       lda     tps                 ; Load accumulator with value in TPS ADC
 8D2F [03] B780      4071       sta     last_tps            ; Copy to last TPS variable
 8D31 [04] 186B      4072       bset    clock100,inputs     ; Set "clock100" bit of "inputs" variable
 8D33 [03] 202C      4073       bra     TIM2CH0_ISR_JMP     ; Branch to TIM2CH0_ISR_JMP:
                     4074  
                     4075  ;===============================================================================================
                     4076  ;********************************* 250 Millisecond section *************************************
                     4077  ;===============================================================================================
                     4078  
                     4079  DO_250MS:
 8D35 [04] 1A6B      4080       bset    clock250,inputs     ; Set "clock250" bit of "inputs" variable
                     4081  
                     4082  ;**********************************************************************************************
                     4083  ; If we are in ASE mode, and 250 ms counter has been selected, Increment after-start
                     4084  ; enrichment counter
                     4085  ;**********************************************************************************************
                     4086  
 8D37 [05] 056317    4087       brclr   startw,engine,NO_250MS_COUNT   ; If "startw" bit of "engine" variable is clear,
                     4088                                              ; branch to NO_250MS_COUNT:
 8D3A [05] 076309    4089       brclr   warmup,engine,HOT_250MS        ; If "startw" bit of "engine" variable is clear,
                     4090                                              ; branch to HOT_250MS:
 8D3D [04] C6E445    4091       lda     ASEtype           ; Load accumulator with value in ASE type configuration variable
 8D40 [02] A102      4092       cmp     #$2               ; Compare it with decimal 2
 8D42 [03] 270B      4093       beq     DO_250MS_COUNT    ; IF Z bit of CCR is set, branch to DO_250MS_COUNT: (ASEtype = 2)
 8D44 [03] 200B      4094       bra     NO_250MS_COUNT    ; Branch to NO_250MS_COUNT: (ASEtype not = 2)
                     4095  
                     4096  HOT_250MS:
 8D46 [04] C6E432    4097       lda     ASEHtype          ; Load accumulator with value in ASE Hot type config variable
 8D49 [02] A102      4098       cmp     #$2               ; Compare it with decimal 2
 8D4B [03] 2702      4099       beq     DO_250MS_COUNT    ; IF Z bit of CCR is set, branch to DO_250MS_COUNT: (ASEHtype = 2)
 8D4D [03] 2002      4100       bra     NO_250MS_COUNT    ; Branch to NO_250MS_COUNT: (ASEHtype not = 2)
                     4101  
                     4102  DO_250MS_COUNT:
 8D4F [04] 3C7F      4103       inc    asecount
                     4104  
                     4105  NO_250MS_COUNT:
                     4106  
                     4107  ;***********************************************************************************************
                     4108  ; - Increment 250 Millisecond counter and check to see if it's time to do the "500mS" section
                     4109  ;***********************************************************************************************
                     4110  
 8D51 [03] 3F7B      4111       clr     mS                  ; Clear Millisecond counter
 8D53 [04] 3C79      4112       inc     mSx250              ; Increment 250 Millisecond counter
 8D55 [03] B679      4113       lda     mSx250              ; Load accumulator with value in 250 Millisecond counter
 8D57 [02] A102      4114       cmp     #$02                ; Compare with decimal 2
 8D59 [03] 2708      4115       beq     DO_500MS            ; If the Z bit of CCR is set, branch to DO_500MS:
 8D5B [02] A104      4116       cmp     #$04                ; Compare with decimal 4
 8D5D [03] 2704      4117       beq     DO_500MS            ; If the Z bit of CCR is set,branch to DO_500MS:
 8D5F [03] 2065      4118       bra     TIM2CH0_ISR_DONE    ; Branch to TIM2CH0_ISR_DONE:
                     4119  
                     4120  ;***********************************************************************************************
                     4121  ; - Long branch for TIM2CH0_ISR_DONE:
                     4122  ;***********************************************************************************************
                     4123  
                     4124  TIM2CH0_ISR_JMP:
 8D61 [03] 2063      4125       bra     TIM2CH0_ISR_DONE    ; Branch to TIM2CH0_ISR_DONE:
                     4126  
                     4127  ;==============================================================================================
                     4128  ;********************************* 500 Millisecond section ************************************
                     4129  ;==============================================================================================
                     4130  
                     4131  DO_500MS:
                     4132  ;*     bset    clock500,inputs     ; Set "clock500" bit of "inputs" variable
                     4133  
                     4134  ;**********************************************************************************************
                     4135  ; If we are in ASE mode, and 500 ms counter has been selected, Increment after-start
                     4136  ; enrichment counter
                     4137  ;**********************************************************************************************
                     4138  
 8D63 [05] 056317    4139       brclr   startw,engine,NO_500MS_COUNT   ; If "startw" bit of "engine" variable is clear,
                     4140                                              ; branch to NO_500MS_COUNT:


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 33
MC68HC908GP32 User Bootloader


 8D66 [05] 076309    4141       brclr   warmup,engine,HOT_500MS        ; If "startw" bit of "engine" variable is clear,
                     4142                                              ; branch to HOT_500MS:
 8D69 [04] C6E445    4143       lda     ASEtype           ; Load accumulator with value in ASE type configuration variable
 8D6C [02] A103      4144       cmp     #$3               ; Compare it with decimal 3
 8D6E [03] 270B      4145       beq     DO_500MS_COUNT    ; IF Z bit of CCR is set, branch to DO_500MS_COUNT: (ASEtype = 3)
 8D70 [03] 200B      4146       bra     NO_500MS_COUNT    ; Branch to NO_500MS_COUNT: (ASEtype not = 3)
                     4147  
                     4148  HOT_500MS:
 8D72 [04] C6E432    4149       lda     ASEHtype          ; Load accumulator with value in ASE Hot type config variable
 8D75 [02] A103      4150       cmp     #$3               ; Compare it with decimal 3
 8D77 [03] 2702      4151       beq     DO_500MS_COUNT    ; IF Z bit of CCR is set, branch to DO_500MS_COUNT: (ASEHtype = 3)
 8D79 [03] 2002      4152       bra     NO_500MS_COUNT    ; Branch to NO_500MS_COUNT: (ASEHtype not = 3)
                     4153  
                     4154  DO_500MS_COUNT:
 8D7B [04] 3C7F      4155       inc    asecount
                     4156  
                     4157  NO_500MS_COUNT:
                     4158  
                     4159  ;***********************************************************************************************
                     4160  ; - Check to see if it's time to do the "Seconds" section
                     4161  ;***********************************************************************************************
                     4162  
 8D7D [03] B679      4163       lda     mSx250              ; Load accumulator with value in 250 Millisecond counter
 8D7F [02] A104      4164       cmp     #$04                ; Compare with decimal 4
 8D81 [03] 2702      4165       beq     Do_Sec              ; If the Z bit of CCR is set,  branch to DO_Sec:
 8D83 [03] 2041      4166       bra     TIM2CH0_ISR_DONE    ; Branch to TIM2CH0_ISR_DONE:
                     4167  
                     4168  ;===============================================================================================
                     4169  ;************************************* Seconds section *****************************************
                     4170  ;===============================================================================================
                     4171  
                     4172  Do_Sec:
                     4173  
                     4174  ;**********************************************************************************************
                     4175  ; If we are in ASE mode, and Seconds counter has been selected, Increment after-start
                     4176  ; enrichment counter
                     4177  ;**********************************************************************************************
                     4178  
 8D85 [05] 056317    4179       brclr   startw,engine,NO_SEC_COUNT   ; If "startw" bit of "engine" variable is clear,
                     4180                                            ; branch to NO_SEC_COUNT:
 8D88 [05] 076309    4181       brclr   warmup,engine,HOT_SEC        ; If "startw" bit of "engine" variable is clear,
                     4182                                            ; branch to HOT_SEC:
                     4183  
 8D8B [04] C6E445    4184       lda     ASEtype           ; Load accumulator with value in ASE type configuration variable
 8D8E [02] A104      4185       cmp     #$4               ; Compare it with decimal 4
 8D90 [03] 270B      4186       beq     DO_SEC_COUNT      ; IF Z bit of CCR is set, branch to DO_SEC_COUNT: (ASEtype = 4)
 8D92 [03] 200B      4187       bra     NO_SEC_COUNT      ; Branch to NO_SEC_COUNT: (ASEtype not = 4)
                     4188  
                     4189  HOT_SEC:
 8D94 [04] C6E432    4190       lda     ASEHtype          ; Load accumulator with value in ASE Hot type config variable
 8D97 [02] A104      4191       cmp     #$4               ; Compare it with decimal 4
 8D99 [03] 2702      4192       beq     DO_SEC_COUNT      ; IF Z bit of CCR is set, branch to DO_SEC_COUNT: (ASEHtype = 4)
 8D9B [03] 2002      4193       bra     NO_SEC_COUNT      ; Branch to NO_SEC_COUNT: (ASEHtype not = 4)
                     4194  
                     4195  DO_SEC_COUNT:
 8D9D [04] 3C7F      4196       inc    asecount
                     4197  
                     4198  NO_SEC_COUNT:
                     4199  
                     4200  ;***********************************************************************************************
                     4201  ; - Save the current fuel delivery lo res total as "fdSecH:fdSecL" so it can be used by TS
                     4202  ;   and MV in fuel burn calculations
                     4203  ;***********************************************************************************************
                     4204  
 8D9F [03] B6CD      4205       lda     fdtL       ; Load accumulator with value in "fdtL"
 8DA1 [03] B75A      4206       sta     fdSecL     ; Copy to "fdSecL"
 8DA3 [03] B6CC      4207       lda     fdtH       ; Load accumulator with value in "fdtH"
 8DA5 [03] B759      4208       sta     fdSecH     ; Copy to "fdSecH"
 8DA7 [03] 3FCD      4209       clr     fdtL       ; Clear "fdtL"
 8DA9 [03] 3FCC      4210       clr     fdtH       ; Clear "fdtH"
                     4211  
                     4212  ;***********************************************************************************************
                     4213  ; - Crank Mode Inhibit. Make a 1 to 2 second delay after engine starts. Then inhibit crank
                     4214  ;    mode unless engine completely stalls. This is to prohibit re-entry to crank mode under
                     4215  ;    abnormally low idle RPMs
                     4216  ;    * If running and !cranking and !cant_delay, then set cant_delay
                     4217  ;    * If running and !cranking and cant_delay, then set cant_crank
                     4218  ;    * Else clear cant_delay
                     4219  ;***********************************************************************************************
                     4220  
 8DAB [05] 02630E    4221       brset   crank,engine,CANT_OFF        ; If "crank" bit of "engine" is set, branch to
                     4222                                            ; CANT_OFF
 8DAE [05] 01630B    4223       brclr   running,engine,CANT_OFF      ; If "running" bit of "engine" variable is clear,
                     4224                                            ; branch to CANT_OFF:
 8DB1 [05] 0A6904    4225       brset   cant_delay,engine2,CANT_SET  ; If "cant_delay" bit of "engine2" is set, branch to
                     4226                                            ; CANT_SET:
 8DB4 [04] 1A69      4227       bset    cant_delay,engine2           ; Set "cant_off" bit of "engine2"(set timer bit)
 8DB6 [03] 2006      4228       bra     INC_SEC                     ; Branch to INC_SEC:
                     4229  
                     4230  CANT_SET:
 8DB8 [04] 1869      4231       bset    cant_crank,engine2     ; Set "cant_crank" bit of "engine2"(inhibit crank mode)
 8DBA [03] 2002      4232       bra     INC_SEC                ; Branch to SEC_DONE:
                     4233  
                     4234  CANT_OFF:
 8DBC [04] 1B69      4235       bclr    cant_delay,engine2     ; Clear "cant_delay" bit of "engine2"(clear timer bit)
                     4236  
                     4237  ;***********************************************************************************************
                     4238  ; - Increment Seconds counter
                     4239  ;***********************************************************************************************
                     4240  
                     4241  INC_SEC:
 8DBE [03] 3F79      4242       clr     mSx250              ; Clear 0.25 Second variable
 8DC0 [04] 3C40      4243       inc     secl                ; Increment "Seconds" Lo byte variable
 8DC2 [03] 2602      4244       bne     TIM2CH0_ISR_DONE    ; If the Z bit of CCR is clear, branch to TIM2CH0_ISR_DONE:
 8DC4 [04] 3C7D      4245       inc     sech                ; Increment "Seconds" Hi byte variable
                     4246  
                     4247  TIM2CH0_ISR_DONE:
 8DC6 [02] 8A        4248       pulh                        ; Pull value from stack to index register Hi byte
 8DC7 [07] 80        4249       rti                         ; Return from interrupt
                     4250  
                     4251  
                     4252  
                     4253  ;****************************************************************************
                     4254  ;
                     4255  ; ----------------- T2SC1 Interrupt (SPOUT Control) --------------------------
                     4256  ;
                     4257  ;****************************************************************************
                     4258  
                     4259  
                     4260  ;****************************************************************************
                     4261  ; - TIM2 CH1 interrupts twice per ignition event. The first is SPOUT rising
                     4262  ;   edge. This is the delay from PIP rising edge to SPOUT rising edge, which
                     4263  ;   signals the TFI module to fire the coil. TIM2 CH1 was armed and set with
                     4264  ;   the delay,(O/C value) in the main loop after the preceding ignition
                     4265  ;   sequence was finished.
                     4266  ;   In this first interrupt, the SPOUT signal is driven Hi, and the interrupt
                     4267  ;   flag is cleared. The TIM2 counter value is read to get a new timestamp
                     4268  ;   to calculate the new O/C value for the next interrupt which will be to
                     4269  ;   generate the SPOUT falling edge.
                     4270  ;   When the second interrupt is received, the SPOUT signal is driven Lo,
                     4271  ;   the interrupt flag is cleared, and the O/C interrupts are disabled.
                     4272  ;   This prepares TIM2 CH1 to be armed and set with the new O/C value for
                     4273  ;   rising SPOUT, which has already been calculated in the main loop.
                     4274  ;****************************************************************************
                     4275  
                     4276  TIM2CH1_ISR:


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 34
MC68HC908GP32 User Bootloader


 8DC8 [02] 8B        4277       pshh                    ; Push value in index register hi byte to stack
 8DC9 [05] 05690C    4278       brclr   sparking,engine2,SET_LO_OC   ;If "sparking" bit of "engine2"
                     4279                                  ; variable is clear, branch to SET_LO_OC:
 8DCC [03] B633      4280       lda     T2SC1              ; Load accumulator with value in
                     4281                                  ; TIM2 CH1 Status and Control Register
                     4282                                  ;(Arm CHxF flag clear)
 8DCE [04] 1F33      4283       bclr    CHxF,T2SC1         ; Clear CHxF bit of TIM2 CH1 Status and
                     4284                                  ; Control Register (clear interrupt flag)
 8DD0 [04] 1D33      4285       bclr    CHxIE,T2SC1        ; Disable interrupt requests TIM2 channel 1
                     4286                                  ; Status and Control Register
 8DD2 [04] 1200      4287       bset    spark,PORTA        ; Set "spark" bit of Port A
                     4288                                  ;(SPOUT falling edge)(Idle LED on)
 8DD4 [04] 1569      4289       bclr    sparking,engine2   ; Clear "sparking" bit of "engine2" variable
 8DD6 [03] 2024      4290       bra     IGN_SEQ_DONE       ; Branch to IGN_SEQ_DONE:
                     4291  
                     4292  SET_LO_OC:
                     4293  
                     4294  ;****************************************************************************
                     4295  ; - Get 1.0uS Timestamp for SPOUT "0ff" O/C calculations
                     4296  ;   T2CNTH:T2CNTL = SPOUT_tsH:SPOUT_tsL
                     4297  ;****************************************************************************
                     4298  
 8DD8 [03] B62D      4299       lda     T2CNTL      ; Load accumulator with value in TIM2
                     4300                           ; Counter Register Lo byte
                     4301                           ;(Unlatch any previous reads)
 8DDA [03] BE2C      4302       ldx     T2CNTH      ; Load index register Lo byte with value in
                     4303                           ; TIM2 Counter Register Hi byte
 8DDC [03] BFB7      4304       stx     SPOUT_tsH   ; Copy to SPOUT Timestamp Hi byte variable
 8DDE [03] B62D      4305       lda     T2CNTL      ; Load accumulator with value in TIM2
                     4306                           ; Counter Register Lo byte
 8DE0 [03] B7B8      4307       sta     SPOUT_tsL   ; Copy to SPOUT Timestamp Lo byte variable
                     4308  
                     4309  ;****************************************************************************
                     4310  ; - Calculate the output compare value for delay from SPOUT rising edge to
                     4311  ;   SPOUT falling edge.
                     4312  ;   SPOUT_tsH:SPOUT_tsL + SPOUTon_pH:SPOUTon_pL = CH1_offH:CH1_offL
                     4313  ;****************************************************************************
                     4314  
                     4315  CALC_OFF_OC:
 8DE2 [03] B6B8      4316       lda     SPOUT_tsL      ; Load accumulator with value in "SPOUT_tsL"
 8DE4 [03] BBBC      4317       add     SPOUTon_pL     ; Add without Carry A<-(A)+(M)
                     4318                              ;(SPOUT_tsL + SPOUTon_pL)
 8DE6 [01] 97        4319       tax                    ; Transfer result in accumulator to index
                     4320                              ; register Lo byte
 8DE7 [03] B6B7      4321       lda     SPOUT_tsH      ; Load accumulator with value in "PIP_tsH"
 8DE9 [03] B9BB      4322       adc     SPOUTon_pH     ; Add with Carry A<-(A)+(M)
 8DEB [03] B7BD      4323       sta     CH1_offH       ; Copy to CH1 off O/C value Hi byte
 8DED [03] BFBE      4324       stx     CH1_offL       ; Copy to CH1 off O/C value Lo byte
                     4325  
                     4326  ;****************************************************************************
                     4327  ; - Set and arm TIM2 Chan 1 output compare value to drive SPOUT Lo
                     4328  ;   CH1_offH:CH1_offL = T2CH1H:T2CH1L
                     4329  ;****************************************************************************
                     4330  
                     4331  OFF_DELAY:
 8DEF [03] B633      4332       lda     T2SC1          ; Load accumulator with value in
                     4333                              ; TIM2 CH1 Status and Control Register
                     4334                              ;(Arm CHxF flag clear)
 8DF1 [04] 1F33      4335       bclr    CHxF,T2SC1     ; Clear CHxF bit of TIM2 CH1 Status and
                     4336                              ; Control Register (clear interrupt flag)
 8DF3 [01] 8C        4337       clrh                   ; Clear index register Hi byte
 8DF4 [04] 55BD      4338       ldhx    CH1_offH       ; Load index register with value in CH1 off
                     4339                              ; O/C value H:L
 8DF6 [04] 3534      4340       sthx    T2CH1H         ; Copy to TIM2 CH1 register H:L
                     4341                              ;(output compare value for SPOUT rising edge)
                     4342  
                     4343  ;****************************************************************************
                     4344  ; - Drive SPOUT Hi to command TFI module to fire coil.
                     4345  ;****************************************************************************
                     4346  
 8DF8 [04] 1300      4347       bclr    spark,PORTA        ; Clear "spark" bit of Port A
                     4348                                  ;(SPOUT rising edge)(idle LED off)
 8DFA [04] 1469      4349       bset    sparking,engine2   ; Set "sparking" bit of "engine2" variable
                     4350  
                     4351  
                     4352  IGN_SEQ_DONE:
 8DFC [02] 8A        4353       pulh                  ; Pull value from stack to index register Hi byte
 8DFD [07] 80        4354       rti                   ; Return from interrupt routine
                     4355  
                     4356  
                     4357  
                     4358  ;***********************************************************************************************
                     4359  ;
                     4360  ; -------------------- Serial Communications Interface ----------------------
                     4361  ;
                     4362  ; Communications is established when the PC communications program sends
                     4363  ; a command character - the particular character sets the mode:
                     4364  ;
                     4365  ; "A" = send all of the realtime variables via txport.(Output Channel Get Command)
                     4366  ; "V" = send the VE table and constants via txport (128 bytes)(Page Read Command)
                     4367  ; "W"+<offset>+<newbyte> = receive new VE or constant byte value and store in offset location
                     4368  ;                          (Page value(byte)write command)
                     4369  ; "X"+<offset>+<count>+<newbyte>+<newbyte>... = receive series of new data bytes(chunk write)
                     4370  ; "B" = jump to flash burner routine and burn VE/constant values in RAM into flash
                     4371  ; "C" = Test communications - echo back SECL
                     4372  ; "Q" = Send over Embedded Code Revision Number (irrelevant in Extra, send zero)
                     4373  ; "S" = Signature - update every time there is a change in data format
                     4374  ; "T" = full code revision in text. 32 bytes
                     4375  ; "P"+<page> = Load page of data from Flash to RAM(page select(activate))
                     4376  ;
                     4377  ; txmode:
                     4378  ;              01 = Getting realtime data
                     4379  ;              02 = ?
                     4380  ;              03 = Sending VE
                     4381  ;              04 = Sending Signature
                     4382  ;              05 = Getting offset VE
                     4383  ;              06 = Getting data VE
                     4384  ;              07 = Getting offset chunk write
                     4385  ;              08 = Getting count  chunk write
                     4386  ;              09 = Getting data   chunk write
                     4387  ;              0C = getting table number
                     4388  ;              0E = format string
                     4389  ;
                     4390  ; NOTE!!! txgoal = number of bytes to send + 1
                     4391  ;
                     4392  ;***************************************************************************
                     4393  
                     4394  SCIRCV_ISR:
 8DFE [02] 8B        4395       pshh                 ; Push value in index register Hi byte to Stack
 8DFF [03] B616      4396       lda     SCS1         ; Load accumulator with value in "SCS1"
                     4397                            ;(Clear the SCRF bit by reading this register)
 8E01 [03] B687      4398       lda     txmode       ; Load accumulator with value in "txmode" variable
                     4399                            ;(Check if we are in the middle of a receive
                     4400                            ; new VE/constant)
 8E03 [02] A105      4401       cmp     #$05         ; Compare with decimal 5
 8E05 [03] 2719      4402       beq     TXMODE_5     ; If the Z bit of CCR is set, branch to TXMODE_5:
 8E07 [02] A106      4403       cmp     #$06         ; Compare with decimal 6
 8E09 [03] 271D      4404       beq     TXMODE_6     ; If the Z bit of CCR is set, branch to TXMODE_6:
 8E0B [02] A107      4405       cmp     #$07         ; Compare with decimal 7
 8E0D [03] 2725      4406       beq     TXMODE_7     ; If the Z bit of CCR is set, branch to TXMODE_7:
 8E0F [02] A108      4407       cmp     #$08         ; Compare with decimal 8
 8E11 [03] 2729      4408       beq     TXMODE_8     ; If the Z bit of CCR is set, branch to TXMODE_8:
 8E13 [02] A109      4409       cmp     #$09         ; Compare with decimal 8
 8E15 [03] 272D      4410       beq     TXMODE_9     ; If the Z bit of CCR is set, branch to TXMODE_8:
 8E17 [02] A10C      4411       cmp     #$0C         ; Compare with decimal 12
 8E19 [03] 2702      4412       beq     TXMODE_C1    ; If the Z bit of CCR is set, branch to TXMODE_C1:


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 35
MC68HC908GP32 User Bootloader


 8E1B [03] 2039      4413       bra     CHECK_TXCMD  ; Branch to CHECK_TXCMD:
                     4414  
                     4415  TXMODE_C1:
 8E1D [03] CC8F37    4416       jmp     TXMODE_C
                     4417  
                     4418  TXMODE_5:
 8E20 [05] 4E1888    4419       mov     SCDR,rxoffset   ; Move value in "SCDR" to "rxoffset"
 8E23 [04] 3C87      4420       inc     txmode          ; (continue to next mode)
 8E25 [03] CC8EEA    4421       jmp     DONE_RCV        ; Jump to DONE_RCV:
                     4422  
                     4423  TXMODE_6:
 8E28 [01] 8C        4424       clrh                 ; Clear index register Hi byte
 8E29 [03] B618      4425       lda     SCDR         ; Load accumulator with value in "SCDR"
 8E2B [03] BE88      4426       ldx     rxoffset     ; Load index register Lo byte with value in "rxoffset"
 8E2D [03] E7F0      4427       sta     VE_r,x         ; Copy to VE table, offset in index register Lo byte
 8E2F [03] 3F87      4428       clr     txmode       ; Clear "txmode" variable
 8E31 [03] CC8EEA    4429       jmp     DONE_RCV     ; Jump to DONE_RCV:
                     4430  
                     4431  TXMODE_7:
 8E34 [05] 4E1888    4432       mov     SCDR,rxoffset   ; Move value in "SCDR" to "rxoffset"
 8E37 [04] 3C87      4433       inc     txmode          ; (continue to next mode)
 8E39 [03] CC8EEA    4434       jmp     DONE_RCV        ; Jump to DONE_RCV:
                     4435  
                     4436  TXMODE_8:
 8E3C [05] 4E1886    4437       mov     SCDR,txgoal   ; Move value in "SCDR" to "txgoal"
 8E3F [04] 3C87      4438       inc     txmode          ; (continue to next mode)
 8E41 [03] CC8EEA    4439       jmp     DONE_RCV        ; Jump to DONE_RCV:
                     4440  
                     4441  TXMODE_9:
 8E44 [01] 8C        4442       clrh
 8E45 [03] B618      4443       lda     SCDR
 8E47 [03] BE88      4444       ldx     rxoffset
 8E49 [03] E7F0      4445       sta     VE_r,x
 8E4B [04] 3C88      4446       inc     rxoffset
 8E4D [04] 3A86      4447       dec     txgoal
 8E4F [03] 2602      4448       bne     TXMODE_9_CONT
 8E51 [03] 3F87      4449       clr     txmode
                     4450  
                     4451  TXMODE_9_CONT:
 8E53 [03] CC8EEA    4452       jmp     DONE_RCV
                     4453  
                     4454  CHECK_TXCMD:
 8E56 [03] B618      4455       lda     SCDR       ; Load accumulator with value in "SCDR" (Get the command byte)
 8E58 [02] A141      4456       cmp     #$41       ; Compare it with decimal 65 = ASCII "A"
 8E5A [03] 272B      4457       beq     MODE_A     ; If the Z bit of CCR is set, branch to Mode_A:
 8E5C [02] A142      4458       cmp     #$42       ; Compare it with decimal 66 = ASCII "B"
 8E5E [03] 2731      4459       beq     MODE_B     ; If the Z bit of CCR is set, branch to Mode_B:
 8E60 [02] A143      4460       cmp     #$43       ; Compare it with decimal 67 = ASCII "C"
 8E62 [03] 2741      4461       beq     MODE_C     ; If the Z bit of CCR is set, branch to Mode_C:
 8E64 [02] A156      4462       cmp     #$56       ; Compare it with decimal 86 = ASCII "V"
 8E66 [03] 2756      4463       beq     MODE_V     ; If the Z bit of CCR is set, branch to Mode_V:
 8E68 [02] A157      4464       cmp     #$57       ; Compare it with decimal 87 = ASCII "W"
 8E6A [03] 275D      4465       beq     MODE_W     ; If the Z bit of CCR is set, branch to Mode_W:
 8E6C [02] A151      4466       cmp     #$51       ; Compare it with decimal 81 = ASCII "Q"
 8E6E [03] 2744      4467       beq     MODE_Q     ; If the Z bit of CCR is set, branch to Mode_Q:
 8E70 [02] A150      4468       cmp     #$50       ; Compare it with decimal 80 = ASCII "P"
 8E72 [03] 273B      4469       beq     MODE_P     ; If the Z bit of CCR is set, branch to Mode_P:
 8E74 [02] A153      4470       cmp     #$53       ; Compare it with decimal 83 = ASCII "S"
 8E76 [03] 2765      4471       beq     MODE_S     ; If the Z bit of CCR is set, branch to Mode_S:
 8E78 [02] A152      4472       cmp     #$52       ; Compare it with decimal 82 = ASCII "R"
 8E7A [03] 270B      4473       beq     MODE_R     ; If the Z bit of CCR is set, branch to Mode_R:
 8E7C [02] A158      4474       cmp     #$58       ; Compare it with decimal 88 = ASCII "X"
 8E7E [03] 274F      4475       beq     MODE_X     ; If the Z bit of CCR is set, branch to Mode_X:
 8E80 [02] A154      4476       cmp     #$54       ; Compare it with decimal 84 = ASCII "T"
 8E82 [03] 2750      4477       beq     MODE_T     ; If the Z bit of CCR is set, branch to Mode_T:
 8E84 [03] CC8EEA    4478       jmp     DONE_RCV
                     4479  
                     4480  MODE_R:
                     4481  MODE_A:
 8E87 [02] A62A      4482       lda     #$2A           ; Load accumulator with decimal 42(41 real time variables for
                     4483                              ; MV and TS)(Set this for the number of bytes to send +1)
 8E89 [03] B786      4484       sta     txgoal         ; Copy to "txgoal" variable
 8E8B [03] 3F85      4485       clr     txcnt          ; Clear "txcnt"
 8E8D [02] A601      4486       lda     #$01           ; Load accumulator with decimal 1
 8E8F [03] 2053      4487       bra     EN_XMIT
                     4488  
                     4489  MODE_B:
 8E91 [03] B6C3      4490       lda     page
 8E93 [04] 1B14      4491       bclr    SCRIE,SCC2
 8E95 [04] 6ECCC4    4492       mov     #$CC,flocker
 8E98 [05] CD91C2    4493       jsr     burnConst     ; Jump to "burnConst" subroutine
 8E9B [03] 3FC4      4494       clr     flocker
 8E9D [03] 3F87      4495       clr     txmode        ; Clear "txmode" variable
 8E9F [03] B6C3      4496       lda     page
 8EA1 [04] 1A14      4497       bset    SCRIE,SCC2
 8EA3 [03] 2045      4498       bra     DONE_RCV      ; Branch to DONE_RCV:
                     4499  
                     4500  MODE_C:
 8EA5 [03] 3F85      4501       clr     txcnt          ; Clear "txcnt" (Just send back SECL variable to test comm port)
 8EA7 [02] A601      4502       lda     #$01           ; Load accumulator with decimal 1
 8EA9 [03] B786      4503       sta     txgoal         ; Copy to "txgoal" variable
 8EAB [02] A601      4504       lda     #$01           ; Load accumulator with decimal 1
 8EAD [03] 2035      4505       bra     EN_XMIT
                     4506  
                     4507  MODE_P:
 8EAF [04] 6E0C87    4508       mov     #$0C,txmode
 8EB2 [03] 2036      4509       bra     DONE_RCV
                     4510  
                     4511  MODE_Q:
 8EB4 [03] 3F85      4512       clr     txcnt          ; Clear "txcnt"(Just send back SECL variable to test comm port)
 8EB6 [02] A601      4513       lda     #$01           ; Load accumulator with decimal 1
 8EB8 [03] B786      4514       sta     txgoal         ; Copy to "txgoal" variable
 8EBA [02] A605      4515       lda     #$05           ; Load accumulator with decimal 5
 8EBC [03] 2026      4516       bra     EN_XMIT
                     4517  
                     4518  MODE_V:
 8EBE [03] 3F85      4519       clr     txcnt          ; Clear "txcnt"
 8EC0 [04] 6EA886    4520       mov     #PAGESIZE,txgoal
 8EC3 [03] B6C3      4521       lda     page
 8EC5 [02] A603      4522       lda     #$03           ; Load accumulator with decimal 3
 8EC7 [03] 201B      4523       bra     EN_XMIT
                     4524  
                     4525  MODE_W:
 8EC9 [02] A605      4526       lda     #$05         ; Load accumulator with decimal 5
 8ECB [03] B787      4527       sta     txmode       ; Copy to "txmode" variable
 8ECD [03] 201B      4528       bra     DONE_RCV     ; Branch to DONE_RCV:
                     4529  
                     4530  MODE_X:
 8ECF [04] 6E0787    4531       mov     #$07,txmode
 8ED2 [03] 2016      4532       bra     DONE_RCV
                     4533  
                     4534  MODE_T:
 8ED4 [03] 3F85      4535       clr     txcnt
 8ED6 [04] 6E2086    4536       mov     #$20,txgoal
 8ED9 [02] A60E      4537       lda     #$0E
 8EDB [03] 2007      4538       bra     EN_XMIT
                     4539  
                     4540  MODE_S:
 8EDD [03] 3F85      4541       clr     txcnt
 8EDF [04] 6E2086    4542       mov     #$20,txgoal
 8EE2 [02] A604      4543       lda     #$04
                     4544  
                     4545  EN_XMIT:
 8EE4 [03] B787      4546       sta     txmode         ; Copy to "txmode" variable
 8EE6 [04] 1614      4547       bset    TE,SCC2        ; Set "TE" bit of SCC2(Enable Transmit)
 8EE8 [04] 1E14      4548       bset    SCTIE,SCC2     ; Set "SCTIE" bit of SCC2(Enable transmit interrupt)


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 36
MC68HC908GP32 User Bootloader


                     4549  
                     4550  DONE_RCV:
 8EEA [02] 8A        4551       pulh                 ; Pull value from Stack to index register Hi byte
 8EEB [07] 80        4552       rti                  ; Return from interrupt
                     4553  
                     4554  ;****************************************************************************
                     4555  ;----------------- Transmit Character Interrupt Handler --------------------
                     4556  ;****************************************************************************
                     4557  
                     4558  SCITX_ISR:
 8EEC [02] 8B        4559       pshh                  ; Push value in index register Hi byte to Stack
 8EED [03] B616      4560       lda     SCS1          ; Load accumulator with value in "SCS1"
                     4561                             ; (Clear the SCRF bit by reading this register)
 8EEF [01] 8C        4562       clrh                  ; Clear index register Hi byte
 8EF0 [03] B685      4563       lda     txcnt         ; Load accumulator with value in "txcnt" variable
 8EF2 [01] 97        4564       tax                   ; Transfer value in accumulator to index register
                     4565                             ; Lo byte
 8EF3 [03] B687      4566       lda     txmode        ; Load accumulator with value in "txmode" variable
 8EF5 [03] 2761      4567       beq     TX_DONE
 8EF7 [02] A105      4568       cmp     #$05          ; Compare it with decimal 5
 8EF9 [03] 2726      4569       beq     IN_Q_MODE     ; If the Z bit of CCR is set, branch to IN_Q_MODE:
 8EFB [02] A104      4570       cmp     #$04
 8EFD [03] 271D      4571       beq     IN_S_MODE
 8EFF [02] A10E      4572       cmp     #$0E
 8F01 [03] 2714      4573       beq     IN_T_MODE
 8F03 [02] A101      4574       cmp     #$01          ; Compare it with decimal 1
 8F05 [03] 2706      4575       beq     IN_A_OR_C_MODE
 8F07 [02] A103      4576       cmp     #$03          ; Compare it with decimal 3
 8F09 [03] 2706      4577       beq     IN_V_MODE
 8F0B [03] 204B      4578       bra     TX_DONE
                     4579  
                     4580  
                     4581  IN_A_OR_C_MODE:
 8F0D [03] E640      4582       lda     secl,X      ; Load accumulator with value in address "secl",
                     4583                           ; offset in index register Lo byte
 8F0F [03] 2013      4584       bra     CONT_TX     ; Branch to CONT_TX:
                     4585  
                     4586  IN_V_MODE
 8F11 [03] B6C3      4587       lda     page
 8F13 [03] E6F0      4588       lda     VE_r,x        ; Load accumulator with value in address "ve",
                     4589                           ; offset in index register Lo byte
 8F15 [03] 200D      4590       bra     CONT_TX     ; Branch to CONT_TX:
                     4591  
                     4592  IN_T_MODE:
 8F17 [04] D69182    4593       lda     textversion_f,x
 8F1A [03] 2008      4594       bra     CONT_TX
                     4595  
                     4596  IN_S_MODE:
 8F1C [04] D691A2    4597       lda     Signature,x
 8F1F [03] 2003      4598       bra     CONT_TX     ; Branch to CONT_TX:
                     4599  
                     4600  IN_Q_MODE
 8F21 [04] D69181    4601       lda     REVNUM,X   ; Load accumulator with value in address "REVNUM",
                     4602                          ; offset in index register Lo byte
                     4603  
                     4604  CONT_TX:
 8F24 [03] B718      4605       sta     SCDR           ; Copy to "SCDR" variable (Send char)
 8F26 [03] B685      4606       lda     txcnt          ; Load accumulator with value in "txcnt" variable
 8F28 [01] 4C        4607       inca                   ; Increment value in accumulator
                     4608                              ;(Increase number of chars sent)
 8F29 [03] B785      4609       sta     txcnt          ; Copy to "txcnt" variable
 8F2B [03] B186      4610       cmp     txgoal         ; Compare it to value in "txgoal" (Check if done)
 8F2D [03] 2606      4611       bne     DONE_BYTE      ; If the Z bit of CCR is clear, branch to DONE_BYTE:
                     4612                              ;(Branch if NOT done to DONE_XFER !?!?!)
                     4613  
                     4614  FIN_TX:
 8F2F [03] 3F85      4615       clr     txcnt          ; Clear "txcnt"
 8F31 [03] 3F86      4616       clr     txgoal         ; Clear "txgoal"
 8F33 [03] 3F87      4617       clr     txmode         ; Clear "txmode"
                     4618  
                     4619  DONE_BYTE:
 8F35 [02] 8A        4620       pulh                   ; Pull value from Stack to index register Hi byte
 8F36 [07] 80        4621       rti                    ; Return from interrupt
                     4622  
                     4623  TXMODE_C:
 8F37 [03] B618      4624       lda     SCDR          ; expect 1 to 3
 8F39 [03] B1C3      4625       cmp     page          ; check if already loaded
 8F3B [03] 2715      4626       beq     DONE_LOAD
 8F3D [01] 5F        4627       clrx
 8F3E [03] B7C3      4628       sta     page
 8F40 [02] ABDF      4629       add     #$DF
 8F42 [02] 87        4630       psha
 8F43 [02] 8A        4631       pulh
 8F44 [04] 1B14      4632       bclr     SCRIE,SCC2     ; Turn off receive interrrupt so we don't re-enter
 8F46 [02] 9A        4633       cli                     ; Re-enable interrupts
                     4634  
                     4635  LOAD_TABLE:
 8F47 [02] F6        4636       lda     0,x             ; h:x
 8F48 [02] 8B        4637       pshh
 8F49 [01] 8C        4638       clrh
 8F4A [03] E7F0      4639       sta     VE_r,x          ; Dump into RAM
 8F4C [02] 8A        4640       pulh
 8F4D [01] 5C        4641       incx
 8F4E [02] A3A9      4642       cpx     #PAGESIZE+1
 8F50 [03] 26F5      4643       bne     LOAD_TABLE
                     4644  
                     4645  DONE_LOAD:
 8F52 [04] 1A14      4646       bset    SCRIE,SCC2
 8F54 [03] 3F87      4647       clr     txmode
 8F56 [02] 8A        4648       pulh
 8F57 [07] 80        4649       rti
                     4650  
                     4651  TX_DONE:                  ; We get here after we've sent the last byte
 8F58 [04] 1714      4652       bclr     TE,SCC2
 8F5A [04] 1F14      4653       bclr     SCTIE,SCC2
 8F5C [02] 8A        4654       pulh                 ; Pull value from Stack to index register Hi byte
 8F5D [07] 80        4655       rti                  ; Return from interrupt
                     4656  
                     4657  
                     4658  ;***********************************************************************************************
                     4659  ;
                     4660  ; ---------------------------- Interrupt for ADC conversion complete ---------------------------
                     4661  ;
                     4662  ; ADC channel is set by "adsel" variable which starts at 0. This reads channel 0, which is
                     4663  ; "map". When the conversion complete interrupt is requested the current value in the ADC Data
                     4664  ; Register (ADR) is stored as current "map" value. The "adsel" variable is then incremented to
                     4665  ; the next channel and the process repeats until channel 7 is requested. Channel 7 is the
                     4666  ; multiplexer channel which is controlled by "adsel2" variable which starts at 0, This reads
                     4667  ; multiplexer channel 0 which is "ITrm_ADC". When the conversion complete interrupt is
                     4668  ; requested the current value in the ADC Data Register (ADR) is stored as current "ITrm_ADC"
                     4669  ; value. The "adsel2" variable is then incremented to the next channel and the process repeats
                     4670  ; until channel 4 is requested at which time, "adsel2" and "adsel" are cleared to start the
                     4671  ; sequence again.
                     4672  ;
                     4673  ; "ADR" values are averaged with values in memory to reduce "digit rattle" and minimize the
                     4674  ; effects of spikes
                     4675  ;
                     4676  ;***********************************************************************************************
                     4677  
                     4678  ADC_ISR:
 8F5E [02] 8B        4679       pshh                    ; Push index register Hi byte on to stack
                     4680                               ; (Do this because processor does not stack H)
 8F5F [01] 8C        4681       clrh                    ; Clear index register Hi byte
 8F60 [03] B66E      4682       lda     adsel           ; Load accumulator with value in ADC Channel Selector
 8F62 [02] A107      4683       cmp     #$07            ; Compare with decimal 7
 8F64 [03] 2717      4684       beq     MULTIPLEX       ; If equal, branch to MULTIPLEX:


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 37
MC68HC908GP32 User Bootloader


 8F66 [01] 97        4685       tax                     ; Transfer value in accumulator to index register Lo
 8F67 [03] E6E3      4686       lda     mapcur,x        ; Load accumulator with value in "mapcur,x"
 8F69 [03] B63D      4687       lda     ADR             ; Load accumulator with value in ADC Data Register(this also
                     4688                               ; clears conversion complete and interupt enable bit)
 8F6B [03] EBE3      4689       add     mapcur,x        ; Add without Carry A<-(A)+(M)
 8F6D [01] 46        4690       rora                    ; Rotate right accumulator (divide by two)
 8F6E [03] E7E3      4691       sta     mapcur,x        ; Copy result to address mapcur,x
 8F70 [03] B66E      4692       lda     adsel           ; Load accumulator with value in ADC Channel Selector
 8F72 [03] B7EE      4693       sta     ADCcnt          ; Copy to ADC channel counter
 8F74 [01] 4C        4694       inca                    ; Increment ADC Channel Selector Variable
 8F75 [03] B76E      4695       sta     adsel           ; Copy result to ADC Channel Selector Variable
 8F77 [02] A107      4696       cmp     #$07            ; Compare with decimal 7
 8F79 [03] 2725      4697       beq     MULPLX_SET      ; If equal, branch to MULPLX_SET:
 8F7B [03] 2049      4698       bra     MULPLX_SET_DONE ; Branch to MULPLX_SET_DONE:
                     4699  
                     4700  MULTIPLEX:
 8F7D [03] B66F      4701       lda     adsel2          ; Load accumulator with value in ADC Channel Selector 2
 8F7F [01] 97        4702       tax                     ; Transfer value in accumulator to index register Lo
 8F80 [03] E6EA      4703       lda     ITrm_ADCcur,x   ; Load accumulator with value in "ITrm_ADCcur,x"
 8F82 [03] B63D      4704       lda     ADR             ; Load accumulator with value in ADC Data Register(this also
                     4705                               ; clears conversion complete and interupt enable bit)
 8F84 [03] EBEA      4706       add     ITrm_ADCcur,x   ; Add without Carry A<-(A)+(M)
 8F86 [01] 46        4707       rora                    ; Rotate right accumulator (divide by two)
 8F87 [03] E7EA      4708       sta     ITrm_ADCcur,x   ; Copy result to address ITrm_ADCcur,x
 8F89 [03] B66F      4709       lda     adsel2          ; Load accumulator with value in ADC Channel Selector 2
 8F8B [02] AB07      4710       add     #$07            ; Add without Carry A<-(A)+(M)
 8F8D [03] B7EE      4711       sta     ADCcnt          ; Copy to ADC channel counter
 8F8F [03] B66F      4712       lda     adsel2          ; Load accumulator with value in ADC Channel Selector 2
 8F91 [01] 4C        4713       inca                    ; Increment ADC Channel Selector Variable 2
 8F92 [02] A104      4714       cmp      #$04           ; Compare with decimal 4
 8F94 [03] 2704      4715       beq     MULTIPLEX_DONE  ; If equal, branch to MULTIPLEX_DONE:
 8F96 [03] B76F      4716       sta     adsel2          ; Copy to ADC Channel Selector Variable 2
 8F98 [03] 2006      4717       bra     MULPLX_SET      ; Branch to MULPLX_SET:
                     4718  
                     4719  MULTIPLEX_DONE:
 8F9A [03] 3F6E      4720       clr     adsel           ; Clear "adsel"
 8F9C [03] 3F6F      4721       clr     adsel2          ; Clear "adsel2"
 8F9E [03] 2026      4722       bra     MULPLX_SET_DONE ; Branch to MULPLX_SET_DONE:
                     4723  
                     4724  
                     4725  ;***********************************************************************************************
                     4726  ; - Check the ADC selector variable. If it is decimal 7 check the ADC selector variable 2
                     4727  ;   to select the multiplexer channels. If it is anything other than decimal 7, fall through.
                     4728  ;***********************************************************************************************
                     4729  
                     4730  MULPLX_SET:
 8FA0 [03] B66F      4731       lda     adsel2           ; Load accumulator with value in ADC selector 2
 8FA2 [04] 41000B    4732       cbeqa   #$0,CHAN_0       ; Compare and if equal, branch to CHAN_0:(ign trim, A=0, B=0)
 8FA5 [04] 41010E    4733       cbeqa   #$1,CHAN_1       ; Compare and if equal, branch to CHAN_1:(oil prs, A=1, B=0)
 8FA8 [04] 410211    4734       cbeqa   #$2,CHAN_2       ; Compare and if equal, branch to CHAN_2:(fuel prs, A=0, B=1)
 8FAB [04] 410314    4735       cbeqa   #$3,CHAN_3       ; Compare and if equal, branch to CHAN_3:(EGT, A=1, B=1)
 8FAE [03] 2016      4736       bra     MULPLX_SET_DONE  ; Branch to MULPLX_SET_DONE:
                     4737  
                     4738  CHAN_0:
 8FB0 [04] 1F00      4739       bclr    MplexA,PORTA     ; Clear "MplexA" bit of Port A (logic Lo)
 8FB2 [04] 1D00      4740       bclr    MplexB,PORTA     ; Clear "MplexB" bit of Port A (Logic Lo)
 8FB4 [03] 2010      4741       bra     MULPLX_SET_DONE  ; Branch to MULPLX_SET_DONE:
                     4742  
                     4743  CHAN_1:
 8FB6 [04] 1E00      4744       bset    MplexA,PORTA     ; Set "MplexA" bit of Port A (Logic Hi)
 8FB8 [04] 1D00      4745       bclr    MplexB,PORTA     ; Clear "MplexB" bit of Port A (Logic Lo)
 8FBA [03] 200A      4746       bra     MULPLX_SET_DONE  ; Branch to MULPLX_IN_DONE
                     4747  
                     4748  CHAN_2:
 8FBC [04] 1F00      4749       bclr    MplexA,PORTA     ; Clear "MplexA" bit of Port A (Logic Lo)
 8FBE [04] 1C00      4750       bset    MplexB,PORTA     ; Set "MplexB" bit of Port A (Logic Hi)
 8FC0 [03] 2004      4751       bra     MULPLX_SET_DONE  ; Branch to MULPLX_SET_DONE:
                     4752  
                     4753  CHAN_3:
 8FC2 [04] 1E00      4754       bset    MplexA,PORTA     ; Set "MplexA" bit of Port A (Logic Hi)
 8FC4 [04] 1C00      4755       bset    MplexB,PORTA     ; Set "MplexB" bit of Port A (Logic Hi)
                     4756  
                     4757  MULPLX_SET_DONE:
 8FC6 [04] 126B      4758       bset    adcc,inputs     ; Set "adcc"bit of "inputs" variable
 8FC8 [02] 8A        4759       pulh                    ; Pull value from stack to index register Hi byte
 8FC9 [07] 80        4760       rti                     ; Return from interrupt
                     4761  
                     4762  
                     4763  ;**********************************************************************************************
                     4764  ; ----------------- Keyboard interrupt (Ign Mon on PortA4) ------------------
                     4765  ;
                     4766  ; The Keyboard interrupts are set up as edge sensetive only. A falling edge on
                     4767  ; a Keyboard pin does not latch an interrupt request if another keyboard pin
                     4768  ; is already low. To prevent losing an interrupt request in this situation,
                     4769  ; The Keyboard interrupts are disabled, and acknowledged. The pin requesting
                     4770  ; the interrupt is identified and disabled, then the keyboard interrupts are
                     4771  ; re enabled. In the main loop, the Port is polled to see when the pin returns
                     4772  ; high and re enabled as a keyboard interrupt pin at that time.
                     4773  ;***********************************************************************************************
                     4774  
                     4775  KYBD_ISR:
 8FCA [04] 141A      4776       bset    ACKK,INTKBSCR       ; Set the Keyboard Acknowledge bit of Keyboard Status and
                     4777                                   ; Control Register (clear interrupt)
                     4778  
 8FCC [05] 066B02    4779       brset   MONen,inputs,CHK_MON_LO   ; If "MONen" bit of "inputs" variable is set, branch to
                     4780                                         ; CHK_MON_LO:
 8FCF [03] 201C      4781       bra     KEYBD_DONE                ; Branch to KEYBD_DONE:
                     4782  
                     4783  CHK_MON_LO:
 8FD1 [04] 1904      4784       bclr     Ign_Mon,DDRA             ; Clear "Ign_Mon" bit of Port A Data Direction Register
                     4785                                         ;(Make sure PTA4 is configured as an input so it can
                     4786                                         ; be read)
 8FD3 [05] 080017    4787       brset   Ign_Mon,porta,KEYBD_DONE  ; If "Ign Mon" bit of Port A is set, branch to
                     4788                                         ; KEYBD_DONE:
                     4789  
                     4790  ;***********************************************************************************************
                     4791  ; -------------------------- Calculate actual Ignition Timing Period ---------------------------
                     4792  ;***********************************************************************************************
                     4793  
                     4794  DO_MON:
 8FD6 [04] 191B      4795       bclr    Ign_Mon,INTKBIER   ; Clear "Ign_Mon" bit Keyboard Interrupt Enable Register
                     4796                                  ; (disable keyboard interrupt for ignition monitor while pin
                     4797                                  ; is low)
 8FD8 [04] 176B      4798       bclr    MONen,inputs       ; Clear "MONen" bit of "inputs" variable
 8FDA [03] B62D      4799       lda     T2CNTL             ; Load accumulator with value in TIM2 counter register Lo byte
                     4800                                  ; (Unlatch any previous reads)
 8FDC [03] BE2C      4801       ldx     T2CNTH             ; Load index register Lo byte with value in TIM2 counter
                     4802                                  ; register Hi byte (also latches Lo byte)
 8FDE [03] BFBF      4803       stx     MON_tsH            ; Copy to "MON_tsH" variable
 8FE0 [03] B62D      4804       lda     T2CNTL             ; Load accumulator with value in TIM2 counter register Lo byte
 8FE2 [03] B7C0      4805       sta     MON_tsL            ; Copy to "MON_tsL: variable
 8FE4 [03] B0A8      4806       sub     PIP_tsL            ; Subtract A<-(A)-(M)(Calculate cycle time)
                     4807                                  ;(MON_tsL - PIP_tsL = MON_pL)
 8FE6 [03] B761      4808       sta     MON_pL             ; Copy result to "MON_pL" variable
 8FE8 [01] 9F        4809       txa                        ; Transfer value in index register Lo byte to accumulator
                     4810                                  ; (MON_tsH)
 8FE9 [03] B2A7      4811       sbc     PIP_tsH            ; Subtract with carry A<-(A)-(M)-(C)
                     4812                                  ;(MON_tsH - PIP_tsH = MON_pH)
 8FEB [03] B760      4813       sta     MON_pH             ; Copy result to "MON_pH" variable
                     4814  
                     4815  KEYBD_DONE:
 8FED [07] 80        4816       rti                        ; Return from interrupt
                     4817  
                     4818  ;***********************************************************************************************
                     4819  ; ----- Dummy ISR vector - there just to keep the assembler happy -----
                     4820  ;***********************************************************************************************


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 38
MC68HC908GP32 User Bootloader


                     4821  
                     4822  Dummy:
 8FEE [07] 80        4823       rti     ; Return from interrupt
                     4824  
                     4825  ;***********************************************************************************************
                     4826  ;
                     4827  ; ---------------------------------------- SUBROUTINES -----------------------------------------
                     4828  ;
                     4829  ;  - Ordered Table Search
                     4830  ;  - Linear Interpolation
                     4831  ;  - 32 x 16 divide
                     4832  ;  - Round after division
                     4833  ;  - Computation of Normalized Variables
                     4834  ;  - Pulse Width Totals
                     4835  ;  - VE table lookup
                     4836  ;  - ST table lookup
                     4837  ;  - Divide by 16
                     4838  ;
                     4839  ;***********************************************************************************************
                     4840  
                     4841  
                     4842  ;***********************************************************************************************
                     4843  ;
                     4844  ; ----------------------------------------Ordered Table Search ---------------------------------
                     4845  ;
                     4846  ;  X is pointing to the start of the first value in the table
                     4847  ;  tmp1:2 initially hold the start of table address,
                     4848  ;  then they hold the bound values
                     4849  ;  tmp3 is the end of the table ("n" elements - 1)
                     4850  ;  tmp4 is the comparison value
                     4851  ;  tmp5 is the index result - if zero then comp value is less
                     4852  ;  than beginning of table, and if equal to "n" elements then it is
                     4853  ;  rail-ed at upper end
                     4854  ;
                     4855  ;***********************************************************************************************
                     4856  
                     4857  ORD_TABLE_FIND:
 8FEF [03] 3F95      4858       clr     tmp5     ; Clear tmp5 variable
 8FF1 [04] 5591      4859       ldhx    tmp1     ; Load high part of index register with value in tmp1
 8FF3 [02] F6        4860       lda     ,x       ; Load accumulator with low part of index register???
 8FF4 [03] B792      4861       sta     tmp2     ; Copy to tmp2 variable
                     4862  
                     4863  REENT:
 8FF6 [01] 5C        4864       incx                    ; Increment low part of index register
 8FF7 [04] 3C95      4865       inc     tmp5            ; Increment tmp5 variable
 8FF9 [05] 4E9291    4866       mov     tmp2,tmp1       ; Move value in tmp2 variable to tmp1 variable
 8FFC [02] F6        4867       lda     ,x              ; Load accumulator with value in index reg Lo??
 8FFD [03] B792      4868       sta     tmp2            ; Copy to tmp2 variable
 8FFF [03] B194      4869       cmp     tmp4            ; Compare it with tmp4 variable
 9001 [03] 2206      4870       bhi     GOT_ORD_NUM     ; If higher, branch to GOT_ORD_NUM lable
 9003 [03] B695      4871       lda     tmp5            ; Load accumulator with value in tmp5 variable
 9005 [03] B193      4872       cmp     tmp3            ; Compare it with value in tmp3 variable
 9007 [03] 26ED      4873       bne     REENT           ; If the Z bit of CCR is clesr, branch to REENT:
                     4874  
                     4875  GOT_ORD_NUM:
 9009 [04] 81        4876       rts                     ; Return from subroutine
                     4877  
                     4878  
                     4879  ;***********************************************************************************************
                     4880  ;
                     4881  ; ---------------------------------- Linear Interpolation - 2D ---------------------------------
                     4882  ;
                     4883  ; Graph Plot        X2
                     4884  ;                   Y2
                     4885  ;               X
                     4886  ;               Y
                     4887  ;         X1
                     4888  ;         Y1
                     4889  ;            (y2 - y1)
                     4890  ;  Y = Y1 +  --------- * (x - x1)
                     4891  ;            (x2 - x1)
                     4892  ;
                     4893  ;   tmp1 = x1
                     4894  ;   tmp2 = x2
                     4895  ;   tmp3 = y1
                     4896  ;   tmp4 = y2
                     4897  ;   tmp5 = x
                     4898  ;   tmp6 = y
                     4899  ;***********************************************************************************************
                     4900  
                     4901  LININTERP:
 900A [03] 3F97      4902       clr     tmp7          ; Clear tmp7 variable (This is the negative slope
                     4903                             ; detection bit) (tmp7 = 0)
 900C [05] 4E9396    4904       mov     tmp3,tmp6     ; Move value in tmp3 variable to tmp6 variable
                     4905                             ; (Y1 to tmp6)
                     4906  
                     4907  CHECK_LESS_THAN:
 900F [03] B695      4908       lda     tmp5               ; Load accumulator with value in tmp5 variable
                     4909                                  ; (x)
 9011 [03] B191      4910       cmp     tmp1               ; Compare it with value in tmp1 variable
                     4911                                  ; (x1)
 9013 [03] 2202      4912       bhi     CHECK_GREATER_THAN ; If higher, branch to CHECK_GREATER_THAN:
                     4913                                  ; (X>X1)
 9015 [03] 2047      4914       bra     DONE_WITH_INTERP        ; Branch to DONE_WITH_INTERP: (else (Y=Y1))
                     4915  
                     4916  CHECK_GREATER_THAN:
 9017 [03] B695      4917       lda     tmp5             ; Load accumulator with value in tmp5 variable
                     4918                                ; (x)
 9019 [03] B192      4919       cmp     tmp2             ; Compare it with value in tmp2 variable
                     4920                                ; (X2)
 901B [03] 2505      4921       blo     DO_INTERP        ; If lower, branch to DO_INTERP lable
                     4922                                ; (X<X2)
 901D [05] 4E9496    4923       mov     tmp4,tmp6        ; Move value in tmp4 variable to tmp6 variable
                     4924                                ; (Y2 to tmp6)
 9020 [03] 203C      4925       bra     DONE_WITH_INTERP ; Branch to DONE_WITH_INTERP lable (else (Y=Y2))
                     4926  
                     4927  DO_INTERP:
 9022 [05] 4E9396    4928       mov     tmp3,tmp6        ; Move value in tmp3 variable to tmp6 variable
                     4929                                ; (Y1 to tmp6)
 9025 [03] B692      4930       lda     tmp2             ; Load accumulator with value in tmp2 variable
                     4931                                ; (X2)
 9027 [03] B091      4932       sub     tmp1             ; Subtract tmp1 from tmp2 (A=X2-X1)
 9029 [03] 2733      4933       beq     DONE_WITH_INTERP ; If the Z bit of CCR is set, branch to
                     4934                                ;DONE_WITH_INTERP:  else (Y=Y1)
 902B [02] 87        4935       psha                     ; Push value in accumulator to stack
                     4936                                ; (X2-X1)(stack 1)
 902C [03] B694      4937       lda     tmp4             ; Load accumulator with value in tmp4 variable
                     4938                                ; (Y2)
 902E [03] B093      4939       sub     tmp3             ; Subtract tmp3 from tmp4 (A=Y2-Y1)
 9030 [03] 2403      4940       bcc     POSINTERP        ; If C bit of CCR is clear, branch to POSINTERP:
 9032 [01] 40        4941       nega                     ; Negate accumulator      ??????????
 9033 [04] 3C97      4942       inc     tmp7             ; Increment tmp7 variable (tmp7 = 1)
                     4943  
                     4944  POSINTERP:
 9035 [02] 87        4945       psha                     ; Push value in accumulator to stack
                     4946                                ; (negated Y2-Y1) (stack 2)
 9036 [03] B695      4947       lda     tmp5             ; Load accumulator with value in tmp5 variable
                     4948                                ; (X)
 9038 [03] B091      4949       sub     tmp1             ; Subtract tmp1 from tmp5 (A=X-X1)
 903A [03] 2720      4950       beq     ZERO_SLOPE            ; If the Z bit of CCR is set,
                     4951                                ; branch to ZERO_SLOPE lable  (Y=Y1)
 903C [02] 88        4952       pulx                     ; Pull value from stack to index register Lo
                     4953                                ;(negated Y2-Y1) (stack 2)
 903D [05] 42        4954       mul                      ; Multiply it by the value in the accumulator
                     4955                                ; A=(negated Y2-Y1)*(X-X1)
 903E [02] 89        4956       pshx                     ; Push the index register L to the stack


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 39
MC68HC908GP32 User Bootloader


                     4957                                ; (stack 2)
 903F [02] 8A        4958       pulh                     ; Pull this value to index register Hi(stack 2)
 9040 [02] 88        4959       pulx                     ; Pull the next value to index register Lo
                     4960                                ;(stack 1)
 9041 [07] 52        4961       div                      ; Divide A<-(H:A)/(X);H<-Remainder
 9042 [05] CD90EB    4962       jsr     DIVROUND         ; Jump to "DIVROUND" subroutine,(round result)
 9045 [02] 87        4963       psha                     ; Push the value in the accumulator onto stack
                     4964                                ; (stack 1)
 9046 [03] B697      4965       lda     tmp7             ; Load accumulator with value in tmp7 variable
 9048 [03] 2607      4966       bne     NEG_SLOPE        ; If the Z bit of CCR is clear,
                     4967                                ; branch to NEG_SLOPE: (Y=Y1)
 904A [02] 86        4968       pula                     ; Pull value from stack to accumulator (stack 1)
 904B [03] BB93      4969       add     tmp3             ; Add it with value in tmp3 variable
 904D [03] B796      4970       sta     tmp6             ; Copy it to tmp6 variable
 904F [03] 200D      4971       bra     DONE_WITH_INTERP ; Branch to  DONE_WITH_INTERP:
                     4972  
                     4973  NEG_SLOPE:
 9051 [02] 86        4974       pula                     ; Pull value from stack to accumulator(stack 1)
 9052 [03] B797      4975       sta     tmp7             ; Copy to tmp7 variable
 9054 [03] B693      4976       lda     tmp3             ; Load accumulator with value in tmp3  Y1)
 9056 [03] B097      4977       sub     tmp7             ; Subtract tmp7 from tmp3
 9058 [03] B796      4978       sta     tmp6             ; Copy result to tmp6 variable
 905A [03] 2002      4979       bra     DONE_WITH_INTERP ; Branch to  DONE_WITH_INTERP:
                     4980  
                     4981  ZERO_SLOPE:
 905C [02] 86        4982          pula    ; Pull value from stack to accumulator (clean stack)(stack 2)
 905D [02] 86        4983          pula    ; Pull value from stack to accumulator (clean stack)(stack 1)
                     4984  
                     4985  DONE_WITH_INTERP:
 905E [04] 81        4986          rts      ; Return from subroutine
                     4987  
                     4988  ;****************************************************************************
                     4989  ;
                     4990  ; ---------------------- 32 x 16 Unsigned Divide ---------------------------
                     4991  ;
                     4992  ; This routine takes the 32-bit dividend stored in INTACC1.....INTACC1+3
                     4993  ; and divides it by the 16-bit divisor stored in INTACC2:INTACC2+1.
                     4994  ; The quotient replaces the dividend and the remainder replaces the divisor.
                     4995  ;
                     4996  ;***************************************************************************
                     4997  
 905F                4998  UDVD32    EQU     *
                     4999  *
 905F                5000  DIVIDEND  EQU     INTACC1+2
 905F                5001  DIVISOR   EQU     INTACC2
 905F                5002  QUOTIENT  EQU     INTACC1
 905F                5003  REMAINDER EQU     INTACC1
                     5004  *
 905F [02] 8B        5005          PSHH                            ;save h-reg value
 9060 [02] 87        5006          PSHA                            ;save accumulator
 9061 [02] 89        5007          PSHX                            ;save x-reg value
 9062 [02] A7FD      5008          AIS     #-3                     ;reserve three bytes of temp storage
 9064 [02] A620      5009          LDA     #!32                    ;
 9066 [04] 9EE703    5010          STA     3,SP                    ;loop counter for number of shifts
 9069 [03] B68D      5011          LDA     DIVISOR                 ;get divisor msb
 906B [04] 9EE701    5012          STA     1,SP                    ;put divisor msb in working storage
 906E [03] B68E      5013          LDA     DIVISOR+1               ;get divisor lsb
 9070 [04] 9EE702    5014          STA     2,SP                    ;put divisor lsb in working storage
                     5015  
                     5016  ****************************************************************************
                     5017  *     Shift all four bytes of dividend 16 bits to the right and clear
                     5018  *     both bytes of the temporary remainder location
                     5019  ****************************************************************************
                     5020  
 9073 [05] 4E8C8E    5021          MOV     DIVIDEND+1,DIVIDEND+3   ;shift dividend lsb
 9076 [05] 4E8B8D    5022          MOV     DIVIDEND,DIVIDEND+2     ;shift 2nd byte of dividend
 9079 [05] 4E8A8C    5023          MOV     DIVIDEND-1,DIVIDEND+1   ;shift 3rd byte of dividend
 907C [05] 4E898B    5024          MOV     DIVIDEND-2,DIVIDEND     ;shift dividend msb
 907F [03] 3F89      5025          CLR     REMAINDER               ;zero remainder msb
 9081 [03] 3F8A      5026          CLR     REMAINDER+1             ;zero remainder lsb
                     5027  
                     5028  ****************************************************************************
                     5029  *     Shift each byte of dividend and remainder one bit to the left
                     5030  ****************************************************************************
                     5031  
 9083 [03] B689      5032  SHFTLP  LDA     REMAINDER               ;get remainder msb
 9085 [01] 49        5033          ROLA                            ;shift remainder msb into carry
 9086 [04] 398E      5034          ROL     DIVIDEND+3              ;shift dividend lsb
 9088 [04] 398D      5035          ROL     DIVIDEND+2              ;shift 2nd byte of dividend
 908A [04] 398C      5036          ROL     DIVIDEND+1              ;shift 3rd byte of dividend
 908C [04] 398B      5037          ROL     DIVIDEND                ;shift dividend msb
 908E [04] 398A      5038          ROL     REMAINDER+1             ;shift remainder lsb
 9090 [04] 3989      5039          ROL     REMAINDER               ;shift remainder msb
                     5040  
                     5041  *****************************************************************************
                     5042  *     Subtract both bytes of the divisor from the remainder
                     5043  *****************************************************************************
                     5044  
 9092 [03] B68A      5045          LDA     REMAINDER+1          ;get remainder lsb
 9094 [04] 9EE002    5046          SUB     2,SP                 ;subtract divisor lsb from remainder lsb
 9097 [03] B78A      5047          STA     REMAINDER+1          ;store new remainder lsb
 9099 [03] B689      5048          LDA     REMAINDER            ;get remainder msb
 909B [04] 9EE201    5049          SBC     1,SP                 ;subtract divisor msb from remainder msb
 909E [03] B789      5050          STA     REMAINDER            ;store new remainder msb
 90A0 [03] B68E      5051          LDA     DIVIDEND+3           ;get low byte of dividend/quotient
 90A2 [02] A200      5052          SBC     #0                   ;dividend low bit holds subtract carry
 90A4 [03] B78E      5053          STA     DIVIDEND+3           ;store low byte of dividend/quotient
                     5054  
                     5055  *****************************************************************************
                     5056  *     Check dividend/quotient lsb. If clear, set lsb of quotient to indicate
                     5057  *     successful subraction, else add both bytes of divisor back to remainder
                     5058  *****************************************************************************
                     5059  
 90A6 [05] 018E16    5060          BRCLR   0,DIVIDEND+3,SETLSB     ;check for a carry from subtraction
                     5061                                          ;and add divisor to remainder if set
 90A9 [03] B68A      5062          LDA     REMAINDER+1             ;get remainder lsb
 90AB [04] 9EEB02    5063          ADD     2,SP                    ;add divisor lsb to remainder lsb
 90AE [03] B78A      5064          STA     REMAINDER+1             ;store remainder lsb
 90B0 [03] B689      5065          LDA     REMAINDER               ;get remainder msb
 90B2 [04] 9EE901    5066          ADC     1,SP                    ;add divisor msb to remainder msb
 90B5 [03] B789      5067          STA     REMAINDER               ;store remainder msb
 90B7 [03] B68E      5068          LDA     DIVIDEND+3              ;get low byte of dividend
 90B9 [02] A900      5069          ADC     #0                      ;add carry to low bit of dividend
 90BB [03] B78E      5070          STA     DIVIDEND+3              ;store low byte of dividend
 90BD [03] 2002      5071          BRA     DECRMT                  ;do next shift and subtract
                     5072  
 90BF [04] 108E      5073  SETLSB  BSET    0,DIVIDEND+3            ;set lsb of quotient to indicate
                     5074                                          ;successive subtraction
 90C1 [06] 9E6B03BE  5075  DECRMT  DBNZ    3,SP,SHFTLP             ;decrement loop counter and do next
                     5076                                          ;shift
                     5077  
                     5078  *****************************************************************************
                     5079  *     Move 32-bit dividend into INTACC1.....INTACC1+3 and put 16-bit
                     5080  *     remainder in INTACC2:INTACC2+1
                     5081  *****************************************************************************
                     5082  
 90C5 [03] B689      5083          LDA     REMAINDER               ;get remainder msb
 90C7 [04] 9EE701    5084          STA     1,SP                    ;temporarily store remainder msb
 90CA [03] B68A      5085          LDA     REMAINDER+1             ;get remainder lsb
 90CC [04] 9EE702    5086          STA     2,SP                    ;temporarily store remainder lsb
 90CF [05] 4E8B89    5087          MOV     DIVIDEND,QUOTIENT       ;
 90D2 [05] 4E8C8A    5088          MOV     DIVIDEND+1,QUOTIENT+1   ;shift all four bytes of quotient
 90D5 [05] 4E8D8B    5089          MOV     DIVIDEND+2,QUOTIENT+2   ; 16 bits to the left
 90D8 [05] 4E8E8C    5090          MOV     DIVIDEND+3,QUOTIENT+3   ;
 90DB [04] 9EE601    5091          LDA     1,SP                    ;get final remainder msb
 90DE [03] B78D      5092          STA     INTACC2                 ;store final remainder msb


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 40
MC68HC908GP32 User Bootloader


 90E0 [04] 9EE602    5093          LDA     2,SP                    ;get final remainder lsb
 90E3 [03] B78E      5094          STA     INTACC2+1               ;store final remainder lsb
                     5095  
                     5096  *****************************************************************************
                     5097  *     Deallocate local storage, restore register values, and return from
                     5098  *     subroutine
                     5099  *****************************************************************************
                     5100  
 90E5 [02] A703      5101          AIS     #3                      ;deallocate temporary storage
 90E7 [02] 88        5102          PULX                            ;restore x-reg value
 90E8 [02] 86        5103          PULA                            ;restore accumulator value
 90E9 [02] 8A        5104          PULH                            ;restore h-reg value
 90EA [04] 81        5105          RTS                             ;return
                     5106  
                     5107  *****************************************************************************
                     5108  
                     5109  *****************************************************************************
                     5110  **
                     5111  ** ROUND after div (unsigned)
                     5112  ** 1)  check for div overflow (carry set), rail result if detected
                     5113  ** 2)  if (remainder * 2) > divisor then     ; was remainder > (divisor / 2)
                     5114  ** 2a)    increment result, rail if over-flow
                     5115  **
                     5116  *****************************************************************************
                     5117  
                     5118  DIVROUND:
 90EB [03] 250E      5119       bcs     DIVROUND0     ; If C bit of CCR is set, branch to DIVROUND0:
                     5120                             ; (div overflow? yes, branch)
 90ED [03] BFA6      5121       stx     tmp22         ; Copy value in index register Lo byte to
                     5122                             ; tmp22 variable (divisor)
 90EF [02] 8B        5123       pshh                  ; Push value in index register Hi byte onto
                     5124                             ; stack (retrieve remainder)
 90F0 [02] 88        5125       pulx                  ; Pull value on stack to index register Lo byte
 90F1 [01] 58        5126       lslx                  ; Logical shift left index register lo byte (* 2)
 90F2 [03] 2504      5127       bcs     DIVROUND2     ; If C bit of CCR is set, branch to DIVROUND2:
                     5128                             ;(over-flow on left-shift, (remainder * 2) > $FF)
 90F4 [03] B3A6      5129       cpx     tmp22         ; Compare value in tmp22 variable with value
                     5130                             ; in index register Lo byte
                     5131                             ;(compare (remainder * 2) to divisor)
 90F6 [03] 2505      5132       blo     DIVROUND1     ; If lower, branch to DIVROUND1:
                     5133  
                     5134  
                     5135  DIVROUND2:
 90F8 [01] 4C        5136       inca                   ; Increment accumulator (round-up result)
 90F9 [03] 2602      5137       bne      DIVROUND1     ; If Z bit of CCR is clear, branch to DIVROUND1:
                     5138                              ; (result roll over? no, branch)
                     5139  
                     5140  
                     5141  DIVROUND0:
 90FB [02] A6FF      5142       lda     #$FF     ; Load accumulator with decimal 255 (rail result)
                     5143  
                     5144  
                     5145  DIVROUND1:
 90FD [04] 81        5146       rts              ; return from subroutine
                     5147  
                     5148  
                     5149  ;****************************************************************************
                     5150  ;
                     5151  ; ---------------- Computation of Normalized Variables ----------------------
                     5152  ;
                     5153  ;  The following is the form of the evaluation for the normalized variables:
                     5154  ;
                     5155  ;  (A rem A * B)
                     5156  ;  -------------  = C rem C
                     5157  ;      100
                     5158  ;
                     5159  ;  Where A = Whole part of the percentage,
                     5160  ;        rem A = Remainder of A from previous calculation (range 0 to 99)
                     5161  ;        B = Percentage multiplied (this always has a zero remainder)
                     5162  ;        C = Whole part of result
                     5163  ;        rem C = remainder of result
                     5164  ;
                     5165  ;
                     5166  ;  Calculation is performed by the following method:
                     5167  ;
                     5168  ;     |(A * B) + (rem A * B)|
                     5169  ;     |          -----------|
                     5170  ;     |              100    |
                     5171  ;     ----------------------- = C rem C
                     5172  ;             100
                     5173  ;
                     5174  ;
                     5175  ;   Inputs:  tmp10 = A
                     5176  ;            tmp11 = rem A
                     5177  ;            tmp12 = B
                     5178  ;            tmp13 = rem B
                     5179  ;
                     5180  ;
                     5181  ;   Outputs: tmp10 = C
                     5182  ;            tmp11 = rem C
                     5183  ;            tmp13 = high order part of (A rem A) * B
                     5184  ;            tmp14 = low order part of (A rem A) * B
                     5185  ;
                     5186  ;****************************************************************************
                     5187  
                     5188  Supernorm:
 90FE [03] B69A      5189       lda     tmp10        ; Load accumulator with value in tmp10 (A)
 9100 [01] 97        5190       tax                  ; Transfer value in accumulator to index register Lo
 9101 [03] B69C      5191       lda     tmp12        ; Load accumulator with value in tmp12 (B)
 9103 [05] 42        5192       mul                  ; Multiply ( X:A<-(X)x(A) )
 9104 [03] BF9D      5193       stx     tmp13        ; Copy value in index register Lo byte to tmp13
                     5194                            ;(High order of A * B)
 9106 [03] B79E      5195       sta     tmp14        ; Copy value in accumulator to tmp14
                     5196                            ;(Low order of A * B)
 9108 [03] B69B      5197       lda     tmp11        ; Load accumulator with value in tmp11 (rem A)
 910A [01] 97        5198       tax                  ; Transfer value in accumulator to index reg Lo
 910B [03] B69C      5199       lda     tmp12        ; Load accumulator with value in tmp12 (B)
 910D [05] 42        5200       mul                  ; Multiply ( X:A<-(X)x(A) )
 910E [02] 89        5201       pshx                 ; Push value in index register to stack
 910F [02] 8A        5202       pulh                 ; Pull value in stack to index register Hi byte
                     5203                            ; (X)->(H)
 9110 [02] AE64      5204       ldx     #$64         ; Load accumulator with decimal 100
 9112 [07] 52        5205       div                  ; Divide ( A<-(H:A)/(X);H<-Remainder )
 9113 [03] B99E      5206       adc     tmp14        ; Add with carry ( A<-(A)+(M)+(C) )
                     5207                            ;(Add to lower part)
 9115 [03] B79E      5208       sta     tmp14        ; Copy to tmp14 (Store back)
 9117 [03] 2402      5209       bcc     Roundrem     ;If the C bit of CCR is clear, branch to Roundrem:
                     5210                            ;(Branch if no carry occurred)
 9119 [04] 3C9D      5211       inc     tmp13        ; Increment value in tmp13
                     5212                            ;(Increment high-order part because an overflow
                     5213                            ; occurred in adc)
                     5214  
                     5215  Roundrem:
 911B [02] 8B        5216       pshh                  ; Push value in index register Hi byte to stack
 911C [02] 86        5217       pula                  ; Pull value from stack to accumulator
 911D [02] A132      5218       cmp     #$32          ; Compare it to decimal 50
                     5219                             ;(Round if division remainder is greater than 50)
 911F [03] 930A      5220       ble     FinalNorm     ; If lesws than or equal to, branch to FinalNorm:
 9121 [03] B69E      5221       lda     tmp14         ; Load accumulator with value in tmp14
 9123 [02] A901      5222       adc     #$01          ; Add with carry decimal 1
 9125 [03] B79E      5223       sta     tmp14         ; Copy result to tmp13
 9127 [03] 2402      5224       bcc     FinalNorm     ; If C bit of CCR is clear, branch to FinalNorm:
 9129 [04] 3C9D      5225       inc     tmp13         ; Increment value in tmp13
                     5226  
                     5227  FinalNorm:
 912B [03] B69D      5228       lda     tmp13        ; Load accumulator with value in tmp13


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 41
MC68HC908GP32 User Bootloader


 912D [02] 87        5229       psha                 ; Push value in accumulator to stack
 912E [02] 8A        5230       pulh                 ; Pull value in stack to index register Hi byte
 912F [03] B69E      5231       lda     tmp14        ; Load accumulator with value in tmp14
 9131 [02] AE64      5232       ldx     #$64         ; Load index register Hi byte with decimal 100
 9133 [07] 52        5233       div                  ; Divide ( A<-(H:A)/(X);H<-Remainder )
 9134 [03] 251A      5234       bcs     RailCalc     ; If C bit of CCR is set, branch to RailCalc:
 9136 [03] B79A      5235       sta     tmp10        ; Copy result to tmp10
 9138 [02] 8B        5236       pshh                 ; Push value in index register Hi byte to stack
 9139 [02] 86        5237       pula                 ; Pull value in stack to accumulator
 913A [03] B79B      5238       sta     tmp11        ; copy to tmp11
 913C [02] A132      5239       cmp     #$32         ; Compare with decimal 50
                     5240                            ;(Round if division remainder is greater than 50)
 913E [03] 9313      5241       ble     ExitSN       ; If lower than or equal to, branch to ExitSN:
 9140 [03] B69B      5242       lda     tmp11        ; Load accumulator with value in tmp11
 9142 [02] A901      5243       adc     #$01         ; Add with carry decimal 1
 9144 [03] B79B      5244       sta     tmp11        ; Copy result to tmp11
 9146 [03] 240B      5245       bcc     ExitSN       ; If C bit of CCR is set, branch to ExitSN:
 9148 [03] B69A      5246       lda     tmp10        ; Load accumulator with value in tmp10
 914A [02] AB01      5247       add     #$01         ; Add it with decimal 1
 914C [03] B79A      5248       sta     tmp10        ; Copy result to tmp10
 914E [03] 2603      5249       bne     ExitSN       ; If Z bit of CCR is clear, branch to ExitSN:
                     5250  
                     5251  RailCalc:
 9150 [04] 6EFF9A    5252       mov     #$FF,tmp10      ; Move decimal 255 to tmp10 variable
                     5253                               ;(Rail value if rollover)
                     5254  
                     5255  ExitSN:
 9153 [04] 81        5256       rts                     ; Return from subroutine
                     5257  
                     5258  ;***********************************************************************************************
                     5259  
                     5260  ;***********************************************************************************************
                     5261  ; Paging subroutines. ("page" stores which table is paged into RAM, the value is sent by
                     5262  ; Tuner Studio depending on the mode, default is zero)
                     5263  ;***********************************************************************************************
                     5264  ;***********************************************************************************************
                     5265  ; VE Table and Ranges. If page value is 1, get value from RAM, otherwise, use Flash
                     5266  ;***********************************************************************************************
                     5267  
                     5268  VE1X:
 9154 [03] B6C3      5269       lda     page       ; Load accumulator with value in "page"
 9156 [02] A101      5270       cmp     #01T       ; Compare with decimal 1
 9158 [03] 2604      5271       bne     VE1XF      ; If not (A)not=(M) branch to VE1XF:
 915A [03] E6F0      5272       lda     VE_r,x     ; Load accumulator with value in "VE_r", offset in index register Lo
 915C [03] 2003      5273       bra     VE1XC      ; Branch to VE1XC:
                     5274  
                     5275  VE1XF:
 915E [04] D6E000    5276       lda     VE_f,x     ; Load accumulator with value in "VE_f" offset in index register Lo
                     5277  
                     5278  VE1XC:
 9161 [04] 81        5279       rts                ; Return from subroutine
                     5280  
                     5281  ;***********************************************************************************************
                     5282  ; ST Table and Ranges, If page value is 2, get value from RAM, otherwise, use Flash
                     5283  ;***********************************************************************************************
                     5284  
                     5285  VE2X:
 9162 [03] B6C3      5286       lda     page       ; Load accumulator with value in "page"
 9164 [02] A102      5287       cmp     #02T       ; Compare with decimal 2
 9166 [03] 2604      5288       bne     VE2XF      ; If not (A)not=(M) branch to VE2XF:
 9168 [03] E6F0      5289       lda     ST_r,x     ; Load accumulator with value in "ST_r", offset in index register Lo
 916A [03] 2003      5290       bra     VE2XC      ; Branch to VE2XC:
                     5291  
                     5292  VE2XF:
 916C [04] D6E100    5293       lda     ST_f,x     ; Load accumulator with value in "ST_f" offset in index register Lo
                     5294  
                     5295  VE2XC:
 916F [04] 81        5296       rts                ; Return from subroutine
                     5297  
                     5298  ;***********************************************************************************************
                     5299  ; --------------------------------------- Divide by 16 -----------------------------------------
                     5300  ;
                     5301  ; This subroutine takes a 16 bit value stored in tmp2:tmp1 and divides it by 16. The 8
                     5302  ; bit result is tmp1
                     5303  ;***********************************************************************************************
                     5304  
                     5305  DIV_BY_16:
                     5306  ;***********************************************************************************************
                     5307  ; - First divide by 2
                     5308  ;***********************************************************************************************
                     5309  
 9170 [04] 3492      5310       lsr     tmp2     ; Logical shift right "tmp2" (divide by 2 Hi Byte)
 9172 [04] 3691      5311       ror     tmp1     ; Rotate right throught carry "tmp1" (divide by 2 Lo Byte)
                     5312  
                     5313  ;***********************************************************************************************
                     5314  ; - Second divide by 2 (2x2=4 divide)
                     5315  ;***********************************************************************************************
                     5316  
 9174 [04] 3492      5317       lsr     tmp2     ; Logical shift right "tmp2" (divide by 2 Hi Byte)
 9176 [04] 3691      5318       ror     tmp1     ; Rotate right throught carry "tmp1" (divide by 2 Lo Byte)
                     5319  
                     5320  ;***********************************************************************************************
                     5321  ; - Third divide by 2 (2x2x2=8 divide)
                     5322  ;***********************************************************************************************
                     5323  
 9178 [04] 3492      5324       lsr     tmp2     ; Logical shift right "tmp2" (divide by 2 Hi Byte)
 917A [04] 3691      5325       ror     tmp1     ; Rotate right throught carry "tmp1" (divide by 2 Lo Byte)
                     5326  
                     5327  ;***********************************************************************************************
                     5328  ; - Fourth divide by 2 (2x2x2x2=16 divide)
                     5329  ;***********************************************************************************************
                     5330  
 917C [04] 3492      5331       lsr     tmp2     ; Logical shift right "tmp2" (divide by 2 Hi Byte)
 917E [04] 3691      5332       ror     tmp1     ; Rotate right throught carry "tmp1" (divide by 2 Lo Byte)
 9180 [04] 81        5333       rts              ; Return from subroutine
                     5334  
                     5335  
                     5336  ;***********************************************************************************************
                     5337  ; REVNUM is not used with this format, but is retained to keep MT and TS happy.
                     5338  ; textversion_f is the specific code that this works with. (32 char)
                     5339  ; Signature is the data format that the code uses to communicate with MT and TS. (32 char)
                     5340  ;***********************************************************************************************
                     5341  
 9181      00        5342  REVNUM:          db     00T
 9182      4D536E53  5343  textversion_f:   db     'MSnS351WM by Robert Hiebert ****'
           33353157 
           4D206279 
           20526F62 
           65727420 
           48696562 
           65727420 
           2A2A2A2A 
 91A2      4D53312F  5344  Signature:       db     'MS1/Extra format 029y3 *********'
           45787472 
           6120666F 
           726D6174 
           20303239 
           7933202A 
           2A2A2A2A 
           2A2A2A2A 
                     5345  
                     5346  
                     5347  ;****************************************************************************
                     5348  ;
                     5349  ;------------------ Boot Loader-defined jump table/vector -------------------
                     5350  ;


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 42
MC68HC908GP32 User Bootloader


                     5351  ;****************************************************************************
                     5352  
 91C2                5353       include "burnerHP.asm"
                     5354  ;****************************************************************************************
                     5355  ; Megasquirt Flash page erase and programming routines. Heavily based on the routines
                     5356  ; from boot_r12.asm
                     5357  ;
                     5358  ; JSM - revised timing for 8MHz
                     5359  ; RJH - revised for MS_ECU_HP 10/28/10
                     5360  ;****************************************************************************************
                     5361  ;****************************************************************************************
                     5362  ; - Variables
                     5363  ;
                     5364  ; page      - Page address pointer when added to $E000(MS_ECU_HP.h)
                     5365  ; burnDst   - Burn destination address(MS_ECU_HP.h)
                     5366  ; burnSrc   - Burn source address(MS_ECU_HP.h)
                     5367  ; burncount - Number of bytes to burn(MS_ECU_HP.h)
                     5368  ; ram_exec  - Start of execurable RAM space($01ED)(493)(boot_r12)
                     5369  ; flcr      - HC908 Flash Control Register
                     5370  ; HVEN      = High Voltage Enable Bit of flcr
                     5371  ; ERASE     = Erase Control bit of flcr
                     5372  ; PGM       = Program Control bit of flcr
                     5373  ; flbpr     - HC908 Flash Block Protect Register
                     5374  ;
                     5375  ;****************************************************************************************
                     5376  ;****************************************************************************************
                     5377  ; - Erase 256 bytes in Flash starting at the selected page address
                     5378  ;****************************************************************************************
                     5379  
                     5380  burnConst:
 91C2 [03] B6C4      5381       lda     flocker
 91C4 [02] A1CC      5382       cmp     #$CC
 91C6 [03] 2701      5383       beq     BURN_CONT
 91C8 [04] 81        5384       rts
                     5385  
                     5386  BURN_CONT:
 91C9 [03] B6C3      5387       lda     page     ; Load accumulaotr with value in "page"
 91CB [02] ABDF      5388       add     #$DF
                     5389  ;*     add     #$E0     ; A<-(A)+(M) Add value in accumulator with with $E0
 91CD [02] 87        5390       psha             ; Push result to Stack
 91CE [02] 8A        5391       pulh             ; Pull result from stack and copy 
 91CF [01] 5F        5392       clrx             ; Clear index register Lo byte(now a 16 bit value)
 91D0 [04] 35C7      5393       sthx    burnDst  ; Copy to "burnDst"
                     5394  
                     5395  ;****************************************************************************************
                     5396  ; - Erase the first block of 128 bytes
                     5397  ;****************************************************************************************
                     5398  
 91D2 [05] CD91F7    5399       jsr     ms_EraseFlash     ; Jump to subroutine at ms_EraseFlash:
                     5400  
                     5401  ;****************************************************************************************
                     5402  ; - Load the address of the second 128 bytes of the page to be erased
                     5403  ;****************************************************************************************
                     5404  
 91D5 [04] 55C7      5405       ldhx    burnDst     ; Load index register with value in "burnDst"
 91D7 [02] AF40      5406       aix     #64T        ; Add decimal 64 to index register Lo byte
 91D9 [02] AF40      5407       aix     #64T        ; Add decimal 64 to index register Lo byte (total of 128)
 91DB [04] 35C7      5408       sthx    burnDst     ; Copy result to "burnDst"
                     5409  
                     5410  ;****************************************************************************************
                     5411  ; - Erase the second block of 128 bytes
                     5412  ;****************************************************************************************
                     5413  
 91DD [05] CD91F7    5414       jsr     ms_EraseFlash     ; Jump to subroutine at ms_EraseFlash:
                     5415  
                     5416  ;****************************************************************************************
                     5417  ; - Load the address of the destination page to be burnt. (pages start at $E000)
                     5418  ;****************************************************************************************
                     5419  
 91E0 [03] B6C3      5420       lda     page     ; Load accumulaotr with value in "page"
 91E2 [02] ABDF      5421       add     #$DF
                     5422  ;*     add     #$E0     ; A<-(A)+(M) Add value in accumulator with with $E0
 91E4 [02] 87        5423       psha             ; Push result to Stack
 91E5 [02] 8A        5424       pulh             ; Pull result from stack and copy to index register Hi byte
 91E6 [01] 5F        5425       clrx             ; Clear index register Lo byte(now a 16 bit value)
 91E7 [04] 35C7      5426       sthx    burnDst  ; Copy to "burnDst"
                     5427  
                     5428  ;****************************************************************************************
                     5429  ; - Load the address of the source page to be burnt.
                     5430  ;****************************************************************************************
                     5431  
 91E9 [03] 4500F0    5432       ldhx     #VE_r     ; Load index register with address at "VE_r"
 91EC [04] 35C5      5433       sthx    burnSrc    ; Copy to "burnSrc"
                     5434  
                     5435  ;****************************************************************************************
                     5436  ; - Burn 189 bytes per page
                     5437  ;****************************************************************************************
                     5438  
 91EE [02] A6BD      5439       lda     #189T               ; Load accumulator with decimal 189
 91F0 [03] B7C9      5440       sta     burncount           ; Copy to "burncount"
 91F2 [01] 8C        5441       clrh                        ; Clear index register Hi byte
 91F3 [01] 5F        5442       clrx                        ; Clear index register Lo byte
 91F4 [03] CC9206    5443       jmp     ms_ProgramFlash     ; Jump to subroutine at ms_ProgramFlash:
                     5444  
                     5445  
                     5446  ;****************************************************************************************
                     5447  ;
                     5448  ;======================  Single Flash Page Erase Subroutine  ============================
                     5449  ;
                     5450  ; This subroutine will copy the Flash Erase algorithm into RAM and execute
                     5451  ; it to erase the page starting at address pointers "burnDst"
                     5452  ;
                     5453  ;****************************************************************************************
                     5454  ;****************************************************************************************
                     5455  ; - Initialize pointer
                     5456  ;****************************************************************************************
                     5457  
                     5458  ms_EraseFlash:
 91F7 [03] 450031    5459       ldhx    #ms_EraseRamSize     ; Load index register with address of "ms_EraseRamSize"
                     5460  
                     5461  ;****************************************************************************************
                     5462  ; - Get program from Flash, copy to RAM, decrement pointer and loop back until done.
                     5463  ;****************************************************************************************
                     5464  
                     5465  ms_EraseFlash1:
 91FA [04] D69214    5466       lda     ms_MassErase-1,x     ; Load accumulator with value at "ms_MAssErase-1,
                     5467                                    ; offset in index register Lo byte
 91FD [04] D701EC    5468       sta     ram_exec-1,x         ; Copy to location "ram_exec-1", offset in index
                     5469                                    ; register Lo byte
 9200 [03] 5BF8      5470       dbnzx   ms_EraseFlash1       ; Decrement index register Lo byte and branch to lable
                     5471                                    ; at "ms_EraseFlash1:" if not zero
 9202 [02] 9B        5472       sei                          ; Set interrupt mask bit of CCR(prohibit interrrupts)
                     5473  
                     5474  ;****************************************************************************************
                     5475  ; - Execute Flash Mass Erase algorithm from RAM
                     5476  ;****************************************************************************************
                     5477  
 9203 [03] CC01ED    5478       jmp     ram_exec     ; Jump to subroutine at lable "ram_exec:"(start of executable
                     5479                            ; RAM space from "boot_r12"
                     5480  
                     5481  ;****************************************************************************************
                     5482  ;
                     5483  ;==========================  Flash Program Subroutine  ==================================
                     5484  ;
                     5485  ; This subroutine will copy the Flash Program algorithm into RAM and execute it to
                     5486  ; program  "burncount" bytes from the address pointed to by 'burnSrc' to the address


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 43
MC68HC908GP32 User Bootloader


                     5487  ; pointed to by "burnDst"
                     5488  ;
                     5489  ;****************************************************************************************
                     5490  ;****************************************************************************************
                     5491  ; - Initialize pointer
                     5492  ;****************************************************************************************
                     5493  
                     5494  ms_ProgramFlash:
 9206 [03] 45004A    5495       ldhx    #ms_ProgramRamSize     ; Load index register with address at
                     5496                                      ; "ms_ProgramRamSize"
                     5497  
                     5498  ;****************************************************************************************
                     5499  ; - Get program from Flash, copy to RAM, decrement pointer and loop back until done.
                     5500  ;****************************************************************************************
                     5501  
                     5502  ms_ProgramFlash1:
 9209 [04] D6923A    5503       lda     ms_Delay-1,x             ; Load accumulator withe value in address
                     5504                                        ;  "ms_Delay-1, offset in index register Lo byte
 920C [04] D701EC    5505       sta     ram_exec-1,x             ; Copy to address at "ram_exec-1, offset in index
                     5506                                        ; register Lo byte
 920F [03] 5BF8      5507       dbnzx   ms_ProgramFlash1         ; Decrement index register Lo byte and branch to
                     5508                                        ; lable at "ms_EraseFlash1:" if not zero
 9211 [02] 9B        5509       sei                              ; Set interrupt mask bit of CCR
                     5510                                        ; (prohibit ineterrupts)
 9212 [03] CC01F8    5511       jmp     {ram_exec+ms_ProgramRam} ; Jump to location at "ram_exec+ms_ProgramRam"
                     5512  
                     5513  ;****************************************************************************************
                     5514  ;
                     5515  ;==============================  Flash Erase Subroutine  ================================
                     5516  ;
                     5517  ;  This subroutine performs a single Page Erase @ BurnDst
                     5518  ;  This subroutine has been tuned for a bus speed of 7.3728 MHz. Constants revised for
                     5519  ;  8MHz
                     5520  ;  This subroutine is copied into and executed from RAM.
                     5521  ;
                     5522  ;****************************************************************************************
                     5523  ;****************************************************************************************
                     5524  ; - Initialize pointer to Flash Memory Address
                     5525  ;****************************************************************************************
                     5526  
                     5527  ms_MassErase:
 9215 [04] 55C7      5528       ldhx    burnDst     ;Load accumulator with value in "burnDst"
                     5529  
                     5530  ;****************************************************************************************
                     5531  ;   Set ERASE, read the Flash Block Protect Register and write any data into Flash page.
                     5532  ;****************************************************************************************
                     5533  
 9217 [02] A602      5534       lda     #{ERASE}     ; Load accumulaotr with value in "{ERASE}"
 9219 [04] C7FE08    5535       sta     flcr         ; Copy to Flash Control Register(set erase bit)
 921C [04] C6FF7E    5536       lda     flbpr        ; Load accumulator with value in Flash Block Protest Register
 921F [02] F7        5537       sta     ,x           ; Copy to index register Lo byte
                     5538  
                     5539  ;****************************************************************************************
                     5540  ;   Wait for >10us(11.1uS), then set HVEN in Flash Control Register.
                     5541  ;****************************************************************************************
                     5542  
 9220 [02] A601      5543       lda     #1                 ; Load accumulator with decimal 1
 9222 [04] AD17      5544       bsr     ms_delay           ; Branch to subroutine at lable "ms_delay:"
 9224 [02] A60A      5545       lda     #{ERASE | HVEN}    ; Load accumulator with value in "ERASE" bit wise Or
                     5546                                  ; "HVEN"
 9226 [04] C7FE08    5547       sta     flcr               ; Copy to Flash Control Register
                     5548  
                     5549  ;****************************************************************************************
                     5550  ;   Wait for >1ms(1.012mS), then clear ERASE.
                     5551  ;****************************************************************************************
                     5552  
 9229 [02] A669      5553       lda     #105T        ; Load accumulator with decimal 105
 922B [04] AD0E      5554       bsr     ms_delay     ; Branch to subroutine at lable "ms_delay:"
 922D [02] A608      5555       lda     #{HVEN}      ; Load accumulaotr with value in "HVEN"(clears ERASE)
 922F [04] C7FE08    5556       sta     flcr         ; Copy to Flash Control Register
                     5557  
                     5558  ;****************************************************************************************
                     5559  ;   Wait for >5us(11.1uS), then clear HVEN.
                     5560  ;****************************************************************************************
                     5561  
 9232 [02] A601      5562       lda     #1           ; Load accumulator with decimal 1
 9234 [04] AD05      5563       bsr     ms_delay     ; Branch to subroutine at lable "ms_delay:"
 9236 [01] 4F        5564       clra                 ; Clear accumulator
 9237 [04] C7FE08    5565       sta     flcr         ; Copy to Flash Control Register
 923A [04] 81        5566       rts                  ; Return from subroutine
                     5567  
                     5568  
                     5569  ;****************************************************************************************
                     5570  ;
                     5571  ;==================================  Delay Subroutine  ==================================
                     5572  ;
                     5573  ;  This subroutine performs a simple software delay loop based upon the value passed in
                     5574  ;  ACC.
                     5575  ;  The following timing calculation applies:
                     5576  ;
                     5577  ;   was supposed to be  delay = ((ACC * 74) + 12) (tcyc)
                     5578  ;   actually            delay = ((ACC * 108) + 12) (tcyc) i.e. longer/safer? delays
                     5579  ;   now                 delay = ((ACC * 77) + 12) (tcyc)
                     5580  ;
                     5581  ;  Calling convention:
                     5582  ;
                     5583  ;      lda     data
                     5584  ;      jsr     delay
                     5585  ;
                     5586  ;  Returns:    nothing
                     5587  ;
                     5588  ;  Changes:    ACC
                     5589  ;
                     5590  ;****************************************************************************************
                     5591  ;****************************************************************************************
                     5592  ; - Save outer delay loop parameter
                     5593  ;****************************************************************************************
                     5594  
                     5595  ms_Delay:
 923B [02] 87        5596       psha     ; Push value in accumulator to Stack
                     5597  
                     5598  ;****************************************************************************************
                     5599  ; - Initialize inner delay loop counter
                     5600  ;****************************************************************************************
                     5601  
                     5602  ms_Delay1:
 923C [02] A617      5603       lda     #23T     ; Load accumulator with decimal 23
                     5604  
                     5605  ;****************************************************************************************
                     5606  ; - Decrement inner delay loop counter, decrement outer delay loop counter, dealocate
                     5607  ;   local variable, return from subroutine
                     5608  ;****************************************************************************************
                     5609  
                     5610  ms_Delay2:
 923E [03] 4BFE      5611       dbnza   ms_Delay2          ; Decrement accumulator and branch to lable at
                     5612                                  ; "ms_Delay2" if not zero
 9240 [06] 9E6B01F8  5613       dbnz    1,sp,ms_Delay1     ; Decrement Stack Pointer and return to lable at
                     5614                                  ; "ms_Delay1  if not zero
 9244 [02] 86        5615       pula                       ; Pull value from stack and copy to accumulator
 9245 [04] 81        5616       rts                        ; Return from subroutine
                     5617  
                     5618  ;****************************************************************************************
                     5619  ;
                     5620  ;============================  Flash Program Subroutine  ================================
                     5621  ;
                     5622  ;  This subroutine controls the Flash programming sequence.


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 44
MC68HC908GP32 User Bootloader


                     5623  ;
                     5624  ;****************************************************************************************
                     5625  ;****************************************************************************************
                     5626  ; - Equates
                     5627  ;****************************************************************************************
                     5628  
 9246                5629  ms_EraseRamSize:   equ     {*-ms_MassErase}
 9246                5630  ms_ProgramRam:     equ     {*-ms_Delay}
                     5631  
                     5632  ;****************************************************************************************
                     5633  
                     5634  ms_FlashProgram:
                     5635  ms_FlashProgram1:
                     5636  
                     5637  ;****************************************************************************************
                     5638  ; - Set PGM, read the Flash Block Protect Register and write anywhere in desired Flash
                     5639  ;   row.
                     5640  ;****************************************************************************************
                     5641  
 9246 [02] A601      5642       lda     #{PGM}      ; Load accumulator with value in "{PGM}"
 9248 [04] C7FE08    5643       sta     flcr        ; Copy to Flash Control Register
 924B [04] C6FF7E    5644       lda     flbpr       ; Load accumulaotr with value in  Flash Block Protect Register
 924E [04] 55C7      5645       ldhx    burnDst     ; Load index register with value in "burnDst"
 9250 [02] F7        5646       sta     ,x          ; Copy to address in "burnDst, offset in index register Lo byte
                     5647  
                     5648  ;****************************************************************************************
                     5649  ; - Wait for >10us, then set HVEN.
                     5650  ;****************************************************************************************
                     5651  
 9251 [02] A601      5652       lda     #1                ; Load accumulator with decimal 1
 9253 [04] ADE6      5653       bsr     ms_delay          ; Branch to subroutine at lable "ms_delay:"
 9255 [02] A609      5654       lda     #{PGM | HVEN}     ; Load accumulator with value in "ERASE" bit wise Or
                     5655                                 ; "HVEN"
 9257 [04] C7FE08    5656       sta     flcr              ; Copy to Flash Control Register
                     5657  
                     5658  ;****************************************************************************************
                     5659  ; - Wait for >5us.
                     5660  ;****************************************************************************************
                     5661  
 925A [02] A601      5662       lda     #1           ; Load accumulator with decimal 1
 925C [04] ADDD      5663       bsr     ms_delay     ; Branch to subroutine at lable "ms_delay:"
                     5664  
                     5665  ;****************************************************************************************
                     5666  ; - Write data to Flash and wait for 30 - 40us.
                     5667  ;****************************************************************************************
                     5668  
 925E [04] 55C5      5669       ldhx    burnsrc     ; Load index register with address at "burnsrc"
 9260 [02] F6        5670       lda     ,x          ; Load accumulator with value in "burnsrc, offset in index
                     5671                           ; register Lo byte
 9261 [04] 55C7      5672       ldhx    burndst     ; Load index register with address at "burndst"
 9263 [02] F7        5673       sta     ,x          ; Copy to address at "burndst", offset in index register Lo byte
 9264 [02] A603      5674       lda     #3          ; Load accumulator with decimal 3(30.3uS)
 9266 [04] ADD3      5675       bsr     ms_delay    ; Jump to subroutine at "ms_delay:)
                     5676  
                     5677  ;****************************************************************************************
                     5678  ; - Clear PGM.
                     5679  ;****************************************************************************************
                     5680  
 9268 [02] A608      5681       lda     #{HVEN}     ; Load accumulator with value in {HVEN}
 926A [04] C7FE08    5682       sta     flcr        ; Copy to Flash Control Register
                     5683  
                     5684  ;****************************************************************************************
                     5685  ; - Wait for >5us, then clear HVEN.
                     5686  ;****************************************************************************************
                     5687  
 926D [02] A601      5688       lda     #1           ; Load accumulator with decimal 1
 926F [04] ADCA      5689       bsr     ms_delay     ; Branch to subroutine at lable "ms_delay:"
 9271 [01] 4F        5690       clra                 ; Clear accumulator
 9272 [04] C7FE08    5691       sta     flcr         ; Copy to Flash Control Register
                     5692  
                     5693  ;****************************************************************************************
                     5694  ; - Advance source pointer, advance destination pointer, decrement data counter,
                     5695  ;   return from subroutine
                     5696  ;****************************************************************************************
                     5697  
                     5698  ms_FlashProgram2:
 9275 [04] 55C5      5699       ldhx    burnsrc                     ; Load index register with address at "burnscr"
 9277 [02] AF01      5700       aix     #1                          ; Add decimal 1 to index register Lo byte
 9279 [04] 35C5      5701       sthx    BurnSrc                     ; Copy result to "burnSrc"
 927B [04] 55C7      5702       ldhx    burndst                     ; Load index register with address at "burnDst"
 927D [02] AF01      5703       aix     #1                          ; Add decimal 1 to index register Lo byte
 927F [04] 35C7      5704       sthx    BurnDst                     ; Copy result to "burnDst"
 9281 [05] 3BC9C2    5705       dbnz    burncount,ms_FlashProgram1  ; Decrement "burnount" and branch to
                     5706                                           ;  "ms_FlashProgram1" back if not zero.
 9284 [04] 81        5707       rts                                 ; Return from subroutine
                     5708  
                     5709  ;****************************************************************************************
                     5710  ; - Equates
                     5711  ;****************************************************************************************
                     5712  
 9285                5713  ms_ProgramRamSize: equ     {*-ms_Delay}
                     5714  
                     5715  
                     5716  
                     5717  
                     5718  
 FAC3                5719       org     $FAC3              ; start bootloader-defined jump table/vector
                     5720                                  ;(64,195)
 FAC3      12        5721       db      $12                ; scbr regi init value
 FAC4      01        5722       db      %00000001          ; config1
 FAC5      01        5723       db      %00000001          ; config2
 FAC6      8128      5724       dw      start              ; Megasquirt code start
 FAC8      FB00      5725       dw      $FB00              ; bootloader start(64,256)
                     5726  
                     5727  ;****************************************************************************
                     5728  ;
                     5729  ; ----------------- Vector table origin vec_timebase -----------------------
                     5730  ;
                     5731  ;****************************************************************************
                     5732  
                     5733  
                     5734  
 FACA      CC        5735          db      $CC
 FACB      8FEE      5736       dw      Dummy        ;Timebase
 FACD      CC        5737          db      $CC
 FACE      8F5E      5738       dw      ADC_ISR      ;ADC Conversion Complete
 FAD0      CC        5739          db      $CC
 FAD1      8FCA      5740       dw      KYBD_ISR     ;Keyboard pin
 FAD3      CC        5741          db      $CC
 FAD4      8EEC      5742       dw      SCITX_ISR    ;SCI transmission complete/transmitter empty
 FAD6      CC        5743          db      $CC
 FAD7      8DFE      5744       dw      SCIRCV_ISR   ;SCI input idle/receiver full
 FAD9      CC        5745          db      $CC
 FADA      8FEE      5746       dw      Dummy        ;SCI parity/framing/noise/receiver_overrun error
 FADC      CC        5747          db      $CC
 FADD      8FEE      5748       dw      Dummy        ;SPI Transmitter empty
 FADF      CC        5749          db      $CC
 FAE0      8FEE      5750       dw      Dummy        ;SPI mode/overflow/receiver full
 FAE2      CC        5751          db      $CC
 FAE3      8FEE      5752       dw      Dummy        ;TIM2 overflow
 FAE5      CC        5753          db      $CC
 FAE6      8DC8      5754       dw      TIM2CH1_ISR  ;TIM2 Ch1
 FAE8      CC        5755          db      $CC
 FAE9      8C1F      5756       dw      TIM2CH0_ISR  ;TIM2 Ch0
 FAEB      CC        5757          db      $CC
 FAEC      8FEE      5758       dw      Dummy        ;TIM1 overflow


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 45
MC68HC908GP32 User Bootloader


 FAEE      CC        5759          db      $CC
 FAEF      8FEE      5760       dw      Dummy        ;TIM1 Ch1
 FAF1      CC        5761          db      $CC
 FAF2      8FEE      5762       dw      Dummy        ;TIM1 Ch0
 FAF4      CC        5763          db      $CC
 FAF5      8FEE      5764       dw      Dummy        ;CGM
 FAF7      CC        5765          db      $CC
 FAF8      8BA2      5766       dw      IRQ_ISR      ;IRQ
 FAFA      CC        5767          db      $CC
 FAFB      8FEE      5768       dw      Dummy        ;SWI
 FAFD      CC        5769          db      $CC
 FAFE      8128      5770       dw      Start        ;Reset
                     5771  
                     5772  
                     5773  ;***********************************************************************************************
                     5774  ;
                     5775  ; ------------------------------------- Lookup Tables ------------------------------------------
                     5776  ;
                     5777  ;***********************************************************************************************
                     5778  
 F000                5779       org     $F000     ; Origin at Memory Location $F000=61440
                     5780  
 F000                5781       include "barofactor4250rjh.inc"  ; Converts Barometer ADC Raw Reading to baro correction
                     5782  BAROFAC4250rjh: ;% correction
 F000      64        5783          DB      100T     ; x=000;=0.000v;=100KPA;=sensor failure
 F001      8E        5784          DB      142T     ; x=001;=0.020v;=11KPA
 F002      8E        5785          DB      142T     ; x=002;=0.039v;=12KPA
 F003      8E        5786          DB      142T     ; x=003;=0.059v;=13KPA
 F004      8D        5787          DB      141T     ; x=004;=0.078v;=14KPA
 F005      8D        5788          DB      141T     ; x=005;=0.098v;=15KPA
 F006      8C        5789          DB      140T     ; x=006;=0.118v;=16KPA
 F007      8C        5790          DB      140T     ; x=007;=0.137v;=17KPA
 F008      8B        5791          DB      139T     ; x=008;=0.157v;=18KPA
 F009      8B        5792          DB      139T     ; x=009;=0.176v;=19KPA
 F00A      8A        5793          DB      138T     ; x=010;=0.196v;=20KPA
 F00B      8A        5794          DB      138T     ; x=011;=0.216v;=21KPA
 F00C      89        5795          DB      137T     ; x=012;=0.235v;=22KPA
 F00D      89        5796          DB      137T     ; x=013;=0.255v;=23KPA
 F00E      88        5797          DB      136T     ; x=014;=0.275v;=24KPA
 F00F      88        5798          DB      136T     ; x=015;=0.294v;=25KPA
 F010      88        5799          DB      136T     ; x=016;=0.314v;=26KPA
 F011      87        5800          DB      135T     ; x=017;=0.333v;=27KPA
 F012      87        5801          DB      135T     ; x=018;=0.353v;=28KPA
 F013      86        5802          DB      134T     ; x=019;=0.373v;=29KPA
 F014      86        5803          DB      134T     ; x=020;=0.392v;=30KPA
 F015      85        5804          DB      133T     ; x=021;=0.412v;=31KPA
 F016      85        5805          DB      133T     ; x=022;=0.431v;=32KPA
 F017      84        5806          DB      132T     ; x=023;=0.451v;=33KPA
 F018      84        5807          DB      132T     ; x=024;=0.471v;=34KPA
 F019      83        5808          DB      131T     ; x=025;=0.490v;=35KPA
 F01A      83        5809          DB      131T     ; x=026;=0.510v;=35KPA
 F01B      82        5810          DB      130T     ; x=027;=0.529v;=36KPA
 F01C      82        5811          DB      130T     ; x=028;=0.549v;=37KPA
 F01D      82        5812          DB      130T     ; x=029;=0.569v;=38KPA
 F01E      81        5813          DB      129T     ; x=030;=0.588v;=39KPA
 F01F      81        5814          DB      129T     ; x=031;=0.608v;=40KPA
 F020      80        5815          DB      128T     ; x=032;=0.627v;=41KPA
 F021      80        5816          DB      128T     ; x=033;=0.647v;=42KPA
 F022      7F        5817          DB      127T     ; x=034;=0.667v;=43KPA
 F023      7F        5818          DB      127T     ; x=035;=0.686v;=44KPA
 F024      7E        5819          DB      126T     ; x=036;=0.706v;=45KPA
 F025      7E        5820          DB      126T     ; x=037;=0.725v;=46KPA
 F026      7D        5821          DB      125T     ; x=038;=0.745v;=47KPA
 F027      7D        5822          DB      125T     ; x=039;=0.765v;=48KPA
 F028      7C        5823          DB      124T     ; x=040;=0.784v;=49KPA
 F029      7C        5824          DB      124T     ; x=041;=0.804v;=50KPA
 F02A      7C        5825          DB      124T     ; x=042;=0.824v;=51KPA
 F02B      7B        5826          DB      123T     ; x=043;=0.843v;=52KPA
 F02C      7B        5827          DB      123T     ; x=044;=0.863v;=53KPA
 F02D      7A        5828          DB      122T     ; x=045;=0.882v;=54KPA
 F02E      7A        5829          DB      122T     ; x=046;=0.902v;=55KPA
 F02F      79        5830          DB      121T     ; x=047;=0.922v;=56KPA
 F030      79        5831          DB      121T     ; x=048;=0.941v;=57KPA
 F031      78        5832          DB      120T     ; x=049;=0.961v;=58KPA
 F032      78        5833          DB      120T     ; x=050;=0.980v;=59KPA
 F033      77        5834          DB      119T     ; x=051;=1.000v;=60KPA
 F034      77        5835          DB      119T     ; x=052;=1.020v;=61KPA
 F035      76        5836          DB      118T     ; x=053;=1.039v;=62KPA
 F036      76        5837          DB      118T     ; x=054;=1.059v;=63KPA
 F037      76        5838          DB      118T     ; x=055;=1.078v;=64KPA
 F038      75        5839          DB      117T     ; x=056;=1.096v;=65KPA
 F039      75        5840          DB      117T     ; x=057;=1.118v;=66KPA
 F03A      74        5841          DB      116T     ; x=058;=1.137v;=67KPA
 F03B      74        5842          DB      116T     ; x=059;=1.157v;=68KPA
 F03C      73        5843          DB      115T     ; x=060;=1.176v;=69KPA
 F03D      73        5844          DB      115T     ; x=061;=1,196v;=70KPA
 F03E      72        5845          DB      114T     ; x=062;=1,216v;=71KPA
 F03F      72        5846          DB      114T     ; x=063;=1.235v;=72KPA
 F040      71        5847          DB      113T     ; x=064;=1.255v;=73KPA
 F041      71        5848          DB      113T     ; x=065;=1.275v;=74KPA
 F042      70        5849          DB      112T     ; x=066;=1.294v;=75KPA
 F043      70        5850          DB      112T     ; x=067;=1.314v;=76KPA
 F044      70        5851          DB      112T     ; x=068;=1.333v;=77KPA
 F045      6F        5852          DB      111T     ; x=069;=1.353v;=78KPA
 F046      6F        5853          DB      111T     ; x=070;=1.373v;=79KPA
 F047      6E        5854          DB      110T     ; x=071;=1.392v;=80KPA
 F048      6E        5855          DB      110T     ; x=072;=1.412v;=81KPA
 F049      6D        5856          DB      109T     ; x=073;=1.431v;=82KPA
 F04A      6D        5857          DB      109T     ; x=074;=1.451v;=83KPA
 F04B      6C        5858          DB      108T     ; x=075;=1.471v;=84KPA
 F04C      6C        5859          DB      108T     ; x=076;=1.490v;=85KPA
 F04D      6B        5860          DB      107T     ; x=077;=1.510v;=85KPA
 F04E      6B        5861          DB      107T     ; x=078;=1.529v;=86KPA
 F04F      6A        5862          DB      106T     ; x=079;=1.549v;=87KPA
 F050      6A        5863          DB      106T     ; x=080;=1.569v;=88KPA
 F051      6A        5864          DB      106T     ; x=081;=1.588v;=89KPA
 F052      69        5865          DB      105T     ; x=082;=1.608v;=90KPA
 F053      69        5866          DB      105T     ; x=083;=1.627v;=91KPA
 F054      68        5867          DB      104T     ; x=084;=1.647v;=92KPA
 F055      68        5868          DB      104T     ; x=085;=1.667v;=93KPA
 F056      67        5869          DB      103T     ; x=086;=1.686v;=94KPA
 F057      67        5870          DB      103T     ; x=087;=1.706v;=95KPA
 F058      66        5871          DB      102T     ; x=088;=1.725v;=96KPA
 F059      66        5872          DB      102T     ; x=089;=1.745v;=97KPA
 F05A      65        5873          DB      101T     ; x=090;=1.765v;=98KPA
 F05B      65        5874          DB      101T     ; x=091;=1.784v;=99KPA
 F05C      64        5875          DB      100T     ; x=092;=1.804v;=100KPA
 F05D      64        5876          DB      100T     ; x=093;=1.824v;=101KPA
 F05E      64        5877          DB      100T     ; x=094;=1.843v;=102KPA
 F05F      63        5878          DB      99T      ; x=095;=1.863v;=103KPA
 F060      63        5879          DB      99T      ; x=096;=1.882v;=104KPA
 F061      62        5880          DB      98T      ; x=097;=1.902v;=105KPA
 F062      62        5881          DB      98T      ; x=098;=1.922v;=106KPA
 F063      61        5882          DB      97T      ; x=099;=1.941v;=107KPA
 F064      61        5883          DB      97T      ; x=100;=1.961v;=108KPA
 F065      60        5884          DB      96T      ; x=101;=1.980v;=109KPA
 F066      60        5885          DB      96T      ; x=102;=2.000v;=110KPA
 F067      5F        5886          DB      95T      ; x=103;=2.020v;=111KPA
 F068      5F        5887          DB      95T      ; x=104;=2.039v;=112KPA
 F069      5E        5888          DB      94T      ; x=105;=2.059v;=113KPA
 F06A      5E        5889          DB      94T      ; x=106;=2.078v;=114KPA
 F06B      5E        5890          DB      94T      ; x=107;=2.098v;=115KPA
 F06C      5D        5891          DB      93T      ; x=108;=2.118v;=116KPA
 F06D      5D        5892          DB      93T      ; x=109;=2.137v;=117KPA
 F06E      5C        5893          DB      92T      ; x=110;=2.157v;=118KPA
 F06F      5C        5894          DB      92T      ; x=111;=2.176v;=119KPA


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 46
MC68HC908GP32 User Bootloader


 F070      5B        5895          DB      91T      ; x=112;=2.196v;=120KPA
 F071      5B        5896          DB      91T      ; x=113;=2.216v;=121KPA
 F072      5A        5897          DB      90T      ; x=114;=2.235v;=122KPA
 F073      5A        5898          DB      90T      ; x=115;=2.255v;=123KPA
 F074      59        5899          DB      89T      ; x=116;=2.275v;=124KPA
 F075      59        5900          DB      89T      ; x=117;=2.294v;=125KPA
 F076      58        5901          DB      88T      ; x=118;=2.314v;=126KPA
 F077      58        5902          DB      88T      ; x=119;=2.333v;=127KPA
 F078      58        5903          DB      88T      ; x=120;=2.353v;=128KPA
 F079      57        5904          DB      87T      ; x=121;=2.373v;=129KPA
 F07A      57        5905          DB      87T      ; x=122;=2.392v;=130KPA
 F07B      56        5906          DB      86T      ; x=123;=2.412v;=131KPA
 F07C      56        5907          DB      86T      ; x=124;=2.431v;=132KPA
 F07D      55        5908          DB      85T      ; x=125;=2.451v;=133KPA
 F07E      55        5909          DB      85T      ; x=126;=2.471v;=134KPA
 F07F      54        5910          DB      84T      ; x=127;=2.490v;=135KPA
 F080      54        5911          DB      84T      ; x=128;=2.510v;=135KPA
 F081      53        5912          DB      83T      ; x=129;=2.529v;=136KPA
 F082      53        5913          DB      83T      ; x=130;=2.549v;=137KPA
 F083      52        5914          DB      82T      ; x=131;=2.569v;=138KPA
 F084      52        5915          DB      82T      ; x=132;=2.588v;=139KPA
 F085      52        5916          DB      82T      ; x=133;=2.608v;=140KPA
 F086      51        5917          DB      81T      ; x=134;=2.627v;=141KPA
 F087      51        5918          DB      81T      ; x=135;=2.647v;=142KPA
 F088      50        5919          DB      80T      ; x=136;=2.667v;=143KPA
 F089      50        5920          DB      80T      ; x=137;=2.686v;=144KPA
 F08A      4F        5921          DB      79T      ; x=138;=2.706v;=145KPA
 F08B      4F        5922          DB      79T      ; x=139;=2.725v;=146KPA
 F08C      4E        5923          DB      78T      ; x=140;=2.745v;=147KPA
 F08D      4E        5924          DB      78T      ; x=141;=2.765v;=148KPA
 F08E      4D        5925          DB      77T      ; x=142;=2.784v;=149KPA
 F08F      4D        5926          DB      77T      ; x=143;=2.804v;=150KPA
 F090      4C        5927          DB      76T      ; x=144;=0.824v;=151KPA
 F091      4C        5928          DB      76T      ; x=145;=2.843v;=152KPA
 F092      4C        5929          DB      76T      ; x=146;=2.863v;=153KPA
 F093      4B        5930          DB      75T      ; x=147;=2.882v;=154KPA
 F094      4B        5931          DB      75T      ; x=148;=2.902v;=155KPA
 F095      4A        5932          DB      74T      ; x=149;=2.922v;=156KPA
 F096      4A        5933          DB      74T      ; x=150;=2.941v;=157KPA
 F097      49        5934          DB      73T      ; x=151;=2.961v;=158KPA
 F098      49        5935          DB      73T      ; x=152;=2.980v;=159KPA
 F099      48        5936          DB      72T      ; x=153;=3.000v;=160KPA
 F09A      48        5937          DB      72T      ; x=154;=3.020v;=161KPA
 F09B      47        5938          DB      71T      ; x=155;=3.039v;=162KPA
 F09C      47        5939          DB      71T      ; x=156;=3.059v;=163KPA
 F09D      46        5940          DB      70T      ; x=157;=3.078v;=164KPA
 F09E      46        5941          DB      70T      ; x=158;=3.098v;=165KPA
 F09F      46        5942          DB      70T      ; x=159;=3.118v;=166KPA
 F0A0      45        5943          DB      69T      ; x=160;=3.137v;=167KPA
 F0A1      45        5944          DB      69T      ; x=161;=3.157v;=168KPA
 F0A2      44        5945          DB      68T      ; x=162;=3.176v;=169KPA
 F0A3      44        5946          DB      68T      ; x=163;=3.196v;=170KPA
 F0A4      43        5947          DB      67T      ; x=164;=3.216v;=171KPA
 F0A5      43        5948          DB      67T      ; x=165;=3.235v;=172KPA
 F0A6      42        5949          DB      66T      ; x=166;=3.255v;=173KPA
 F0A7      42        5950          DB      66T      ; x=167;=3.275v;=174KPA
 F0A8      41        5951          DB      65T      ; x=168;=3.294v;=175KPA
 F0A9      41        5952          DB      65T      ; x=169;=3.314v;=176KPA
 F0AA      40        5953          DB      64T      ; x=170;=3.333v;=177KPA
 F0AB      40        5954          DB      64T      ; x=171;=3.353v;=178KPA
 F0AC      40        5955          DB      64T      ; x=172;=3.373v;=179KPA
 F0AD      3F        5956          DB      63T      ; x=173;=3.392v;=180KPA
 F0AE      3F        5957          DB      63T      ; x=174;=3.412v;=181KPA
 F0AF      3E        5958          DB      62T      ; x=175;=3.431v;=1823KPA
 F0B0      3E        5959          DB      62T      ; x=176;=3.451v;=183KPA
 F0B1      3D        5960          DB      61T      ; x=177;=3.471v;=184KPA
 F0B2      3D        5961          DB      61T      ; x=178;=3.490v;=185KPA
 F0B3      3C        5962          DB      60T      ; x=179;=3.510v;=185KPA
 F0B4      3C        5963          DB      60T      ; x=180;=3.529v;=186KPA
 F0B5      3B        5964          DB      59T      ; x=181;=3.549v;=187KPa
 F0B6      3B        5965          DB      59T      ; x=182;=3.569v;=188KPA
 F0B7      3A        5966          DB      58T      ; x=183;=3.588v;=189KPA
 F0B8      3A        5967          DB      58T      ; x=184;=3.608v;=190KPA
 F0B9      3A        5968          DB      58T      ; x=185;=3.627v;=191KPA
 F0BA      39        5969          DB      57T      ; x=186;=3.647v;=192KPA
 F0BB      39        5970          DB      57T      ; x=187;=3.667v;=193KPA
 F0BC      38        5971          DB      56T      ; x=188;=3.686v;=194KPA
 F0BD      38        5972          DB      56T      ; x=189;=3.706v;=195KPA
 F0BE      37        5973          DB      55T      ; x=190;=3.725v;=196KPA
 F0BF      37        5974          DB      55T      ; x=191;=3.745v;=197KPA
 F0C0      36        5975          DB      54T      ; x=192;=3.765v;=198KPA
 F0C1      36        5976          DB      54T      ; x=193;=3.784v;=199KPA
 F0C2      35        5977          DB      53T      ; x=194;=3.804v;=200KPA
 F0C3      35        5978          DB      53T      ; x=195;=3.824v;=201KPA
 F0C4      34        5979          DB      52T      ; x=196;=3.843v;=202KPA
 F0C5      34        5980          DB      52T      ; x=197;=3.863v;=203KPA
 F0C6      34        5981          DB      52T      ; x=198;=3.882v;=204KPA
 F0C7      33        5982          DB      51T      ; x=199;=3.902v;=205KPA
 F0C8      33        5983          DB      51T      ; x=200;=3.922v;=206KPA
 F0C9      32        5984          DB      50T      ; x=201;=3.941v;=207KPA
 F0CA      32        5985          DB      50T      ; x=202;=3.961v;=208KPA
 F0CB      31        5986          DB      49T      ; x=203;=3.980v;=209KPA
 F0CC      31        5987          DB      49T      ; x=204;=4.000v;=210KPA
 F0CD      30        5988          DB      48T      ; x=205;=4.020v;=211KPA
 F0CE      30        5989          DB      48T      ; x=206;=4.039v;=212KPA
 F0CF      2F        5990          DB      47T      ; x=207;=4.059v;=213KPA
 F0D0      2F        5991          DB      47T      ; x=208;=4.078v;=214KPA
 F0D1      2E        5992          DB      46T      ; x=209;=4.098v;=215KPA
 F0D2      2E        5993          DB      46T      ; x=210;=4.118v;=216KPA
 F0D3      2E        5994          DB      46T      ; x=211;=4.137v;=217KPA
 F0D4      2D        5995          DB      45T      ; x=212;=4.157v;=218KPA
 F0D5      2D        5996          DB      45T      ; x=213;=4.176v;=219KPA
 F0D6      2C        5997          DB      44T      ; x=214;=4.196v;=220KPA
 F0D7      2C        5998          DB      44T      ; x=215;=4.216v;=221KPA
 F0D8      2B        5999          DB      43T      ; x=216;=4.235v;=222KPA
 F0D9      2B        6000          DB      43T      ; x=217;=4.255v;=223KPA
 F0DA      2A        6001          DB      42T      ; x=218;=4.275v;=224KPA
 F0DB      2A        6002          DB      42T      ; x=219;=4.294v;=225KPA
 F0DC      29        6003          DB      41T      ; x=220;=4.314v;=226KPA
 F0DD      29        6004          DB      41T      ; x=221;=4.333v;=227KPA
 F0DE      28        6005          DB      40T      ; x=222;=4.353v;=228KPA
 F0DF      28        6006          DB      40T      ; x=223;=4.373v;=229KPA
 F0E0      28        6007          DB      40T      ; x=224;=4.392v;=230KPA
 F0E1      27        6008          DB      39T      ; x=225;=4.412v;=231KPA
 F0E2      27        6009          DB      39T      ; x=226;=4.431v;=232KPA
 F0E3      26        6010          DB      38T      ; x=227;=4.451v;=233KPA
 F0E4      26        6011          DB      38T      ; x=228;=4.471v;=234KPA
 F0E5      25        6012          DB      37T      ; x=229;=4.490v;=235KPA
 F0E6      25        6013          DB      37T      ; x=230;=4.510v;=235KPA
 F0E7      24        6014          DB      36T      ; x=231;=4.529v;=236KPA
 F0E8      24        6015          DB      36T      ; x=232;=4.549v;=237KPA
 F0E9      23        6016          DB      35T      ; x=233;=4.569v;=238KPA
 F0EA      23        6017          DB      35T      ; x=234;=4.588v;=239KPA
 F0EB      22        6018          DB      34T      ; x=235;=4.608v;=240KPA
 F0EC      22        6019          DB      34T      ; x=236;=4.627v;=241KPA
 F0ED      22        6020          DB      34T      ; x=237;=4.647v;=242KPA
 F0EE      21        6021          DB      33T      ; x=238;=4.667v;=243KPA
 F0EF      21        6022          DB      33T      ; x=239;=4.686v;=244KPA
 F0F0      20        6023          DB      32T      ; x=240;=4.706v;=245KPA
 F0F1      20        6024          DB      32T      ; x=241;=4.725v;=246KPA
 F0F2      1F        6025          DB      31T      ; x=242;=4.745v;=247KPA
 F0F3      1F        6026          DB      31T      ; x=243;=4.765v;=248KPA
 F0F4      1E        6027          DB      30T      ; x=244;=4.784v;=249KPA
 F0F5      1E        6028          DB      30T      ; x=245;=4.804v;=250KPA
 F0F6      1D        6029          DB      29T      ; x=246;=4.824v;=251KPA
 F0F7      1D        6030          DB      29T      ; x=247;=4.843v;=252KPA


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 47
MC68HC908GP32 User Bootloader


 F0F8      1C        6031          DB      28T      ; x=248;=4.863v;=253KPA
 F0F9      1C        6032          DB      28T      ; x=249;=4.882v;=254KPA
 F0FA      1C        6033          DB      28T      ; x=250;=4.902v;=255KPA
 F0FB      1B        6034          DB      27T      ; x=251;=4.922v;=256KPA
 F0FC      1B        6035          DB      27T      ; x=252;=4.941v;=257KPA
 F0FD      1A        6036          DB      26T      ; x=253;=4.961v;=258KPA
 F0FE      1A        6037          DB      26T      ; x=254;=4.980v;=259KPA
 F0FF      64        6038          DB      100T     ; x=255;=5.000v;=100KPA;=sensor fail
                     6039                                        ; factor in %
                     6040  
 F100                6041       include "kpafactor4250rjh.inc"   ; Converts Manifold Absolute Pressure ADC and Barometric
                     6042  KPAFACTOR4250rjh:
 F100      64        6043          DB      100T     ; x=000;=0.000v;sensor failure
 F101      0B        6044          DB      11T      ; x=001;=0.020v
 F102      0C        6045          DB      12T      ; x=002;=0.039v
 F103      0D        6046          DB      13T      ; x=003;=0.059v
 F104      0E        6047          DB      14T      ; x=004;=0.078v
 F105      0F        6048          DB      15T      ; x=005;=0.098v
 F106      10        6049          DB      16T      ; x=006;=0.118v
 F107      11        6050          DB      17T      ; x=007;=0.137v
 F108      12        6051          DB      18T      ; x=008;=0.157v
 F109      13        6052          DB      19T      ; x=009;=0.176v
 F10A      14        6053          DB      20T      ; x=010;=0.196v
 F10B      15        6054          DB      21T      ; x=011;=0.216v
 F10C      16        6055          DB      22T      ; x=012;=0.235v
 F10D      17        6056          DB      23T      ; x=013;=0.255v
 F10E      18        6057          DB      24T      ; x=014;=0.275v
 F10F      19        6058          DB      25T      ; x=015;=0.294v
 F110      1A        6059          DB      26T      ; x=016;=0.314v
 F111      1B        6060          DB      27T      ; x=017;=0.333v
 F112      1C        6061          DB      28T      ; x=018;=0.353v
 F113      1D        6062          DB      29T      ; x=019;=0.373v
 F114      1E        6063          DB      30T      ; x=020;=0.392v
 F115      1F        6064          DB      31T      ; x=021;=0.412v
 F116      20        6065          DB      32T      ; x=022;=0.431v
 F117      21        6066          DB      33T      ; x=023;=0.451v
 F118      22        6067          DB      34T      ; x=024;=0.471v
 F119      23        6068          DB      35T      ; x=025;=0.490v
 F11A      23        6069          DB      35T      ; x=026;=0.510v
 F11B      24        6070          DB      36T      ; x=027;=0.529v
 F11C      25        6071          DB      37T      ; x=028;=0.549v
 F11D      26        6072          DB      38T      ; x=029;=0.569v
 F11E      27        6073          DB      39T      ; x=030;=0.588v
 F11F      28        6074          DB      40T      ; x=031;=0.608v
 F120      29        6075          DB      41T      ; x=032;=0.627v
 F121      2A        6076          DB      42T      ; x=033;=0.647v
 F122      2B        6077          DB      43T      ; x=034;=0.667v
 F123      2C        6078          DB      44T      ; x=035;=0.686v
 F124      2D        6079          DB      45T      ; x=036;=0.706v
 F125      2E        6080          DB      46T      ; x=037;=0.725v
 F126      2F        6081          DB      47T      ; x=038;=0.745v
 F127      30        6082          DB      48T      ; x=039;=0.765v
 F128      31        6083          DB      49T      ; x=040;=0.784v
 F129      32        6084          DB      50T      ; x=041;=0.804v
 F12A      33        6085          DB      51T      ; x=042;=0.824v
 F12B      34        6086          DB      52T      ; x=043;=0.843v
 F12C      35        6087          DB      53T      ; x=044;=0.863v
 F12D      36        6088          DB      54T      ; x=045;=0.882v
 F12E      37        6089          DB      55T      ; x=046;=0.902v
 F12F      38        6090          DB      56T      ; x=047;=0.922v
 F130      39        6091          DB      57T      ; x=048;=0.941v
 F131      3A        6092          DB      58T      ; x=049;=0.961v
 F132      3B        6093          DB      59T      ; x=050;=0.980v
 F133      3C        6094          DB      60T      ; x=051;=1.000v
 F134      3D        6095          DB      61T      ; x=052;=1.020v
 F135      3E        6096          DB      62T      ; x=053;=1.039v
 F136      3F        6097          DB      63T      ; x=054;=1.059v
 F137      40        6098          DB      64T      ; x=055;=1.078v
 F138      41        6099          DB      65T      ; x=056;=1.096v
 F139      42        6100          DB      66T      ; x=057;=1.118v
 F13A      43        6101          DB      67T      ; x=058;=1.137v
 F13B      44        6102          DB      68T      ; x=059;=1.157v
 F13C      45        6103          DB      69T      ; x=060;=1.176v
 F13D      46        6104          DB      70T      ; x=061;=1,196v
 F13E      47        6105          DB      71T      ; x=062;=1,216v
 F13F      48        6106          DB      72T      ; x=063;=1.235v
 F140      49        6107          DB      73T      ; x=064;=1.255v
 F141      4A        6108          DB      74T      ; x=065;=1.275v
 F142      4B        6109          DB      75T      ; x=066;=1.294v
 F143      4C        6110          DB      76T      ; x=067;=1.314v
 F144      4D        6111          DB      77T      ; x=068;=1.333v
 F145      4E        6112          DB      78T      ; x=069;=1.353v
 F146      4F        6113          DB      79T      ; x=070;=1.373v
 F147      50        6114          DB      80T      ; x=071;=1.392v
 F148      51        6115          DB      81T      ; x=072;=1.412v
 F149      52        6116          DB      82T      ; x=073;=1.431v
 F14A      53        6117          DB      83T      ; x=074;=1.451v
 F14B      54        6118          DB      84T      ; x=075;=1.471v
 F14C      55        6119          DB      85T      ; x=076;=1.490v
 F14D      55        6120          DB      85T      ; x=077;=1.510v
 F14E      56        6121          DB      86T      ; x=078;=1.529v
 F14F      57        6122          DB      87T      ; x=079;=1.549v
 F150      58        6123          DB      88T      ; x=080;=1.569v
 F151      59        6124          DB      89T      ; x=081;=1.588v
 F152      5A        6125          DB      90T      ; x=082;=1.608v
 F153      5B        6126          DB      91T      ; x=083;=1.627v
 F154      5C        6127          DB      92T      ; x=084;=1.647v
 F155      5D        6128          DB      93T      ; x=085;=1.667v
 F156      5E        6129          DB      94T      ; x=086;=1.686v
 F157      5F        6130          DB      95T      ; x=087;=1.706v
 F158      60        6131          DB      96T      ; x=088;=1.725v
 F159      61        6132          DB      97T      ; x=089;=1.745v
 F15A      62        6133          DB      98T      ; x=090;=1.765v
 F15B      63        6134          DB      99T      ; x=091;=1.784v
 F15C      64        6135          DB      100T     ; x=092;=1.804v
 F15D      65        6136          DB      101T     ; x=093;=1.824v
 F15E      66        6137          DB      102T     ; x=094;=1.843v
 F15F      67        6138          DB      103T     ; x=095;=1.863v
 F160      68        6139          DB      104T     ; x=096;=1.882v
 F161      69        6140          DB      105T     ; x=097;=1.902v
 F162      6A        6141          DB      106T     ; x=098;=1.922v
 F163      6B        6142          DB      107T     ; x=099;=1.941v
 F164      6C        6143          DB      108T     ; x=100;=1.961v
 F165      6D        6144          DB      109T     ; x=101;=1.980v
 F166      6E        6145          DB      110T     ; x=102;=2.000v
 F167      6F        6146          DB      111T     ; x=103;=2.020v
 F168      70        6147          DB      112T     ; x=104;=2.039v
 F169      71        6148          DB      113T     ; x=105;=2.059v
 F16A      72        6149          DB      114T     ; x=106;=2.078v
 F16B      73        6150          DB      115T     ; x=107;=2.098v
 F16C      74        6151          DB      116T     ; x=108;=2.118v
 F16D      75        6152          DB      117T     ; x=109;=2.137v
 F16E      76        6153          DB      118T     ; x=110;=2.157v
 F16F      77        6154          DB      119T     ; x=111;=2.176v
 F170      78        6155          DB      120T     ; x=112;=2.196v
 F171      79        6156          DB      121T     ; x=113;=2.216v
 F172      7A        6157          DB      122T     ; x=114;=2.235v
 F173      7B        6158          DB      123T     ; x=115;=2.255v
 F174      7C        6159          DB      124T     ; x=116;=2.275v
 F175      7D        6160          DB      125T     ; x=117;=2.294v
 F176      7E        6161          DB      126T     ; x=118;=2.314v
 F177      7F        6162          DB      127T     ; x=119;=2.333v
 F178      80        6163          DB      128T     ; x=120;=2.353v
 F179      81        6164          DB      129T     ; x=121;=2.373v
 F17A      82        6165          DB      130T     ; x=122;=2.392v
 F17B      83        6166          DB      131T     ; x=123;=2.412v


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 48
MC68HC908GP32 User Bootloader


 F17C      84        6167          DB      132T     ; x=124;=2.431v
 F17D      85        6168          DB      133T     ; x=125;=2.451v
 F17E      86        6169          DB      134T     ; x=126;=2.471v
 F17F      87        6170          DB      135T     ; x=127;=2.490v
 F180      87        6171          DB      135T     ; x=128;=2.510v
 F181      88        6172          DB      136T     ; x=129;=2.529v
 F182      89        6173          DB      137T     ; x=130,=2.549v
 F183      8A        6174          DB      138T     ; x=131;=2.569v
 F184      8B        6175          DB      139T     ; x=132;=2.588v
 F185      8C        6176          DB      140T     ; x=133;=2.608v
 F186      8D        6177          DB      141T     ; x=134;=2.627v
 F187      8E        6178          DB      142T     ; x=135;=2.647v
 F188      8F        6179          DB      143T     ; x=136;=2.667v
 F189      90        6180          DB      144T     ; x=137;=2.686v
 F18A      91        6181          DB      145T     ; x=138;=2.706v
 F18B      92        6182          DB      146T     ; x=139;=2.725v
 F18C      93        6183          DB      147T     ; x=140;=2.745v
 F18D      94        6184          DB      148T     ; x=141;=2.765v
 F18E      95        6185          DB      149T     ; x=142;=2.784v
 F18F      96        6186          DB      150T     ; x=143;=2.804v
 F190      97        6187          DB      151T     ; x=144;=0.824v
 F191      98        6188          DB      152T     ; x=145;=2.843v
 F192      99        6189          DB      153T     ; x=146;=2.863v
 F193      9A        6190          DB      154T     ; x=147;=2.882v
 F194      9B        6191          DB      155T     ; x=148;=2.902v
 F195      9C        6192          DB      156T     ; x=149;=2.922v
 F196      9D        6193          DB      157T     ; x=150;=2.941v
 F197      9E        6194          DB      158T     ; x=151;=2.961v
 F198      9F        6195          DB      159T     ; x=152;=2.980v
 F199      A0        6196          DB      160T     ; x=153;=3.000v
 F19A      A1        6197          DB      161T     ; x=154;=3.020v
 F19B      A2        6198          DB      162T     ; x=155;=3.039v
 F19C      A3        6199          DB      163T     ; x=156;=3.059v
 F19D      A4        6200          DB      164T     ; x=157;=3.078v
 F19E      A5        6201          DB      165T     ; x=158;=3.098v
 F19F      A6        6202          DB      166T     ; x=159;=3.118v
 F1A0      A7        6203          DB      167T     ; x=160;=3.137v
 F1A1      A8        6204          DB      168T     ; x=161;=3.157v
 F1A2      A9        6205          DB      169T     ; x=162;=3.176v
 F1A3      AA        6206          DB      170T     ; x=163;=3.196v
 F1A4      AB        6207          DB      171T     ; x=164;=3.216v
 F1A5      AC        6208          DB      172T     ; x=165;=3.235v
 F1A6      AD        6209          DB      173T     ; x=166;=3.255v
 F1A7      AE        6210          DB      174T     ; x=167;=3.275v
 F1A8      AF        6211          DB      175T     ; x=168;=3.294v
 F1A9      B0        6212          DB      176T     ; x=169;=3.314v
 F1AA      B1        6213          DB      177T     ; x=170;=3.333v
 F1AB      B2        6214          DB      178T     ; x=171;=3.353v
 F1AC      B3        6215          DB      179T     ; x=172;=3.373v
 F1AD      B4        6216          DB      180T     ; x=173;=3.392v
 F1AE      B5        6217          DB      181T     ; x=174;=3.412v
 F1AF      B6        6218          DB      182T     ; x=175;=3.431v
 F1B0      B7        6219          DB      183T     ; x=176;=3.451v
 F1B1      B8        6220          DB      184T     ; x=177;=3.471v
 F1B2      B9        6221          DB      185T     ; x=178;=3.490v
 F1B3      B9        6222          DB      185T     ; x=179;=3.510v
 F1B4      BA        6223          DB      186T     ; x=180;=3.529v
 F1B5      BB        6224          DB      187T     ; x=181;=3.549v
 F1B6      BC        6225          DB      188T     ; x=182;=3.569v
 F1B7      BD        6226          DB      189T     ; x=183;=3.588v
 F1B8      BE        6227          DB      190T     ; x=184;=3.608v
 F1B9      BF        6228          DB      191T     ; x=185;=3.627v
 F1BA      C0        6229          DB      192T     ; x=186;=3.647v
 F1BB      C1        6230          DB      193T     ; x=187;=3.667v
 F1BC      C2        6231          DB      194T     ; x=188;=3.686v
 F1BD      C3        6232          DB      195T     ; x=189;=3.706v
 F1BE      C4        6233          DB      196T     ; x=190;=3.725v
 F1BF      C5        6234          DB      197T     ; x=191;=3.745v
 F1C0      C6        6235          DB      198T     ; x=192;=3.765v
 F1C1      C7        6236          DB      199T     ; x=193;=3.784v
 F1C2      C8        6237          DB      200T     ; x=194;=3.804v
 F1C3      C9        6238          DB      201T     ; x=195;=3.824v
 F1C4      CA        6239          DB      202T     ; x=196;=3.843v
 F1C5      CB        6240          DB      203T     ; x=197;=3.863v
 F1C6      CC        6241          DB      204T     ; x=198;=3.882v
 F1C7      CD        6242          DB      205T     ; x=199;=3.902v
 F1C8      CE        6243          DB      206T     ; x=200;=3.922v
 F1C9      CF        6244          DB      207T     ; x=201;=3.941v
 F1CA      D0        6245          DB      208T     ; x=202;=3.961v
 F1CB      D1        6246          DB      209T     ; x=203;=3.980v
 F1CC      D2        6247          DB      210T     ; x=204;=4.000v
 F1CD      D3        6248          DB      211T     ; x=205;=4.020v
 F1CE      D4        6249          DB      212T     ; x=206;=4.039v
 F1CF      D5        6250          DB      213T     ; x=207;=4.059v
 F1D0      D6        6251          DB      214T     ; x=208;=4.078v
 F1D1      D7        6252          DB      215T     ; x=209;=4.098v
 F1D2      D8        6253          DB      216T     ; x=210;=4.118v
 F1D3      D9        6254          DB      217T     ; x=211;=4.137v
 F1D4      DA        6255          DB      218T     ; x=212;=4.157v
 F1D5      DB        6256          DB      219T     ; x=213;=4.176v
 F1D6      DC        6257          DB      220T     ; x=214;=4.196v
 F1D7      DD        6258          DB      221T     ; x=215;=4.216v
 F1D8      DE        6259          DB      222T     ; x=216;=4.235v
 F1D9      DF        6260          DB      223T     ; x=217;=4.255v
 F1DA      E0        6261          DB      224T     ; x=218;=4.275v
 F1DB      E1        6262          DB      225T     ; x=219;=4.294v
 F1DC      E2        6263          DB      226T     ; x=220;=4.314v
 F1DD      E3        6264          DB      227T     ; x=221;=4.333v
 F1DE      E4        6265          DB      228T     ; x=222;=4.353v
 F1DF      E5        6266          DB      229T     ; x=223;=4.373v
 F1E0      E6        6267          DB      230T     ; x=224;=4.392v
 F1E1      E7        6268          DB      231T     ; x=225;=4.412v
 F1E2      E8        6269          DB      232T     ; x=226;=4.431v
 F1E3      E9        6270          DB      233T     ; x=227;=4.451v
 F1E4      EA        6271          DB      234T     ; x=228;=4.471v
 F1E5      EB        6272          DB      235T     ; x=229;=4.490v
 F1E6      EB        6273          DB      235T     ; x=230;=4.510v
 F1E7      EC        6274          DB      236T     ; x=231;=4.529v
 F1E8      ED        6275          DB      237T     ; x=232;=4.549v
 F1E9      EE        6276          DB      238T     ; x=233;=4.569v
 F1EA      EF        6277          DB      239T     ; x=234;=4.588v
 F1EB      F0        6278          DB      240T     ; x=235;=4.608v
 F1EC      F1        6279          DB      241T     ; x=236;=4.627v
 F1ED      F2        6280          DB      242T     ; x=237;=4.647v
 F1EE      F3        6281          DB      243T     ; x=238;=4.667v
 F1EF      F4        6282          DB      244T     ; x=239;=4.686v
 F1F0      F5        6283          DB      245T     ; x=240;=4.706v
 F1F1      F6        6284          DB      246T     ; x=241;=4.725v
 F1F2      F7        6285          DB      247T     ; x=242;=4.745v
 F1F3      F8        6286          DB      248T     ; x=243;=4.765v
 F1F4      F9        6287          DB      249T     ; x=244;=4.784v
 F1F5      FA        6288          DB      250T     ; x=245;=4.804v
 F1F6      FB        6289          DB      251T     ; x=246;=4.824v
 F1F7      FC        6290          DB      252T     ; x=247;=4.843v
 F1F8      FD        6291          DB      253T     ; x=248;=4.863v
 F1F9      FE        6292          DB      254T     ; x=249;=4.882v
 F1FA      FF        6293          DB      255T     ; x=250;=4.902v
 F1FB      FF        6294          DB      255T     ; x=251;=4.922v
 F1FC      FF        6295          DB      255T     ; x=252;=4.941v
 F1FD      FF        6296          DB      255T     ; x=253;=4.961v
 F1FE      FF        6297          DB      255T     ; x=254;=4.980v
 F1FF      64        6298          DB      100T     ; x=255;=5.000v;sensor failure
                     6299                                        ; Pressure ADC Raw Reading to Pressure in KPA
                     6300  
 F200                6301       include "thermfactor.inc"        ; Converts Coolant Temperature ADC Reading and Manifold
                     6302  ; Generated using EasyTherm4.exe


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 49
MC68HC908GP32 User Bootloader


                     6303  ;
                     6304  ; Ford ECT
                     6305  ;
                     6306  ; ***** CAUTION - NON STD BIAS RESISTOR REQUIRED *****
                     6307  ; File generated for use with 22000 ohm resistor at R7
                     6308  ;
                     6309  ; Steinhart-Hart coefficients:  A= 9.34735E-04   B=2.2114E-04   C= 1.273387E-07
                     6310  ;
                     6311  ; Input Data:        Temp, degF      Resistance
                     6312  ;                50             58750
                     6313  ;               104             16150
                     6314  ;               212              2070
                     6315  ;
                     6316  
                     6317  THERMFACTOR:
                     6318                       ;    ADC  Temp, degF
 F200      D2        6319       DB      210T    ;     0    Sensor Failure - use 170 degF as default
 F201      FF        6320       DB      255T    ;     1    472.13
 F202      FF        6321       DB      255T    ;     2    400.72
 F203      FF        6322       DB      255T    ;     3    363.34
 F204      FF        6323       DB      255T    ;     4    338.48
 F205      FF        6324       DB      255T    ;     5    320.04
 F206      FF        6325       DB      255T    ;     6    305.49
 F207      FF        6326       DB      255T    ;     7    293.51
 F208      FF        6327       DB      255T    ;     8    283.36
 F209      FF        6328       DB      255T    ;     9    274.58
 F20A      FF        6329       DB      255T    ;    10    266.84
 F20B      FF        6330       DB      255T    ;    11    259.94
 F20C      FF        6331       DB      255T    ;    12    253.72
 F20D      FF        6332       DB      255T    ;    13    248.06
 F20E      FF        6333       DB      255T    ;    14    242.86
 F20F      FF        6334       DB      255T    ;    15    238.06
 F210      FF        6335       DB      255T    ;    16    233.61
 F211      FF        6336       DB      255T    ;    17    229.45
 F212      FF        6337       DB      255T    ;    18    225.56
 F213      FF        6338       DB      255T    ;    19    221.89
 F214      FF        6339       DB      255T    ;    20    218.43
 F215      FF        6340       DB      255T    ;    21    215.16
 F216      FC        6341       DB      252T    ;    22    212.05
 F217      F9        6342       DB      249T    ;    23    209.09
 F218      F6        6343       DB      246T    ;    24    206.26
 F219      F4        6344       DB      244T    ;    25    203.56
 F21A      F1        6345       DB      241T    ;    26    200.96
 F21B      EE        6346       DB      238T    ;    27    198.48
 F21C      EC        6347       DB      236T    ;    28    196.08
 F21D      EA        6348       DB      234T    ;    29    193.78
 F21E      E8        6349       DB      232T    ;    30    191.56
 F21F      E5        6350       DB      229T    ;    31    189.41
 F220      E3        6351       DB      227T    ;    32    187.33
 F221      E1        6352       DB      225T    ;    33    185.32
 F222      DF        6353       DB      223T    ;    34    183.38
 F223      DD        6354       DB      221T    ;    35    181.48
 F224      DC        6355       DB      220T    ;    36    179.65
 F225      DA        6356       DB      218T    ;    37    177.86
 F226      D8        6357       DB      216T    ;    38    176.12
 F227      D6        6358       DB      214T    ;    39    174.43
 F228      D5        6359       DB      213T    ;    40    172.78
 F229      D3        6360       DB      211T    ;    41    171.17
 F22A      D2        6361       DB      210T    ;    42    169.60
 F22B      D0        6362       DB      208T    ;    43    168.06
 F22C      CF        6363       DB      207T    ;    44    166.56
 F22D      CD        6364       DB      205T    ;    45    165.09
 F22E      CC        6365       DB      204T    ;    46    163.66
 F22F      CA        6366       DB      202T    ;    47    162.25
 F230      C9        6367       DB      201T    ;    48    160.87
 F231      C8        6368       DB      200T    ;    49    159.52
 F232      C6        6369       DB      198T    ;    50    158.19
 F233      C5        6370       DB      197T    ;    51    156.89
 F234      C4        6371       DB      196T    ;    52    155.61
 F235      C2        6372       DB      194T    ;    53    154.35
 F236      C1        6373       DB      193T    ;    54    153.12
 F237      C0        6374       DB      192T    ;    55    151.91
 F238      BF        6375       DB      191T    ;    56    150.71
 F239      BE        6376       DB      190T    ;    57    149.54
 F23A      BC        6377       DB      188T    ;    58    148.38
 F23B      BB        6378       DB      187T    ;    59    147.24
 F23C      BA        6379       DB      186T    ;    60    146.12
 F23D      B9        6380       DB      185T    ;    61    145.02
 F23E      B8        6381       DB      184T    ;    62    143.93
 F23F      B7        6382       DB      183T    ;    63    142.85
 F240      B6        6383       DB      182T    ;    64    141.79
 F241      B5        6384       DB      181T    ;    65    140.75
 F242      B4        6385       DB      180T    ;    66    139.72
 F243      B3        6386       DB      179T    ;    67    138.70
 F244      B2        6387       DB      178T    ;    68    137.69
 F245      B1        6388       DB      177T    ;    69    136.70
 F246      B0        6389       DB      176T    ;    70    135.71
 F247      AF        6390       DB      175T    ;    71    134.74
 F248      AE        6391       DB      174T    ;    72    133.78
 F249      AD        6392       DB      173T    ;    73    132.83
 F24A      AC        6393       DB      172T    ;    74    131.89
 F24B      AB        6394       DB      171T    ;    75    130.97
 F24C      AA        6395       DB      170T    ;    76    130.05
 F24D      A9        6396       DB      169T    ;    77    129.14
 F24E      A8        6397       DB      168T    ;    78    128.23
 F24F      A7        6398       DB      167T    ;    79    127.34
 F250      A6        6399       DB      166T    ;    80    126.46
 F251      A6        6400       DB      166T    ;    81    125.58
 F252      A5        6401       DB      165T    ;    82    124.71
 F253      A4        6402       DB      164T    ;    83    123.85
 F254      A3        6403       DB      163T    ;    84    123.00
 F255      A2        6404       DB      162T    ;    85    122.16
 F256      A1        6405       DB      161T    ;    86    121.32
 F257      A0        6406       DB      160T    ;    87    120.49
 F258      A0        6407       DB      160T    ;    88    119.66
 F259      9F        6408       DB      159T    ;    89    118.84
 F25A      9E        6409       DB      158T    ;    90    118.03
 F25B      9D        6410       DB      157T    ;    91    117.22
 F25C      9C        6411       DB      156T    ;    92    116.42
 F25D      9C        6412       DB      156T    ;    93    115.63
 F25E      9B        6413       DB      155T    ;    94    114.84
 F25F      9A        6414       DB      154T    ;    95    114.05
 F260      99        6415       DB      153T    ;    96    113.27
 F261      98        6416       DB      152T    ;    97    112.50
 F262      98        6417       DB      152T    ;    98    111.73
 F263      97        6418       DB      151T    ;    99    110.97
 F264      96        6419       DB      150T    ;   100    110.21
 F265      95        6420       DB      149T    ;   101    109.45
 F266      95        6421       DB      149T    ;   102    108.70
 F267      94        6422       DB      148T    ;   103    107.95
 F268      93        6423       DB      147T    ;   104    107.21
 F269      92        6424       DB      146T    ;   105    106.47
 F26A      92        6425       DB      146T    ;   106    105.73
 F26B      91        6426       DB      145T    ;   107    105.00
 F26C      90        6427       DB      144T    ;   108    104.27
 F26D      90        6428       DB      144T    ;   109    103.54
 F26E      8F        6429       DB      143T    ;   110    102.82
 F26F      8E        6430       DB      142T    ;   111    102.10
 F270      8D        6431       DB      141T    ;   112    101.39
 F271      8D        6432       DB      141T    ;   113    100.67
 F272      8C        6433       DB      140T    ;   114     99.96
 F273      8B        6434       DB      139T    ;   115     99.26
 F274      8B        6435       DB      139T    ;   116     98.55
 F275      8A        6436       DB      138T    ;   117     97.85
 F276      89        6437       DB      137T    ;   118     97.15
 F277      88        6438       DB      136T    ;   119     96.45


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 50
MC68HC908GP32 User Bootloader


 F278      88        6439       DB      136T    ;   120     95.75
 F279      87        6440       DB      135T    ;   121     95.06
 F27A      86        6441       DB      134T    ;   122     94.37
 F27B      86        6442       DB      134T    ;   123     93.68
 F27C      85        6443       DB      133T    ;   124     92.99
 F27D      84        6444       DB      132T    ;   125     92.31
 F27E      84        6445       DB      132T    ;   126     91.62
 F27F      83        6446       DB      131T    ;   127     90.94
 F280      82        6447       DB      130T    ;   128     90.26
 F281      82        6448       DB      130T    ;   129     89.58
 F282      81        6449       DB      129T    ;   130     88.90
 F283      80        6450       DB      128T    ;   131     88.22
 F284      80        6451       DB      128T    ;   132     87.54
 F285      7F        6452       DB      127T    ;   133     86.87
 F286      7E        6453       DB      126T    ;   134     86.19
 F287      7E        6454       DB      126T    ;   135     85.52
 F288      7D        6455       DB      125T    ;   136     84.85
 F289      7C        6456       DB      124T    ;   137     84.17
 F28A      7C        6457       DB      124T    ;   138     83.50
 F28B      7B        6458       DB      123T    ;   139     82.83
 F28C      7A        6459       DB      122T    ;   140     82.16
 F28D      79        6460       DB      121T    ;   141     81.49
 F28E      79        6461       DB      121T    ;   142     80.82
 F28F      78        6462       DB      120T    ;   143     80.15
 F290      77        6463       DB      119T    ;   144     79.48
 F291      77        6464       DB      119T    ;   145     78.81
 F292      76        6465       DB      118T    ;   146     78.14
 F293      75        6466       DB      117T    ;   147     77.47
 F294      75        6467       DB      117T    ;   148     76.80
 F295      74        6468       DB      116T    ;   149     76.13
 F296      73        6469       DB      115T    ;   150     75.46
 F297      73        6470       DB      115T    ;   151     74.79
 F298      72        6471       DB      114T    ;   152     74.12
 F299      71        6472       DB      113T    ;   153     73.44
 F29A      71        6473       DB      113T    ;   154     72.77
 F29B      70        6474       DB      112T    ;   155     72.10
 F29C      6F        6475       DB      111T    ;   156     71.42
 F29D      6F        6476       DB      111T    ;   157     70.74
 F29E      6E        6477       DB      110T    ;   158     70.07
 F29F      6D        6478       DB      109T    ;   159     69.39
 F2A0      6D        6479       DB      109T    ;   160     68.71
 F2A1      6C        6480       DB      108T    ;   161     68.03
 F2A2      6B        6481       DB      107T    ;   162     67.34
 F2A3      6B        6482       DB      107T    ;   163     66.66
 F2A4      6A        6483       DB      106T    ;   164     65.97
 F2A5      69        6484       DB      105T    ;   165     65.28
 F2A6      69        6485       DB      105T    ;   166     64.59
 F2A7      68        6486       DB      104T    ;   167     63.90
 F2A8      67        6487       DB      103T    ;   168     63.21
 F2A9      67        6488       DB      103T    ;   169     62.51
 F2AA      66        6489       DB      102T    ;   170     61.81
 F2AB      65        6490       DB      101T    ;   171     61.11
 F2AC      64        6491       DB      100T    ;   172     60.41
 F2AD      64        6492       DB      100T    ;   173     59.70
 F2AE      63        6493       DB       99T    ;   174     58.99
 F2AF      62        6494       DB       98T    ;   175     58.28
 F2B0      62        6495       DB       98T    ;   176     57.56
 F2B1      61        6496       DB       97T    ;   177     56.84
 F2B2      60        6497       DB       96T    ;   178     56.12
 F2B3      5F        6498       DB       95T    ;   179     55.39
 F2B4      5F        6499       DB       95T    ;   180     54.66
 F2B5      5E        6500       DB       94T    ;   181     53.93
 F2B6      5D        6501       DB       93T    ;   182     53.19
 F2B7      5C        6502       DB       92T    ;   183     52.45
 F2B8      5C        6503       DB       92T    ;   184     51.70
 F2B9      5B        6504       DB       91T    ;   185     50.95
 F2BA      5A        6505       DB       90T    ;   186     50.19
 F2BB      59        6506       DB       89T    ;   187     49.43
 F2BC      59        6507       DB       89T    ;   188     48.67
 F2BD      58        6508       DB       88T    ;   189     47.89
 F2BE      57        6509       DB       87T    ;   190     47.12
 F2BF      56        6510       DB       86T    ;   191     46.33
 F2C0      56        6511       DB       86T    ;   192     45.54
 F2C1      55        6512       DB       85T    ;   193     44.75
 F2C2      54        6513       DB       84T    ;   194     43.95
 F2C3      53        6514       DB       83T    ;   195     43.14
 F2C4      52        6515       DB       82T    ;   196     42.32
 F2C5      51        6516       DB       81T    ;   197     41.50
 F2C6      51        6517       DB       81T    ;   198     40.67
 F2C7      50        6518       DB       80T    ;   199     39.83
 F2C8      4F        6519       DB       79T    ;   200     38.98
 F2C9      4E        6520       DB       78T    ;   201     38.13
 F2CA      4D        6521       DB       77T    ;   202     37.26
 F2CB      4C        6522       DB       76T    ;   203     36.39
 F2CC      4C        6523       DB       76T    ;   204     35.50
 F2CD      4B        6524       DB       75T    ;   205     34.61
 F2CE      4A        6525       DB       74T    ;   206     33.70
 F2CF      49        6526       DB       73T    ;   207     32.79
 F2D0      48        6527       DB       72T    ;   208     31.86
 F2D1      47        6528       DB       71T    ;   209     30.92
 F2D2      46        6529       DB       70T    ;   210     29.97
 F2D3      45        6530       DB       69T    ;   211     29.00
 F2D4      44        6531       DB       68T    ;   212     28.02
 F2D5      43        6532       DB       67T    ;   213     27.02
 F2D6      42        6533       DB       66T    ;   214     26.01
 F2D7      41        6534       DB       65T    ;   215     24.99
 F2D8      40        6535       DB       64T    ;   216     23.94
 F2D9      3F        6536       DB       63T    ;   217     22.88
 F2DA      3E        6537       DB       62T    ;   218     21.80
 F2DB      3D        6538       DB       61T    ;   219     20.70
 F2DC      3C        6539       DB       60T    ;   220     19.58
 F2DD      3A        6540       DB       58T    ;   221     18.44
 F2DE      39        6541       DB       57T    ;   222     17.27
 F2DF      38        6542       DB       56T    ;   223     16.08
 F2E0      37        6543       DB       55T    ;   224     14.86
 F2E1      36        6544       DB       54T    ;   225     13.62
 F2E2      34        6545       DB       52T    ;   226     12.34
 F2E3      33        6546       DB       51T    ;   227     11.03
 F2E4      32        6547       DB       50T    ;   228      9.69
 F2E5      30        6548       DB       48T    ;   229      8.31
 F2E6      2F        6549       DB       47T    ;   230      6.90
 F2E7      2D        6550       DB       45T    ;   231      5.44
 F2E8      2C        6551       DB       44T    ;   232      3.93
 F2E9      2A        6552       DB       42T    ;   233      2.38
 F2EA      29        6553       DB       41T    ;   234       .77
 F2EB      27        6554       DB       39T    ;   235      -.90
 F2EC      25        6555       DB       37T    ;   236     -2.63
 F2ED      24        6556       DB       36T    ;   237     -4.43
 F2EE      22        6557       DB       34T    ;   238     -6.31
 F2EF      20        6558       DB       32T    ;   239     -8.28
 F2F0      1E        6559       DB       30T    ;   240    -10.34
 F2F1      1B        6560       DB       27T    ;   241    -12.51
 F2F2      19        6561       DB       25T    ;   242    -14.81
 F2F3      17        6562       DB       23T    ;   243    -17.24
 F2F4      14        6563       DB       20T    ;   244    -19.84
 F2F5      11        6564       DB       17T    ;   245    -22.62
 F2F6      0E        6565       DB       14T    ;   246    -25.63
 F2F7      0B        6566       DB       11T    ;   247    -28.91
 F2F8      07        6567       DB        7T    ;   248    -32.51
 F2F9      03        6568       DB        3T    ;   249    -36.53
 F2FA      00        6569       DB        0T    ;   250    -41.08
 F2FB      00        6570       DB        0T    ;   251    -46.35
 F2FC      00        6571       DB        0T    ;   252    -52.64
 F2FD      00        6572       DB        0T    ;   253    -60.51
 F2FE      00        6573       DB        0T    ;   254    -71.20
 F2FF      D2        6574       DB      210T    ;   255    Sensor Failure - use 170 degF as default


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 51
MC68HC908GP32 User Bootloader


                     6575                                        ; Air TemperatureRaw Reading to temp in degrees F +40
                     6576  
 F300                6577       include "airdenfactor.inc"       ; Converts Manifold Air Temp ADC to air density
                     6578  ; Generated using EasyTherm4.exe,
                     6579  ;
                     6580  ; Ford IAT
                     6581  ;
                     6582  ; ***** CAUTION - NON STD BIAS RESISTOR REQUIRED *****
                     6583  ; File generated for use with 22000 ohm resistor at R4
                     6584  ;
                     6585  ; Steinhart-Hart coefficients:  A= 9.34735E-04   B=2.2114E-04   C= 1.273387E-07
                     6586  ;
                     6587  ; Input Data:        Temp, degF      Resistance
                     6588  ;                50             58750
                     6589  ;               104             16150
                     6590  ;               212              2070
                     6591  ;
                     6592  
                     6593  AIRDENFACTOR:
                     6594                       ;    ADC  Temp, degF
 F300      64        6595       DB      100T    ;     0    Sensor Failure - 100% applied
 F301      39        6596       DB       57T    ;     1    471.69
 F302      3D        6597       DB       61T    ;     2    400.35
 F303      40        6598       DB       64T    ;     3    362.99
 F304      42        6599       DB       66T    ;     4    338.15
 F305      44        6600       DB       68T    ;     5    319.73
 F306      45        6601       DB       69T    ;     6    305.18
 F307      46        6602       DB       70T    ;     7    293.21
 F308      47        6603       DB       71T    ;     8    283.07
 F309      48        6604       DB       72T    ;     9    274.29
 F30A      49        6605       DB       73T    ;    10    266.56
 F30B      49        6606       DB       73T    ;    11    259.66
 F30C      4A        6607       DB       74T    ;    12    253.44
 F30D      4B        6608       DB       75T    ;    13    247.78
 F30E      4B        6609       DB       75T    ;    14    242.59
 F30F      4C        6610       DB       76T    ;    15    237.79
 F310      4C        6611       DB       76T    ;    16    233.34
 F311      4D        6612       DB       77T    ;    17    229.19
 F312      4D        6613       DB       77T    ;    18    225.29
 F313      4E        6614       DB       78T    ;    19    221.63
 F314      4E        6615       DB       78T    ;    20    218.17
 F315      4E        6616       DB       78T    ;    21    214.90
 F316      4F        6617       DB       79T    ;    22    211.79
 F317      4F        6618       DB       79T    ;    23    208.83
 F318      4F        6619       DB       79T    ;    24    206.00
 F319      50        6620       DB       80T    ;    25    203.30
 F31A      50        6621       DB       80T    ;    26    200.71
 F31B      50        6622       DB       80T    ;    27    198.22
 F31C      51        6623       DB       81T    ;    28    195.83
 F31D      51        6624       DB       81T    ;    29    193.52
 F31E      51        6625       DB       81T    ;    30    191.30
 F31F      51        6626       DB       81T    ;    31    189.16
 F320      52        6627       DB       82T    ;    32    187.08
 F321      52        6628       DB       82T    ;    33    185.07
 F322      52        6629       DB       82T    ;    34    183.12
 F323      52        6630       DB       82T    ;    35    181.23
 F324      53        6631       DB       83T    ;    36    179.39
 F325      53        6632       DB       83T    ;    37    177.61
 F326      53        6633       DB       83T    ;    38    175.87
 F327      53        6634       DB       83T    ;    39    174.17
 F328      54        6635       DB       84T    ;    40    172.52
 F329      54        6636       DB       84T    ;    41    170.91
 F32A      54        6637       DB       84T    ;    42    169.34
 F32B      54        6638       DB       84T    ;    43    167.81
 F32C      54        6639       DB       84T    ;    44    166.31
 F32D      55        6640       DB       85T    ;    45    164.84
 F32E      55        6641       DB       85T    ;    46    163.40
 F32F      55        6642       DB       85T    ;    47    161.99
 F330      55        6643       DB       85T    ;    48    160.61
 F331      55        6644       DB       85T    ;    49    159.26
 F332      56        6645       DB       86T    ;    50    157.93
 F333      56        6646       DB       86T    ;    51    156.63
 F334      56        6647       DB       86T    ;    52    155.35
 F335      56        6648       DB       86T    ;    53    154.10
 F336      56        6649       DB       86T    ;    54    152.86
 F337      56        6650       DB       86T    ;    55    151.65
 F338      57        6651       DB       87T    ;    56    150.45
 F339      57        6652       DB       87T    ;    57    149.28
 F33A      57        6653       DB       87T    ;    58    148.12
 F33B      57        6654       DB       87T    ;    59    146.98
 F33C      57        6655       DB       87T    ;    60    145.86
 F33D      57        6656       DB       87T    ;    61    144.76
 F33E      58        6657       DB       88T    ;    62    143.67
 F33F      58        6658       DB       88T    ;    63    142.59
 F340      58        6659       DB       88T    ;    64    141.53
 F341      58        6660       DB       88T    ;    65    140.48
 F342      58        6661       DB       88T    ;    66    139.45
 F343      58        6662       DB       88T    ;    67    138.43
 F344      58        6663       DB       88T    ;    68    137.42
 F345      59        6664       DB       89T    ;    69    136.43
 F346      59        6665       DB       89T    ;    70    135.45
 F347      59        6666       DB       89T    ;    71    134.47
 F348      59        6667       DB       89T    ;    72    133.51
 F349      59        6668       DB       89T    ;    73    132.56
 F34A      59        6669       DB       89T    ;    74    131.62
 F34B      59        6670       DB       89T    ;    75    130.69
 F34C      5A        6671       DB       90T    ;    76    129.77
 F34D      5A        6672       DB       90T    ;    77    128.86
 F34E      5A        6673       DB       90T    ;    78    127.96
 F34F      5A        6674       DB       90T    ;    79    127.07
 F350      5A        6675       DB       90T    ;    80    126.18
 F351      5A        6676       DB       90T    ;    81    125.31
 F352      5A        6677       DB       90T    ;    82    124.44
 F353      5B        6678       DB       91T    ;    83    123.58
 F354      5B        6679       DB       91T    ;    84    122.72
 F355      5B        6680       DB       91T    ;    85    121.88
 F356      5B        6681       DB       91T    ;    86    121.04
 F357      5B        6682       DB       91T    ;    87    120.20
 F358      5B        6683       DB       91T    ;    88    119.38
 F359      5B        6684       DB       91T    ;    89    118.56
 F35A      5B        6685       DB       91T    ;    90    117.74
 F35B      5C        6686       DB       92T    ;    91    116.94
 F35C      5C        6687       DB       92T    ;    92    116.13
 F35D      5C        6688       DB       92T    ;    93    115.34
 F35E      5C        6689       DB       92T    ;    94    114.55
 F35F      5C        6690       DB       92T    ;    95    113.76
 F360      5C        6691       DB       92T    ;    96    112.98
 F361      5C        6692       DB       92T    ;    97    112.21
 F362      5C        6693       DB       92T    ;    98    111.44
 F363      5D        6694       DB       93T    ;    99    110.67
 F364      5D        6695       DB       93T    ;   100    109.91
 F365      5D        6696       DB       93T    ;   101    109.15
 F366      5D        6697       DB       93T    ;   102    108.40
 F367      5D        6698       DB       93T    ;   103    107.65
 F368      5D        6699       DB       93T    ;   104    106.91
 F369      5D        6700       DB       93T    ;   105    106.16
 F36A      5D        6701       DB       93T    ;   106    105.43
 F36B      5E        6702       DB       94T    ;   107    104.69
 F36C      5E        6703       DB       94T    ;   108    103.96
 F36D      5E        6704       DB       94T    ;   109    103.24
 F36E      5E        6705       DB       94T    ;   110    102.51
 F36F      5E        6706       DB       94T    ;   111    101.79
 F370      5E        6707       DB       94T    ;   112    101.07
 F371      5E        6708       DB       94T    ;   113    100.36
 F372      5E        6709       DB       94T    ;   114     99.65
 F373      5F        6710       DB       95T    ;   115     98.94


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 52
MC68HC908GP32 User Bootloader


 F374      5F        6711       DB       95T    ;   116     98.23
 F375      5F        6712       DB       95T    ;   117     97.53
 F376      5F        6713       DB       95T    ;   118     96.83
 F377      5F        6714       DB       95T    ;   119     96.13
 F378      5F        6715       DB       95T    ;   120     95.43
 F379      5F        6716       DB       95T    ;   121     94.73
 F37A      5F        6717       DB       95T    ;   122     94.04
 F37B      60        6718       DB       96T    ;   123     93.35
 F37C      60        6719       DB       96T    ;   124     92.66
 F37D      60        6720       DB       96T    ;   125     91.97
 F37E      60        6721       DB       96T    ;   126     91.28
 F37F      60        6722       DB       96T    ;   127     90.60
 F380      60        6723       DB       96T    ;   128     89.92
 F381      60        6724       DB       96T    ;   129     89.23
 F382      60        6725       DB       96T    ;   130     88.55
 F383      60        6726       DB       96T    ;   131     87.87
 F384      61        6727       DB       97T    ;   132     87.19
 F385      61        6728       DB       97T    ;   133     86.52
 F386      61        6729       DB       97T    ;   134     85.84
 F387      61        6730       DB       97T    ;   135     85.16
 F388      61        6731       DB       97T    ;   136     84.49
 F389      61        6732       DB       97T    ;   137     83.81
 F38A      61        6733       DB       97T    ;   138     83.14
 F38B      61        6734       DB       97T    ;   139     82.47
 F38C      62        6735       DB       98T    ;   140     81.79
 F38D      62        6736       DB       98T    ;   141     81.12
 F38E      62        6737       DB       98T    ;   142     80.45
 F38F      62        6738       DB       98T    ;   143     79.78
 F390      62        6739       DB       98T    ;   144     79.10
 F391      62        6740       DB       98T    ;   145     78.43
 F392      62        6741       DB       98T    ;   146     77.76
 F393      62        6742       DB       98T    ;   147     77.09
 F394      63        6743       DB       99T    ;   148     76.41
 F395      63        6744       DB       99T    ;   149     75.74
 F396      63        6745       DB       99T    ;   150     75.07
 F397      63        6746       DB       99T    ;   151     74.39
 F398      63        6747       DB       99T    ;   152     73.72
 F399      63        6748       DB       99T    ;   153     73.04
 F39A      63        6749       DB       99T    ;   154     72.36
 F39B      63        6750       DB       99T    ;   155     71.69
 F39C      64        6751       DB      100T    ;   156     71.01
 F39D      64        6752       DB      100T    ;   157     70.33
 F39E      64        6753       DB      100T    ;   158     69.65
 F39F      64        6754       DB      100T    ;   159     68.96
 F3A0      64        6755       DB      100T    ;   160     68.28
 F3A1      64        6756       DB      100T    ;   161     67.60
 F3A2      64        6757       DB      100T    ;   162     66.91
 F3A3      64        6758       DB      100T    ;   163     66.22
 F3A4      65        6759       DB      101T    ;   164     65.53
 F3A5      65        6760       DB      101T    ;   165     64.84
 F3A6      65        6761       DB      101T    ;   166     64.14
 F3A7      65        6762       DB      101T    ;   167     63.45
 F3A8      65        6763       DB      101T    ;   168     62.75
 F3A9      65        6764       DB      101T    ;   169     62.05
 F3AA      65        6765       DB      101T    ;   170     61.34
 F3AB      66        6766       DB      102T    ;   171     60.64
 F3AC      66        6767       DB      102T    ;   172     59.93
 F3AD      66        6768       DB      102T    ;   173     59.22
 F3AE      66        6769       DB      102T    ;   174     58.50
 F3AF      66        6770       DB      102T    ;   175     57.79
 F3B0      66        6771       DB      102T    ;   176     57.06
 F3B1      66        6772       DB      102T    ;   177     56.34
 F3B2      67        6773       DB      103T    ;   178     55.61
 F3B3      67        6774       DB      103T    ;   179     54.88
 F3B4      67        6775       DB      103T    ;   180     54.14
 F3B5      67        6776       DB      103T    ;   181     53.40
 F3B6      67        6777       DB      103T    ;   182     52.66
 F3B7      67        6778       DB      103T    ;   183     51.91
 F3B8      67        6779       DB      103T    ;   184     51.16
 F3B9      68        6780       DB      104T    ;   185     50.40
 F3BA      68        6781       DB      104T    ;   186     49.64
 F3BB      68        6782       DB      104T    ;   187     48.87
 F3BC      68        6783       DB      104T    ;   188     48.10
 F3BD      68        6784       DB      104T    ;   189     47.32
 F3BE      68        6785       DB      104T    ;   190     46.53
 F3BF      69        6786       DB      105T    ;   191     45.74
 F3C0      69        6787       DB      105T    ;   192     44.95
 F3C1      69        6788       DB      105T    ;   193     44.14
 F3C2      69        6789       DB      105T    ;   194     43.33
 F3C3      69        6790       DB      105T    ;   195     42.51
 F3C4      69        6791       DB      105T    ;   196     41.69
 F3C5      6A        6792       DB      106T    ;   197     40.86
 F3C6      6A        6793       DB      106T    ;   198     40.02
 F3C7      6A        6794       DB      106T    ;   199     39.17
 F3C8      6A        6795       DB      106T    ;   200     38.31
 F3C9      6A        6796       DB      106T    ;   201     37.44
 F3CA      6A        6797       DB      106T    ;   202     36.57
 F3CB      6B        6798       DB      107T    ;   203     35.68
 F3CC      6B        6799       DB      107T    ;   204     34.79
 F3CD      6B        6800       DB      107T    ;   205     33.88
 F3CE      6B        6801       DB      107T    ;   206     32.96
 F3CF      6B        6802       DB      107T    ;   207     32.03
 F3D0      6C        6803       DB      108T    ;   208     31.09
 F3D1      6C        6804       DB      108T    ;   209     30.14
 F3D2      6C        6805       DB      108T    ;   210     29.17
 F3D3      6C        6806       DB      108T    ;   211     28.19
 F3D4      6C        6807       DB      108T    ;   212     27.19
 F3D5      6D        6808       DB      109T    ;   213     26.18
 F3D6      6D        6809       DB      109T    ;   214     25.15
 F3D7      6D        6810       DB      109T    ;   215     24.11
 F3D8      6D        6811       DB      109T    ;   216     23.05
 F3D9      6E        6812       DB      110T    ;   217     21.97
 F3DA      6E        6813       DB      110T    ;   218     20.86
 F3DB      6E        6814       DB      110T    ;   219     19.74
 F3DC      6E        6815       DB      110T    ;   220     18.60
 F3DD      6F        6816       DB      111T    ;   221     17.43
 F3DE      6F        6817       DB      111T    ;   222     16.24
 F3DF      6F        6818       DB      111T    ;   223     15.02
 F3E0      70        6819       DB      112T    ;   224     13.77
 F3E1      70        6820       DB      112T    ;   225     12.49
 F3E2      70        6821       DB      112T    ;   226     11.18
 F3E3      70        6822       DB      112T    ;   227      9.84
 F3E4      71        6823       DB      113T    ;   228      8.46
 F3E5      71        6824       DB      113T    ;   229      7.04
 F3E6      72        6825       DB      114T    ;   230      5.58
 F3E7      72        6826       DB      114T    ;   231      4.07
 F3E8      72        6827       DB      114T    ;   232      2.52
 F3E9      73        6828       DB      115T    ;   233       .91
 F3EA      73        6829       DB      115T    ;   234      -.76
 F3EB      74        6830       DB      116T    ;   235     -2.49
 F3EC      74        6831       DB      116T    ;   236     -4.30
 F3ED      74        6832       DB      116T    ;   237     -6.18
 F3EE      75        6833       DB      117T    ;   238     -8.15
 F3EF      76        6834       DB      118T    ;   239    -10.21
 F3F0      76        6835       DB      118T    ;   240    -12.38
 F3F1      77        6836       DB      119T    ;   241    -14.68
 F3F2      77        6837       DB      119T    ;   242    -17.11
 F3F3      78        6838       DB      120T    ;   243    -19.71
 F3F4      79        6839       DB      121T    ;   244    -22.50
 F3F5      7A        6840       DB      122T    ;   245    -25.51
 F3F6      7B        6841       DB      123T    ;   246    -28.79
 F3F7      7C        6842       DB      124T    ;   247    -32.39
 F3F8      7D        6843       DB      125T    ;   248    -36.41
 F3F9      7E        6844       DB      126T    ;   249    -40.96
 F3FA      80        6845       DB      128T    ;   250    -46.23
 F3FB      82        6846       DB      130T    ;   251    -52.53


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 53
MC68HC908GP32 User Bootloader


 F3FC      84        6847       DB      132T    ;   252    -60.40
 F3FD      88        6848       DB      136T    ;   253    -71.10
 F3FE      8E        6849       DB      142T    ;   254    -88.38
 F3FF      64        6850       DB      100T    ;   255    Sensor Failure - 100% applied
                     6851                                        ; corrrection factor in %
                     6852  
                     6853  ;**********************************************************************************************
                     6854  ; VE table and Ranges (copied into RAM on demand for tuning. (page = 1)(all pages 168 bytes)
                     6855  ; VE values are percent, KPARANGEVE values are KPA, RPMRANGEVE values are RPM/20
                     6856  ;**********************************************************************************************
                     6857  
 E000                6858       org     $E000    ;(57,344)
                     6859  
                     6860  flash_table1:
                     6861  
                     6862  VE_f:
 E000      35353538  6863       db      53T,53T,53T,56T,58T,59T,60T,60T,61T,62T,63T,64T ; VE (0,0-11)(Bottom Row)
           3A3B3C3C 
           3D3E3F40 
 E00C      35353536  6864       db      53T,53T,53T,54T,54T,55T,56T,57T,58T,59T,60T,61T ; VE (1,0-11)
           36373839 
           3A3B3C3D 
 E018      36363637  6865       db      54T,54T,54T,55T,55T,56T,57T,58T,59T,60T,61T,62T ; VE (2,0-11)
           3738393A 
           3B3C3D3E 
 E024      36363738  6866       db      54T,54T,55T,56T,56T,56T,57T,58T,59T,60T,61T,62T ; VE (3,0-11)
           3838393A 
           3B3C3D3E 
 E030      36363738  6867       db      54T,54T,55T,56T,57T,57T,58T,59T,60T,61T,62T,63T ; VE (4,0-11)
           39393A3B 
           3C3D3E3F 
 E03C      37373839  6868       db      55T,55T,56T,57T,58T,59T,60T,61T,62T,63T,64T,65T ; VE (5,0-11)
           3A3B3C3D 
           3E3F4041 
 E048      3A3A3B3C  6869       db      58T,58T,59T,60T,61T,62T,63T,64T,65T,66T,67T,68T ; VE (6,0-11)
           3D3E3F40 
           41424344 
 E054      3C3C3D3E  6870       db      60T,60T,61T,62T,63T,64T,65T,66T,67T,68T,69T,70T ; VE (7,0-11)
           3F404142 
           43444546 
 E060      3D3D3E3F  6871       db      61T,61T,62T,63T,64T,65T,66T,67T,68T,69T,70T,71T ; VE (8,0-11)
           40414243 
           44454647 
 E06C      46464748  6872       db      70T,70T,71T,72T,73T,74T,75T,75T,76T,77T,78T,79T ; VE (9,0-11)
           494A4B4B 
           4C4D4E4F 
 E078      55555657  6873       db      85T,85T,86T,87T,88T,89T,90T,91T,91T,92T,93T,94T; VE (10,0-11)
           58595A5B 
           5B5C5D5E 
 E084      56565758  6874       db      86T,86T,87T,88T,89T,90T,91T,92T,92T,93T,94T,95T; VE (11,0-11)(Top Row)
           595A5B5C 
           5C5D5E5F 
                     6875  
                     6876  RPMRANGEVE_f:        ; RPMRANGEVE[0-11](Left to Right)
 E090      19233241  6877       db      25T,35T,50T,65T,80T,95T,110T,130T,150T,170T,190T,210T
           505F6E82 
           96AABED2 
                     6878               ; 500,700,1000,1300,1600,1900,2200,2600,3000,3400,3800,4200
                     6879  
                     6880  KPARANGEVE_f:        ; KPARANGEVE[0-b](Bottom to Top)
 E09C      1E282D32  6881       db      30T,40T,45T,50T,55T,60T,65T,70T,75T,80T,85T,100T
           373C4146 
           4B505564 
                     6882  
                     6883  flash_table1_end:
                     6884  
                     6885  ;**********************************************************************************************
                     6886  ; ST table and Ranges (copied into RAM on demand for tuning. (page = 2)(all pages 168 bytes)
                     6887  ; ST values are delay from PIP scaled to 255. MT table displays degrees advance,including
                     6888  ; the initial timing which is always 10 degrees BTDC
                     6889  ; KPARANGEST values are KPA, RPMRANGEST values are RPM/20
                     6890  ;**********************************************************************************************
                     6891  
 E100                6892       org     $E100    ;(57600)
                     6893  
                     6894  flash_table2:
                     6895  
                     6896  ST_f:
 E100      DADDD5C4  6897       db    218T,221T,213T,196T,176T,156T,147T,147T,147T,147T,147T,147T ;(0,0-11)(Bottom Row)
           B09C9393 
           93939393 
 E10C      CFCFC9B8  6898       db    207T,207T,201T,184T,167T,153T,147T,147T,147T,147T,147T,147T ;(1,0-11)
           A7999393 
           93939393 
 E118      C6C6B5A7  6899       db    198T,198T,181T,167T,156T,147T,147T,147T,147T,147T,147T,147T ;(2,0-11)
           9C939393 
           93939393 
 E124      BBBBAA9C  6900       db    187T,187T,170T,156T,147T,147T,147T,147T,147T,147T,147T,147T ;(3,0-11)
           93939393 
           93939393 
 E130      BEBEB09F  6901       db    190T,190T,176T,159T,147T,147T,147T,147T,147T,147T,147T,147T ;(4,0-11)
           93939393 
           93939393 
 E13C      C1C1BBAD  6902       db    193T,193T,187T,173T,156T,147T,147T,147T,147T,147T,147T,147T ;(5,0-11)
           9C939393 
           93939393 
 E148      C6C6BEB5  6903       db    198T,198T,190T,181T,170T,156T,153T,153T,153T,153T,153T,153T ;(6,0-11)
           AA9C9999 
           99999999 
 E154      C9C9C4BB  6904       db    201T,201T,196T,187T,179T,170T,156T,156T,156T,156T,156T,156T ;(7,0-11)
           B3AA9C9C 
           9C9C9C9C 
 E160      CFCFC9C1  6905       db    207T,207T,201T,193T,187T,181T,170T,156T,156T,156T,156T,156T ;(8,0-11)
           BBB5AA9C 
           9C9C9C9C 
 E16C      D5D5CFC6  6906       db    213T,213T,207T,198T,193T,190T,181T,170T,170T,170T,170T,170T ;(9,0-11)
           C1BEB5AA 
           AAAAAAAA 
 E178      DDDAD5CC  6907       db    221T,218T,213T,204T,196T,193T,190T,184T,181T,181T,181T,181T ;(10,0-11)
           C4C1BEB8 
           B5B5B5B5 
 E184      E0E0DDD5  6908       db    224T,224T,221T,213T,204T,201T,198T,196T,190T,187T,184T,184T ;(11,0-11)(Top Row)
           CCC9C6C4 
           BEBBB8B8 
                     6909  
                     6910  RPMRANGEST_f:        ; RPMRANGEST[0-11](Left to Right)
 E190      19233241  6911       db      25T,35T,50T,65T,80T,95T,110T,130T,150T,170T,190T,210T
           505F6E82 
           96AABED2 
                     6912               ; 500,700,1000,1300,1600,1900,2200,2600,3000,3400,3800,4200
                     6913  
                     6914  KPARANGEST_f:        ; KPARANGEST[0-b](Bottom to Top)
 E19C      1E282D32  6915       db      30T,40T,45T,50T,55T,60T,65T,70T,75T,80T,85T,100T
           373C4146 
           4B505564 
                     6916  
                     6917  flash_table2_end:
                     6918  
                     6919  ;**********************************************************************************************
                     6920  ; AFR1 table and Ranges (copied into RAM on demand for tuning. (page = 3)(all pages 168 bytes)
                     6921  ; AFR1 values are AFRx10(Used for MLV VE Analyze only)
                     6922  ; KPARANGEAFR1 values are KPA, RPMRANGEAFR1 values are RPM/20
                     6923  ;**********************************************************************************************
                     6924  
 E200                6925       org     $E200    ;(57856)
                     6926  


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 54
MC68HC908GP32 User Bootloader


                     6927  flash_table3:
                     6928  
                     6929  AFR1_f:
 E200      82828282  6930       db    130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T ;(0,0-11)(Bottom Row)
           82828282 
           82828282 
 E20C      82828282  6931       db    130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T ;(1,0-11)
           82828282 
           82828282 
 E218      82828282  6932       db    130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T ;(2,0-11)
           82828282 
           82828282 
 E224      82828282  6933       db    130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T ;(3,0-11)
           82828282 
           82828282 
 E230      82828282  6934       db    130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T ;(4,0-11)
           82828282 
           82828282 
 E23C      82828282  6935       db    130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T ;(5,0-11)
           82828282 
           82828282 
 E248      82828282  6936       db    130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T ;(6,0-11)
           82828282 
           82828282 
 E254      82828282  6937       db    130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T ;(7,0-11)
           82828282 
           82828282 
 E260      82828282  6938       db    130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T ;(8,0-11)
           82828282 
           82828282 
 E26C      82828282  6939       db    130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T ;(9,0-11)
           82828282 
           82828282 
 E278      82828282  6940       db    130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T ;(10,0-11)
           82828282 
           82828282 
 E284      82828282  6941       db    130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T ;(11,0-11)(Top Row)
           82828282 
           82828282 
                     6942  
                     6943  RPMRANGEAFR1_f:        ; RPMRANGEAFR1[0-11](Left to Right)
 E290      19233241  6944       db      25T,35T,50T,65T,80T,95T,110T,130T,150T,170T,190T,210T
           505F6E82 
           96AABED2 
                     6945               ; 500,700,1000,1300,1600,1900,2200,2600,3000,3400,3800,4200
                     6946  
                     6947  KPARANGEAFR1_f:        ; KPARANGEAFR1[0-b](Bottom to Top)
 E29C      1E282D32  6948       db      30T,40T,45T,50T,55T,60T,65T,70T,75T,80T,85T,100T
           373C4146 
           4B505564 
                     6949  
                     6950  flash_table3_end:
                     6951  
                     6952  ;**********************************************************************************************
                     6953  ; AFR2 table and Ranges (copied into RAM on demand for tuning. (page = 4)(all pages 168 bytes)
                     6954  ; AFR2 values are AFRx10(Used for MLV VE Analyze only)
                     6955  ; KPARANGEAFR2 values are KPA, RPMRANGEAFR2 values are RPM/20
                     6956  ;**********************************************************************************************
                     6957  
 E300                6958       org     $E300    ;(58112)
                     6959  
                     6960  flash_table4:
                     6961  
                     6962  AFR2_f:
 E300      75757582  6963       db    117T,117T,117T,130T,147T,147T,147T,147T,147T,147T,147T,147T ;(0,0-11)(Bottom Row)
           93939393 
           93939393 
 E30C      75757593  6964       db    117T,117T,117T,147T,165T,165T,165T,165T,165T,165T,165T,165T ;(1,0-11)
           A5A5A5A5 
           A5A5A5A5 
 E318      828293A5  6965       db    130T,130T,147T,165T,165T,165T,165T,165T,165T,165T,165T,165T ;(2,0-11)
           A5A5A5A5 
           A5A5A5A5 
 E324      828293A5  6966       db    130T,130T,147T,165T,165T,165T,165T,165T,165T,165T,165T,165T ;(3,0-11)
           A5A5A5A5 
           A5A5A5A5 
 E330      828293A5  6967       db    130T,130T,147T,165T,165T,165T,165T,165T,165T,165T,165T,165T ;(4,0-11)
           A5A5A5A5 
           A5A5A5A5 
 E33C      828293A5  6968       db    130T,130T,147T,165T,165T,165T,165T,165T,165T,165T,165T,165T ;(5,0-11)
           A5A5A5A5 
           A5A5A5A5 
 E348      828293A5  6969       db    130T,130T,147T,165T,165T,165T,165T,165T,165T,165T,165T,165T ;(6,0-11)
           A5A5A5A5 
           A5A5A5A5 
 E354      828293A5  6970       db    130T,130T,147T,165T,165T,165T,165T,165T,165T,165T,165T,165T ;(7,0-11)
           A5A5A5A5 
           A5A5A5A5 
 E360      828293A5  6971       db    130T,130T,147T,165T,165T,165T,165T,165T,165T,165T,165T,165T ;(8,0-11)
           A5A5A5A5 
           A5A5A5A5 
 E36C      82828282  6972       db    130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T,130T ;(9,0-11)
           82828282 
           82828282 
 E378      807F7E7D  6973       db    128T,127T,126T,125T,124T,123T,122T,121T,120T,119T,118T,117T ;(10,0-11)
           7C7B7A79 
           78777675 
 E384      7E7D7C7B  6974       db    126T,125T,124T,123T,122T,121T,120T,119T,118T,117T,116T,115T ;(11,0-11)(Top Row)
           7A797877 
           76757473 
                     6975  
                     6976  RPMRANGEAFR2_f:        ; RPMRANGEAFR2[0-11](Left to Right)
 E390      19233241  6977       db      25T,35T,50T,65T,80T,95T,110T,130T,150T,170T,190T,210T
           505F6E82 
           96AABED2 
                     6978               ; 500,700,1000,1300,1600,1900,2200,2600,3000,3400,3800,4200
                     6979  
                     6980  KPARANGEAFR2_f:        ; KPARANGEAFR2[0-b](Bottom to Top)
 E39C      1E282D32  6981       db      30T,40T,45T,50T,55T,60T,65T,70T,75T,80T,85T,100T
           373C4146 
           4B505564 
                     6982  
                     6983  flash_table4_end:
                     6984  
                     6985  ;**********************************************************************************************
                     6986  ; Configuration constants and tables (copied into RAM on demand for tuning. page = 5)
                     6987  ; (all pages 168 bytes)
                     6988  ;**********************************************************************************************
                     6989  
 E400                6990       org     $E400    ;(58368)
                     6991  
                     6992  flash_table5:
                     6993  
 E400      00        6994  WWURANGE:   db      0T       ; WWURANGE[0] -40 F
 E401      14        6995              db      20T      ; WWURANGE[1] -20 F
 E402      28        6996              db      40T      ; WWURANGE[2]   0 F
 E403      3C        6997              db      60T      ; WWURANGE[3] +20 F
 E404      50        6998              db      80T      ; WWURANGE[4] +40 F
 E405      64        6999              db      100T     ; WWURANGE[5] +60 F
 E406      78        7000              db      120T     ; WWURANGE[6] +80 F
 E407      8C        7001              db      140T     ; WWURANGE[7] +100 F
 E408      AA        7002              db      170T     ; WWURANGE[8] +130 F
 E409      C8        7003              db      200T     ; WWURANGE[9] +160 F
                     7004  
                     7005  
 E40A      91        7006  WWU:        db      145T    ; WWU   Warmup bin @ -40 F


MSnS351WM.asm          Assembled with CASM08Z  8/21/12  1:10:26 PM  PAGE 55
MC68HC908GP32 User Bootloader


 E40B      8C        7007              db      140T    ; WWU   Warmup bin @ -20 F
 E40C      87        7008              db      135T    ; WWU   Warmup bin @   0 F
 E40D      82        7009              db      130T    ; WWU   Warmup bin @ +20 F
 E40E      7D        7010              db      125T    ; WWU   Warmup bin @ +40 F
 E40F      78        7011              db      120T    ; WWU   Warmup bin @ +60 F
 E410      73        7012              db      115T    ; WWU   Warmup bin @ +80 F
 E411      6E        7013              db      110T    ; WWU   Warmup bin @ +100 F
 E412      69        7014              db      105T    ; WWU   Warmup bin @ +130 F
 E413      64        7015              db      100T    ; WWU   Warmup bin @ +160 F
                     7016  
                     7017  
 E414      05        7018  TPSDOTRATE: db      05T     ; TPSDOTRATE[0] (TPS ADC counts 0.1 volts)
 E415      14        7019              db      20T     ; TPSDOTRATE[1] (TPS ADC counts 0.4 volts)
 E416      28        7020              db      40T     ; TPSDOTRATE[2] (TPS ADC counts 0.8 volts)
 E417      4D        7021              db      77T     ; TPSDOTRATE[3] (TPS ADC counts 1.5 volts)
                     7022  
 E418      14        7023  TPSAQ:      db      20T     ; TPSAQ   Accel amount in 1ms units (tpsdot=0.1mS)
 E419      1E        7024              db      30T     ; TPSAQ   Accel amount in 1ms units (tpsdot=0.4mS)
 E41A      28        7025              db      40T     ; TPSAQ   Accel amount in 1ms units (tpsdot=0.8mS)
 E41B      32        7026              db      50T     ; TPSAQ   Accel amount in 1ms units (tpsdot=1.5mS)
 E41C      6E        7027  cwu:        db      110T    ; CWU          Crank Enrichment at - 40 F
 E41D      28        7028  cwh:        db      40T     ; CWH          Crank Enrichment at +165 F
 E41E      46        7029  awev:       db      70T     ; AWEV         Afterstart Warmup % enrich add on value
 E41F      64        7030  awc:        db      100T    ; AWC          Afterstart number of ignition cycles
 E420      5A        7031  tpsacold:   db      90T     ; TPSACOLD     Accel amount at - 40 F in .1 mS units
 E421      05        7032  tpsthresh:  db      5T      ; TPSTHRESH    Accel difference over time threshold
 E422      02        7033  tpsasync:   db      2T      ; TPSASYNC     Accel enrich time in .1 sec increments
 E423      F2        7034  req_fuel:   db      242T    ; REQFUEL      Required fuel constant
 E424      04        7035  divider:    db      4T      ; DIVIDER      IRQ divide factor for fuel pulse
 E425      01        7036  Alternate:  db      1T      ; ALTERNATE    Alternate injector firing (1 = alt, 0 = sim)
 E426      09        7037  InjOpen:    db      9T      ; INJOPEN      Injector open time .1ms units
 E427      0C        7038  battfac:    db      12T     ; BATTFAC      Injector voltage compensation mms/V
 E428      C8        7039  floodClear: db      200T    ; floodClear   tpsADC value for flood clear
 E429      64        7040  acmult:     db      100T    ; ACCELMULT    Accel cold mult factor (%/100)
 E42A      14        7041  pru:        db      20T     ; PRU          Primer PW @ -40 F)(0.1mS res)
 E42B      0A        7042  prh:        db      10T     ; PRH          Primer PW @ 165 F)(0.1mS res)
 E42C      5A        7043  PIP_Angle:  db      90T     ; PIP_Angle    PIP angle in crank degrees (6cyl=120, 8cyl=90)
 E42D      30        7044  CT_cnt:     db      48T     ; CT_cnt       Closed throttle position ADC count
 E42E      E7        7045  WOT_cnt:    db      231T    ; WOT_cnt      Wide Open throttle position ADC count
 E42F      05        7046  awevh:      db      5T      ; awevh        After-start hot start % enrichment add-on
 E430      64        7047  awch:       db      100T    ; awch         After-start hot number of cycles or time
 E431      64        7048  tpsdq:      db      100T    ; TPSDQ        Deceleration fuel cut %
 E432      01        7049  ASEHtype:   db      1T      ; ASEHtype     Configuration variable for ASE Hot counter type
                     7050                              ;              0 = ignition cycles, 1 = 100 ms counter,
                     7051                              ;              2 = 250 ms counter, 3 = 500 ms counter
                     7052                              ;              4 = 1 second counter
 E433      C8        7053  coolanton:  db      200T    ; coolanton    Set point for coolant temp ASE Hot Degrees F+40
 E434      F0        7054  heton:      db      240T    ; heton        High engine temperature alarm on set point (degF+40)
 E435      EB        7055  hetoff:     db      235T    ; hetoff       High engine temperature alarm off set point (degF+40)
 E436      5C        7056  lopon:      db      92T     ; lopon        Low oil pressure alarm on set point (OP_adc 0-255=0-100 PSI)
 E437      66        7057  lopoff:     db      102T    ; lopoff       Low oil pressure alarm off set point (OP_adc 0-255=0-100 PSI)
 E438      BF        7058  hegton:     db      191T    ; hegton       High exhaust temp alarm on set point (EGT_adc 0-255=32-1328F)
 E439      B5        7059  hegtoff:    db      181T    ; hegtoff      High exhaust temp alarm off set point (EGT_adc 0-255=32-1328F)
 E43A      66        7060  lfpon:      db      102T    ; lfpon        Low fuel pressure alarm on set point (FP_adc 0-255=0-100 PSI)
 E43B      70        7061  lfpoff:     db      112T    ; lfpoff       Low fuel pressure alarm off set point (FP_adc 0-255=0-100 PSI)
 E43C      99        7062  hfpon:      db      153T    ; hfpon        High fuel pressure alarm on set point (FP_adc 0-255=0-100 PSI)
 E43D      8F        7063  hfpoff:     db      143T    ; hfpoff       High fuel pressure alarm off set point (FP_adc 0-255=0-100 PSI)
 E43E      E1        7064  revlon:     db      225T    ; revlon       Rev limiter alarm on set point (RPM20)
 E43F      AF        7065  revloff:    db      175T    ; revloff      Rev limiter alarm off set point (RPM20)
 E440      11        7066  runon:      db      17T     ; runon        Run on set point for ignition (RPM20)
 E441      11        7067  startedon:  db      17T     ; startedon    Started on set point for fuel (RPM20)
 E442      BE        7068  airtempon:  db      190T    ; airtempon    Set point for Manifold Air Temp ASE Hot degrees F+40
 E443      02        7069  BnkflowH:   db      2T      ; BnkflowH     Injector bank flow rate L/hr x 10 Hi byte
                     7070                              ;              configuration variable
 E444      1F        7071  BnkflowL:   db      31T     ; BnkflowL     Injector bank flow rate L/hr x 10 Lo byte
                     7072                              ;              configuration variable
 E445      01        7073  ASEtype:    db      1T      ; ASEtype      Configuration variable for ASE counter type
                     7074                              ;              0 = ignition cycles, 1 = 100 ms counter,
                     7075                              ;              2 = 250 ms counter, 3 = 500 ms counter
                     7076                              ;              4 = 1 second counter
                     7077  
                     7078  
                     7079  flash_table5_end:
                     7080  
                     7081  
 E446                7082       include "boot_r12.asm"
                     7083  ;=====================================
                     7084  ; MEGASQUIRT BOOTLOADER VERSION - Dec 2001
                     7085  ;
                     7086  ; Mods by Bruce Bowling
                     7087  ;
                     7088  ; Corrected bug in BootReset 5
                     7089  ;
                     7090  ;=====================================
                     7091  
                     7092  ;********************************************************************************************
                     7093  ;*                                                                                          *
                     7094  ;*  Bootloader - MC68HC908GP32                                                              *
                     7095  ;*                                                          Copyright (c) Motorola, 2001    *
                     7096  ;*                                                                                          *
                     7097  ;********************************************************************************************
                     7098  ;*                                                                                          *
                     7099  ;*  This file provides the low level assembly bootloader routine.                           *
                     7100  ;*  This program has been specially tailored towards the MC68HC908GP32.                     *
                     7101  ;*                                                                                          *
                     7102  ;********************************************************************************************
                     7103  ;*                                                                                          *
                     7104  ;*  File name:          boot.asm                        Current Release Level:      1.1     *
                     7105  ;*  Last Edit Date:     07-Jun-01                       Classification:             ES      *
                     7106  ;*                                                                                          *
                     7107  ;*  Include Files:      gp32.equ            : MC68HC908GP32 MCU definitions                 *
                     7108  ;*                                                                                          *
                     7109  ;*  Assembler:          P&E's CASM08Z                   Version:    3.16                    *
                     7110  ;*                                                                                          *
                     7111  ;*  Target:             MC68HC908GP32                                                       *
                     7112  ;*                                                                                          *
                     7113  ;*  Documentation:      MC68HC908GP32/H  Rev 3                                              *
                     7114  ;*                      Motorola Microcontroller Technical Data                             *
                     7115  ;*                                                                                          *
                     7116  ;********************************************************************************************
                     7117  ;*                                                                                          *
                     7118  ;*  Author:             DHJ Klotz                                                           *
                     7119  ;*  First Release:      26-Feb-00                                                           *
                     7120  ;*                                                                                          *
                     7121  ;*  Update History:                                                                         *
                     7122  ;*                                                                                          *
                     7123  ;*  Rev     Date       Author  Description of Change                                        *
                     7124  ;*  ------  ---------  ------  -----------------------------------------------------------  *
                     7125  ;*  ES 1.0  26-Feb-00  DHJK    Initial release for HC908 Seminar 2000.                      *
                     7126  ;*  ES 1.1  07-Jun-01  DHJK    Improved functionality for Application Note.                 *
                     7127  ;*                                                                                          *
                     7128  ;********************************************************************************************
                     7129  ;*                                                                                          *
                     7130  ;*  Notes:                                                                                  *
                     7131  ;*    - In order to minimize overall program size, subroutines are position within the      *
                     7132  ;*      core bootloader routine.  Although this can make the program somewhat difficult     *
                     7133  ;*      to read and follow, it permits the use of relative branch opcodes.  Most of         *
                     7134  ;*      these subroutines can be called from an external application program.               *
                     7135  ;*                                                                                          *
                     7136  ;********************************************************************************************
                     7137  ;*                                                                                          *
                     7138  ;*    Motorola reserves the right to make changes without further notice to any product     *
                     7139  ;*    herein to improve reliability, function, or design.  Motorola does not assume any     *
                     7140  ;*    liability arising out of the application or use of any product, circuit, or software  *
                     7141  ;*    described herein; neither does it convey any license under its patent rights nor the  *
                     7142  ;*    rights of others.  Motorola products are not designed, intended, or authorized for    *
                     7143  ;*    use as components in systems intended for surgical implant into the body, or other    *
                     7144  ;*    applications intended to support life, or for any other application in which the      *
                     7145  ;*    failure of the Motorola product could create a situation where personal injury or     *
                     7146  ;*    death may occur.  Should Buyer purchase or use Motorola products for any such         *
                     7147  ;*    intended or unauthorized application, Buyer shall indemnify and hold Motorola and     *
                     7148  ;*    its officers, employees, subsidiaries, affiliates, and distributors harmless against  *
                     7149  ;*    all claims, costs, damages, and expenses, and reasonable attorney fees arising out    *
                     7150  ;*    of, directly or indirectly, any claim of personal injury or death associated with     *
                     7151  ;*    such unintended or unauthorized use, even if such claim alleges that Motorola was     *
                     7152  ;*    negligent regarding the design or manufacture of the part.                            *
                     7153  ;*                                                                                          *
                     7154  ;*    Motorola and the Motorola logo are registered trademarks of Motorola Ltd.             *
                     7155  ;*                                                                                          *
                     7156  ;********************************************************************************************
                     7157  
                     7158  ;*  Microcontroller Peripheral Equates  *****************************************************
                     7159  ;*
                     7160  
                     7161  ; uncomment out if standalone
 E446                7162          list
                     7163  
                     7164  
                     7165  ;*  Flash Memory Specifics  =================================================================
                     7166  ;*
 E446                7167  boot_start:     equ     $FB00               ; starting address of protected Bootloader
 E446                7168  flash_protect:  equ     {boot_start>7&$FF}  ; Flash Block Protect Register value
 E446                7169  flash_page:     equ     128                 ; Flash Erase Page size
 E446                7170  flash_row:      equ     64                  ; Flash Program Row size
 E446                7171  flash_erased:   equ     $FF                 ; Flash erased state
                     7172  
                     7173  
                     7174  ;*  RAM Utilization  ========================================================================
                     7175  ;*
 0040                7176          org     ram_start                   ; begining of RAM
                     7177  
 0040                7178  count:          ds      1                   ; 0040:     => data counter
 0041                7179  temp_sp:        ds      2                   ; 0041:0042 => temporary Stack Pointer storage
 0043                7180  flash_first:    ds      2                   ; 0043:0044 => first Flash reprogram address
 0045                7181  flash_last:     ds      2                   ; 0045:0046 => last Flash reprogram address + 1
                     7182  
 0047                7183  ram_exec:       equ     $01ED               ; start of executable RAM space
                     7184  
                     7185  
                     7186  ;*  Bootloader Customization Parameters  ====================================================
                     7187  ;*
 0047                7188  user_scbr:      equ     boot_start-61       ; FAC3      => SCBR register
 0047                7189  init_scbr:      equ     $12                 ;   default set SCI for 9600 kbaud
                     7190  
 0047                7191  user_config1:   equ     boot_start-60       ; FAC4      => CONFIG1 register
 0047                7192  init_config1:   equ     %00000001           ;   default CONFIG1
                     7193  
 0047                7194  user_config2:   equ     boot_start-59       ; FAC5      => CONFIG2 register
 0047                7195  init_config2:   equ     %00000001           ;   default CONFIG2
                     7196  
 0047                7197  user_first:     equ     boot_start-58       ; FAC6:FAC7 => 1st application address
 0047                7198  init_first:     equ     rom_start           ;   default first Flash address
                     7199  
 0047                7200  user_last:      equ     boot_start-56       ; FAC8:FAC9 => last application address
 0047                7201  init_last:      equ     boot_start          ;   default last Flash address
                     7202  
                     7203  
                     7204  ;*  Application Program Jump Vector Table  ==================================================
                     7205  ;*
                     7206                                              ; FACA      => "JMP ext" instruction (opcode $CC)
 0047                7207  user_timebase:  equ     boot_start-54       ; FACB:FACC => user Timebase jump vector
                     7208  
                     7209                                              ; FACD      => "JMP ext" instruction (opcode $CC)
 0047                7210  user_ADC:       equ     boot_start-51       ; FACE:FACF => user ADC jump vector
                     7211  
                     7212                                              ; FAD0      => "JMP ext" instruction (opcode $CC)
 0047                7213  user_keyboard:  equ     boot_start-48       ; FAD1:FAD2 => user Keyboard jump vector
                     7214  
                     7215                                              ; FAD3      => "JMP ext" instruction (opcode $CC)
 0047                7216  user_SCItx:     equ     boot_start-45       ; FAD4:FAD5 => user SCI transmit jump vector
                     7217  
                     7218                                              ; FAD6      => "JMP ext" instruction (opcode $CC)
 0047                7219  user_SCIrx:     equ     boot_start-42       ; FAD7:FAD8 => user SCI receive jump vector
                     7220  
                     7221                                              ; FAD9      => "JMP ext" instruction (opcode $CC)
 0047                7222  user_SCIerr:    equ     boot_start-39       ; FADA:FADB => user SCI error jump vector
                     7223  
                     7224                                              ; FADC      => "JMP ext" instruction (opcode $CC)
 0047                7225  user_SPItx:     equ     boot_start-36       ; FADD:FADE => user SPI transmit jump vector
                     7226  
                     7227                                              ; FADF      => "JMP ext" instruction (opcode $CC)
 0047                7228  user_SPIrx:     equ     boot_start-33       ; FAE0:FAE1 => user SPI receive jump vector
                     7229  
                     7230                                              ; FAE2      => "JMP ext" instruction (opcode $CC)
 0047                7231  user_Tim2Ov:    equ     boot_start-30       ; FAE3:FAE4 => user Timer 2 overflow jump vector
                     7232  
                     7233                                              ; FAE5      => "JMP ext" instruction (opcode $CC)
 0047                7234  user_Tim2Ch1:   equ     boot_start-27       ; FAE6:FAE7 => user Timer 2 channel 1 jump vector
                     7235  
                     7236                                              ; FAE8      => "JMP ext" instruction (opcode $CC)
 0047                7237  user_Tim2Ch0:   equ     boot_start-24       ; FAE9:FAEA => user Timer 2 channel 0 jump vector
                     7238  
                     7239                                              ; FAEB      => "JMP ext" instruction (opcode $CC)
 0047                7240  user_Tim1Ov:    equ     boot_start-21       ; FAEC:FAED => user Timer 1 oveflow jump vector
                     7241  
                     7242                                              ; FAEE      => "JMP ext" instruction (opcode $CC)
 0047                7243  user_Tim1Ch1:   equ     boot_start-18       ; FAEF:FAF0 => user Timer 1 channel 1 jump vector
                     7244  
                     7245                                              ; FAF1      => "JMP ext" instruction (opcode $CC)
 0047                7246  user_Tim1Ch0:   equ     boot_start-15       ; FAF2:FAF3 => user Timer 1 channel 0 jump vector
                     7247  
                     7248                                              ; FAF4      => "JMP ext" instruction (opcode $CC)
 0047                7249  user_PLL:       equ     boot_start-12       ; FAF5:FAF6 => user PLL jump vector
                     7250  
                     7251                                              ; FAF7      => "JMP ext" instruction (opcode $CC)
 0047                7252  user_IRQ:       equ     boot_start-9        ; FAF8:FAF9 => user IRQ jump vector
                     7253  
                     7254                                              ; FAFA      => "JMP ext" instruction (opcode $CC)
 0047                7255  user_SWI:       equ     boot_start-6        ; FAFB:FAFC => user SWI jump vector
                     7256  
                     7257                                              ; FAFD      => "JMP ext" instruction (opcode $CC)
 0047                7258  user_reset:     equ     boot_start-3        ; FAFE:FAFF => user Reset interrupt jump vector
                     7259  
                     7260  
                     7261  ;*  Bootloader Program  *********************************************************************
                     7262  ;*
                     7263  
 0047                7264  init_stack:     equ     ram_exec-1          ; initialize stack pointer to before RAM routine
                     7265  ;
 0047                7266  init_scc1:      equ     %01000000           ; enable SCI, 8-bits, no parity, 1 stop
 0047                7267  init_scc2:      equ     %00001100           ; no interupts, receiver and transmitter enabled
                     7268  
 FB00                7269          org     boot_start                  ; beginning of code
                     7270  
                     7271  
                     7272  ;*  CGM Parameter Tables  ===================================================================
                     7273  ;*
                     7274  ;*  The following CGM parameter tables are placed here so that they are easy to access via
                     7275  ;*  external application programs.
                     7276  ;*
                     7277  ;*  7.3728 MHz bus frequency parameters (located at address "boot_start").
                     7278  ;*
                     7279  bus7372800:
 FB00      02        7280          db      $02                         ; P & E
 FB01      C0        7281          db      $C0                         ; L
 FB02      03        7282          db      $03                         ; N msb
 FB03      84        7283          db      $84                         ; N lsb
                     7284  
                     7285  ;*  8.003584 MHz bus frequency parameters (located at address "boot_start+4").
                     7286  ;*
                     7287  bus8003584:
 FB04      02        7288          db      $02                         ; P & E
 FB05      D0        7289          db      $D0                         ; L
 FB06      03        7290          db      $03                         ; N msb
 FB07      D1        7291          db      $D1                         ; N lsb
                     7292  
                     7293  
                     7294  ;*  Power-on Reset  =========================================================================
                     7295  ;* MODIFIED FOR MEGASQUIRT - Initialization code here
                     7296  ;*
                     7297  
                     7298  BootReset:
 FB08 [01] 4F        7299          clra
 FB09 [04] C7FFFF    7300          sta     copctl
 FB0C [04] 6E011E    7301          mov     #%00000001,config2
 FB0F [04] 6E011F    7302          mov     #%00000001,config1
 FB12 [03] 450240    7303          ldhx    #ram_last+1
 FB15 [02] 94        7304          txs
                     7305  
 FB16 [03] 45FB00    7306          ldhx    #bus7372800                 ; point to 7.3728 MHz parameters
 FB19 [04] AD22      7307          bsr     PLLset                      ; change bus speed
                     7308  
 FB1B [02] A600      7309          lda      #%00000000
 FB1D [03] B705      7310          sta      ddrb                       ; ADC Channels - inputs
                     7311  
 FB1F [02] A670      7312          lda     #%01110000                  ; Set up ADC for divide by 8 and internal clock
 FB21 [03] B73E      7313          sta     adclk
 FB23 [02] A604      7314          lda     #%00000100                  ; No interrupt, channel AD4 selected
 FB25 [03] B73C      7315          sta     adscr
 FB27 [05] 0F3CFD    7316          brclr   coco,adscr,*                ; wait until conversion complete
                     7317  
 FB2A [03] B63D      7318          lda     adr
 FB2C [02] A105      7319          cmp     #$05                        ; Check for low voltage on divider
 FB2E [03] 2529      7320          blo     BootReset1                  ; enter bootloader if low voltage
                     7321  
                     7322  ;
                     7323  ;   Test application reset vector.
                     7324  ;
 FB30 [04] C6FAFE    7325          lda     user_reset+1                ; get the MSB of the user reset vector
 FB33 [02] A1FF      7326          cmp     #flash_erased               ; check if it's erased
 FB35 [03] 2722      7327          beq     BootReset1                  ; enter bootloader if erased
 FB37 [03] 20C4      7328          bra     user_reset                  ; else, jump to user reset jump vector
                     7329  
                     7330  
                     7331  ;*  External CGM PLL Bus Frequency Change Subroutine  =======================================
                     7332  ;*
                     7333  ;*  This subroutine will program the CGM PLL to change the bus frequency in accordance with
                     7334  ;*  the data being pointed to by X:A (which is a common implementation for pointer parameter
                     7335  ;*  passing used by HC08 C compilers).
                     7336  ;*
                     7337  ;*  C function prototype:
                     7338  ;*
                     7339  ;*      void CGMChange (char parameters*);
                     7340  ;*
                     7341  ;*  Calling convention:
                     7342  ;*
                     7343  ;*      ldx     #{parameters>8}             ; get CGM parameter table address msb
                     7344  ;*      lda     #{parameters&$FF}           ; get CGM parameter table address lsb
                     7345  ;*      jsr     CGMChange                   ; go change the bus speed
                     7346  ;*
                     7347  ;*  Returns:    nothing
                     7348  ;*
                     7349  ;*  Changes:    H:X
                     7350  ;*
                     7351  CGMChange:
 FB39 [02] 87        7352          psha                                ; save pointer lsb on stack
 FB3A [02] 89        7353          pshx                                ; save pointer msb on stack
 FB3B [02] 8A        7354          pulh                                ; initialize
 FB3C [02] 88        7355          pulx                                ;  H:X points to data array
                     7356  
                     7357  
                     7358  ;*  Internal CGM PLL Bus Frequency Change Subroutine  =======================================
                     7359  ;*
                     7360  ;*  This subroutine will program the CGM PLL to change the bus frequency in accordance with
                     7361  ;*  the data being pointed to by H:X.
                     7362  ;*
                     7363  ;*  Calling convention:
                     7364  ;*
                     7365  ;*      ldhx    #parameters                 ; point to CGM parameter table
                     7366  ;*      jsr     PLLset                      ; go change the bus speed
                     7367  ;*
                     7368  ;*  Returns:    nothing
                     7369  ;*
                     7370  ;*  Changes:    H:X
                     7371  ;*
                     7372  PLLset:
 FB3D [04] 1936      7373          bclr    BCS,pctl                    ; select external reference as base clock
 FB3F [04] 1B36      7374          bclr    PLLON,pctl                  ; turn off PLL
 FB41 [04] 7E36      7375          mov     x+,pctl                     ; program P & E
 FB43 [04] 7E3A      7376          mov     x+,pmrs                     ; program L
 FB45 [04] 7E38      7377          mov     x+,pmsh                     ; program N msb
 FB47 [04] 7E39      7378          mov     x+,pmsl                     ; program N lsb
 FB49 [04] 1E37      7379          bset    AUTO,pbwc                   ; enable automatic bandwidth control
 FB4B [04] 1A36      7380          bset    PLLON,pctl                  ; turn on PLL
                     7381  PLLwait:
 FB4D [05] 0D37FD    7382          brclr   LOCK,pbwc,PLLwait           ; wait for PLL to lock (Note: won't simulate)
 FB50 [04] 1836      7383          bset    BCS,pctl                    ; select VCO as base clock
 FB52 [04] 81        7384          rts                                 ; return
                     7385  
                     7386  
                     7387  ;*  PutChar Subroutine  =====================================================================
                     7388  ;*
                     7389  ;*  This subroutine will output the character passed in ACC to the SCI.
                     7390  ;*
                     7391  ;*  C function prototype:
                     7392  ;*
                     7393  ;*      void PutChar (char data);
                     7394  ;*
                     7395  ;*  Calling convention:
                     7396  ;*
                     7397  ;*      lda     data                        ; get character
                     7398  ;*      jsr     PutChar                     ; go output it
                     7399  ;*
                     7400  ;*  Returns:    nothing
                     7401  ;*
                     7402  ;*  Changes:    nothing
                     7403  ;*
                     7404  PutChar:
 FB53 [05] 0F16FD    7405          brclr   SCTE,scs1,PutChar           ; wait until SCI transmitter is empty
 FB56 [03] B718      7406          sta     scdr                        ; output character to the SCI
 FB58 [04] 81        7407          rts                                 ; return
                     7408  
                     7409  
                     7410  ;*  Power-on Reset Bootloader Entry  ========================================================
                     7411  ;*
                     7412  ;*  This is where the Bootloader starts from power-on reset.
                     7413  ;*
                     7414  BootReset1:
                     7415  ;
                     7416  ;   Initialize the PLL CGM for 7.3728 MHz bus speed from 32.768 kHz crystal.
                     7417  ;
                     7418  ;        ldhx    #bus7372800                 ; point to 7.3728 MHz parameters
                     7419  ;        bsr     PLLset                      ; change bus speed
                     7420  ;
                     7421  ;   Copy user Flash parameters into RAM.
                     7422  ;
 FB59 [03] 45FAC3    7423          ldhx    #user_scbr                  ; point to first parameter
 FB5C [04] 7E40      7424          mov     x+,count                    ; copy user SCI baud rate
 FB5E [04] 7E41      7425          mov     x+,temp_sp                  ; copy user Configuration Register 1
 FB60 [04] 7E42      7426          mov     x+,temp_sp+1                ; copy user Configuration Register 2
 FB62 [04] 7E43      7427          mov     x+,flash_first              ; copy first user Flash address MSB
 FB64 [04] 7E44      7428          mov     x+,flash_first+1            ; copy first user Flash address LSB
 FB66 [04] 7E45      7429          mov     x+,flash_last               ; copy last user Flash address MSB
 FB68 [04] 7E46      7430          mov     x+,flash_last+1             ; copy last user Flash address LSB
 FB6A [03] 450040    7431          ldhx    #count                      ; point to first parameter, now saved in RAM
 FB6D [02] 94        7432          txs                                 ; use SP to point to parameter list in RAM
                     7433  ;
                     7434  ;   Test the user SCI baud rate.  The user can override the default baud rate.
                     7435  ;
 FB6E [02] 86        7436          pula                                ; get user SCBR initial data
 FB6F [02] A1FF      7437          cmp     #flash_erased               ; check if it's erased
 FB71 [03] 2602      7438          bne     BootReset2                  ; skip if not
 FB73 [02] A612      7439          lda     #init_scbr                  ; else, force default value
                     7440  BootReset2:
 FB75 [03] B740      7441          sta     count                       ; save initial SCI baud rate
                     7442  ;
                     7443  ;   Program the write-once configuration registers.  The user can override the defaults.
                     7444  ;
 FB77 [02] 86        7445          pula                                ; get user Configuration Register 1 initial data
 FB78 [02] A1FF      7446          cmp     #flash_erased               ; check if it's erased
 FB7A [03] 2602      7447          bne     BootReset3                  ; skip if not
 FB7C [02] A601      7448          lda     #init_config1               ; else, force default value
                     7449  BootReset3:
 FB7E [03] B71F      7450          sta     config1                     ; initialize Configuration Register 1
                     7451  ;
 FB80 [02] 86        7452          pula                                ; get user Configuration Register 2 initial data
 FB81 [02] A1FF      7453          cmp     #flash_erased               ; check if it's erased
 FB83 [03] 2602      7454          bne     BootReset4                  ; skip if not
 FB85 [02] A601      7455          lda     #init_config2               ; else, force default value
                     7456  BootReset4:
 FB87 [03] B71E      7457          sta     config2                     ; initialize Configuration Register 2
                     7458  ;
                     7459  ;   Program the first and last user Flash addresses.  The user can override the defaults.
                     7460  ;
 FB89 [02] 88        7461          pulx                                ; get first user Flash address LSB
 FB8A [02] 8A        7462          pulh                                ; get first user Flash address MSB
 FB8B [03] 65FFFF    7463          cphx    #$FFFF                      ; check if it's erased
 FB8E [03] 2608      7464          bne     BootReset5                  ; skip if not
 FB90 [02] A600      7465          lda     #{init_first&$FF}           ; else, get default first user address LSB
 FB92 [02] 87        7466          psha                                ;  save it
 FB93 [02] A680      7467          lda     #{init_first>8}             ;  and get default first user address MSB
 FB95 [02] 87        7468          psha                                ;  save it
 FB96 [02] A702      7469          ais     #2                          ; move stack pointer back
                     7470  ;
                     7471  BootReset5:
 FB98 [02] 88        7472          pulx                                ; get last user Flash address LSB
 FB99 [02] 8A        7473          pulh                                ; get last user Flash address MSB
 FB9A [03] 65FFFF    7474          cphx    #$FFFF                      ; check if it's erased
 FB9D [03] 2606      7475          bne     BootReset6                  ; skip if not
                     7476  ;        ldx     #{init_last&$FF}            ; else, get default last user address LSB
 FB9F [02] A600      7477          lda     #{init_last&$FF}            ; else, get default last user address LSB
 FBA1 [02] 87        7478          psha                                ;  save it
 FBA2 [02] A6FB      7479          lda     #{init_last>8}              ;  and get default last user address MSB
 FBA4 [02] 87        7480          psha                                ;  save it
                     7481  BootReset6:
                     7482  
                     7483  
                     7484  ;*  User Bootloader Entry  ==================================================================
                     7485  ;*
                     7486  ;*  The user can launch the bootloader from here.
                     7487  ;*
                     7488  BootResetUser:
 FBA5 [02] 9B        7489          sei                                 ; disable all interrupts
 FBA6 [04] C7FFFF    7490          sta     copctl                      ; clear the COP counter
 FBA9 [03] 4501ED    7491          ldhx    #init_stack+1               ; initialize
 FBAC [02] 94        7492          txs                                 ;  the stack pointer
                     7493  ;
                     7494  ;   Initialize the PLL CGM for 7.3728 MHz bus speed from 32.768 kHz crystal.
                     7495  ;
 FBAD [03] 45FB00    7496          ldhx    #bus7372800                 ; point to 7.3728 MHz parameters
 FBB0 [04] AD8B      7497          bsr     PLLset                      ; change bus speed
                     7498  ;
                     7499  ;   Take over and initialize the SCI.  The user can override the default baud rate.
                     7500  ;
 FBB2 [05] 4E4019    7501          mov     count,scbr                  ; initialize SCI baud rate
 FBB5 [04] 6E4013    7502          mov     #init_scc1,scc1             ; initialize SCI Control Register 1
 FBB8 [04] 6E0C14    7503          mov     #init_scc2,scc2             ; initialize SCI Control Register 2
                     7504  
                     7505  
                     7506  ;*  Main Bootloader Control Loop  ==========================================================
                     7507  ;*
                     7508  ;*  Bootloader program supports the following commands:
                     7509  ;*
                     7510  ;*      'X'  = Exit and execute user program via user reset vector
                     7511  ;*      'P'  = Program Flash via S-Records
                     7512  ;*      'W'  = Erase Flash (Wipe)
                     7513  ;*      'U'  = Upgrade Flash by erasing all user space, then programming via S-Records
                     7514  ;*      'H'  = Help
                     7515  ;*      '?'  = Help
                     7516  ;*
                     7517  ;*  Note: avoid using 'A' - 'F', as these are valid S-Record characters that could get
                     7518  ;*        misinterpreted.
                     7519  ;*
 FBBB                7520  cmd_exit:       equ     'X'                 ; Exit command
 FBBB                7521  cmd_program:    equ     'P'                 ; Program Flash command
 FBBB                7522  cmd_erase:      equ     'W'                 ; Erase Flash command (Wipe)
 FBBB                7523  cmd_upgrade:    equ     'U'                 ; Upgrade Flash command
 FBBB                7524  cmd_help:       equ     'H'                 ; Help command
 FBBB                7525  cmd_help1:      equ     $1F                 ; '?' = alternate Help command
                     7526  ;
                     7527  Boot:
 FBBB [03] 45FD88    7528          ldhx    #msg_hello                  ; point to hello message
 FBBE [04] AD38      7529          bsr     PrintString                 ; output it
 FBC0 [05] CDFC6A    7530          jsr     GetChar                     ; get a character from the SCI
 FBC3 [02] A10D      7531          cmp     #ascii_CR                   ; check for ASCII carriage return
 FBC5 [03] 27F4      7532          beq     Boot                        ; just loop back if so
 FBC7 [04] AD8A      7533          bsr     PutChar                     ; else, echo character back
 FBC9 [02] A4DF      7534          and     #$DF                        ; convert to uppercase
                     7535  
                     7536  
                     7537  ;*  Execute User Program Command Check  =====================================================
                     7538  ;*
 FBCB [02] A158      7539          cmp     #cmd_exit                   ; check for Exit command
 FBCD [03] 2611      7540          bne     Boot2                       ; skip if not
 FBCF [04] C6FAFE    7541          lda     user_reset+1                ; else, get the MSB of the user reset vector
 FBD2 [02] A1FF      7542          cmp     #flash_erased               ; check if it's erased
 FBD4 [03] 2703      7543          beq     Boot1                       ; skip if not
 FBD6 [03] CCFAFD    7544          jmp     user_reset                  ; else, jump to user reset jump vector
                     7545  ;
                     7546  ;   Remain in the Bootloader if the MSB of the User Reset Jump Vector is erased.
                     7547  ;
                     7548  Boot1:
 FBD9 [03] 45FDE0    7549          ldhx    #msg_noreset                ; point to error message
 FBDC [04] AD1A      7550          bsr     PrintString                 ; output it
 FBDE [03] 20DB      7551          bra     Boot                        ; jump back to top
                     7552  
                     7553  
                     7554  ;*  Erase Flash Command Check  ==============================================================
                     7555  ;*
                     7556  Boot2:
 FBE0 [02] A157      7557          cmp     #cmd_erase                  ; check for Erase Flash command
 FBE2 [03] 2618      7558          bne     Boot3                       ; skip if not
 FBE4 [04] AD76      7559          bsr     EraseFlash                  ; else, go erase Flash
                     7560  ;
                     7561  ;   Common Bootloader command completion points.
                     7562  ;
                     7563  BootDone:
 FBE6 [03] 45FDB4    7564          ldhx    #msg_complete               ; point to operation complete message
                     7565  BootDone1:
 FBE9 [04] AD0D      7566          bsr     PrintString                 ; output it
                     7567  BootDone2:
 FBEB [03] 20CE      7568          bra     Boot                        ; jump back to top
                     7569  
                     7570  
                     7571  ;*  External PutString Subroutine  ==========================================================
                     7572  ;*
                     7573  ;*  This subroutine will output the null terminated string pointed to by X:A (which is a
                     7574  ;*  common implementation for pointer parameter passing used by HC08 C compilers) to the SCI.
                     7575  ;*
                     7576  ;*  C function prototype:
                     7577  ;*
                     7578  ;*      void PutString (char string*);
                     7579  ;*
                     7580  ;*  Calling convention:
                     7581  ;*
                     7582  ;*      ldx     #{string>8}                 ; get CGM parameter table address msb
                     7583  ;*      lda     #{string&$FF}               ; get CGM parameter table address lsb
                     7584  ;*      jsr     PutString                   ; go change the bus speed
                     7585  ;*
                     7586  ;*  Returns:    nothing
                     7587  ;*
                     7588  ;*  Changes:    H:X
                     7589  ;*
                     7590  PutString:
 FBED [02] 87        7591          psha                                ; save pointer lsb on stack
 FBEE [02] 89        7592          pshx                                ; save pointer msb on stack
 FBEF [02] 8A        7593          pulh                                ; initialize
 FBF0 [02] 88        7594          pulx                                ;  H:X points to data array
 FBF1 [03] 2005      7595          bra     PrintString                 ; go output string
                     7596  
                     7597  
                     7598  ;*  PrintString Subroutine  =================================================================
                     7599  ;*
                     7600  ;*  This subroutine will output the null teminated string pointed to by H:X to the SCI.
                     7601  ;*
                     7602  ;*  Calling convention:
                     7603  ;*
                     7604  ;*      ldhx    #string                     ; point to start of string
                     7605  ;*      jsr     PrintString                 ; go output it
                     7606  ;*
                     7607  ;*  Returns:    nothing
                     7608  ;*
                     7609  ;*  Changes:    H:X
                     7610  ;*
                     7611  PrintString1:
 FBF3 [05] 0F16FD    7612          brclr   SCTE,scs1,PrintString1      ; wait until SCI transmitter is empty
 FBF6 [04] 7E18      7613          mov     x+,scdr                     ; output character to the SCI and advance pointer
                     7614  PrintString:
 FBF8 [02] 7D        7615          tst     ,x                          ; test string character
 FBF9 [03] 26F8      7616          bne     PrintString1                ; loop back if not null
 FBFB [04] 81        7617          rts                                 ; else, return
                     7618  
                     7619  
                     7620  ;*  Program Flash Command Check  ============================================================
                     7621  ;*
                     7622  Boot3:
 FBFC [02] A150      7623          cmp     #cmd_program                ; check for Program Flash command
 FBFE [03] 264A      7624          bne     Boot4                       ; skip if not
                     7625  ;
 FC00 [04] AD02      7626          bsr     BootProg                    ; go accept S19 records and program the Flash
 FC02 [03] 20B7      7627          bra     Boot                        ; return to top of control loop
                     7628  
                     7629  
                     7630  ;*  Program Flash Subroutine  ===============================================================
                     7631  ;*
                     7632  ;*  This subroutine will copy the Flash Program algorithm into RAM and execute it in
                     7633  ;*  conjunction with the S19 record retrieval to program the required Flash pages between
                     7634  ;*  address pointers "flash_first" and "flash_last".
                     7635  ;*
                     7636  ;*  Calling convention:
                     7637  ;*
                     7638  ;*      jsr     BootProg                    ; retrieve S19 records and program Flash
                     7639  ;*
                     7640  ;*  Returns:    nothing
                     7641  ;*
                     7642  ;*  Changes:    everything
                     7643  ;*
                     7644  BootProg:
 FC04 [03] 45004F    7645          ldhx    #ProgramRamSize             ; initialize pointer
                     7646  BootProg1:
 FC07 [04] D6FD38    7647          lda     Delay-1,x                   ; get program from Flash
 FC0A [04] D701EC    7648          sta     ram_exec-1,x                ; copy into RAM
 FC0D [03] 5BF8      7649          dbnzx   BootProg1                   ; decrement pointer and loop back until done
 FC0F [03] 45FDBF    7650          ldhx    #msg_waiting                ; point to waiting message
 FC12 [04] ADE4      7651          bsr     PrintString                 ; output it
                     7652  ;
                     7653  ;   Get S-Record from host.
                     7654  ;
                     7655  BootProg2:
 FC14 [02] 95        7656          tsx                                 ; get the Stack Pointer
 FC15 [04] 3541      7657          sthx    temp_sp                     ; save it temporarily
 FC17 [02] A7DC      7658          ais     #-36                        ; allocate stack space for data
 FC19 [04] AD58      7659          bsr     GetSRec                     ; get an S-Record
 FC1B [03] 2625      7660          bne     BootProg5                   ; indicate error if S-Record is invalid
 FC1D [02] 86        7661          pula                                ; get S-Record type
 FC1E [02] A130      7662          cmp     #'0'                        ; check for text header record type
 FC20 [03] 270B      7663          beq     BootProg3                   ; ignore and get next record
 FC22 [02] A139      7664          cmp     #'9'                        ; check for end record type
 FC24 [03] 270B      7665          beq     BootProg4                   ; indicate operation complete
 FC26 [02] A131      7666          cmp     #'1'                        ; check for data record type
 FC28 [03] 2618      7667          bne     BootProg5                   ; indicate error if S-Record is invalid
                     7668  ;
                     7669  ;   Program Flash.
                     7670  ;
 FC2A [05] CD01F8    7671          jsr     {ram_exec+ProgramRam}       ; execute Program Flash algorithm from RAM
                     7672  BootProg3:
 FC2D [02] A723      7673          ais     #35                         ; deallocate stack space
 FC2F [03] 20E3      7674          bra     BootProg2                   ; loop back for next S-Record
                     7675  ;
                     7676  BootProg4:
 FC31 [02] A723      7677          ais     #35                         ; deallocate stack space
 FC33 [05] 0B16B0    7678          brclr   SCRF,scs1,BootDone          ; skip if SCI receiver is empty
 FC36 [04] AD32      7679          bsr     GetChar                     ; else, clear last ASCII carriage return from SCI
 FC38 [05] 0B16AB    7680          brclr   SCRF,scs1,BootDone          ; skip if SCI receiver is empty
 FC3B [04] AD2D      7681          bsr     GetChar                     ; else, clear last ASCII line feed from the SCI
 FC3D [03] 45FDB4    7682          ldhx    #msg_complete               ; point to operation complete message
 FC40 [03] 2005      7683          bra     BootProg6                   ; go output it
                     7684  ;
                     7685  BootProg5:
 FC42 [02] A724      7686          ais     #36                         ; deallocate stack space
 FC44 [03] 45FDCE    7687          ldhx    #msg_error                  ; point to error message
                     7688  BootProg6:
 FC47 [04] ADAF      7689          bsr     PrintString                 ; output it
 FC49 [04] 81        7690          rts                                 ; return
                     7691  
                     7692  
                     7693  ;*  Upgrade Flash Command Check  ============================================================
                     7694  ;*
                     7695  Boot4:
 FC4A [02] A155      7696          cmp     #cmd_upgrade                ; check for Upgrade Flash command
 FC4C [03] 2670      7697          bne     Boot5                       ; skip if not
                     7698  ;
 FC4E [03] 458000    7699          ldhx    #init_first                 ; force
 FC51 [04] 3543      7700          sthx    flash_first                 ;  first Flash address
 FC53 [03] 45FB00    7701          ldhx    #init_last                  ; force
 FC56 [04] 3545      7702          sthx    flash_last                  ;  last Flash address
 FC58 [04] AD02      7703          bsr     EraseFlash                  ; go erase Flash
 FC5A [03] 20A8      7704          bra     BootProg                    ; go program Flash
                     7705  
                     7706  
                     7707  ;*  Multiple Flash Page Erase Subroutine  ===================================================
                     7708  ;*
                     7709  ;*  This subroutine will copy the Flash Erase algorithm into RAM and execute it to erase
                     7710  ;*  all pages between address pointers "flash_first" and "flash_last".
                     7711  ;*
                     7712  ;*  Calling convention:
                     7713  ;*
                     7714  ;*      ldhx    #init_first                 ; initialize
                     7715  ;*      sthx    flash_first                 ;  first Flash address
                     7716  ;*      ldhx    #init_last                  ; initialize
                     7717  ;*      sthx    flash_last                  ;  last Flash address
                     7718  ;*      jsr     EraseFlash                  ; go erase flash
                     7719  ;*
                     7720  ;*  Returns:    nothing
                     7721  ;*
                     7722  ;*  Changes:    everything
                     7723  ;*
                     7724  EraseFlash:
 FC5C [03] 45003B    7725          ldhx    #EraseRamSize               ; initialize pointer
                     7726  EraseFlash1:
 FC5F [04] D6FD08    7727          lda     MassErase-1,x               ; get program from Flash
 FC62 [04] D701EC    7728          sta     ram_exec-1,x                ; copy into RAM
 FC65 [03] 5BF8      7729          dbnzx   EraseFlash1                 ; decrement pointer and loop back until done
 FC67 [03] CC01ED    7730          jmp     ram_exec                    ; execute Flash Mass Erase algorithm from RAM
                     7731  
                     7732  
                     7733  ;*  GetChar Subroutine  =====================================================================
                     7734  ;*
                     7735  ;*  This subroutine will wait forever for a character to be received by the SCI and then
                     7736  ;*  returns with that character in ACC.  No error checking is performed.  Note that this
                     7737  ;*  is the primary loop where the COP counter is cleared.
                     7738  ;*
                     7739  ;*  C function prototype:
                     7740  ;*
                     7741  ;*      char GetChar (void);
                     7742  ;*
                     7743  ;*  Calling convention:
                     7744  ;*
                     7745  ;*      jsr     GetChar                     ; get a character from the SCI
                     7746  ;*
                     7747  ;*  Returns:
                     7748  ;*      ACC= data
                     7749  ;*
                     7750  GetChar:
 FC6A [04] C7FFFF    7751          sta     copctl                      ; clear the COP counter
 FC6D [05] 0B16FA    7752          brclr   SCRF,scs1,GetChar           ; wait forever until SCI receiver is full
 FC70 [03] B618      7753          lda     scdr                        ; get data
 FC72 [04] 81        7754          rts                                 ; return
                     7755  
                     7756  
                     7757  ;*  GetSRec Subroutine  =====================================================================
                     7758  ;*
                     7759  ;*  This subroutine will retrieve data in S19 record format via the SCI.
                     7760  ;*
                     7761  ;*  Calling convention:
                     7762  ;*
                     7763  ;*      ais     #-buffer_length             ; allocate stack space for data
                     7764  ;*      jsr     GetSRec                     ; go get S-record data
                     7765  ;*
                     7766  ;*  Returns:    CCRZ= 1 if valid S-Record retrieved.  Otherwise, CCRZ= 0.
                     7767  ;*              S-Record Type at SP+1     (1 byte)
                     7768  ;*              S-Record Size at SP+2     (1 byte)
                     7769  ;*              S-Record Address at SP+3  (2 bytes)
                     7770  ;*              S-Record Data at SP+5     (up to 32 bytes, typically)
                     7771  ;*
                     7772  ;*              |                |    <-sp (after local space allocation)
                     7773  ;*      H:X->   | SRecCount      |
                     7774  ;*              | SRecChkSum     |    <-sp (when called)
                     7775  ;*              | ReturnAddr msb |
                     7776  ;*              | ReturnAddr lsb |    <-sp (upon return)
                     7777  ;*              | SRecType       |
                     7778  ;*              | SRecSize       |
                     7779  ;*      H:X->   | SRecAddr msb   |
                     7780  ;*              | SRecAddr lsb   |
                     7781  ;*              | SRecData 00    |
                     7782  ;*              | SRecData 01    |  etc..
                     7783  ;*
                     7784  ;*  Changes:    everything
                     7785  ;*
 FC73                7786  SRecCount:      equ     1                   ; stack pointer offset for S-Record Counter
 FC73                7787  SRecChkSum:     equ     2                   ; stack pointer offset for S-Record Check Sum
 FC73                7788  SRecType:       equ     5                   ; stack pointer offset for S-Record Type
 FC73                7789  SRecSize:       equ     6                   ; stack pointer offset for S-Record Size
 FC73                7790  SRecAddr:       equ     7                   ; stack pointer offset for S-Record Address
 FC73                7791  SRedData:       equ     8                   ; stack pointer offset for S-Record Data
                     7792  ;
                     7793  GetSRec:
 FC73 [02] A7FE      7794          ais     #-2                         ; allocate local variable space
 FC75 [04] 9E6F06    7795          clr     SRecSize,sp                 ; initialize S-Record size
                     7796  GetSRec1:
 FC78 [04] ADF0      7797          bsr     GetChar                     ; get a character from the SCI
 FC7A [02] A10D      7798          cmp     #ascii_CR                   ; check for ASCII carriage return
 FC7C [03] 2602      7799          bne     GetSRec1a                   ; just loop back if so
 FC7E [02] A60A      7800          lda     #ascii_LF                   ; get ASCII line feed
                     7801  GetSRec1a:
 FC80 [02] A153      7802          cmp     #'S'                        ; check for start of record character
 FC82 [03] 26F4      7803          bne     GetSRec1                    ; loop back if not
 FC84 [04] ADE4      7804          bsr     GetChar                     ; else, get next character from the SCI
 FC86 [02] A130      7805          cmp     #'0'                        ; check for header record type
 FC88 [03] 27EE      7806          beq     GetSRec1                    ; loop back if so
 FC8A [02] A139      7807          cmp     #'9'                        ; else, check for end record type
 FC8C [03] 2704      7808          beq     GetSRec2                    ; continue if so
 FC8E [02] A131      7809          cmp     #'1'                        ; else, check for data record type
 FC90 [03] 26E6      7810          bne     GetSRec1                    ; loop back if not
                     7811  GetSRec2:
 FC92 [04] 9EE705    7812          sta     SRecType,sp                 ; save S-Record type
 FC95 [04] AD3B      7813          bsr     GetHexByte                  ; get the S-Record length
 FC97 [03] 2622      7814          bne     GetSRec4                    ; exit if not a valid hex byte
 FC99 [04] 9EE701    7815          sta     SRecCount,sp                ; initialize S-Record counter
 FC9C [04] 9EE702    7816          sta     SRecChkSum,sp               ; initialize S-Record check sum
 FC9F [02] A003      7817          sub     #3                          ; adjust for address and checksum
 FCA1 [04] 9EE706    7818          sta     SRecSize,sp                 ; save S-Record size
 FCA4 [02] 95        7819          tsx                                 ; use H:X as data stack frame pointer
 FCA5 [02] AF06      7820          aix     #{SRecAddr-1}               ; adjust so pointer starts at S-Record Address
                     7821  GetSRec3:
 FCA7 [04] AD29      7822          bsr     GetHexByte                  ; get next S-Record hex byte
 FCA9 [03] 2610      7823          bne     GetSRec4                    ; exit if not a valid hex byte
 FCAB [02] F7        7824          sta     ,x                          ; save data in stack frame
 FCAC [04] 9EEB02    7825          add     SRecChkSum,sp               ; add data to check sum
 FCAF [04] 9EE702    7826          sta     SRecChkSum,sp               ; save new check sum
 FCB2 [02] AF01      7827          aix     #1                          ; move data stack frame pointer
 FCB4 [06] 9E6B01EF  7828          dbnz    SRecCount,sp,GetSRec3       ; loop back until all data has been received
 FCB8 [05] 9E6C02    7829          inc     SRecChkSum,sp               ; final calculation zeros check sum if it's okay
                     7830  GetSRec4:
 FCBB [02] A702      7831          ais     #2                          ; deallocate local variables
 FCBD [04] 81        7832          rts                                 ; return
                     7833  
                     7834  
                     7835  ;*  Help Command Response  ==================================================================
                     7836  ;*
                     7837  Boot5:
 FCBE [02] A148      7838          cmp     #cmd_help                   ; check for Help command
 FCC0 [03] 2704      7839          beq     Boot6                       ; continue if so
 FCC2 [02] A11F      7840          cmp     #cmd_help1                  ; check for alternate Help command
 FCC4 [03] 2606      7841          bne     Boot7                       ; skip if not
                     7842  boot6:
 FCC6 [03] 45FD90    7843          ldhx    #msg_help                   ; point to Help command message
 FCC9 [03] CCFBE9    7844          jmp     BootDone1                   ; go output it
                     7845  
                     7846  
                     7847  ;*  Unknown Command Response  ===============================================================
                     7848  ;*
                     7849  Boot7:
 FCCC [03] 45FDD7    7850          ldhx    #msg_what                   ; point to unknown command message
 FCCF [03] CCFBE9    7851          jmp     BootDone1                   ; go output it
                     7852  
                     7853  
                     7854  ;*  GetHexByte Subroutine  ==================================================================
                     7855  ;*
                     7856  ;*  This subroutine retrieves two ASCII bytes via the SCI and converts (packs) them into one
                     7857  ;*  hex byte, which is returned in ACC.
                     7858  ;*
                     7859  ;*  Calling convention:
                     7860  ;*
                     7861  ;*      jsr     GetHexByte
                     7862  ;*
                     7863  ;*  Returns:    CCRZ= 1 if valid hex byte retrieved.  Otherwise, CCRZ= 0.
                     7864  ;*              ACC= data
                     7865  ;*
                     7866  ;*  Changes:    ACC
                     7867  ;*
                     7868  GetHexByte:
 FCD2 [04] AD96      7869          bsr     GetChar                     ; get msb character from the SCI
 FCD4 [04] AD20      7870          bsr     IsHex                       ; check if valid ASCII hex character
 FCD6 [03] 2614      7871          bne     GetHexByte2                 ; exit if not
 FCD8 [04] AD13      7872          bsr     ToHex                       ; convert ASCII hex character to hex value
 FCDA [03] 62        7873          nsa                                 ; swap lower nibble up
 FCDB [02] 87        7874          psha                                ; save temporarily
 FCDC [05] CDFC6A    7875          jsr     GetChar                     ; get lsb character from the SCI
 FCDF [04] AD15      7876          bsr     IsHex                       ; check if valid ASCII hex character
 FCE1 [03] 2607      7877          bne     GetHexByte1                 ; exit if not
 FCE3 [04] AD08      7878          bsr     ToHex                       ; convert ASCII hex character to hex value
 FCE5 [04] 9EEB01    7879          add     1,sp                        ; combine msb and lsb nibbles
 FCE8 [02] A500      7880          bit     #0                          ; CCRZ= 1
                     7881  GetHexByte1:
 FCEA [02] A701      7882          ais     #1                          ; deallocate local variable
                     7883  GetHexByte2:
 FCEC [04] 81        7884          rts                                 ; return
                     7885  
                     7886  
                     7887  ;*  ToHex Subroutine  =======================================================================
                     7888  ;*
                     7889  ;*  This subroutine converts the ASCII hex value passed in ACC to a binary hex value.
                     7890  ;*
                     7891  ;*  Calling convention:
                     7892  ;*
                     7893  ;*      lda     data
                     7894  ;*      jsr     ToHex
                     7895  ;*
                     7896  ;*  Returns:    ACC= data.
                     7897  ;*
                     7898  ;*  Changes:    ACC
                     7899  ;*
                     7900  ToHex:
 FCED [02] A030      7901          sub     #'0'                        ; adjust first by subtracting '0'
 FCEF [02] A109      7902          cmp     #9                          ; check if value was between '0' to '9'
 FCF1 [03] 2302      7903          bls     ToHex1                      ; exit if so
 FCF3 [02] A007      7904          sub     #7                          ; else, adjust for value between 'A' to 'F'
                     7905  ToHex1:
 FCF5 [04] 81        7906          rts                                 ; return
                     7907  
                     7908  
                     7909  ;*  IsHex Subroutine  =======================================================================
                     7910  ;*
                     7911  ;*  This subroutine checks if the value passed in ACC is a valid ASCII hex character within
                     7912  ;*  within the ranges of '0' to '9' or 'A' to 'F'.  Note that the range 'a' to 'f' is not
                     7913  ;*  checked.
                     7914  ;*
                     7915  ;*  Calling convention:
                     7916  ;*
                     7917  ;*      lda     data
                     7918  ;*      jsr     IsHex
                     7919  ;*
                     7920  ;*  Returns:    CCRZ= 1 if data is a valid hex character.  Otherwise, CCRZ= 0.
                     7921  ;*
                     7922  ;*  Changes:    nothing
                     7923  ;*
                     7924  IsHex:
 FCF6 [02] A130      7925          cmp     #'0'                        ; check value against '0'
 FCF8 [03] 250E      7926          blo     IsntHex                     ; not hex if lower
 FCFA [02] A139      7927          cmp     #'9'                        ; check value against '9'
 FCFC [03] 2308      7928          bls     IsHex1                      ; is hex if lower
 FCFE [02] A141      7929          cmp     #'A'                        ; check value against 'A'
 FD00 [03] 2506      7930          blo     IsntHex                     ; not hex if lower
 FD02 [02] A146      7931          cmp     #'F'                        ; check value against 'F'
 FD04 [03] 2202      7932          bhi     IsntHex                     ; not hex if higher
                     7933  IsHex1:
 FD06 [02] A500      7934          bit     #0                          ; CCRZ= 1
                     7935  IsntHex:
 FD08 [04] 81        7936          rts                                 ; return
                     7937  
                     7938  
                     7939  ;*  Flash Mass Erase Subroutine  ============================================================
                     7940  ;*
                     7941  ;*  This subroutine performs multiple Page Erase operations in order to erase the application
                     7942  ;*  space Flash memory between "flash_first" and "flash_last".  This subroutine has been
                     7943  ;*  tuned for a bus speed of 7.3728 MHz.
                     7944  ;*  This subroutine is copied into and executed from RAM.
                     7945  ;*
                     7946  MassErase:
 FD09 [04] 5545      7947          ldhx    flash_last                  ; initialize pointer to last Flash memory address
 FD0B [03] 2023      7948          bra     MassErase2                  ; go move pointer before erasing Flash
                     7949  MassErase1:
                     7950  ;
                     7951  ;   Set ERASE, read the Flash Block Protect Register and write any data into Flash page.
                     7952  ;
 FD0D [02] A602      7953          lda     #{ERASE}                    ; set ERASE control bit
 FD0F [04] C7FE08    7954          sta     flcr                        ;  in Flash Control Register
 FD12 [04] C6FF7E    7955          lda     flbpr                       ; read from Flash Block Protect Register
 FD15 [02] F7        7956          sta     ,x                          ; write any data to address within page
                     7957  ;
                     7958  ;   Wait for >10us, then set HVEN.
                     7959  ;
 FD16 [02] A601      7960          lda     #1                          ; wait
 FD18 [04] AD1F      7961          bsr     delay                       ;  for 11.7us
 FD1A [02] A60A      7962          lda     #{ERASE | HVEN}             ; set HVEN control bit
 FD1C [04] C7FE08    7963          sta     flcr                        ;  in Flash Control Register
                     7964  ;
                     7965  ;   Wait for >1ms, then clear ERASE.
                     7966  ;
 FD1F [02] A664      7967          lda     #100                        ; wait
 FD21 [04] AD16      7968          bsr     delay                       ;  for 1.005ms
 FD23 [02] A608      7969          lda     #{HVEN}                     ; clear ERASE control bit
 FD25 [04] C7FE08    7970          sta     flcr                        ;  in Flash Control Register
                     7971  ;
                     7972  ;   Wait for >5us, then clear HVEN.
                     7973  ;
 FD28 [02] A601      7974          lda     #1                          ; wait
 FD2A [04] AD0D      7975          bsr     delay                       ;  for 11.7us
 FD2C [01] 4F        7976          clra                                ; clear HVEN control bit
 FD2D [04] C7FE08    7977          sta     flcr                        ;  in Flash Control Register
                     7978  ;
                     7979  ;   Advance pointer and repeat until finished.
                     7980  ;
                     7981  MassErase2:
 FD30 [02] AFC0      7982          aix     #-64                        ; move pointer back
 FD32 [02] AFC0      7983          aix     #-64                        ;  by one complete erase page
 FD34 [04] 7543      7984          cphx    flash_first                 ; check if finished
 FD36 [03] 22D5      7985          bhi     MassErase1                  ; loop back if not
                     7986  ;
 FD38 [04] 81        7987          rts                                 ; return
                     7988  
                     7989  
                     7990  ;*  Delay Subroutine  =======================================================================
                     7991  ;*
                     7992  ;*  This subroutine performs a simple software delay loop based upon the value passed in ACC.
                     7993  ;*  The following timing calculation applies:
                     7994  ;*
                     7995  ;*              delay = ((ACC * 74) + 12) (tcyc)
                     7996  ;*
                     7997  ;*  Calling convention:
                     7998  ;*
                     7999  ;*      lda     data
                     8000  ;*      jsr     delay
                     8001  ;*
                     8002  ;*  Returns:    nothing
                     8003  ;*
                     8004  ;*  Changes:    ACC
                     8005  ;*
                     8006  Delay:
 FD39 [02] 87        8007          psha                                ; [2] save outer delay loop parameter
                     8008  Delay1:
 FD3A [02] A616      8009          lda     #22                         ; [2] initialize inner delay loop counter
                     8010  Delay2:
 FD3C [03] 4BFE      8011          dbnza   Delay2                      ; [3] decrement inner delay loop counter
 FD3E [06] 9E6B01F8  8012          dbnz    1,sp,Delay1                 ; [6] decrement outer delay loop counter
 FD42 [02] 86        8013          pula                                ; [2] deallocate local variable
 FD43 [04] 81        8014          rts                                 ; [4] return
                     8015  
 FD44                8016  EraseRamSize:   equ     {*-MassErase}
 FD44                8017  ProgramRam:     equ     {*-Delay}
                     8018  
                     8019  
                     8020  ;*  Flash Program Subroutine  ===============================================================
                     8021  ;*
                     8022  ;*  This subroutine controls the Flash programming sequence.  A stack frame data block is
                     8023  ;*  passed to it in the format shown below.  This subroutine has been tuned for a bus speed
                     8024  ;*  of 7.3728 MHz.
                     8025  ;*  This subroutine is copied into and executed from RAM.
                     8026  ;*
                     8027  ;*              |                |    <-sp (when called)
                     8028  ;*              | ReturnAddr msb |
                     8029  ;*              | ReturnAddr lsb |    <-sp (upon return)
                     8030  ;*              | SRecSize       |
                     8031  ;*              | SRecAddr msb   |
                     8032  ;*              | SRecAddr lsb   |
                     8033  ;*              | SRecData 00    |
                     8034  ;*              | SRecData 01    |  etc..
                     8035  ;*
                     8036  FlashProgram:
 FD44 [02] 95        8037          tsx                                 ; get the Stack Pointer
 FD45 [04] 3541      8038          sthx    temp_sp                     ; save it temporarily
                     8039  ;
                     8040  ;   Get S-Record size and use the Stack Pointer as the data source pointer.
                     8041  ;
 FD47 [02] A702      8042          ais     #2                          ; SP points to SRecSize
 FD49 [02] 86        8043          pula                                ; get SRecSize
 FD4A [03] B740      8044          sta     count                       ; save it temporarily
                     8045  ;
                     8046  ;   Establish H:X as the destination pointer.
                     8047  ;
 FD4C [02] 8A        8048          pulh                                ; get destination address msb
 FD4D [02] 88        8049          pulx                                ; get destination address lsb
                     8050  
                     8051  FlashProgram1:
 FD4E [04] 7543      8052          cphx    flash_first                 ; check against minimum address
 FD50 [03] 252D      8053          blo     FlashProgram2               ; skip if lower
 FD52 [04] 7545      8054          cphx    flash_last                  ; check against maximum address
 FD54 [03] 2429      8055          bhs     FlashProgram2               ; skip if the same or higher
                     8056  ;
                     8057  ;   Set PGM, read the Flash Block Protect Register and write anywhere in desired Flash row.
                     8058  ;
 FD56 [02] A601      8059          lda     #{PGM}                      ; set PGM control bit
 FD58 [04] C7FE08    8060          sta     flcr                        ;  in Flash Control Register
 FD5B [04] C6FF7E    8061          lda     flbpr                       ; read from Flash Block Protect Register
 FD5E [02] F7        8062          sta     ,x                          ; write any data to first Flash address
                     8063  ;
                     8064  ;   Wait for >10us, then set HVEN.
                     8065  ;
 FD5F [02] A601      8066          lda     #1                          ; wait
 FD61 [04] ADD6      8067          bsr     delay                       ;  for 11.7us
 FD63 [02] A609      8068          lda     #{PGM | HVEN}               ; set HVEN control bit
 FD65 [04] C7FE08    8069          sta     flcr                        ;  in Flash Control Register
                     8070  ;
                     8071  ;   Wait for >5us.
                     8072  ;
 FD68 [02] A601      8073          lda     #1                          ; wait
 FD6A [04] ADCD      8074          bsr     delay                       ;  for 11.7us
                     8075  ;
                     8076  ;   Write data to Flash and wait for 30 - 40us.
                     8077  ;
 FD6C [02] 86        8078          pula                                ; get S-Record data
 FD6D [02] F7        8079          sta     ,x                          ; write data to Flash
 FD6E [02] A603      8080          lda     #3                          ; wait
 FD70 [04] ADC7      8081          bsr     delay                       ;  for 31.7us
                     8082  ;
                     8083  ;   Clear PGM.
                     8084  ;
 FD72 [02] A608      8085          lda     #{HVEN}                     ; clear PGM
 FD74 [04] C7FE08    8086          sta     flcr                        ;  in Flash Control Register
                     8087  ;
                     8088  ;   Wait for >5us, then clear HVEN.
                     8089  ;
 FD77 [02] A601      8090          lda     #1                          ; wait
 FD79 [04] ADBE      8091          bsr     delay                       ;  for 11.7us
 FD7B [01] 4F        8092          clra                                ; clear HVEN control bit
 FD7C [04] C7FE08    8093          sta     flcr                        ;  in Flash Control Register
                     8094  ;
                     8095  ;   Advance destination pointer and data counter.
                     8096  ;
                     8097  FlashProgram2:
 FD7F [02] AF01      8098          aix     #1                          ; advance destination pointer
 FD81 [05] 3B40CA    8099          dbnz    count,FlashProgram1         ; decrement counter and loop back if not done.
                     8100  ;
 FD84 [04] 5541      8101          ldhx    temp_sp                     ; restore
 FD86 [02] 94        8102          txs                                 ;  Stack Pointer
 FD87 [04] 81        8103          rts                                 ; return
                     8104  
 FD88                8105  ProgramRamSize: equ     {*-Delay}
                     8106  
                     8107  
                     8108  ;*  Messages  ===================================================================================
                     8109  ;*
 FD88                8110  ascii_CR:       equ     $0D                 ; ASCII carriage return
 FD88                8111  ascii_LF:       equ     $0A                 ; ASCII line feed
                     8112  ;
 FD88      0D0A426F  8113  msg_hello:      db      ascii_CR,ascii_LF,'Boot>',0
           6F743E00 
 FD90      20202850  8114  msg_help:       db      '  (P)rogram (W)ipe (U)pgrade e(X)it',0
           29726F67 
           72616D20 
           28572969 
           70652028 
           55297067 
           72616465 
           20652858 
           29697400 
                     8115  ;
 FDB4      2020436F  8116  msg_complete:   db      '  Complete',0
           6D706C65 
           746500 
 FDBF      202D2077  8117  msg_waiting:    db      ' - waiting ...',0
           61697469 
           6E67202E 
           2E2E00 
 FDCE      202D2065  8118  msg_error:      db      ' - error',0
           72726F72 
           00 
 FDD7      202D2077  8119  msg_what:       db      ' - what?',0
           6861743F 
           00 
 FDE0      202D2052  8120  msg_noreset:    db      ' - Reset Vector Invalid',0
           65736574 
           20566563 
           746F7220 
           496E7661 
           6C696400 
                     8121  
                     8122  ;
                     8123  ;   Last location not to exceed $FDFF
                     8124  ;
                     8125  BootEnd:
                     8126  
                     8127  
                     8128  ;*  Vectors  ************************************************************************************
                     8129  ;*
 FFDC                8130          org     vec_timebase                ; Timebase vector
 FFDC      FACA      8131          dw      user_timebase
 FFDE                8132          org     vec_adc                     ; ADC vector
 FFDE      FACD      8133          dw      user_ADC
 FFE0                8134          org     vec_kbd                     ; Keyboard vector
 FFE0      FAD0      8135          dw      user_keyboard
 FFE2                8136          org     vec_scitx                   ; SCI transmit vector
 FFE2      FAD3      8137          dw      user_SCItx
 FFE4                8138          org     vec_scirx                   ; SCI receive vector
 FFE4      FAD6      8139          dw      user_SCIrx
 FFE6                8140          org     vec_scierr                  ; SCI error vector
 FFE6      FAD9      8141          dw      user_SCIerr
 FFE8                8142          org     vec_spitx                   ; SPI transmit vector
 FFE8      FADC      8143          dw      user_SPItx
 FFEA                8144          org     vec_spirx                   ; SPI receive vector
 FFEA      FADF      8145          dw      user_SPIrx
 FFEC                8146          org     vec_tim2ov                  ; Timer 2 overflow vector
 FFEC      FAE2      8147          dw      user_Tim2Ov
 FFEE                8148          org     vec_tim2ch1                 ; Timer 2 channel 1 vector
 FFEE      FAE5      8149          dw      user_Tim2Ch1
 FFF0                8150          org     vec_tim2ch0                 ; Timer 2 channel 0 vector
 FFF0      FAE8      8151          dw      user_Tim2Ch0
 FFF2                8152          org     vec_tim1ov                  ; Timer 1 oveflow vector
 FFF2      FAEB      8153          dw      user_Tim1Ov
 FFF4                8154          org     vec_tim1ch1                 ; Timer 1 channel 1 vector
 FFF4      FAEE      8155          dw      user_Tim1Ch1
 FFF6                8156          org     vec_tim1ch0                 ; Timer 1 channel 0 vector
 FFF6      FAF1      8157          dw      user_Tim1Ch0
 FFF8                8158          org     vec_pll                     ; PLL vector
 FFF8      FAF4      8159          dw      user_PLL
 FFFA                8160          org     vec_irq                     ; IRQ vector
 FFFA      FAF7      8161          dw      user_IRQ
 FFFC                8162          org     vec_swi                     ; SWI vector
 FFFC      FAFA      8163          dw      user_SWI
 FFFE                8164          org     vec_reset                   ; Reset vector
 FFFE      FB08      8165          dw      BootReset
                     8166  
                     8167  
                     8168  ;*  Flash Block Protect Register  ***************************************************************
                     8169  ;*
 FF7E                8170          org     flbpr
 FF7E      F6        8171          db      flash_protect
                     8172  
 FF7F                8173          end
                     8174  
 FF7F                8175  flash_1_size        equ {flash_table1_end-flash_table1}
 FF7F                8176  flash_2_size        equ {flash_table2_end-flash_table2}
 FF7F                8177  flash_3_size        equ {flash_table3_end-flash_table3}
 FF7F                8178  flash_4_size        equ {flash_table4_end-flash_table4}
 FF7F                8179  flash_5_size        equ {flash_table5_end-flash_table5}
                     8180  
 FF7F                8181       end
                     8182  
                     8183  ;***********************************************************************************************
                     8184  ; This marks the end of the program
                     8185  ;***********************************************************************************************
                     8186  ;****************************************************************************
                     8187  ; ------------------ Engine Configuration Bit Definitions ------------------
                     8188  ;****************************************************************************
                     8189  ;
                     8190  ; EngConfig:
                     8191  ;  Bit 0 = Number of Cylinders
                     8192  ;          1 = 8 cylinders
                     8193  ;          0 = 6 cylinders
                     8194  ;
                     8195  ;  Bit 1 = O2 Sensor type
                     8196  ;          1 = Wide band
                     8197  ;          0 = Narrow band
                     8198  ;
                     8199  ;  Bit 2 = Control Strategy
                     8200  ;          1 = Speed Density
                     8201  ;          0 = Alpha-N
                     8202  ;
                     8203  ;  %00000110 = 6T (SD, WB, 6cyl)
                     8204  ;  %00000111 = 7T (SD, WB, 8cyl)
                     8205  
                     8206   

 Symbol Table 

ACK              0002
ACKK             0002
ACMULT           E429
ACQ              0005
ADCC             0001
ADCCNT           00EE
ADCH0            0000
ADCH1            0001
ADCH2            0002
ADCH3            0003
ADCH4            0004
ADCLK            003E
ADCO             0005
ADCWAIT          8361
ADCWAIT2         8376
ADC_0            846D
ADC_1            847D
ADC_10           859C
ADC_10_J         84D0
ADC_10_J1        853E
ADC_2            8495
ADC_3            84A5
ADC_4            84D2
ADC_5            8500
ADC_5_J          84C6
ADC_6            852E
ADC_6_J          84C8
ADC_7            8535
ADC_7_J          84CA
ADC_8            8540
ADC_8_J          84CC
ADC_9            856E
ADC_9_J          84CE
ADC_9_J1         853C
ADC_DONE         85C7
ADC_ISR          8F5E
ADC_LOOKUPS      844A
ADD_TO_AE        893F
ADICLK           0004
ADIV0            0005
ADIV1            0006
ADIV2            0007
ADR              003D
ADSCR            003C
ADSEL            006E
ADSEL2           006F
AE_COMP_SHOOT_AM 88BE
AFR1_F           E200
AFR1_R           00F0
AFR2_F           E300
AFR2_R           00F0
AIEN             0006
AIOT             0000
AIOTCNTR         00CB
AIOT_CHK_DONE    8C38
AIOT_OFF         8C36
AIRCOR           004F
AIRDENFACTOR     F300
AIRTEMP          00EF
AIRTEMPON        E442
ALARMBITS        0064
ALARM_CHK_DONE   8675
ALARM_OFF        866E
ALARM_ON         865E
ALTCOUNT         0082
ALTERNATE        E425
ASCII_CR         000D
ASCII_LF         000A
ASECOUNT         007F
ASEHTYPE         E432
ASEH_RNG         880D
ASETYPE          E445
ASE_ASEH_END     8889
ASE_RNG          8866
AUTO             0007
AV_HI_RES_PERIOD 874F
AWC              E41F
AWCH             E430
AWEV             E41E
AWEVH            E42F
BAROCOR          004D
BAROFAC4250RJH   F000
BAROMETER        004C
BATT             0045
BATTCNT          00D6
BATTCUR          00E7
BATTFAC          E427
BATTTH           00D4
BATTTL           00D5
BATT_AV          84E8
BATT_CORR_COMP   8A9E
BCFE             0007
BCS              0004
BKF              0001
BNKFLOWH         E443
BNKFLOWHMV       0067
BNKFLOWL         E444
BNKFLOWLMV       0068
BOOT             FBBB
BOOT1            FBD9
BOOT2            FBE0
BOOT3            FBFC
BOOT4            FC4A
BOOT5            FCBE
BOOT6            FCC6
BOOT7            FCCC
BOOTDONE         FBE6
BOOTDONE1        FBE9
BOOTDONE2        FBEB
BOOTEND          FDF8
BOOTPROG         FC04
BOOTPROG1        FC07
BOOTPROG2        FC14
BOOTPROG3        FC2D
BOOTPROG4        FC31
BOOTPROG5        FC42
BOOTPROG6        FC47
BOOTRESET        FB08
BOOTRESET1       FB59
BOOTRESET2       FB75
BOOTRESET3       FB7E
BOOTRESET4       FB87
BOOTRESET5       FB98
BOOTRESET6       FBA5
BOOTRESETUSER    FBA5
BOOT_START       FB00
BRKA             0006
BRKE             0007
BRKH             FE09
BRKL             FE0A
BRKSCR           FE0B
BURNCONST        91C2
BURNCOUNT        00C9
BURNDST          00C7
BURNSRC          00C5
BURN_CONT        91C9
BUS7372800       FB00
BUS8003584       FB04
B_LO_CONT        88F2
CALC_OFF_OC      8DE2
CANT_CRANK       0004
CANT_DELAY       0005
CANT_OFF         8DBC
CANT_SET         8DB8
CGMCHANGE        FB39
CH1_OFFH         00BD
CH1_OFFL         00BE
CH1_ONH          00B5
CH1_ONL          00B6
CHAN_0           8FB0
CHAN_1           8FB6
CHAN_2           8FBC
CHAN_3           8FC2
CHECK_GREATER_TH 9017
CHECK_LESS_THAN  900F
CHECK_PIPN       8BAD
CHECK_STALL      8C41
CHECK_TXCMD      8E56
CHK_ASEH_RNG     87FF
CHK_FTRM         83DD
CHK_HEGT_HI      8611
CHK_HET_HI       85D9
CHK_HFP_HI       8647
CHK_LFP_HI       862D
CHK_LOP_HI       85F5
CHK_LO_SPD_DONE  872A
CHK_MON_HI       8418
CHK_MON_LO       8FD1
CHK_REV_LIMIT    8711
CHK_TRM_DONE     83FE
CHK_WUE_RNG      87ED
CHXF             0007
CHXIE            0006
CHXMAX           0000
CLEARRAM         81BD
CLEAR_HEGT       860A
CLEAR_HET        85D2
CLEAR_HFP        8640
CLEAR_LFP        8634
CLEAR_LOP        85FC
CLOCK100         0004
CLOCK250         0005
CLOCK500         0006
CLT              0043
CLTCUR           00E5
CMD_ERASE        0057
CMD_EXIT         0058
CMD_HELP         0048
CMD_HELP1        001F
CMD_PROGRAM      0050
CMD_UPGRADE      0055
COCO             0007
CONFIG1          001F
CONFIG2          001E
CONT_TX          8F24
COOLANT          006D
COOLANTON        E433
COP              0005
COPCTL           FFFF
COUNT            0040
CPHA             0003
CPOL             0004
CRANK            0001
CRANK_CHK        8BFE
CT_CNT           E42D
CWH              E41D
CWU              E41C
DDRA             0004
DDRB             0005
DDRC             0006
DDRD             0007
DDRE             000C
DEADBAND         0074
DECRMT           90C1
DELAY            FD39
DELAY1           FD3A
DELAY2           FD3C
DELAY_DONE       8444
DELAY_PH         00B3
DELAY_PL         00B4
DIVIDEND         008B
DIVIDER          E424
DIVISOR          008D
DIVROUND         90EB
DIVROUND0        90FB
DIVROUND1        90FD
DIVROUND2        90F8
DIV_BY_16        9170
DLY_ANG_CALC_DON 8B9F
DLY_ANG_FAC      005F
DMARE            0005
DMATE            0004
DONE_BYTE        8F35
DONE_LOAD        8F52
DONE_RCV         8EEA
DONE_WITH_INTERP 905E
DO_100MS         8D11
DO_100MS_COUNT   8D29
DO_250MS         8D35
DO_250MS_COUNT   8D4F
DO_500MS         8D63
DO_500MS_COUNT   8D7B
DO_FUEL          8BDD
DO_IGN_COUNT     8BDB
DO_INTERP        9022
DO_MON           8FD6
DO_SEC           8D85
DO_SEC_COUNT     8D9D
DUMMY            8FEE
EAON             0000
EGO              0046
EGOCNT           00D9
EGOCUR           00E8
EGOTH            00D7
EGOTL            00D8
EGO_AV           8516
EGT_ADC          004B
EGT_ADCCNT       00E2
EGT_ADCCUR       00ED
EGT_ADCTH        00E0
EGT_ADCTL        00E1
EGT_ADC_AV       85B2
ELSXA            0002
ELSXB            0003
END_AE_LONGBRANC 88F6
ENGINE           0063
ENGINE2          0069
ENG_ALRM         0001
ENG_START        8785
ENSCI            0006
EN_KYBD_DONE     8427
EN_XMIT          8EE4
ERASE            0002
ERASEFLASH       FC5C
ERASEFLASH1      FC5F
ERASERAMSIZE     003B
ERRIE            0006
EXITSN           9153
FAST_RPM_CALC    86F5
FD               0058
FDCNTR           00CA
FDHRH            0072
FDHRL            0073
FDSECH           0059
FDSECL           005A
FDTH             00CC
FDTL             00CD
FE               0001
FEIE             0001
FINALNORM        912B
FINAL_PW_CALC    8AC4
FIN_TX           8F2F
FIRE_ADC         8CF7
FIRING1          0003
FIRING2          0005
FLASHPROGRAM     FD44
FLASHPROGRAM1    FD4E
FLASHPROGRAM2    FD7F
FLASH_1_SIZE     00A8
FLASH_2_SIZE     00A8
FLASH_3_SIZE     00A8
FLASH_4_SIZE     00A8
FLASH_5_SIZE     0046
FLASH_ERASED     00FF
FLASH_FIRST      0043
FLASH_LAST       0045
FLASH_PAGE       0080
FLASH_PROTECT    00F6
FLASH_ROW        0040
FLASH_TABLE1     E000
FLASH_TABLE1_END E0A8
FLASH_TABLE2     E100
FLASH_TABLE2_END E1A8
FLASH_TABLE3     E200
FLASH_TABLE3_END E2A8
FLASH_TABLE4     E300
FLASH_TABLE4_END E3A8
FLASH_TABLE5     E400
FLASH_TABLE5_END E446
FLBPR            FF7E
FLCR             FE08
FLDCLR           0006
FLOCKER          00C4
FLOODCLEAR       E428
FLOOD_CLEAR      879C
FPON             0000
FP_ADC           004A
FP_ADCCNT        00DF
FP_ADCCUR        00EC
FP_ADCTH         00DD
FP_ADCTL         00DE
FP_ADC_AV        8584
FTEN             0005
FTRIMCOR         0050
FTRM_ADC         0047
FTRM_ADCCUR      00E9
FTRM_ON          83E7
FUELP            0000
FUEL_TRM_EN      0005
GAMMAE           0051
GETCHAR          FC6A
GETHEXBYTE       FCD2
GETHEXBYTE1      FCEA
GETHEXBYTE2      FCEC
GETSREC          FC73
GETSREC1         FC78
GETSREC1A        FC80
GETSREC2         FC92
GETSREC3         FCA7
GETSREC4         FCBB
GET_TIMESTAMP    8BA3
GOT_ORD_NUM      9009
HEGT             0004
HEGTOFF          E439
HEGTON           E438
HEGT_ALARM_DONE  861D
HET              0001
HETOFF           E435
HETON            E434
HET_ALARM_DONE   85E5
HFP              0003
HFPOFF           E43D
HFPON            E43C
HFP_ALARM_DONE   8653
HI_RES_TACH      8738
HI_RES_TACH_DONE 877A
HOT_100MS        8D20
HOT_250MS        8D46
HOT_500MS        8D72
HOT_IGN          8BD2
HOT_SEC          8D94
HVEN             0008
IDLE             0004
IGNCOUNT         0081
IGNITION_CALCS   867B
IGN_MON          0004
IGN_SEQ_DONE     8DFC
IGN_TRM_EN       0002
ILAD             0003
ILIE             0004
ILOP             0004
ILTY             0002
IMASK            0001
IMASKK           0001
INC_CUS          8CEF
INC_CUS_JMP      8CB9
INC_MS           8CFD
INC_RPM_CNTR     8C38
INC_SEC          8DBE
INIT_CONFIG1     0001
INIT_CONFIG2     0001
INIT_FIRST       8000
INIT_LAST        FB00
INIT_SCBR        0012
INIT_SCC1        0040
INIT_SCC2        000C
INIT_STACK       01EC
INJ1             0000
INJ2             0001
INJECT1          0004
INJECT2          0005
INJF1            8C80
INJF2            8C83
INJOPEN          E426
INJSTRT          8C62
INJ_FIRE_CNTL    8C59
INJ_FIRE_CNTL_DO 8CEF
INPUTS           006B
INT1             FE04
INT2             FE05
INT3             FE06
INTACC1          0089
INTACC2          008D
INTERP_CRANK_PW  87AB
INTERP_PRIME_PW  8388
INTKBIER         001B
INTKBSCR         001A
INTSCR           001D
IN_A_OR_C_MODE   8F0D
IN_Q_MODE        8F21
IN_S_MODE        8F1C
IN_T_MODE        8F17
IN_V_MODE        8F11
IRQF             0003
IRQ_DONE         8C1B
IRQ_ISR          8BA2
ISHEX            FCF6
ISHEX1           FD06
ISNTHEX          FD08
ITEN             0002
ITRM_ADC         0048
ITRM_ADCCUR      00EA
ITRM_ON          83C7
KBIE0            0000
KBIE1            0001
KBIE2            0002
KBIE3            0003
KBIE4            0004
KBIE5            0005
KBIE6            0006
KBIE7            0007
KEYBD_DONE       8FED
KEYF             0003
KNK_DET          0003
KNOCKING         0007
KNOCK_ALARM      8664
KNOCK_DONE       840D
KNOCK_ON         8408
KPA              006C
KPAFACTOR4250RJH F100
KPARANGEAFR1_F   E29C
KPARANGEAFR1_R   018C
KPARANGEAFR2_F   E39C
KPARANGEAFR2_R   018C
KPARANGEST_F     E19C
KPARANGEST_R     018C
KPARANGEVE_F     E09C
KPARANGEVE_R     018C
KYBD_ISR         8FCA
LAST_TPS         0080
LFP              0002
LFPOFF           E43B
LFPON            E43A
LFP_ALARM_DONE   8639
LININTERP        900A
LOAD_TABLE       8F47
LOCK             0006
LOOPCHK          0002
LOOPCOUNTER      00C1
LOOPER           83BD
LOOPS            0007
LOOP_DONE        8B9F
LOP              0000
LOPOFF           E437
LOPON            E436
LOP_ALARM_DONE   8601
LVI              0001
LVIOUT           0007
LVISR            FE0C
M                0004
MAP              0041
MAPAEN           0006
MAPCUR           00E3
MASS             0004
MASSERASE        FD09
MASSERASE1       FD0D
MASSERASE2       FD30
MAT              0042
MATCUR           00E4
MBFF             8ABA
MINPIP           00C2
MINPIP_DONE      8413
MODE             0000
MODEK            0000
MODE_A           8E87
MODE_B           8E91
MODE_C           8EA5
MODE_P           8EAF
MODE_Q           8EB4
MODE_R           8E87
MODE_S           8EDD
MODE_T           8ED4
MODE_V           8EBE
MODE_W           8EC9
MODE_X           8ECF
MODF             0004
MODFEN           0002
MODRST           0002
MONEN            0003
MONRISE          0002
MON_PH           0060
MON_PL           0061
MON_TSH          00BF
MON_TSL          00C0
MPLEXA           0007
MPLEXB           0006
MS               007B
MSG_COMPLETE     FDB4
MSG_ERROR        FDCE
MSG_HELLO        FD88
MSG_HELP         FD90
MSG_NORESET      FDE0
MSG_WAITING      FDBF
MSG_WHAT         FDD7
MSX100           007A
MSX250           0079
MSXA             0004
MSXB             0005
MS_DELAY         923B
MS_DELAY1        923C
MS_DELAY2        923E
MS_ERASEFLASH    91F7
MS_ERASEFLASH1   91FA
MS_ERASERAMSIZE  0031
MS_FLASHPROGRAM  9246
MS_FLASHPROGRAM1 9246
MS_FLASHPROGRAM2 9275
MS_MASSERASE     9215
MS_PROGRAMFLASH  9206
MS_PROGRAMFLASH1 9209
MS_PROGRAMRAM    000B
MS_PROGRAMRAMSIZ 004A
MS_RAM_END       00F0
MS_RAM_SIZE      00B0
MS_RAM_START     0040
MS_RF_END        0198
MS_RF_SIZE       00A8
MS_RF_START      00F0
MS_TOTAL_RAM_SIZ 0158
MULPLX_SET       8FA0
MULPLX_SET_DONE  8FC6
MULTIPLEX        8F7D
MULTIPLEX_DONE   8F9A
NDA1             8938
NEG_SLOPE        9051
NEIE             0002
NEW_SQUIRT1      8C85
NEW_SQUIRT2      8CBB
NF               0002
NOT_WUE_RNG      87F6
NO_100MS_COUNT   8D2B
NO_250MS_COUNT   8D51
NO_500MS_COUNT   8D7D
NO_ADC_PASS      85C9
NO_BATT_AV       84FD
NO_CLOCK_PASS    8994
NO_EGO_AV        852B
NO_EGT_ADC_AV    85C7
NO_FP_ADC_AV     8599
NO_IGN_COUNT     8BDD
NO_OP_ADC_AV     856B
NO_PIP_PASS      8789
NO_REV_LIMIT     870A
NO_SEC_COUNT     8D9F
OFF_DELAY        8DEF
OP_ADC           0049
OP_ADCCNT        00DC
OP_ADCCUR        00EB
OP_ADCTH         00DA
OP_ADCTL         00DB
OP_ADC_AV        8556
OR               0003
ORD_TABLE_FIND   8FEF
ORIE             0003
OVRF             0005
PAGE             00C3
PAGESIZE         00A8
PBWC             0037
PCTL             0036
PE               0000
PEIE             0000
PEN              0001
PGM              0001
PIN              0006
PIPRISE          0000
PIP_ANGLE        E42C
PIP_OK           8BB5
PIP_PASS         867B
PIP_PASS_DONE    8787
PIP_PERIODH      00B9
PIP_PERIODL      00BA
PIP_PH           00AF
PIP_PH_DIF       00AD
PIP_PH_PRED      00B1
PIP_PH_PRV       00AB
PIP_PL           00B0
PIP_PL_DIF       00AE
PIP_PL_PRED      00B2
PIP_PL_PRV       00AC
PIP_TSH          00A7
PIP_TSH_PRV      00A9
PIP_TSL          00A8
PIP_TSL_PRV      00AA
PLLF             0006
PLLIE            0007
PLLON            0005
PLLSET           FB3D
PLLWAIT          FB4D
PLL_WAIT         8140
PMDS             003B
PMRS             003A
PMSH             0038
PMSL             0039
POR              0007
PORTA            0000
PORTABITS        0065
PORTB            0001
PORTC            0002
PORTCBITS        0066
PORTD            0003
PORTE            0008
POSINTERP        9035
PRE0             0002
PRE1             0003
PRH              E42B
PRINTSTRING      FBF8
PRINTSTRING1     FBF3
PROGRAMRAM       000B
PROGRAMRAMSIZE   004F
PRU              E42A
PS0              0000
PS1              0001
PS2              0002
PTAPUE           000D
PTCPUE           000E
PTDPUE           000F
PTY              0000
PUTCHAR          FB53
PUTSTRING        FBED
PW               0057
PWCALCH          0055
PWCALCL          0056
PWNADH           0070
PWNADL           0071
QUOTIENT         0089
R8               0007
RAILCALC         9150
RAIL_DL_ANG_FAC  8B9B
RAM_EXEC         01ED
RAM_LAST         023F
RAM_START        0040
RE               0002
REENT            8FF6
REMAINDER        0089
REQ_FUEL         E423
REVL             0005
REVLOFF          E43F
REVLON           E43E
REVNUM           9181
REV_LIMIT        8718
REV_LIM_DONE     871D
ROM_LAST         FDFF
ROM_START        8000
ROUNDREM         911B
RPF              0000
RPM20            0053
RPMCH            0077
RPMCL            0078
RPMPH            0075
RPMPL            0076
RPMRANGEAFR1_F   E290
RPMRANGEAFR1_R   0180
RPMRANGEAFR2_F   E390
RPMRANGEAFR2_R   0180
RPMRANGEST_F     E190
RPMRANGEST_R     0180
RPMRANGEVE_F     E090
RPMRANGEVE_R     0180
RPM_CALC_DONE    8701
RPM_CNTR_DONE    8C3E
RPM_PERIOD       8BB5
RST_ACCEL        8954
RUN              0000
RUNNING          0000
RUNON            E440
RUN_SET          8BE6
RWU              0001
RXOFFSET         0088
SBFCR            FE03
SBK              0000
SBSR             FE00
SBSW             0001
SCBR             0019
SCC1             0013
SCC2             0014
SCC3             0015
SCDR             0018
SCHED1           0002
SCHED2           0004
SCHEDSPK         0001
SCHED_BOTH       8C17
SCHED_INJ1       8C0B
SCHED_INJ2       8C11
SCHED_SQUIRT     8BFC
SCIRCV_ISR       8DFE
SCITX_ISR        8EEC
SCRF             0005
SCRIE            0005
SCS1             0016
SCS2             0017
SCTE             0007
SCTIE            0007
SECH             007D
SECL             0040
SETLSB           90BF
SET_HEGT         8618
SET_HET          85E0
SET_HFP          864E
SET_LFP          8626
SET_LOP          85EE
SET_LO_OC        8DD8
SET_RUN_E2       8728
SET_SPOUT_HI     8430
SHFTLP           9083
SIGNATURE        91A2
SLOW_SPOUT_DONE  8432
SPARK            0001
SPARKING         0002
SPCR             0010
SPDR             0012
SPE              0001
SPK_ANG_FAC      005D
SPMSTR           0005
SPOUTON_PH       00BB
SPOUTON_PL       00BC
SPOUT_TSH        00B7
SPOUT_TSL        00B8
SPR0             0000
SPR1             0001
SPRF             0007
SPRIE            0007
SPSCR            0011
SPTE             0003
SPTIE            0000
SPWOM            0002
SQUIRT           006A
SRECADDR         0007
SRECCHKSUM       0002
SRECCOUNT        0001
SRECSIZE         0006
SRECTYPE         0005
SREDDATA         0008
SRSR             FE01
START            8128
STARTED          0003
STARTEDON        E441
STARTW           0002
STAT_TIM_ANG     000A
ST_F             E100
ST_R             00F0
SUBAR            FE02
SUPERNORM        90FE
T1CH0H           0026
T1CH0L           0027
T1CH1H           0029
T1CH1L           002A
T1CNTH           0021
T1CNTL           0022
T1MODH           0023
T1MODL           0024
T1SC             0020
T1SC0            0025
T1SC1            0028
T2CH0H           0031
T2CH0L           0032
T2CH1H           0034
T2CH1L           0035
T2CNTH           002C
T2CNTL           002D
T2MODH           002E
T2MODL           002F
T2SC             002B
T2SC0            0030
T2SC1            0033
T8               0006
TACHCNT          00D3
TACHCURH         00CE
TACHCURL         00CF
TACHH            005B
TACHL            005C
TACHTH           00D0
TACHTL           00D2
TACHTM           00D1
TACK             0003
TAE              8891
TAE_CHK_TIME     894B
TBCR             001C
TBIE             0002
TBIF             0007
TBON             0001
TBR0             0004
TBR1             0005
TBR2             0006
TC               0006
TCIE             0006
TDE              895E
TDE2             88F4
TDE_CHK_DONE     8987
TDE_CHK_FUEL_CUT 8976
TDE_DONE         8992
TE               0003
TEMP_SP          0041
TEXTVERSION_F    9182
THERMFACTOR      F200
TIM2CH0_ISR      8C1F
TIM2CH0_ISR_DONE 8DC6
TIM2CH0_ISR_JMP  8D61
TIM2CH1_ISR      8DC8
TMP1             0091
TMP10            009A
TMP11            009B
TMP12            009C
TMP13            009D
TMP14            009E
TMP15            009F
TMP16            00A0
TMP17            00A1
TMP18            00A2
TMP19            00A3
TMP2             0092
TMP20            00A4
TMP21            00A5
TMP22            00A6
TMP3             0093
TMP4             0094
TMP5             0095
TMP6             0096
TMP7             0097
TMP8             0098
TMP9             0099
TOF              0007
TOHEX            FCED
TOHEX1           FCF5
TOIE             0006
TOTALIZER1       8CAF
TOTALIZER2       8CE5
TOTALIZER_DONE1  8CB7
TOTALIZER_DONE2  8CED
TOVX             0001
TPS              0044
TPSACCEL         0052
TPSACLK          007E
TPSACLKCMP       0083
TPSACOLD         E420
TPSAEN           0004
TPSAQ            E418
TPSASYNC         E422
TPSCUR           00E6
TPSDEN           0005
TPSDOTRATE       E414
TPSDQ            E431
TPSFUELCUT       0084
TPSP             0062
TPSTHRESH        E421
TRIGHI           0007
TRM_ANG_FAC      005E
TRST             0004
TSTOP            0005
TXCNT            0085
TXGOAL           0086
TXINV            0005
TXMODE           0087
TXMODE_5         8E20
TXMODE_6         8E28
TXMODE_7         8E34
TXMODE_8         8E3C
TXMODE_9         8E44
TXMODE_9_CONT    8E53
TXMODE_C         8F37
TXMODE_C1        8E1D
TX_DONE          8F58
UDVD32           905F
UPPER_RAIL_AE    893B
USER_ADC         FACD
USER_CONFIG1     FAC4
USER_CONFIG2     FAC5
USER_FIRST       FAC6
USER_IRQ         FAF7
USER_KEYBOARD    FAD0
USER_LAST        FAC8
USER_PLL         FAF4
USER_RESET       FAFD
USER_SCBR        FAC3
USER_SCIERR      FAD9
USER_SCIRX       FAD6
USER_SCITX       FAD3
USER_SPIRX       FADF
USER_SPITX       FADC
USER_SWI         FAFA
USER_TIM1CH0     FAF1
USER_TIM1CH1     FAEE
USER_TIM1OV      FAEB
USER_TIM2CH0     FAE8
USER_TIM2CH1     FAE5
USER_TIM2OV      FAE2
USER_TIMEBASE    FACA
USX100           007C
VE1X             9154
VE1XC            9161
VE1XF            915E
VE2X             9162
VE2XC            916F
VE2XF            916C
VECURR           0054
VEC_ADC          FFDE
VEC_IRQ          FFFA
VEC_KBD          FFE0
VEC_PLL          FFF8
VEC_RESET        FFFE
VEC_SCIERR       FFE6
VEC_SCIRX        FFE4
VEC_SCITX        FFE2
VEC_SPIRX        FFEA
VEC_SPITX        FFE8
VEC_SWI          FFFC
VEC_TIM1CH0      FFF6
VEC_TIM1CH1      FFF4
VEC_TIM1OV       FFF2
VEC_TIM2CH0      FFF0
VEC_TIM2CH1      FFEE
VEC_TIM2OV       FFEC
VEC_TIMEBASE     FFDC
VE_F             E000
VE_R             00F0
VPR0             0000
VPR1             0001
WAKE             0003
WARMCOR          004E
WARMUP           0003
WARM_UP_ENRICH   87D6
WOT_CNT          E42E
WUE1             87E3
WUE2             87E8
WUE_ASE_ASEH_DON 8891
WUE_DONE_J       8834
WUE_END          888D
WUE_RNG          8836
WWU              E40A
WWURANGE         E400
ZERO_SLOPE       905C
